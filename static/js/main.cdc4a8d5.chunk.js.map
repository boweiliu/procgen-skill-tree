{"version":3,"sources":["lib/util/misc.ts","data/PointNodeRef.ts","data/WorldGenState.ts","data/GameState.ts","game/Neighbors.ts","lib/util/epsilon_math.ts","lib/util/geometry/vector2.ts","game/EfficiencyCalculator.ts","components/DebugTab.tsx","components/KeyboardControl.tsx","components/NodeDetail.tsx","contexts.ts","components/PixiWrapperComponent.tsx","lib/util/data_structures/hash.ts","lib/pixi/pixify.ts","game/ComputeState.ts","lib/util/batchify.ts","lib/util/updaterGenerator.ts","pixi/components/LifecycleHandler.ts","pixi/components/TooltippableAreaComponent.ts","pixi/components/PointNodeComponent.ts","game/OnAllocation.ts","pixi/components/ChunkComponent.ts","game/WorldGenStateFactory.ts","lib/util/fpsTracker.ts","pixi/components/FpsComponent.ts","pixi/components/ZLevelComponent.ts","pixi/components/ReticleComponent.ts","pixi/components/EfficiencyBarComponent.ts","pixi/components/RootComponent.ts","pixi/textures/PointNodeTexture.ts","pixi/PixiReactBridge.ts","game/GameStateFactory.ts","components/PixiComponent.tsx","components/QuestProgress.tsx","components/Sidebar.tsx","components/TabContent.tsx","components/Tabs.tsx","App.tsx","game/QuestFactory.ts","serviceWorker.ts","index.tsx","lib/util/random.ts"],"names":["Util","list","fn","lowestT","lowestValue","item","value","obj","highestT","highestValue","low","high","Math","floor","random","array","key","sort","a","b","str","mapObj","re","RegExp","Object","keys","join","replace","matched","toLowerCase","func","timeoutId","waitMilliseconds","options","isImmediate","result","args","doLater","undefined","apply","shouldCallNow","clearTimeout","setTimeout","d","monthName","getMonth","getDate","getHours","substr","getMinutes","getSeconds","arr","concat","string","length","intersperse","character","repeat","assertOnlyCalledOnceData","assertOnlyCalledOnce","id","k","toString","Error","stacktrace","stack","Lazy","factory","_wasConstructed","_value","_factory","this","multiplyColor","color1","color2","reds","blues","greens","out","round","enumKeys","enm","ResourceNontrivialType","PointNodeRef","z","chunkCoord","pointNodeCoord","pointNodeId","ChunkRef","chunkId","ChunkGenConstants","CHUNK_HALF_DIM","CHUNK_DIM","DROP_NODES_CHANCE","ResourceModifier","IntentName","ResourceType","Nothing","Direction","noIntent","reduce","object","ResourceTypeAndModifier","type","modifier","EPSILON","Vector2","propsOrX","x","y","_x","_y","p","abs","max","dx","dy","sqrt","newY","about","amount","origin","angle","PI","cos","sin","other","__type","trans","scale","newX","t","console","error","add","tx","ty","lerp","highX","highY","lowX","lowY","RandRange","hasOwnProperty","JSON","stringify","getNeighbors","selfPointNodeRef","worldGen","neighborsMap","neighbors","zLevel","zLevels","myChunk","chunks","get","addX","chunk","withX","nbor","pointNodes","EAST","WEST","addY","withY","SOUTH","NORTH","equals","Zero","upZLevel","upChunkCoordX","upNodeX","upChunkCoordY","upNodeY","upChunkCoord","upChunk","upNode","UP","downZLevel","multiply","downChunk","DOWN","getNeighborsMap","it","push","canAllocate","allocatedPointNodeSet","availableSp","contains","computeQuestEfficiencyPercent","playerSave","questProgressHistory","noEffectNodeCount","forEach","num","i","questInitialAmount","noEffectNodePercent","log","remapQuestEfficiencyToDisplayable","percent","pow","min","remapQuestEfficiencyToGrade","displayable","DebugTab","selectedPointNode","computed","useState","b64PlayerSaveString","setB64PlayerSaveString","history","setHistory","useEffect","pointNodeGen","isAllocated","canBeAllocated","nodeDescription","resourceType","resourceAmount","resourceModifier","playerResourceAmounts","onClick","btoa","map","slice","pointNodeRef","reverse","One","defaultKeyIntentConfig","w","PAN_NORTH","PAN_WEST","s","PAN_SOUTH","PAN_EAST","ArrowUp","ArrowLeft","ArrowDown","ArrowRight","TRAVEL_OUT","TRAVEL_IN","KeyboardControlComponent","props","handleKeydown","e","configuredIntent","state","keyIntentConfig","NOOP","updaters","newIntent","enqueueUpdate","activeIntent","handleKeyup","endedIntent","document","addEventListener","removeEventListener","React","Component","NodeDetail","memo","NodeDetailComponent","UseGameStateContext","createContext","PixiWrapperComponent","application","windowState","container","useRef","useContext","gameState","gameStateUpdaters","fireBatchedSetGameState","current","childNodes","removeChild","appendChild","app","view","rerender","fireBatch","fireBatchedSetWindowState","isSecondConstructorCall","ref","HashSet","initialValues","_values","HashMap","put","remove","values","n","clone","size","hash","KeyedHashMap","_kvalues","hashCode","pv","cv","h","imul","charCodeAt","PixiPointFrom","Pixi","computePlayerResourceAmounts","amounts","playerResourceNodesAggregated","allocatedPointNodeHistory","resourceTypeAndModifier","Flat","Increased0","AfterIncreased0","Increased1","AfterIncreased1","batchifySetState","batch","arg","thisBatch","prev","next","valueOrCallback","updaterGenerator2Helper","dataObject","dataUpdater","newValueOrCallback","oldData","wholeData","newKey","updaterGenerator2","setState","stateCallbackFunction","ChildrenArray","c","indexOf","instance","removed","splice","findIndex","find","cloned","callbackfn","LifecycleHandlerBase","_staleProps","_children","_childrenToConstruct","_childrenToDestruct","_forceUpdates","markForceUpdate","childInstance","childInfo","child","childClass","propsFactory","addChild","renderSelf","didMount","self","initialState","batchedSetState","fireStateUpdaters","stateUpdaters","nextProps","_update","staleState","updateSelf","shouldUpdate","forceUpdates","didForceUpdateChild","didForceUpdate","updateChildren","_updateChildren","Promise","resolve","didUpdate","willUnmount","engageLifecycle","derived","Proxy","construct","target","_didConstruct","newTarget","Reflect","wrapped","hitAreaDrawn","tooltipContainer","onPointerOver","event","isActive","onPointerOut","interactive","buttonMode","hitArea","zIndex","box","lineStyle","beginFill","drawRoundedRect","destroy","addListener","sprite","halfwayCenterSprite","centerSprite","tooltippableArea","justTriedToAllocate","justSpentSp","justFailedToAllocate","numClicks","sortableChildren","pointNodeTexture","anchor","alpha","RenderedChunkConstants","NODE_HITAREA_PX","tooltippableAreaPropsFactory","TooltippableAreaComponent","tint","centerTint","position","isSelected","baseColor","Mana0","staleProps","playerUI","prevGameState","nextSet","nextHistory","doTryAllocate","spSpentThisQuest","activeQuest","batchesSinceQuestStart","afterMaybeSpendingSp","activeTab","SPACING_PX","CHUNK_SPACING_PX","NODE_SIZE_PX","NODE_ROUNDED_PX","children","resyncChildren","prevProps","prevState","childrenToDelete","chunkGen","entries","selfChunkRef","childPropsFactory","delta","allocatedPointNodeSubset","childKey","childComponent","PointNodeComponent","ZLevelGenFactory","config","chunkGenFactory","ChunkGenFactory","squirrel3","seed","startingChunks","j","location","create","pointNodeGenFactory","PointNodeGenFactory","droppedNodes","INTMAX32","loc","randomFloat","Mana1","Mana2","FpsTracker","frameTimestampsInTicks","frameTimestampsInTime","ticksSinceLastUpdate","lastFrameTime","logRowsToKeep","Date","getTime","ticksDiff","framesPerTick","timeDiff","framesPerMilli","getFps","toFixed","getUps","fontFamily","fontSize","fpsTracker","tick","text","getFpsString","getUpsString","appSize","upsertChildren","zLevelGen","doChild","ChunkComponent","chunkRef","filter","outerCircle","drawCircle","moveTo","lineTo","cornerRadius","boundingBoxWidth","boundingBox","innerBarWidth","innerBarHeight","textHeight","paddingBottom","innerBar","barBorder","barFill","mask","titleText","textStyle","padding","pivot","barFillContainer","drawRect","maskContainer","fixedMask","updateText","efficiencyPercent","fixedCameraStage","actionStage","backdropStage","zLevelPropsFactory","reticle","backdrop","efficiencyBar","renderer","g","generateTexture","NEAREST","generatePointNodeTexture","playerCurrentZ","fpsTrackerPropsFactory","FpsComponent","registerChild","reticlePropsFactory","ReticleComponent","ZLevelComponent","efficiencyBarPropsFactory","EfficiencyBarComponent","intent","deltaX","deltaY","unit","currentZ","width","height","whole","PixiReactBridge","rootComponent","onTick","originalAppSize","antialias","transparent","resolution","window","devicePixelRatio","autoDensity","powerPreference","backgroundColor","ticker","texture","baseTexture","baseGameLoop","bind","curr","Infinity","appSizeFromWindowSize","innerWidth","innerHeight","RootComponent","stage","resize","update","GameStateFactory","mySeed","firstId","0","questsCompleted","score","initialApplication","PixiComponent","orientation","setWindowState","useMemo","batchedSetWindowState","setApplication","onresize","old","newGameState","pause","originalSetGameState","QuestProgressComponent","createQuestCb","numBatches","efficiencyGrade","total","scoreComponents","scoreDetails","setScoreDetails","isQuestComplete","doClaimReward","questScore","inputAmount","inputTitle","outputScore","outputDescription","subtotal","calculateQuestScoreDetails","lastScore","Score","className","classnames","table","viewed","setViewed","scoreComponent","Fragment","Sidebar","TabContent","showContent","hidden","Tabs","labels","onChange","label","Tab","active","browser","UAParser","getBrowser","forceRotate","name","tabLabels","initialGameState","App","setGameState","batchedSetGameState","useCallback","numQuestsCompleted","totalAllocatedNodes","historicalAmountPerNode","targetNumAllocatedNodes","randomScale","description","createQuest","tabViews","remainingPoints","Provider","getUpdater","component","Boolean","hostname","match","ReactDOM","render","StrictMode","getElementById","navigator","serviceWorker","ready","then","registration","unregister","catch","message"],"mappings":"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","file":"static/js/main.cdc4a8d5.chunk.js","sourcesContent":["let lastUsedId = 0;\n\nexport const getUniqueID = () => {\n  return lastUsedId++;\n};\n\nexport class Util {\n  static MinBy<T>(list: T[], fn: (T: T) => number): T | null {\n    let lowestT: T | null = null;\n    let lowestValue: number | null = null;\n\n    for (const item of list) {\n      const value = fn(item);\n\n      if (lowestValue === null || value < lowestValue) {\n        lowestT = item;\n        lowestValue = value;\n      }\n    }\n\n    return lowestT;\n  }\n\n  static MinByAndValue<T>(\n    list: T[],\n    fn: (T: T) => number\n  ): { obj: T; value: number } | null {\n    let lowestT: T | null = null;\n    let lowestValue: number | null = null;\n\n    for (const item of list) {\n      const value = fn(item);\n\n      if (lowestValue === null || value < lowestValue) {\n        lowestT = item;\n        lowestValue = value;\n      }\n    }\n\n    return lowestT === null || lowestValue === null\n      ? null\n      : { obj: lowestT, value: lowestValue };\n  }\n\n  static MaxBy<T>(list: T[], fn: (T: T) => number): T | null {\n    let highestT: T | null = null;\n    let highestValue: number | null = null;\n\n    for (const item of list) {\n      const value = fn(item);\n\n      if (highestValue === null || value > highestValue) {\n        highestT = item;\n        highestValue = value;\n      }\n    }\n\n    return highestT;\n  }\n\n  static RandRange(low: number, high: number): number {\n    return Math.floor(Math.random() * (high - low) + low);\n  }\n\n  public static SortByKey<T>(array: T[], key: (x: T) => number): T[] {\n    return array.sort((a, b) => {\n      return key(a) - key(b);\n    });\n  }\n\n  public static ReplaceAll(\n    str: string,\n    mapObj: { [key: string]: string }\n  ): string {\n    const re = new RegExp(Object.keys(mapObj).join(\"|\"), \"gi\");\n\n    return str.replace(re, (matched) => {\n      return mapObj[matched.toLowerCase()];\n    });\n  }\n\n  public static Debounce<F extends (...args: any[]) => void>(\n    func: F,\n    waitMilliseconds = 50,\n    options = {\n      isImmediate: false,\n    }\n  ): F {\n    let timeoutId: any; // types are different on node vs client, so we have to use any.\n\n    const result = (...args: any[]) => {\n      const doLater = () => {\n        timeoutId = undefined;\n        if (!options.isImmediate) {\n          func.apply(this, args);\n        }\n      };\n\n      const shouldCallNow = options.isImmediate && timeoutId === undefined;\n\n      if (timeoutId !== undefined) {\n        clearTimeout(timeoutId);\n      }\n\n      timeoutId = setTimeout(doLater, waitMilliseconds);\n\n      if (shouldCallNow) {\n        func.apply(this, args);\n      }\n    };\n\n    return result as any;\n  }\n\n  public static FormatDate(d: Date): string {\n    const monthName = [\n      \"Jan\",\n      \"Feb\",\n      \"Mar\",\n      \"Apr\",\n      \"May\",\n      \"Jun\",\n      \"Jul\",\n      \"Aug\",\n      \"Sep\",\n      \"Oct\",\n      \"Nov\",\n      \"Dec\",\n    ][d.getMonth()];\n\n    return `${monthName} ${d.getDate()}, ${(\"00\" + d.getHours()).substr(-2)}:${(\n      \"00\" + d.getMinutes()\n    ).substr(-2)}:${(\"00\" + d.getSeconds()).substr(-2)}`;\n  }\n\n  public static FlattenByOne<T>(arr: T[][]): T[] {\n    let result: T[] = [];\n\n    for (const obj of arr) {\n      result = result.concat(obj);\n    }\n\n    return result;\n  }\n\n  public static PadString(\n    string: string,\n    length: number,\n    intersperse = \"\",\n    character = \" \"\n  ) {\n    return string + intersperse + character.repeat(length - string.length);\n  }\n}\n\n/**\n * A deep readonly type - given an object type, all subobjects and their subobjects are also marked as readonly.\n */\nexport type Const<T> = T extends Function\n  ? T\n  : {\n      readonly [P in keyof T]: T[P] extends { [k: string]: any }\n        ? Const<T[P]>\n        : T[P];\n    };\n\nconst assertOnlyCalledOnceData: { [k: string]: [string, number] } = {};\n\n/**\n * Asserts that a function is not called more than twice. Useful for debugging react lifecycle which may be creating more objects than you realize, impacting performance.\n * @param id identifier\n */\nexport function assertOnlyCalledOnce(id: string | number) {\n  let k = id.toString();\n  if (assertOnlyCalledOnceData[k] !== undefined) {\n    if (assertOnlyCalledOnceData[k][1] === 1) {\n      assertOnlyCalledOnceData[k][1] = 2;\n    } else {\n      throw new Error(\n        \"Error, called more than twice with same id: \" +\n          k +\n          \" , callback the first time was : \" +\n          assertOnlyCalledOnceData[k]\n      );\n    }\n  } else {\n    const stacktrace = new Error().stack!;\n    assertOnlyCalledOnceData[k] = [stacktrace, 1];\n  }\n}\n\n/**\n * Class representing a value which is only computed when used.\n *\n * Usage: const lazy = new Lazy(() => thingThatReturnsSomething()).\n * Then thingThatReturnsSomething() will only get called on the first time lazy.get() is called.\n * On the second and subsequent times, lazy.get() will return the same object - the factory method is not called again.\n */\nexport class Lazy<T> {\n  private _wasConstructed: boolean = false;\n  private _value: T | undefined = undefined;\n  private _factory: () => T;\n\n  constructor(\n    factory: () => T,\n    // structure?: T extends { [key: string]: any } ? T : void\n  ) {\n    this._factory = factory;\n  }\n  public get(): T {\n    // T might have undefined as a valid value\n    if (this._value !== undefined || this._wasConstructed === true) {\n      return this._value!;\n    } else {\n      this._value = this._factory();\n      this._wasConstructed = true;\n      return this._value;\n    }\n  }\n  public wasConstructed(): boolean {\n    return this._wasConstructed;\n  }\n  // public async getAsync(): Promise<T> {\n  //   if (this._value !== undefined || this._wasConstructed === true) {\n  //     return Promise.resolve(this._value!);\n  //   } else {\n  //     return new Promise<T>((resolve, reject) => {\n  //       this._value = this._factory();\n  //       this._wasConstructed = true;\n  //       resolve(this._value);\n  //     });\n  //   }\n  // }\n}\n\nexport function LazyProxy<\n  T extends { [key: string]: any } | { [i: number]: any }\n>(factory: () => T): Const<T> {\n  return (new Proxy(new Lazy(factory), {\n    get: (target, property, receiver) => {\n      if (property === \"toJSON\") {\n        return () => {\n          if (target.wasConstructed()) {\n            return target.get();\n          } else {\n            return \"[Object Lazy]\";\n          }\n        };\n      }\n      const targetValue = target.get();\n      return Reflect.get(targetValue, property);\n    },\n    ownKeys: (target) => {\n      const targetValue = target.get();\n      return Reflect.ownKeys(targetValue);\n    },\n    getOwnPropertyDescriptor: (target, property) => {\n      /**\n       * https://stackoverflow.com/questions/40352613/why-does-object-keys-and-object-getownpropertynames-produce-different-output\n       */\n\n      return Object.getOwnPropertyDescriptor(target.get(), property);\n      \n    },\n    has: (target, property) => {\n      // This is called when iterating over array i.e. array.forEach()\n      return property in target.get()\n    }\n  }) as unknown) as Const<T>;\n}\n\n/**\n * Multiplies colors (0xFFFFFF === 1). use for applying tints manually.\n * @param color1 A base color\n * @param color2 A tint\n */\nexport function multiplyColor(color1: number, color2: number): number {\n  let reds = [color1 & 0xff0000, color2 & 0xff0000];\n  let blues = [color1 & 0x0000ff, color2 & 0x0000ff];\n  let greens = [color1 & 0x00ff00, color2 & 0x00ff00];\n  let out = Math.round(((reds[0] / 0x010000) * reds[1]) / 0xffffff) * 0x010000;\n  out += Math.round(((greens[0] / 0x000100) * greens[1]) / 0x00ff00) * 0x000100;\n  out += Math.round((blues[0] * blues[1]) / 0x0000ff);\n  return out;\n}\n\nexport function enumKeys<T extends string>(enm: { [key in T]: T }): T[] {\n  return Object.keys(enm) as T[];\n}\n\n// export function enumKeys<T extends string>(enm: { [key: string]: string }) : T[] {\n//   return Object.keys(enm) as T[];\n// }\n","import { Vector2 } from \"../lib/util/geometry/vector2\";\n\nexport class PointNodeRef {\n  public z: number;\n  public chunkCoord: Vector2;\n  public pointNodeCoord: Vector2;\n  public pointNodeId: number;\n\n  constructor(args: {\n    z: number;\n    chunkCoord: Vector2;\n    pointNodeCoord: Vector2;\n    pointNodeId: number;\n  }) {\n    this.z = args.z;\n    this.chunkCoord = args.chunkCoord;\n    this.pointNodeCoord = args.pointNodeCoord;\n    this.pointNodeId = args.pointNodeId;\n  }\n\n  public hash(): string {\n    return (\n      this.pointNodeId.toString() +\n      this.z.toString() +\n      this.chunkCoord.toString() +\n      this.pointNodeCoord.toString()\n    );\n  }\n\n  public toString(): string {\n    return this.z + \",\" + this.chunkCoord.toString() + \",\" + this.pointNodeCoord.toString()\n  }\n}\n\nexport class ChunkRef {\n  public z: number;\n  public chunkCoord: Vector2;\n  public chunkId: number;\n\n  constructor(args: { z: number; chunkCoord: Vector2; chunkId: number }) {\n    this.z = args.z;\n    this.chunkCoord = args.chunkCoord;\n    this.chunkId = args.chunkId;\n  }\n\n  public hash(): string {\n    return (\n      this.chunkId.toString() + this.z.toString() + this.chunkCoord.toString()\n    );\n  }\n}\n","import { KeyedHashMap } from \"../lib/util/data_structures/hash\";\nimport { Vector2 } from \"../lib/util/geometry/vector2\";\n\n\nexport type WorldGenState = {\n  seed: number;\n  zLevels: { [z: number]: ZLevelGen };\n};\n\nexport type ZLevelGen = {\n  id: number;\n  chunks: KeyedHashMap<Vector2, ChunkGen>;\n};\n\nexport type ChunkGen = {\n  id: number;\n  pointNodes: KeyedHashMap<Vector2, PointNodeGen>;\n};\n\nexport class ChunkGenConstants {\n  public static CHUNK_DIM = 9; // each chunk is a DIM x DIM grid of nodes, centered on a single node\n  public static CHUNK_HALF_DIM = (ChunkGenConstants.CHUNK_DIM - 1) / 2;\n  public static DROP_NODES_CHANCE = 0.3; // before generating edges, how many of the nodes to throw out\n}\n\nexport type PointNodeGen = {\n  id: number;\n\n  // more data to be generated here - size, color, etc.\n  resourceType: ResourceType;\n  resourceModifier: ResourceModifier;\n  resourceAmount: number;\n};\n\nexport enum ResourceNontrivialType {\n  Mana0 = \"Mana0\",\n  Mana1 = \"Mana1\",\n  Mana2 = \"Mana2\",\n}\n\nexport type ResourceType = \"Nothing\" | ResourceNontrivialType;\n// eslint-disable-next-line\nexport const ResourceType = { Nothing: \"Nothing\", ...ResourceNontrivialType };\n\nexport enum ResourceModifier {\n  Flat = \"Flat\",\n  Increased0 = \"% increased\",\n  AfterIncreased0 = \"added after % increased\",\n  Increased1 = \"% increased multiplier\",\n  AfterIncreased1 = \"added after % increased multiplier\",\n}\n\n","import {\n  HashMap,\n} from \"../lib/util/data_structures/hash\";\nimport { enumKeys } from \"../lib/util/misc\";\nimport { PlayerSaveState } from \"./PlayerSaveState\";\nimport { PointNodeRef} from \"./PointNodeRef\";\nimport { ResourceModifier, ResourceNontrivialType, ResourceType, WorldGenState } from \"./WorldGenState\";\n\nexport { PointNodeRef, ChunkRef } from \"./PointNodeRef\";\nexport type { PlayerSaveState, Quest } from \"./PlayerSaveState\";\nexport type { WorldGenState, ChunkGen, ZLevelGen,PointNodeGen,   } from \"./WorldGenState\";\nexport { ChunkGenConstants, ResourceModifier, ResourceNontrivialType, ResourceType } from \"./WorldGenState\";\n\n/**\n * Data owned by the master \"App\" component, to be made available as props to ALL subcomponents (both pixi and react); react uses context providers to make this easier\n * 1. world generation data, stuff that was computed off of the random seed and is stored so we can do logic off of it,\n *   but can be deleted/recomputed any time.\n *   May or may not be persisted to disk - unimportant apart from the random seed.\n * 2. data about player activity in the game e.g. which nodes were allocated, what quest stage they are on\n *   Must be persisted to disk - this is essentially the player's \"save file\"\n * 3. data about player activity that only influences the UI, e.g. which node was selected, but affects UI across\n *   very far away pixi/react components.\n *   Should be persisted to disk - will help the player \"remember their place\" in the game, but not a big deal if lost.\n * 4. data about the window display - should never be persisted to disk.\n * 5. data that is computed from other data - no need to persist to disk.\n *\n * Does NOT include UI data which is only relevant to a small part of the component hierarchy - e.g. how many seconds since last tap.\n * That data should belong in state owned by subcomponents.\n */\nexport type GameState = {\n  worldGen: WorldGenState;\n  playerSave: PlayerSaveState;\n  playerUI: PlayerUIState;\n  computed: ComputedState;\n  intent: PlayerIntentState;\n};\n\n/**\n * Player intents == what they want to do when they press certain mouse/keyboard keys. This is decoupled\n * from their actual keyboard keys to make remapping easier.\n */\nexport type PlayerIntentState = {\n  activeIntent: Intent;\n  newIntent: Intent;\n  endedIntent: Intent;\n};\n\nexport type Intent = {\n  [name in IntentName]: boolean;\n};\n\nexport enum IntentName {\n  // Default intent - does nothing\n  NOOP = \"NOOP\",\n\n  PAN_NORTH = \"PAN_NORTH\",\n  PAN_SOUTH = \"PAN_SOUTH\",\n  PAN_WEST = \"PAN_WEST\",\n  PAN_EAST = \"PAN_EAST\",\n  TRAVEL_IN = \"TRAVEL_IN\",\n  TRAVEL_OUT = \"TRAVEL_OUT\",\n}\n\nexport const noIntent = enumKeys(IntentName).reduce((object: Intent, key) => {\n  object[key] = false;\n  return object;\n}, {} as Intent);\n\n/**\n * current window settings -- allows for dynamic resizing and also rotation on mobile web\n */\nexport type WindowState = {\n  orientation: \"original\" | \"rotated\"; // rotated === we are forcing landscape-in-portrait\n  innerWidth: number;\n  innerHeight: number;\n};\n\nexport type ComputedState = {\n  playerResourceAmounts?: { [k in ResourceType]: number };\n  playerResourceNodesAggregated?: HashMap<ResourceTypeAndModifier, number>;\n};\n\nexport class ResourceTypeAndModifier {\n  public type: ResourceNontrivialType;\n  public modifier: ResourceModifier;\n\n  constructor(args: {\n    type: ResourceNontrivialType;\n    modifier: ResourceModifier;\n  }) {\n    this.type = args.type;\n    this.modifier = args.modifier;\n  }\n\n  public hash(): string {\n    return this.type.toString() + \",\" + this.modifier.toString();\n  }\n}\n\nexport type PlayerUIState = {\n  selectedPointNode: PointNodeRef | undefined;\n  activeTab: number;\n};","import { HashSet } from \"../lib/util/data_structures/hash\";\nimport { enumKeys } from \"../lib/util/misc\";\nimport { ChunkGenConstants, PointNodeRef, WorldGenState } from \"../data/GameState\";\nimport { Vector2 } from \"../lib/util/geometry/vector2\";\n\nenum Direction {\n  NORTH = 'NORTH',\n  SOUTH = 'SOUTH',\n  EAST = 'EAST',\n  WEST = 'WEST',\n  UP = 'UP',\n  DOWN = 'DOWN',\n}\n\ntype NeighborsMap = { [k in Direction]?: PointNodeRef | undefined }\n\nexport function getNeighbors(selfPointNodeRef: PointNodeRef, worldGen: WorldGenState): PointNodeRef[] {\n  let neighborsMap = getNeighborsMap(selfPointNodeRef, worldGen);\n  let neighbors : PointNodeRef[] = []\n  for (let direction of enumKeys(Direction)) {\n    let it = neighborsMap[direction];\n    if (it) {\n      neighbors.push(it);\n    }\n  }\n  return neighbors;\n}\n\n// TODO(bowei): support vertical neighbors\nexport function getNeighborsMap(selfPointNodeRef: PointNodeRef, worldGen: WorldGenState): NeighborsMap {\n  let neighbors: NeighborsMap = {}\n\n  let zLevel = worldGen.zLevels[selfPointNodeRef.z]!\n  let myChunk = zLevel.chunks.get(selfPointNodeRef.chunkCoord)!;\n  // first, the right neighbor:\n  if (selfPointNodeRef.pointNodeCoord.x === ChunkGenConstants.CHUNK_HALF_DIM) {\n    let chunkCoord = selfPointNodeRef.chunkCoord.addX(1)\n    let chunk = zLevel.chunks.get(chunkCoord);\n    if (chunk) {\n      let pointNodeCoord = selfPointNodeRef.pointNodeCoord.withX(-ChunkGenConstants.CHUNK_HALF_DIM)\n      let nbor = chunk.pointNodes.get(pointNodeCoord);\n      if (nbor) {\n        neighbors.EAST = new PointNodeRef({\n          z: selfPointNodeRef.z,\n          chunkCoord,\n          pointNodeCoord,\n          pointNodeId: nbor.id\n        })\n      }\n    }\n  } else {\n    let pointNodeCoord = selfPointNodeRef.pointNodeCoord.addX(1);\n    let nbor = myChunk.pointNodes.get(pointNodeCoord);\n    if (nbor) {\n      neighbors.EAST = new PointNodeRef({\n        z: selfPointNodeRef.z,\n        chunkCoord: selfPointNodeRef.chunkCoord,\n        pointNodeCoord,\n        pointNodeId: nbor.id\n      })\n    }\n  }\n  // left neighbor\n  if (selfPointNodeRef.pointNodeCoord.x === -ChunkGenConstants.CHUNK_HALF_DIM) {\n    let chunkCoord = selfPointNodeRef.chunkCoord.addX(-1)\n    let chunk = zLevel.chunks.get(chunkCoord);\n    if (chunk) {\n      let pointNodeCoord = selfPointNodeRef.pointNodeCoord.withX(ChunkGenConstants.CHUNK_HALF_DIM)\n      let nbor = chunk.pointNodes.get(pointNodeCoord);\n      if (nbor) {\n        neighbors.WEST = new PointNodeRef({\n          z: selfPointNodeRef.z,\n          chunkCoord,\n          pointNodeCoord,\n          pointNodeId: nbor.id\n        })\n      }\n    }\n  } else {\n    let pointNodeCoord = selfPointNodeRef.pointNodeCoord.addX(-1);\n    let nbor = myChunk.pointNodes.get(pointNodeCoord);\n    if (nbor) {\n      neighbors.WEST = new PointNodeRef({\n        z: selfPointNodeRef.z,\n        chunkCoord: selfPointNodeRef.chunkCoord,\n        pointNodeCoord,\n        pointNodeId: nbor.id\n      })\n    }\n  }\n  // +y is down\n  if (selfPointNodeRef.pointNodeCoord.y === ChunkGenConstants.CHUNK_HALF_DIM) {\n    let chunkCoord = selfPointNodeRef.chunkCoord.addY(1)\n    let chunk = zLevel.chunks.get(chunkCoord);\n    if (chunk) {\n      let pointNodeCoord = selfPointNodeRef.pointNodeCoord.withY(-ChunkGenConstants.CHUNK_HALF_DIM)\n      let nbor = chunk.pointNodes.get(pointNodeCoord);\n      if (nbor) {\n        neighbors.SOUTH = new PointNodeRef({\n          z: selfPointNodeRef.z,\n          chunkCoord,\n          pointNodeCoord,\n          pointNodeId: nbor.id\n        })\n      }\n    }\n  } else {\n    let pointNodeCoord = selfPointNodeRef.pointNodeCoord.addY(1);\n    let nbor = myChunk.pointNodes.get(pointNodeCoord);\n    if (nbor) {\n      neighbors.SOUTH = new PointNodeRef({\n        z: selfPointNodeRef.z,\n        chunkCoord: selfPointNodeRef.chunkCoord,\n        pointNodeCoord,\n        pointNodeId: nbor.id\n      })\n    }\n  }\n  // -y is up\n  if (selfPointNodeRef.pointNodeCoord.y === -ChunkGenConstants.CHUNK_HALF_DIM) {\n    let chunkCoord = selfPointNodeRef.chunkCoord.addY(-1)\n    let chunk = zLevel.chunks.get(chunkCoord);\n    if (chunk) {\n      let pointNodeCoord = selfPointNodeRef.pointNodeCoord.withY(ChunkGenConstants.CHUNK_HALF_DIM)\n      let nbor = chunk.pointNodes.get(pointNodeCoord);\n      if (nbor) {\n        neighbors.NORTH = new PointNodeRef({\n          z: selfPointNodeRef.z,\n          chunkCoord,\n          pointNodeCoord,\n          pointNodeId: nbor.id\n        })\n      }\n    }\n  } else {\n    let pointNodeCoord = selfPointNodeRef.pointNodeCoord.addY(-1);\n    let nbor = myChunk.pointNodes.get(pointNodeCoord);\n    if (nbor) {\n      neighbors.NORTH = new PointNodeRef({\n        z: selfPointNodeRef.z,\n        chunkCoord: selfPointNodeRef.chunkCoord,\n        pointNodeCoord,\n        pointNodeId: nbor.id\n      })\n    }\n  }\n  \n  // progress zlevels\n  // up is only available if we are the center of our chunk\n  if (selfPointNodeRef.pointNodeCoord.equals(Vector2.Zero)) {\n    let upZLevel = worldGen.zLevels[selfPointNodeRef.z + 1];\n    if (upZLevel) {\n      // use our chunkcoord and divide by CHUNK_DIM \n      let chunkCoord = selfPointNodeRef.chunkCoord;\n      let upChunkCoordX = Math.round(chunkCoord.x / ChunkGenConstants.CHUNK_DIM)\n      let upNodeX = chunkCoord.x - ChunkGenConstants.CHUNK_DIM * upChunkCoordX // should be between - CHUNK_HALF_DIM and CHUNK_HALF_DIM\n      let upChunkCoordY = Math.round(chunkCoord.y / ChunkGenConstants.CHUNK_DIM)\n      let upNodeY = chunkCoord.y - ChunkGenConstants.CHUNK_DIM * upChunkCoordX // should be between - CHUNK_HALF_DIM and CHUNK_HALF_DIM\n      let upChunkCoord = new Vector2(upChunkCoordX, upChunkCoordY);\n      let upChunk = upZLevel.chunks.get(upChunkCoord);\n      if (upChunk) {\n        let upNode = new Vector2(upNodeX, upNodeY);\n        let nbor = upChunk.pointNodes.get(upNode)\n        if (nbor) {\n          neighbors.UP = new PointNodeRef({\n            z: selfPointNodeRef.z + 1,\n            chunkCoord: upChunkCoord,\n            pointNodeCoord: upNode,\n            pointNodeId: nbor.id\n          });\n        }\n      }\n    }\n  }\n  // down\n  let downZLevel = worldGen.zLevels[selfPointNodeRef.z - 1];\n  if (downZLevel) {\n    let chunkCoord = selfPointNodeRef.chunkCoord.multiply(9).add(selfPointNodeRef.pointNodeCoord);\n    let downChunk = downZLevel.chunks.get(chunkCoord);\n    if (downChunk) {\n      let nbor = downChunk.pointNodes.get(Vector2.Zero);\n      if (nbor) {\n        neighbors.DOWN = new PointNodeRef({\n          z: selfPointNodeRef.z - 1,\n          chunkCoord,\n          pointNodeCoord: Vector2.Zero,\n          pointNodeId: nbor.id\n        });\n      }\n    }\n  }\n\n  return neighbors;\n}\n\nexport function canAllocate(\n  selfPointNodeRef: PointNodeRef,\n  worldGen: WorldGenState,\n  allocatedPointNodeSet: HashSet<PointNodeRef>,\n  availableSp: number\n): \"yes\" | \"already allocated\" | \"not enough sp\" | \"not connected\" {\n  if (allocatedPointNodeSet.contains(selfPointNodeRef)) {\n    return \"already allocated\";\n  }\n  if (availableSp < 1) {\n    return \"not enough sp\";\n  }\n  // check if any of our neighbors are allocated\n  const neighbors = getNeighbors(selfPointNodeRef, worldGen);\n  \n  for (let nbor of neighbors) {\n    if (allocatedPointNodeSet.contains(nbor)) {\n      return \"yes\";\n    }\n  }\n\n  return \"not connected\";\n}","export const EPSILON = 0.0000001;\n\nexport const epsEqual = (x: number, y: number) => {\n  return Math.abs(x - y) < EPSILON;\n}\n\nexport const epsGreaterThan = (x: number, y: number) => {\n  return (x + EPSILON - y) > 0;\n}\n\nexport const epsLessThan = (x: number, y: number) => {\n  return (x - EPSILON - y) < 0;\n}","import { EPSILON } from \"../epsilon_math\";\nimport { Util } from \"../misc\";\n\nexport interface IVector2 {\n  x: number;\n  y: number;\n}\n\nexport class Vector2 {\n  private _x: number;\n  private _y: number;\n\n  public get x(): number { return this._x; }\n  public get y(): number { return this._y; }\n\n  constructor();\n  constructor(x: number, y: number);\n  constructor(props: { x: number, y: number });\n  constructor(propsOrX: { x: number, y: number } | number = { x: 0, y: 0 }, y?: number) {\n    if (typeof propsOrX === \"number\") {\n      this._x = propsOrX;\n      this._y = y!;\n    } else {\n      this._x = propsOrX.x;\n      this._y = propsOrX.y;\n    }\n  }\n\n  public get half(): Vector2 {\n    return new Vector2({ x: this.x / 2, y: this.y / 2 });\n  }\n\n  public static Zero: Vector2 = new Vector2(0, 0);\n  public static One: Vector2 = new Vector2(1, 1);\n\n  static IsVector2(x: any): x is Vector2 {\n    return x instanceof Vector2;\n  }\n\n  static Random(highX: number, highY: number, lowX = 0, lowY = 0) {\n    return new Vector2({\n      x: Util.RandRange(lowX, highX),\n      y: Util.RandRange(lowY, highY),\n    });\n  }\n\n  hash(): string {\n    return this.toString();\n  }\n\n  toString(): string {\n    return `[${this.x}, ${this.y}]`;\n  }\n\n  invert(): Vector2 {\n    return new Vector2({\n      x: -this.x,\n      y: -this.y,\n    });\n  }\n\n  round(): Vector2 {\n    return new Vector2({\n      x: Math.round(this.x),\n      y: Math.round(this.y),\n    });\n  }\n\n  floor(): Vector2 {\n    return new Vector2({\n      x: Math.floor(this.x),\n      y: Math.floor(this.y),\n    });\n  }\n\n  taxicabDistance(p: Vector2): number {\n    return Math.abs(p.x - this.x) + Math.abs(p.y - this.y);\n  }\n\n  diagonalDistance(p: IVector2): number {\n    return Math.max(Math.abs(p.x - this.x), Math.abs(p.y - this.y));\n  }\n\n  distance(p: IVector2): number {\n    let dx = Math.abs(p.x - this.x);\n    let dy = Math.abs(p.y - this.y);\n\n    return Math.sqrt(dx * dx + dy * dy);\n  }\n\n  translate(p: { x: number, y: number }): Vector2 {\n    return new Vector2({\n      x: this.x + p.x,\n      y: this.y + p.y,\n    });\n  }\n\n  subtract(p: { x: number, y: number }): Vector2 {\n    return new Vector2({\n      x: this.x - p.x,\n      y: this.y - p.y,\n    });\n  }\n\n  add(p: { x: number, y: number }): Vector2 {\n    return new Vector2({\n      x: this.x + p.x,\n      y: this.y + p.y,\n    });\n  }\n\n  addX(x: number): Vector2 {\n    return new Vector2({\n      x: this.x + x,\n      y: this.y,\n    });\n  }\n\n  addY(y: number): Vector2 {\n    return new Vector2({\n      x: this.x,\n      y: this.y + y,\n    });\n  }\n\n  subtractX(x: number): Vector2 {\n    return new Vector2({\n      x: this.x - x,\n      y: this.y,\n    });\n  }\n\n  subtractY(y: number): Vector2 {\n    return new Vector2({\n      x: this.x,\n      y: this.y - y,\n    });\n  }\n\n  clampY(low: number, high: number): Vector2 {\n    let newY = this.y;\n\n    if (newY < low) { newY = low; }\n    if (newY > high) { newY = high; }\n\n    return new Vector2({\n      x: this.x,\n      y: newY,\n    });\n  }\n\n  scale(about: { x: number; y: number }, amount: { x: number; y: number }): Vector2 {\n    return new Vector2({\n      x: (this.x - about.x) * amount.x + about.x,\n      y: (this.y - about.y) * amount.y + about.y,\n    });\n  }\n\n  rotate(origin: Vector2, angle: number): Vector2 {\n    angle = angle / (180 / Math.PI);\n\n    return new Vector2({\n      x: Math.cos(angle) * (this.x - origin.x) - Math.sin(angle) * (this.y - origin.y) + origin.x,\n      y: Math.sin(angle) * (this.x - origin.x) + Math.cos(angle) * (this.y - origin.y) + origin.y,\n    });\n  }\n\n  equals(other: Vector2 | undefined): boolean {\n    if (other === undefined) {\n      return false;\n    }\n\n    return (\n      Math.abs(this.x - other.x) < EPSILON &&\n      Math.abs(this.y - other.y) < EPSILON\n    );\n  }\n\n  multiply(other: Vector2 | number): Vector2 {\n    if (typeof other === \"number\") {\n      return new Vector2({\n        x: this.x * other,\n        y: this.y * other,\n      });\n    } else {\n      return new Vector2({\n        x: this.x * other.x,\n        y: this.y * other.y,\n      });\n    }\n  }\n\n  divide(other: Vector2 | number): Vector2 {\n    if (typeof other === \"number\") {\n      return new Vector2({\n        x: this.x / other,\n        y: this.y / other,\n      });\n    } else {\n      return new Vector2({\n        x: this.x / other.x,\n        y: this.y / other.y,\n      });\n    }\n  }\n\n  toJSON(): any {\n    return {\n      __type: \"Vector2\",\n      x: this.x,\n      y: this.y,\n    }\n  }\n\n  transform(trans: Vector2, scale: number): Vector2 {\n    return new Vector2({\n      x: Math.floor((this.x - trans.x) * scale),\n      y: Math.floor((this.y - trans.y) * scale),\n    });\n  }\n\n  normalize(): Vector2 {\n    if (this.x === 0 && this.y === 0) {\n      return this;\n    }\n\n    const length = Math.sqrt(this.x * this.x + this.y * this.y);\n\n    return new Vector2({\n      x: this.x / length,\n      y: this.y / length\n    });\n  }\n\n  withX(newX: number): Vector2 {\n    return new Vector2({\n      x: newX,\n      y: this.y,\n    });\n  }\n\n  withY(newY: number): Vector2 {\n    return new Vector2({\n      x: this.x,\n      y: newY,\n    });\n  }\n\n  invertX(): Vector2 {\n    return new Vector2({\n      x: -this.x,\n      y: this.y,\n    });\n  }\n\n  lerp(other: Vector2, t: number): Vector2 {\n    if (t > 1 || t < 0) { console.error(\"Lerp t must be between 0 and 1.\"); }\n    if (t === 0) return this;\n    if (t === 1) return other;\n\n    return this.scale({ x: 0, y: 0 }, { x: 1 - t, y: 1 - t }).add(other.scale({ x: 0, y: 0 }, { x: t, y: t }))\n  }\n\n  lerp2D(other: Vector2, tx: number, ty: number): Vector2 {\n    if (tx > 1 || tx < 0 || ty > 1 || ty < 0) { console.error(\"Lerp t must be between 0 and 1.\"); }\n    return this.scale({ x: 0, y: 0 }, { x: 1 - tx, y: 1 - ty }).add(other.scale({ x: 0, y: 0 }, { x: tx, y: ty }))\n  }\n\n  coserp(other: Vector2, t: number): Vector2 {\n    t = 0.5 * (1 + Math.cos(2 * t * Math.PI));\n\n    return this.lerp(other, t);\n  }\n\n  static Deserialize(obj: any): Vector2 {\n    if (!obj.hasOwnProperty(\"x\") || !obj.hasOwnProperty(\"y\")) {\n      console.error(\"Failed deserializing point\");\n    }\n\n    return new Vector2({\n      x: obj.x,\n      y: obj.y,\n    });\n  }\n\n  static Serialize(obj: Vector2): string {\n    return JSON.stringify({ x: obj.x, y: obj.y });\n  }\n}","import { PlayerSaveState } from \"../data/GameState\";\nimport { Const } from \"../lib/util/misc\";\n\n\nexport function computeQuestEfficiencyPercent(playerSave: Const<PlayerSaveState>): number {\n  if (playerSave.questProgressHistory.length === 0) {\n    return 100;\n  }\n  let noEffectNodeCount = 0;\n  playerSave.questProgressHistory.forEach((num, i, arr) => {\n    let prev = (i === 0) ? playerSave.questInitialAmount : arr[i - 1];\n    if (num === prev) {\n      noEffectNodeCount += 1;\n    }\n  });\n  // guaranteed to be between 0 and 100\n  // let noEffectNodePercent = 100 * noEffectNodeCount / (playerSave.questProgressHistory.length); \n  // add a 2-node buffer so efficiency doesnt drop to 0 at the very beginning of a quest\n  const noEffectNodeBufferCount = 0.5;\n  let noEffectNodePercent = 100 * (noEffectNodeCount) / (playerSave.questProgressHistory.length + noEffectNodeBufferCount); \n  console.log({ noEffectNodeCount, noEffectNodePercent });\n\n  // the baseline we expect effect node percent to be -- influenced by world gen\n  // let hasEffectNodePercentBaseline = 100;\n  // let hasEffectNodeEfficiencyRaw = Math.min((100 - noEffectNodePercent) / hasEffectNodePercentBaseline * 100, 100);\n\n  return (100 - noEffectNodePercent);\n}\n\nexport function remapQuestEfficiencyToDisplayable(percent: number): number {\n  // remaps the 0-100 percent scale to something that looks better\n  // let's try: 5-110, but also 50 -> 80\n  let x = percent / 100;\n  x = 1 - Math.pow((1 - x), 3);\n  x = x * 1.05 + 0.05;\n  x = Math.max(0, Math.min(x * 100, 100));\n  return x;\n}\n\nexport function remapQuestEfficiencyToGrade(percent: number): string {\n  const displayable = remapQuestEfficiencyToDisplayable(percent);\n  // 0 - 100, remap to grades D, C, B, A, S\n  if (displayable <= 20) {\n    return \"D\";\n  } else if (displayable <= 40) {\n    return \"C\";\n  } else if (displayable <= 60) {\n    return \"B\";\n  } else if (displayable <= 80) {\n    return \"A\";\n  } else {\n    return \"S\";\n  }\n}","import React, { useEffect, useState } from \"react\";\nimport { ComputedState, PlayerSaveState, PointNodeRef, ResourceType, WorldGenState } from \"../data/GameState\";\nimport { HashSet } from \"../lib/util/data_structures/hash\";\nimport { canAllocate } from \"../game/Neighbors\";\nimport { computeQuestEfficiencyPercent } from \"../game/EfficiencyCalculator\";\n\ntype Props = {\n  selectedPointNode?: PointNodeRef\n  allocatedPointNodeSet: HashSet<PointNodeRef>,\n  worldGen: WorldGenState,\n  availableSp: number,\n  playerSave: PlayerSaveState,\n  computed: ComputedState\n}\n\nexport function DebugTab({\n  selectedPointNode,\n  playerSave,\n  worldGen,\n  computed\n}: Props) {\n  const { allocatedPointNodeSet, availableSp } = playerSave;\n\n  let [b64PlayerSaveString, setB64PlayerSaveString] = useState<string>('');\n  const [history, setHistory] = useState<PointNodeRef[]>([]);\n  useEffect(() => {\n    if (!selectedPointNode) return;\n    setHistory((history) => [...history, selectedPointNode]);\n  }, [selectedPointNode]);\n\n  if (!selectedPointNode) {\n    return (<> </>)\n  }\n  const pointNodeGen = worldGen.zLevels[selectedPointNode.z]!.chunks.get(selectedPointNode.chunkCoord)!.pointNodes.get(selectedPointNode.pointNodeCoord)!\n  const isAllocated = (allocatedPointNodeSet.contains(selectedPointNode));\n  const canBeAllocated: string = canAllocate(selectedPointNode, worldGen, allocatedPointNodeSet, availableSp);\n  let nodeDescription: string = \"Nothing (empty node)\";\n  if (pointNodeGen.resourceType !== ResourceType.Nothing) {\n    nodeDescription = `${pointNodeGen.resourceAmount} ${pointNodeGen.resourceModifier} ${pointNodeGen.resourceType}`\n  }\n  return (\n    <>\n      <h3>Player resources</h3> \n      {JSON.stringify(computed.playerResourceAmounts)}\n      <h3>Export to string</h3>\n      <div>\n      <button onClick={() => {\n        // window.alert(btoa(JSON.stringify(playerSave)));\n        setB64PlayerSaveString(btoa(JSON.stringify(playerSave, undefined, 2)));\n      }}>\n        export to base64 {' '}\n      </button></div>\n      <div>{b64PlayerSaveString}</div>\n      <h3>Current Node</h3>\n      <div>\n        Z={selectedPointNode.z}\n      </div>\n      <div>\n        Chunk={selectedPointNode.chunkCoord.x},{selectedPointNode.chunkCoord.y}\n      </div>\n      <div>\n        Node={selectedPointNode.pointNodeCoord.x},{selectedPointNode.pointNodeCoord.y}\n      </div>\n      <br></br>\n      <div>Allocated? <br />{isAllocated ? \"yes\" : \"no\"} </div>\n      <br></br>\n      <div>Can be allocated? <br />{canBeAllocated} </div>\n      <br></br>\n      <div> Stats: </div>\n      <div> {nodeDescription} </div>\n      <h3>efficiency percent</h3>\n      {\n        computeQuestEfficiencyPercent(playerSave)\n      }\n      <h3>Quest progress history</h3>\n      {\n        playerSave.questProgressHistory.length === 0 ? (<> empty </>) : \n        playerSave.questProgressHistory.map((num, i) => {\n          return (\n            <div key={i}>\n              i={i}, quest progress={num}\n            </div>\n          )\n        })\n      }\n      <h3>Previous</h3>\n      {history\n        .slice(0, -1)\n        .map((pointNodeRef: PointNodeRef, i) => {\n          return (\n            <div key={i}>\n              <div>\n                Z={pointNodeRef.z} { }\n                Chunk={pointNodeRef.chunkCoord.x},{pointNodeRef.chunkCoord.y} { }\n                Node={pointNodeRef.pointNodeCoord.x},{pointNodeRef.pointNodeCoord.y}\n              </div>\n            </div>\n          );\n        })\n        .reverse()}\n    </>\n  );\n}\n\n","import React from \"react\";\nimport { GameState, IntentName, PlayerIntentState } from \"../data/GameState\";\nimport { UpdaterGeneratorType2 } from \"../lib/util/updaterGenerator\";\n\ntype Props = {\n  updaters: UpdaterGeneratorType2<PlayerIntentState, GameState>;\n  intent: PlayerIntentState;\n};\n\ntype State = {\n  keyIntentConfig: keyToIntentMap;\n};\n\n// TODO: enumerate all the keyboard keys we care about\ntype BrowserKeys = string;\n\n/**\n * Holds the mapping of which keyboard keys (as interpreted by the browser)\n * map to which intents, e.g. \"up arrow\" means \"pan left\"\n */\ntype keyToIntentMap = {\n  [key in BrowserKeys]?: IntentName;\n};\n\nconst defaultKeyIntentConfig = {\n  w: IntentName.PAN_NORTH,\n  a: IntentName.PAN_WEST,\n  s: IntentName.PAN_SOUTH,\n  d: IntentName.PAN_EAST,\n  ArrowUp: IntentName.PAN_NORTH,\n  ArrowLeft: IntentName.PAN_WEST,\n  ArrowDown: IntentName.PAN_SOUTH,\n  ArrowRight: IntentName.PAN_EAST,\n  \"<\": IntentName.TRAVEL_OUT,\n  \">\": IntentName.TRAVEL_IN,\n};\n\nexport class KeyboardControlComponent extends React.Component<Props, State> {\n  constructor(props: Props) {\n    super(props);\n    this.state = {\n      keyIntentConfig: defaultKeyIntentConfig,\n    };\n    document.addEventListener(\"keydown\", this.handleKeydown);\n    document.addEventListener(\"keyup\", this.handleKeyup);\n  }\n\n  // NOTE(bowei): does using e.repeat here break when window loses focus??\n  handleKeydown = (e: KeyboardEvent) => {\n    const { keyIntentConfig } = this.state;\n    const key: BrowserKeys = e.key;\n    const configuredIntent = keyIntentConfig[key];\n    if (\n      e.repeat === false &&\n      configuredIntent !== undefined &&\n      configuredIntent !== IntentName.NOOP\n    ) {\n      this.props.updaters.newIntent[configuredIntent].enqueueUpdate(() => {\n        this.props.updaters.newIntent[configuredIntent].enqueueUpdate(\n          () => false\n        );\n        return true;\n      });\n      this.props.updaters.activeIntent[configuredIntent].enqueueUpdate(\n        () => true\n      );\n    }\n  };\n\n  handleKeyup = (e: KeyboardEvent) => {\n    const { keyIntentConfig } = this.state;\n    const key: BrowserKeys = e.key;\n    const configuredIntent = keyIntentConfig[key];\n    if (\n      configuredIntent !== undefined &&\n      configuredIntent !== IntentName.NOOP\n    ) {\n      this.props.updaters.activeIntent[configuredIntent].enqueueUpdate(\n        () => false\n      );\n      this.props.updaters.endedIntent[configuredIntent].enqueueUpdate(() => {\n        this.props.updaters.endedIntent[configuredIntent].enqueueUpdate(\n          () => false\n        );\n        return true;\n      });\n    }\n  };\n  componentWillUnmount() {\n    document.removeEventListener(\"keydown\", this.handleKeydown);\n    document.removeEventListener(\"keyup\", this.handleKeyup);\n  }\n  render() {\n    return \"hi\";\n  }\n}\n","import React from \"react\";\nimport { PointNodeRef, ResourceType, WorldGenState } from \"../data/GameState\";\nimport { canAllocate } from \"../game/Neighbors\";\nimport { HashSet } from \"../lib/util/data_structures/hash\";\n\ntype Props = {\n  selectedPointNode?: PointNodeRef;\n  allocatedPointNodeSet: HashSet<PointNodeRef>;\n  worldGen: WorldGenState;\n  availableSp: number;\n};\nexport const NodeDetail = React.memo(NodeDetailComponent);\nfunction NodeDetailComponent({\n  selectedPointNode,\n  allocatedPointNodeSet,\n  worldGen,\n  availableSp,\n}: Props) {\n  if (!selectedPointNode) {\n    return (\n      <>\n        <h1>Stats</h1>\n        <div>Select a node first!</div>\n      </>\n    );\n  }\n  const pointNodeGen = worldGen.zLevels[selectedPointNode.z]!.chunks.get(\n    selectedPointNode.chunkCoord\n  )!.pointNodes.get(selectedPointNode.pointNodeCoord)!;\n  const isAllocated = allocatedPointNodeSet.contains(selectedPointNode);\n  const canBeAllocated: string = canAllocate(\n    selectedPointNode,\n    worldGen,\n    allocatedPointNodeSet,\n    availableSp\n  );\n  let nodeDescription: string = \"Nothing (empty node)\";\n  if (pointNodeGen.resourceType !== ResourceType.Nothing) {\n    nodeDescription = `${pointNodeGen.resourceAmount} ${pointNodeGen.resourceModifier} ${pointNodeGen.resourceType}`;\n  }\n  return (\n    <>\n      <h1>Stats</h1>\n      <div> {nodeDescription} </div>\n      <h3>Allocated?</h3>\n      {isAllocated ? \"yes\" : \"no\"}\n      <h3>Can be allocated?</h3>\n      {canBeAllocated}\n    </>\n  );\n}\n","import React from \"react\";\nimport { GameState } from \"./data/GameState\";\nimport { Const } from \"./lib/util/misc\";\nimport { UpdaterGeneratorType2 } from \"./lib/util/updaterGenerator\";\n\n// nullable, but should be OK, just remember to populate the context\n// export const GameContext = React.createContext<GameState>(null as any);\n// export const GameUpdatersContext = React.createContext<UpdaterGeneratorType<GameState>>(null as any);\nexport const UseGameStateContext = React.createContext<[Const<GameState>, UpdaterGeneratorType2<GameState>, () => void]>([] as any);","import React, { useContext, useEffect, useRef } from \"react\";\nimport { UseGameStateContext } from \"../contexts\";\nimport { PixiReactBridge } from \"../pixi/PixiReactBridge\";\nimport { WindowState } from \"../data/GameState\";\n\nexport function PixiWrapperComponent(props: {\n  application: PixiReactBridge,\n  windowState: WindowState,\n  fireBatchedSetWindowState: () => void,\n}) {\n  const { application, windowState } = props;\n  const container = useRef<HTMLDivElement>(null);\n  const [gameState, gameStateUpdaters, fireBatchedSetGameState]  = useContext(UseGameStateContext);\n  const fireBatch = () => {\n      fireBatchedSetGameState();\n      props.fireBatchedSetWindowState();\n    }\n\n  useEffect(() => {\n    // this block only triggers if a new application instance is created.\n    // first remove old application\n    // const oldLength = container.current!.childNodes.length;\n    for (let i = container.current!.childNodes.length - 1; i >= 0; i--) {\n      container.current!.removeChild(container.current!.childNodes[i]);\n    }\n    // if (oldLength != 0) {\n    //   return;\n    // }\n    // add the application\n    container.current!.appendChild(application.app.view);\n  }, [application]);\n\n  // const prevRef = useRef<Const<GameState>>();\n  // useEffect(() => {\n  //   prevRef.current = gameState;\n  // });\n  // const prevGameState = prevRef.current;\n\n  // Trigger component render on first load and also when game state is updated\n  application.rerender({\n    args: {\n      fireBatch, \n      isSecondConstructorCall: false,\n    },\n    updaters: gameStateUpdaters,\n    windowState,\n    gameState,\n  })\n\n  return (\n    <>\n      <div ref={container} />\n    </>\n  );\n}","/**\n * Intended as a typescript-friendly replacement for {[k: string]: boolean} that allows us to specify what the key type should be (\n * rather than allowing any keyType.toString() to be a valid key, and without going through the trouble of declaring distinguishable\n * types for each key type we want to use). Also serves as a slightly different version of ES6 native Set(), which is hardcoded\n * to use === for object referential equality.\n * \n * NOTE: this assume hash() is a strong test for equality, i.e. 2 objects are considered equal if and only if their hashes are the same!!!\n * TODO: write StrictHashSet<K extends {hash(): string, equals(k: K): boolean}> to handle custom equality checks\n */\nexport class HashSet<K extends { hash(): string }> {\n  private _values: HashMap<K, K>;\n\n  constructor(initialValues: K[] = []) {\n    this._values = new HashMap<K, K>();\n\n    for (const value of initialValues) {\n      this.put(value);\n    }\n  }\n\n  remove(key: K): void {\n    this._values.remove(key);\n  }\n\n  put(key: K): void {\n    this._values.put(key, key);\n  }\n\n  get(key: K): boolean {\n    return this._values.get(key) !== undefined;\n  }\n\n  contains(key: K): boolean {\n    return this._values.contains(key);\n  }\n\n  values(): K[] {\n    return this._values.values();\n  }\n\n  // hash(): string {\n  //   return this._values.hashKeyset();\n  // }\n\n  clone(): HashSet<K> {\n    let n = new HashSet<K>();\n    n._values = this._values.clone()\n    return n;\n  }\n\n  size(): number {\n    return this._values.size();\n  }\n\n  equals(other: HashSet<K> | undefined | null) {\n    if (other === undefined || other === null) {\n      return false;\n    }\n\n    if (this.size() !== other.size()) {\n      return false;\n    }\n\n    for (let k of this.values()) {\n      if (!other.contains(k)) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  // *[Symbol.iterator]() {\n  //   // construct a new iterator. note that as usual\n  //   for (let key of Object.keys(this._values)) {\n  //     yield key;\n  //   }\n  // }\n}\n\n/**\n * Intended as a typescript-friendly replacement for {[k: string]: V} that allows us to specify what the key type should be (\n * rather than allowing any keyType.toString() to be a valid key, and without going through the trouble of declaring distinguishable\n * types for each key type we want to use). Also serves as a slightly different version of ES6 native Map(), which is hardcoded\n * to use === for object referential equality.\n * \n * NOTE: this assume hash() is a strong test for equality, i.e. 2 objects are considered equal if and only if their hashes are the same!!!\n * TODO: write StrictHashMap<K extends {hash(): string, equals(K): boolean}> to handle custom equality checks\n */\nexport class HashMap<K extends { hash(): string }, V> {\n  protected _values: { [key: string]: V } = {};\n\n  put(key: K, value: V) {\n    this._values[key.hash()] = value;\n  }\n\n  remove(key: K): void {\n    delete this._values[key.hash()];\n  }\n\n  get(key: K): V | undefined {\n    return this._values[key.hash()];\n  }\n\n  contains(key: K): boolean {\n    // V may be an undefined type\n    return this.get(key) !== undefined && key.hash() in this._values;\n  }\n\n  values(): V[] {\n    return Object.values(this._values);\n    // return Object.keys(this._values).map(key => this._values[key]); // why grant???\n  }\n\n  // *[Symbol.iterator]() {\n  //   // construct a new iterator. note that as usual editing the object during iteration is not supported\n  //   for (let key of Object.keys(this._values)) {\n  //     yield key;\n  //   }\n  // }\n\n  // hashes only the keys - use HashableHashMap if you know that the value type here is also hashable\n  // hashKeyset(): string {\n  //   const hashes: number[] = Object.keys(this._values).map(s => hashCode(s));\n  //   let code: number = hashes.reduce((pv, cv) => pv + cv);\n  //   return code.toString();\n  // }\n\n  size(): number {\n    return Object.keys(this._values).length;\n  }\n\n  clone(): HashMap<K, V> {\n    let n = new HashMap<K, V>();\n    n._values = { ...this._values };\n    return n;\n  }\n}\n\nexport class HashableHashMap<K extends { hash(): string }, V extends { hash(): string }> extends HashMap<K, V> {\n  hash(): string {\n    const hashes: number[] = Object.entries(this._values).map(([s, v]) => hashCode(s) + hashCode(v.hash()));\n    let code: number = hashes.reduce((pv, cv) => pv + cv);\n    return code.toString();\n  }\n}\n\n/**\n * Same as HashMap, but actually stores the keys used to key the hashmap, instead of just their hashes.\n * Allows iteration over the full key-value pair set.\n */\nexport class KeyedHashMap<K extends { hash(): string }, V>{\n  private _kvalues: { [key: string]: [K, V] } = {};\n\n  put(key: K, value: V) {\n    this._kvalues[key.hash()] = [key, value];\n  }\n\n  remove(key: K): void {\n    delete this._kvalues[key.hash()];\n  }\n\n  get(key: K): V | undefined {\n    return this._kvalues[key.hash()]?.[1];\n  }\n\n  contains(key: K): boolean {\n    // V may be an undefined type\n    return this.get(key) !== undefined && key.hash() in this._kvalues;\n  }\n\n  keys(): K[] {\n    return Object.keys(this._kvalues).map(key => this._kvalues[key][0]);\n  }\n\n  entries(): ([K, V])[] {\n    return Object.keys(this._kvalues).map(key => this._kvalues[key]);\n  }\n\n  values(): V[] {\n    return Object.keys(this._kvalues).map(key => this._kvalues[key][1]);\n  }\n\n  hashKeyset(): string {\n    const hashes: number[] = Object.keys(this._kvalues).map(s => hashCode(s));\n    let code: number = hashes.reduce((pv, cv) => pv + cv);\n    return code.toString();\n  }\n\n  clone(): KeyedHashMap<K, V> {\n    let n = new KeyedHashMap<K, V>();\n    n._kvalues = { ...this._kvalues };\n    return n;\n  }\n\n  size(): number {\n    return Object.keys(this._kvalues).length;\n  }\n}\n\nexport class DefaultHashMap<K extends { hash(): string }, V> {\n  private _values: { [key: string]: V } = {};\n  private _makeDefault: () => V;\n\n  constructor(makeDefaultValue: () => V) {\n    this._makeDefault = makeDefaultValue;\n  }\n\n  put(key: K, value: V) {\n    this._values[key.hash()] = value;\n  }\n\n  get(key: K): V {\n    if (this._values[key.hash()] === undefined) {\n      this._values[key.hash()] = this._makeDefault();\n    } \n\n    return this._values[key.hash()];\n  }\n}\n\n// Hash a string to a number. source: https://gist.github.com/hyamamoto/fd435505d29ebfa3d9716fd2be8d42f0\nexport function hashCode(s: string): number {\n  let h = 0;\n  for (let i = 0; i < s.length; i++) {\n    h = Math.imul(31, h) + s.charCodeAt(i) | 0;\n  }\n  return h;\n}\n\n// declare global {\n//   interface Array<T extends { hash(): string }> {\n//     hash(): string\n//   }\n// \n//   interface Number {\n//     hash(): string\n//   }\n// \n//   interface String {\n//     hash(): String\n//   }\n// }\n// \n// Array.prototype.hash = function () {\n//   return hashArray(this);\n// }\n// \n// Number.prototype.hash = function () {\n//   return this.toString();\n// }\n// \n// String.prototype.hash = function () {\n//   return this;\n// }\n// \n// function hashArray<T extends { hash(): string }>(arr: T[]): string {\n//   return arr.map(elt => hashCode(elt.hash())).reduce((pv, cv) => 31 * pv + cv).hash();\n// }\n// ","import * as Pixi from \"pixi.js\";\nimport { IVector2 } from \"../util/geometry/vector2\";\n\nexport function PixiPointFrom(p: IVector2): Pixi.Point {\n  return new Pixi.Point(p.x, p.y);\n}","import { ComputedState, GameState, ResourceModifier, ResourceNontrivialType, ResourceType, ResourceTypeAndModifier } from \"../data/GameState\";\nimport { HashMap } from \"../lib/util/data_structures/hash\";\nimport { enumKeys } from \"../lib/util/misc\";\n\nexport function computePlayerResourceAmounts(gameState: GameState): ComputedState {\n  let amounts: { [k in ResourceType]?: number } = {};\n\n  let playerResourceNodesAggregated = new HashMap<ResourceTypeAndModifier, number>();\n\n  for (let pointNodeRef of gameState.playerSave.allocatedPointNodeHistory) {\n    let pointNodeGen = gameState.worldGen.zLevels[pointNodeRef.z]!.chunks.get(pointNodeRef.chunkCoord)!.pointNodes.get(pointNodeRef.pointNodeCoord)!\n    if (pointNodeGen.resourceType === \"Nothing\") {\n      continue;\n    }\n\n    let resourceTypeAndModifier = new ResourceTypeAndModifier({\n      type: pointNodeGen.resourceType, modifier: pointNodeGen.resourceModifier\n    });\n    \n    playerResourceNodesAggregated.put(resourceTypeAndModifier,\n      (playerResourceNodesAggregated.get(resourceTypeAndModifier) || 0) + pointNodeGen.resourceAmount);\n  }\n\n  // Do the +flat, %increased, etc. calculations here\n\n  for (let key of enumKeys(ResourceNontrivialType)) {\n    // iterate throu\n    let amount = playerResourceNodesAggregated.get(new ResourceTypeAndModifier({\n      type: key,\n      modifier: ResourceModifier.Flat\n    })) || 0;\n    amount *= (1 + .01 * (playerResourceNodesAggregated.get(new ResourceTypeAndModifier({\n      type: key,\n      modifier: ResourceModifier.Increased0,\n    })) || 0));\n    amount = Math.floor(amount);\n    amount += playerResourceNodesAggregated.get(new ResourceTypeAndModifier({\n      type: key,\n      modifier: ResourceModifier.AfterIncreased0\n    })) || 0;\n    amount *= (1 + .01 * (playerResourceNodesAggregated.get(new ResourceTypeAndModifier({\n      type: key,\n      modifier: ResourceModifier.Increased1,\n    })) || 0));\n    amount = Math.floor(amount);\n    amount += playerResourceNodesAggregated.get(new ResourceTypeAndModifier({\n      type: key,\n      modifier: ResourceModifier.AfterIncreased1\n    })) || 0;\n    amounts[key] = amount;\n  }\n\n  return {\n    playerResourceAmounts: amounts as { [k in ResourceType]: number },\n    playerResourceNodesAggregated\n  };\n}","/**\n * \n * @param fn an arbitrary callback which performs some operation with side effects.\n * @returns a tuple: [batchedFn, fireBatch]. \n * batchedFn takes the same arguments as fn, but the side effects are delayed until fireBatch is called.\n * if batchedFn is called multiple times, those invocations are stored in order, and then popped off in order when fireBatch is called.\n */\nexport function batchify<A extends any[]>(fn: (...args: A)=> void): [((...args: A) => void), () => void] {\n  let batch: A[] = [];\n\n  return [(...args: A) => {\n    batch.push(args);\n    // console.log({ stack: new Error().stack, batchSize: batch.length });\n    // console.log({ batchSize: batch.length });\n  }, (() => {\n      if (batch.length !== 0) { console.log({ fired: batch.length }); }\n      for (let a of batch) {\n        fn(...a);\n      }\n      batch = [];\n    })\n  ];\n}\n\n/**\n * Same use case and types as [batchify], however, specifically we expect [fn] to be a setState function which takes value-or-callback\n * as its single argument, and instead of calling [fn] repeatedly for each callback in the batch, we apply the callbacks in the batch\n * sequentially to get a single state update which we then provide to [fn].\n */\nexport function batchifySetState<T>(\n  fn: (arg: T) => void\n): [((arg: T) => void), () => void] {\n  let batch: T[] = [];\n\n  return [(arg: T) => {\n    batch.push(arg);\n    // console.log({ batchSize: batch.length });\n  }, (() => {\n      if (batch.length === 0) {\n        return;\n      }\n      // console.log({ fired: batch.length });\n      let thisBatch = [...batch];\n      batch = [];\n      (fn as any)((prev: any) => {\n        let next = prev;\n        for (let valueOrCallback of thisBatch) {\n          if (typeof valueOrCallback === 'function') {\n            next = valueOrCallback(next);\n          } else {\n            next = valueOrCallback;\n          }\n        }\n        return next;\n      });\n  })]\n}\n\n","\ntype UpdaterFnParam2<T, W> = ((prev: T, prevWhole: W) => T) | (T extends Function ? never : T) // (T | ((prev: T, prevWhole: W) => T));\ntype UpdaterFn2<T, W> = (arg: UpdaterFnParam2<T, W>) => void;\n\n/**\n * Represent the type which has the same deep object struture as T but instead of values, it has\n * functions on [getUpdater], [enqueueUpdate], and [update] attached to every level of the object structure.\n */\nexport type UpdaterGeneratorType2<T, W = T> = {\n  [k in keyof T]: ((T[k] extends { [kkt: string]: any } ? UpdaterGeneratorType2<T[k], W> : {}) & {\n    getUpdater: () => UpdaterFn2<T[k], W>,\n    enqueueUpdate: UpdaterFn2<T[k], W>,\n  })\n} & {\n  getUpdater: () => UpdaterFn2<T, W>,\n  enqueueUpdate: UpdaterFn2<T, W>,\n}\n\n// helper method for the recursion\nfunction updaterGenerator2Helper<T, W>(dataObject: T, dataUpdater: UpdaterFn2<T, W>): UpdaterGeneratorType2<T, W> {\n  const updaters: UpdaterGeneratorType2<T, W> = {} as any;\n  updaters.getUpdater = () => dataUpdater;\n  updaters.enqueueUpdate = dataUpdater;\n  if (typeof dataObject !== \"object\") return updaters;\n  else {\n    const keys: (keyof T)[] = Object.keys(dataObject) as any;\n    keys.forEach((key: (keyof T)) => {\n      if (key === \"enqueueUpdate\" || key === \"getUpdater\" || key === \"update\") {\n        throw Error(`Invalid key in updaterGenerator: ${key} conflicts with reserved keywords enqueueUpdate, update, getUpdater.`);\n      }\n      function keyUpdater(newValueOrCallback: UpdaterFnParam2<T[typeof key], W>) {\n        if (typeof newValueOrCallback === \"function\") {\n          dataUpdater((oldData: T, wholeData: W) => {\n            const newKey = (newValueOrCallback as ((prev: T[typeof key], whole: W) => T[typeof key]))(oldData[key], wholeData);\n            if (oldData[key] === newKey) {\n              return oldData; // no update detected, no need to update anything\n            } else {\n              const newData = {\n                ...oldData,\n                [key]: newKey\n              };\n              return newData;\n            }\n          });\n        } else {\n          dataUpdater((oldData, wholeData) => ({ ...oldData, [key]: newValueOrCallback }));\n        }\n      }\n      updaters[key] = (updaterGenerator2Helper<T[typeof key], W>(dataObject[key], keyUpdater) as unknown as (typeof updaters)[typeof key]);\n    });\n    return updaters;\n  }\n}\n\n/**\n * Convenience method for generating setState<FancyObject.sub.component>() from setState<FancyObject> callbacks.\n * If used in react, recommended that this be memoized.\n * \n * @generic T should be a data-only object - nested objects are allowed but arrays, sets not supported\n * @param dataObject ANY instance of T, used only for its keys. MUST have all keys present\n * @param setState an updater function, which can be called as: dataUpdater(newT) or\n *   dataUpdater((oldT) => { return newTFromOldT(oldT) }) ; e.g. react setState() function.\n * @return a deep object that has the same keys as T, except each key also has a getUpdater()/set/update member;\n *   the getUpdater() on a subobject of T acts similarly to the [setState] param but to the subobject rather than the whole object;\n *   the whole object is also available as the second argument of the callback\n * e.g. :\n *   let gameStateUpdater = updaterGenerator(skeletonObject, setGameState);\n *   let setName = gameStateUpdater.player.name.getUpdater();\n *   gameStateUpdater.player.name.set(newName);\n *   gameStateUpdater.player.name.update((oldName, wholeObject) => oldName + \" \");\n * \n */\nexport function updaterGenerator2<T>(dataObject: T, setState: UpdaterFn<T>): UpdaterGeneratorType2<T> {\n  const dataUpdater2 = (stateCallbackFunction: UpdaterFnParam2<T, T>) => {\n    if (typeof stateCallbackFunction === 'function') {\n      setState((prev: T) => {\n        // if T is a function type already, typescript correctly notifies us that this will fail\n        const next = (stateCallbackFunction as ((prev: T, prevWhole: T) => T))(prev, prev);\n        // console.log(\" in updater generator 2\", { next });\n        return next;\n      })\n    } else {\n      setState(stateCallbackFunction);\n    }\n  };\n  return updaterGenerator2Helper<T, T>(dataObject, dataUpdater2);\n}\n\nexport type UpdaterFnParam<T> = (T extends Function ? never  : T) | ((prev: T) => T);\nexport type UpdaterFn<T> = (arg: UpdaterFnParam<T>) => void;","import * as Pixi from \"pixi.js\";\r\nimport { batchifySetState } from \"../../lib/util/batchify\";\r\nimport { UpdaterFn, updaterGenerator2 } from \"../../lib/util/updaterGenerator\";\r\n\r\ntype Props = {\r\n  args?: {\r\n    markForceUpdate?: (self: LifecycleHandlerBase<any, any>) => void,\r\n    [k: string]: any\r\n  },\r\n  [k: string]: any\r\n};\r\n\r\ntype State = {};\r\n\r\ntype ChildInstructions<\r\n  ChildInstanceType,\r\n  ChildPropsType extends Props,\r\n  ParentPropsType extends Props,\r\n  ParentStateType extends State\r\n  > = {\r\n    childClass: new (props: ChildPropsType) => ChildInstanceType;\r\n    instance?: ChildInstanceType;\r\n    propsFactory: (\r\n      parentProps: ParentPropsType,\r\n      parentState: ParentStateType\r\n    ) => ChildPropsType;\r\n  };\r\n\r\nclass ChildrenArray<P extends Props, S extends State> {\r\n  private _values: ChildInstructions<LifecycleHandlerBase<any, any>, any, P, S>[] = [];\r\n\r\n  public add<CIT extends LifecycleHandlerBase<any, any>, CPT>(c: ChildInstructions<CIT, CPT, P, S>) {\r\n    if (this._values.indexOf(c) === -1 || (c.instance && this.contains(c.instance))) { \r\n      // do nohting - its already in here\r\n    }\r\n    this._values.push(c);\r\n  }\r\n\r\n  public remove<CIT extends LifecycleHandlerBase<any, any>>(c: CIT): ChildInstructions<CIT, any, P, S> | undefined {\r\n    const removed = this._values.splice(this._values.findIndex(it => it.instance === c), 1);\r\n    if (removed.length === 0) {\r\n      return undefined;\r\n    } else {\r\n      return removed[0] as ChildInstructions<CIT, any, P, S>;\r\n    }\r\n  }\r\n\r\n  public contains<CIT extends LifecycleHandlerBase<any, any>>(c: CIT): boolean {\r\n    return (this._values.findIndex(it => it.instance === c) > -1);\r\n  }\r\n\r\n  public get<CIT extends LifecycleHandlerBase<CPT, any>, CPT>(c: CIT): ChildInstructions<CIT, CPT, P, S> | undefined {\r\n    return this._values.find((it) => it.instance === c) as (ChildInstructions<CIT, CPT, P, S> | undefined);\r\n  }\r\n\r\n  public clone(): ChildrenArray<P, S> {\r\n    let cloned = new ChildrenArray<P, S>();\r\n    cloned._values = [...this._values];\r\n    return cloned;\r\n  }\r\n\r\n  public forEach(callbackfn: (\r\n    value: ChildInstructions<LifecycleHandlerBase<any, any>, any, P, S>,\r\n    index: number,\r\n    array: ChildInstructions<LifecycleHandlerBase<any, any>, any, P, S>[],\r\n  ) => void) {\r\n    this._values.forEach(callbackfn);\r\n  }\r\n}\r\n\r\n// export interface LifecycleHandlerBase<P extends Props, S extends State> {\r\n// // useful for interface merging?? https://stackoverflow.com/questions/44153378/typescript-abstract-optional-method\r\n// }\r\n\r\n/**\r\n * LifecycleHandlerConstructor <- this should take the usual props, and will return new proxy, new base component(props), the handler object which has the construct() property and that function in it\r\n */\r\n// export function LifecycleHandlerConstructor<T>(props:\r\n// class and interface merging??? https://stackoverflow.com/questions/44153378/typescript-abstract-optional-method\r\nexport abstract class LifecycleHandlerBase<P extends Props, S extends State> {\r\n  // public, only to interface with non lifecycleHandler classes that we have yet to refactor\r\n  public abstract container: Pixi.Container;\r\n  // public, only to allow useState function below to set this.state\r\n  public abstract state: S;\r\n\r\n  protected _staleProps: P; // NOTE(bowei): need it for args for now; maybe we can extract out args?\r\n  private _children: ChildrenArray<P, S> = new ChildrenArray();\r\n  private _childrenToConstruct: ChildrenArray<P, S> = new ChildrenArray();\r\n  private _childrenToDestruct: ChildrenArray<P, S> = new ChildrenArray();\r\n  private _forceUpdates: ChildrenArray<P, S> = new ChildrenArray();\r\n  // private _self!: LifecycleHandlerBase<P, S>;\r\n\r\n  constructor(props: P) {\r\n    this._staleProps = props;\r\n  }\r\n\r\n  protected addChild<CIT extends LifecycleHandlerBase<CPT, any>, CPT>(\r\n    c: ChildInstructions<CIT, CPT, P, S>\r\n  ) {\r\n    this._children.add(c); // make sure children are updated\r\n    this._childrenToConstruct.add(c); // if not already constructed/added to pixi hierarchy, queue it up\r\n  }\r\n\r\n  protected registerChild<CIT extends LifecycleHandlerBase<CPT, any>, CPT>(\r\n    c: ChildInstructions<CIT, CPT, P, S>\r\n  ) { // only add children to updateable, not constructed\r\n    this._children.add(c);\r\n  }\r\n\r\n  protected removeChild<CIT extends LifecycleHandlerBase<any, any>>(c: CIT) {\r\n    let childInfo = this._children.remove(c); // make sure children are no longer updated\r\n    // NOTE(bowei): do we need to call willUnount on the children here??\r\n    childInfo && this._childrenToDestruct.add(childInfo); // queue it for destruction next update tick\r\n  }\r\n\r\n  private _didConstruct(props: P) {\r\n    // this._self = this;\r\n    this._childrenToConstruct.forEach((child) => {\r\n      if (!child.instance) {\r\n        child.instance = new child.childClass(\r\n          child.propsFactory(props, this.state)\r\n        );\r\n      }\r\n      // NOTE(bowei): we are assuming the derived class did NOT manually add child to pixi hierarchy, even if \r\n      // they constructed the instance themselves (in order to e.g. hold a reference); we do that here\r\n      this.container.addChild(child.instance.container);\r\n    });\r\n    this.renderSelf(props);\r\n    this.didMount?.();\r\n  }\r\n\r\n  /** callback passed to child - since child is not a pure component, it needs to inform us of updates if otherwise we wouldnt update */\r\n  protected markForceUpdate = (childInstance: any) => {\r\n    this._staleProps.args?.markForceUpdate?.(this); // mark us for update in OUR parent\r\n\r\n    const childInfo = this._children.get(childInstance);\r\n    if (childInfo) {\r\n      this._forceUpdates.add(childInfo);\r\n    } else {\r\n      throw new Error(`Error, child ${childInstance} not found in ${this}`);\r\n    }\r\n  }\r\n\r\n  // cannot be attached to an instance due to typescript\r\n  // if satic, cannot be called \"useState\" or else react linter complains\r\n  protected useState<S, T extends { state: S }>(self: T, initialState: S) {\r\n    const setState: UpdaterFn<S> = (valueOrCallback) => {\r\n      if (typeof valueOrCallback === \"function\") {\r\n        self.state = (valueOrCallback as (s: S) => S)(self.state);\r\n      } else {\r\n        self.state = valueOrCallback;\r\n      }\r\n    };\r\n    const [batchedSetState, fireBatch] = batchifySetState(setState);\r\n    const stateUpdaters = updaterGenerator2<S>(initialState, batchedSetState);\r\n\r\n    return {\r\n      state: initialState,\r\n      setState,\r\n      fireStateUpdaters: fireBatch,\r\n      stateUpdaters,\r\n    };\r\n  }\r\n\r\n  // shim while we migrate\r\n  public update(nextProps: P) { this._update(nextProps); }\r\n\r\n  // NOTE(bowei): this is public because the root of component hierarchy needs to be bootstrapped from pixi react bridge\r\n  public _update(nextProps: P) { // nextProps is guaranteed to be referentially a distinct object (might be shallow copy though)\r\n    const staleState = { ...this.state };\r\n    this.fireStateUpdaters?.();\r\n    this.updateSelf?.(nextProps);\r\n    if (this.shouldUpdate && !this.shouldUpdate(this._staleProps, staleState, nextProps, this.state)) {\r\n      // we think we don't need to update; however, we still need to\r\n      // update the chidlren that asked us to forcefully update them\r\n      let forceUpdates = this._forceUpdates.clone();\r\n      this._forceUpdates = new ChildrenArray<P, S>();\r\n      forceUpdates.forEach(childInfo => {\r\n        let { instance, propsFactory } = childInfo;\r\n        instance?._update(propsFactory(nextProps, this.state)); // why are we even calling props factory here?? theres no point... we should just tell the child to use their own stale props, like this:\r\n        // instance._forceUpdate();\r\n        // note that children can add themselves into forceupdate next tick as well, if they need to ensure they're continuously in there\r\n\r\n        instance && this.didForceUpdateChild?.(instance);\r\n      })\r\n      // no need to do anything else -- stale props has not changed\r\n\r\n      this.didForceUpdate?.();\r\n      return;\r\n    }\r\n    this.updateChildren?.(nextProps);\r\n    this._updateChildren(nextProps); // implementation should call children._update in here\r\n    this.renderSelf(nextProps);\r\n    this._staleProps = nextProps;\r\n    new Promise((resolve) => resolve(this.didUpdate?.()));\r\n  }\r\n\r\n  protected updateChildren?(nextProps: P): void\r\n\r\n  // destroy, update, create in that order, so that there's no extra update right before destroy or after create\r\n  private _updateChildren(nextProps: P) {\r\n    this._childrenToDestruct.forEach((child) => {\r\n      if (child.instance) { // should always be true\r\n        child.instance.willUnmount?.()\r\n        this.container.removeChild(child.instance.container);\r\n      }\r\n    });\r\n    this._childrenToDestruct = new ChildrenArray();\r\n\r\n    this._children.forEach(({ instance, propsFactory }) => {\r\n      instance?._update(propsFactory(nextProps, this.state));\r\n    });\r\n\r\n    this._childrenToConstruct.forEach((child) => {\r\n      // here we expect the child instances to be empty, but they could be already constructed, if the derived class needs to keep a reference to it\r\n      if (!child.instance) {\r\n        child.instance = new child.childClass(\r\n          child.propsFactory(nextProps, this.state)\r\n        );\r\n      }\r\n      this.container.addChild(child.instance.container);\r\n    });\r\n    this._childrenToConstruct = new ChildrenArray();\r\n  }\r\n\r\n  protected fireStateUpdaters?(): void;\r\n  protected didMount?(): void;\r\n  protected updateSelf?(nextProps: P): void;\r\n  protected shouldUpdate?(\r\n    staleProps: P,\r\n    staleState: S,\r\n    nextProps: P,\r\n    state: S\r\n  ): boolean;\r\n  protected abstract renderSelf(nextProps: P): void;\r\n  protected didUpdate?(): void;\r\n  protected didForceUpdate?(): void;\r\n  public willUnmount(): void {} // TODO(bowei): revert this to protected nullable; however it's needed for shim for now\r\n  protected didForceUpdateChild?(child: LifecycleHandlerBase<any, any>): void;\r\n\r\n  public toString(): string {\r\n    return \"lifecyclehandler object\";\r\n  }\r\n}\r\n\r\nexport type LifecycleHandlerType<P, S> = LifecycleHandlerBase<P, S>;\r\nexport const LifecycleHandler = new Proxy(LifecycleHandlerBase, {\r\n  construct: (target, args, newTarget) => {\r\n    const instance = Reflect.construct(target, args, newTarget);\r\n    instance._didConstruct(...args);\r\n    return instance;\r\n  },\r\n});\r\n\r\nexport function engageLifecycle<T extends object>(derived: T): T {\r\n  return new Proxy<T>(derived, {\r\n    construct: (target, args) => {\r\n      const instance = new (target as any)(args[0]);\r\n      instance._didConstruct(args[0]);\r\n      return instance;\r\n    },\r\n  });\r\n}\r\n\r\n/**\r\n * First render:\r\n * constructor\r\n * renderChildren?\r\n * renderSelf\r\n * didMount\r\n *\r\n * Subsequent updates:\r\n *\r\n * fireStateUpdaters\r\n * updateSelf\r\n * shouldUpdate(props,state)?\r\n * updateChildren\r\n * children._update\r\n * renderSelf\r\n * didUpdate\r\n * staleProps = props\r\n *\r\n */\r\n\r\ntype ReferenceProps = {\r\n  updaters: \"stuff\";\r\n  args: { s: \"other stuff\" };\r\n};\r\ntype ReferenceState = {\r\n  lalalala: \"hahahah\";\r\n};\r\n\r\nexport class Reference extends LifecycleHandler<ReferenceProps, ReferenceState> {\r\n  public container: Pixi.Container\r\n  public state: ReferenceState\r\n  constructor(props: ReferenceProps) {\r\n    super(props);\r\n    this.container = new Pixi.Container();\r\n    this.state = {\r\n      lalalala: \"hahahah\",\r\n    };\r\n  }\r\n\r\n  updateSelf(nextProps: ReferenceProps) { }\r\n  renderSelf(nextProps: ReferenceProps) { }\r\n  didMount() { } \r\n  didUpdate() { }\r\n  shouldUpdate(): boolean { return true; }\r\n  fireStateUpdaters() { }\r\n  willUnmount() { }\r\n}\r\n","import * as Pixi from \"pixi.js\";\nimport { UpdaterGeneratorType2 } from \"../../lib/util/updaterGenerator\";\nimport { engageLifecycle, LifecycleHandlerBase } from \"./LifecycleHandler\";\n\ntype Props = {\n  args: {\n    markForceUpdate: (childInstance: any) => void,\n  },\n  hitArea: Pixi.IHitArea;\n  delaySeconds?: number;\n}\n\ntype State = {\n  isActive: boolean;\n\n}\n\n/**\n * For a interesting reference implementation, see https://www.iwm-tuebingen.de/iwmbrowser/lib/pixi/button.html\n */\nclass TooltippableAreaComponent extends LifecycleHandlerBase<Props, State> {\n  public state: State\n  public container: Pixi.Container;\n  private stateUpdaters: UpdaterGeneratorType2<State>\n  protected fireStateUpdaters: () => void\n\n  public hitAreaDrawn?: Pixi.Graphics; // debug\n\n  tooltipContainer: Pixi.Container | null;\n\n  constructor(props: Props) {\n    super(props);\n    this.container = new Pixi.Container();\n    this.container.interactive = true;\n    this.container.buttonMode = true;\n    this.container.hitArea = props.hitArea;\n    this.container.zIndex = 2;\n    // this.container.hitArea = new Pixi.Rectangle(\n    //   - RenderedChunkConstants.NODE_HITAREA_PX / 2,\n    //   - RenderedChunkConstants.NODE_HITAREA_PX / 2,\n    //   RenderedChunkConstants.NODE_HITAREA_PX,\n    //   RenderedChunkConstants.NODE_HITAREA_PX,\n    // );\n    // this.hitAreaDrawn = new Pixi.Graphics();\n    // this.hitAreaDrawn.beginFill(0xffffff);\n    // this.hitAreaDrawn.drawRect(\n    //   - RenderedChunkConstants.NODE_HITAREA_PX / 2,\n    //   - RenderedChunkConstants.NODE_HITAREA_PX / 2,\n    //   RenderedChunkConstants.NODE_HITAREA_PX,\n    //   RenderedChunkConstants.NODE_HITAREA_PX,\n    // );\n    // this.container.addChild(this.hitAreaDrawn);\n\n    this.tooltipContainer = null;\n\n    ({ state: this.state, stateUpdaters: this.stateUpdaters, fireStateUpdaters: this.fireStateUpdaters } =\n      this.useState<State, TooltippableAreaComponent>(this, {\n        isActive: false\n      }));\n  }\n\n  protected renderSelf(props: Props) {\n    // if (this.state.isActive) {\n    //   this.hitAreaDrawn.tint = 0x888888;\n    // } else {\n    //   this.hitAreaDrawn.tint = 0xffffff;\n    // }\n\n    if (this.state.isActive) {\n      if (this.tooltipContainer === null) {\n        // if doesnt exist, construct it\n        this.tooltipContainer = new Pixi.Container();\n        const box = new Pixi.Graphics();\n        box.lineStyle(1, 0x222222, 1);\n        box.beginFill(0xEEEEEE);\n        box.drawRoundedRect(0, 0, 40, 40, 4);\n        this.tooltipContainer.addChild(box)\n        this.container.addChild(this.tooltipContainer);\n      }\n    } else {\n      if (this.tooltipContainer) {\n        // remove it\n        this.container.removeChild(this.tooltipContainer);\n        this.tooltipContainer.destroy();\n        this.tooltipContainer = null;\n      }\n    }\n  }\n\n  protected didMount() {\n    // TODO(bowei): move these listeners to the parent so that hitArea can be unified\n    // TODO(bowei): move this object to somewhere else in pixi e.g. the parent hud layer to resolve hiding issues\n    // using worldtransform: https://www.html5gamedevs.com/topic/12774-absolute-position-of-displayobjectsspritesprimitives/\n    this.container.addListener('pointerover', this.onPointerOver);\n    this.container.addListener('pointerout', this.onPointerOut);\n  }\n\n  public onPointerOver = (event: Pixi.InteractionEvent) => {\n    // console.log('got onPointerOver in toolltippable');\n    this._staleProps.args.markForceUpdate(this);\n    this.stateUpdaters.isActive.enqueueUpdate(() => {\n      // console.log('fired onPointerOver in toolltippable');\n      return true;\n    });\n  }\n\n  public onPointerOut = (event: Pixi.InteractionEvent) => {\n    this._staleProps.args.markForceUpdate(this);\n    // console.log('got onPointerOut in tooltippable')\n    this.stateUpdaters.isActive.enqueueUpdate(() => {\n      // console.log('fired onPointerOut in tooltippable')\n      return false;\n    });\n  }\n}\n\nconst wrapped = engageLifecycle(TooltippableAreaComponent);\n// eslint-disable-next-line\ntype wrapped = TooltippableAreaComponent;\nexport { wrapped as TooltippableAreaComponent };\nexport type { Props as TooltippableAreaComponentProps };","import * as Pixi from \"pixi.js\";\nimport { RenderedChunkConstants } from \"./ChunkComponent\";\nimport { UpdaterGeneratorType2 } from \"../../lib/util/updaterGenerator\";\nimport { GameState, PointNodeGen, PointNodeRef, ResourceModifier, ResourceType } from \"../../data/GameState\";\nimport { Vector2 } from \"../../lib/util/geometry/vector2\";\nimport { PixiPointFrom } from \"../../lib/pixi/pixify\";\nimport { multiplyColor } from \"../../lib/util/misc\";\nimport { afterMaybeSpendingSp, doTryAllocate } from \"../../game/OnAllocation\";\nimport { computePlayerResourceAmounts } from \"../../game/ComputeState\";\nimport { TooltippableAreaComponent } from \"./TooltippableAreaComponent\";\nimport { engageLifecycle, LifecycleHandlerBase } from \"./LifecycleHandler\";\n\ntype Props = {\n  delta: number,\n  args: {\n    pointNodeTexture: Pixi.Texture,\n    markForceUpdate: (childInstance: any) => void,\n  },\n  selfPointNodeRef: PointNodeRef,\n  updaters: UpdaterGeneratorType2<GameState>,\n  position: Vector2,\n  pointNodeGen: PointNodeGen,\n  isSelected: boolean,\n  isAllocated: boolean\n};\n\ntype State = {\n  justTriedToAllocate: boolean\n  justSpentSp: boolean\n  justFailedToAllocate: boolean\n  numClicks:number\n}\n\nclass PointNodeComponent extends LifecycleHandlerBase<Props, State> {\n  public container: Pixi.Container;\n  public state: State;\n\n  public sprite: Pixi.Sprite\n  public halfwayCenterSprite: Pixi.Sprite;\n  public centerSprite: Pixi.Sprite;\n  public hitArea: Pixi.IHitArea;\n\n  public tooltippableArea?: TooltippableAreaComponent\n\n  constructor(props: Props) {\n    super(props);\n    this.state = {\n      justTriedToAllocate: false,\n      justSpentSp: false,\n      justFailedToAllocate: false,\n      numClicks: 0\n    };\n    this.container = new Pixi.Container();\n\n    this.container.sortableChildren = true;\n    this.sprite = new Pixi.Sprite(props.args.pointNodeTexture);\n    this.sprite.anchor.x = 0.5;\n    this.sprite.anchor.y = 0.5;\n    this.sprite.zIndex = -1;\n    this.container.addChild(this.sprite);\n\n    this.centerSprite = new Pixi.Sprite(props.args.pointNodeTexture);\n    this.centerSprite.anchor.x = 0.5;\n    this.centerSprite.anchor.y = 0.5;\n    this.centerSprite.scale = PixiPointFrom(new Vector2(0.5, 0.5));\n    this.centerSprite.zIndex = 1;\n    this.centerSprite.alpha = 0; // TESTING\n    // this.container.addChild(this.centerSprite);\n\n    this.halfwayCenterSprite = new Pixi.Sprite(props.args.pointNodeTexture);\n    this.halfwayCenterSprite.anchor.x = 0.5;\n    this.halfwayCenterSprite.anchor.y = 0.5;\n    this.halfwayCenterSprite.scale = PixiPointFrom(new Vector2(0.75, 0.75));\n    this.halfwayCenterSprite.zIndex = 0;\n    // disable this sprite for now - causes a fairly significant fps hit, until we get around to holding less nodes on the page at once\n    this.halfwayCenterSprite.alpha = 0;\n    // this.container.addChild(this.halfwayCenterSprite);\n\n    this.container.interactive = true;\n    // NOTE(bowei): ive tested, the following 2 settings don't significantly affect FPS\n    this.container.buttonMode = true;\n    this.hitArea = new Pixi.Rectangle(\n      - RenderedChunkConstants.NODE_HITAREA_PX / 2,\n      - RenderedChunkConstants.NODE_HITAREA_PX / 2,\n      RenderedChunkConstants.NODE_HITAREA_PX,\n      RenderedChunkConstants.NODE_HITAREA_PX,\n    );\n    // note: hitarea breaks child onhover: https://github.com/pixijs/pixi.js/issues/5837\n    // this.container.hitArea = this.hitArea;\n\n    const tooltippableAreaPropsFactory = (p: Props, s: State) => {\n      return {\n        args: {\n          markForceUpdate: this.markForceUpdate,\n        },\n        hitArea: this.hitArea, // TODO(bowei): move into state???\n      }\n    }\n    this.tooltippableArea = new TooltippableAreaComponent(tooltippableAreaPropsFactory(props, this.state));\n    // this.container.addChild(this.tooltippableArea.container);\n    this.addChild({\n      childClass: TooltippableAreaComponent,\n      instance: this.tooltippableArea,\n      propsFactory: tooltippableAreaPropsFactory,\n    });\n  }\n\n  protected renderSelf(props: Props) {\n    this.container.position = PixiPointFrom(props.position);\n    let tint: number;\n    let centerTint: number;\n    if (props.isSelected) {\n      tint = 0xBBBBFF;\n      centerTint = 0xBBBBFF;\n    } else {\n      tint = 0xFFFFFF;\n      centerTint = 0xFFFFFF;\n    }\n    if (props.isAllocated) {\n      tint = 0x444444;\n    } else {\n    }\n    let baseColor: number = 0;\n    if (props.pointNodeGen.resourceType === ResourceType.Nothing) {\n      baseColor = 0x99bbff; // blue that mixes in with bg\n    } else if (props.pointNodeGen.resourceType === ResourceType.Mana0) {\n      if (props.pointNodeGen.resourceModifier === ResourceModifier.Flat) {\n        baseColor = 0xeeaaaa; // pink\n      } else if (props.pointNodeGen.resourceModifier === ResourceModifier.Increased0) {\n        baseColor = 0xcc88ee; // lavender?\n      }\n    }\n    // switch (props.pointNodeGen.resourceType) {\n    //   case ResourceType.Nothing:\n    //     baseColor = 0x99bbff; // blue that mixes in with bg\n    //     break;\n    //   case ResourceType.Mana0:\n    //     baseColor = 0xeeaaaa; // red\n    //     break;\n    //   case ResourceType.Mana1:\n    //     baseColor = 0xbb7733; // brown?\n    //     break;\n    //   case ResourceType.Mana2:\n    //     baseColor = 0x44aa44; // green\n    //     break;\n    // }\n\n    this.sprite.tint = multiplyColor(baseColor, tint);\n    this.centerSprite.tint = multiplyColor(baseColor, centerTint);\n\n    // NOTE(bowei): careful, we dont want to set the scale of our tooltip to be bigger\n    if (props.selfPointNodeRef.pointNodeCoord.equals(Vector2.Zero)) {\n      this.container.scale = PixiPointFrom(new Vector2(1.25, 1.25));\n    }\n  }\n\n  protected shouldUpdate(staleProps: Props, staleState: State, props: Props, state: State): boolean {\n    for (let key of (Object.keys(staleProps) as (keyof Props)[])) {\n      if (key === 'delta' || key === 'args' || key === 'updaters') { continue; }\n      if (staleProps[key] !== props[key]) {\n        return true;\n      }\n      if (key === 'position') {\n        if (!staleProps[key].equals(props[key])) {\n          console.log(`chunk shouldUpdate differed in ${key}, returning true`);\n          return true;\n        } else {\n          continue;\n        }\n      }\n      if (key === 'selfPointNodeRef') {\n        if (staleProps[key]?.hash() !== props[key]?.hash()) {\n          console.log(`chunk shouldUpdate differed in ${key}, returning true`);\n          return true;\n        } else {\n          continue;\n        }\n      }\n    }\n    return false;\n  }\n\n  protected didMount() {\n    const { updaters } = this._staleProps; // we assume this will never change\n\n//     this.container.addListener('pointerover', (event: Pixi.InteractionEvent) => {\n//       this.state.pointerover = event;\n//     })\n//     this.container.addListener('pointerout', () => {\n//       this.state.pointerover = undefined;\n//     })\n// \n\n    this.container.addListener(\"pointerdown\", (event: Pixi.InteractionEvent) => {\n      this.state.numClicks++;\n      // event.stopPropagation();\n\n      // update selected to ourselves\n      updaters.playerUI.selectedPointNode.enqueueUpdate((prev, gameState) => {\n        if (prev?.pointNodeId === this._staleProps.selfPointNodeRef.pointNodeId) {\n          console.log('just selected: ', this);\n          this.state.justTriedToAllocate = true;\n        }\n        return this._staleProps.selfPointNodeRef;\n      });\n\n      // if we tried to allocate ourselves, see if we can\n      updaters.playerSave.enqueueUpdate((prev, prevGameState) => {\n        if (this.state.justTriedToAllocate) {\n          this.state.justTriedToAllocate = false;\n          let [next, succeeded] = doTryAllocate(prev, prevGameState, this._staleProps.selfPointNodeRef);\n          if (succeeded) {\n            this.state.justSpentSp = true;\n            return next;\n          } else {\n            this.state.justFailedToAllocate = true;\n            return prev;\n          }\n        }\n        return prev;\n      });\n\n      // TODO(bowei): if we spent sp, remember to update quest status!!\n      updaters.computed.enqueueUpdate((prev, prevGameState) => {\n        if (this.state.justSpentSp) {\n          // this.state.justSpentSp = false;\n          // console.log(\"just spent SP!\");\n          return computePlayerResourceAmounts(prevGameState);\n        }\n        return prev;\n      })\n\n      updaters.playerSave.enqueueUpdate((prev, prevGameState) => {\n        if (this.state.justSpentSp) {\n          this.state.justSpentSp = false;\n          // console.log(\"just spent SP!\");\n          return afterMaybeSpendingSp(prev, prevGameState);\n        }\n        return prev;\n      })\n\n      // if we failed to allocate, shift the active tab so the player can see why\n      updaters.playerUI.activeTab.enqueueUpdate((prev, prevGameState) => {\n        if (this.state.justFailedToAllocate) {\n          console.log('just failed to allocate: ', this);\n          this.state.justFailedToAllocate = false;\n          return 1;\n        }\n        return prev;\n      });\n    });\n  }\n\n  public toString(): string {\n    return \"PointNodeCompoent \" + this._staleProps.selfPointNodeRef.toString();\n  }\n}\n\nconst wrapped = engageLifecycle(PointNodeComponent);\n// eslint-disable-next-line\ntype wrapped = PointNodeComponent;\nexport { wrapped as PointNodeComponent };\nexport type { Props as PointNodeComponentProps };","import { GameState, PlayerSaveState, PointNodeRef } from \"../data/GameState\";\nimport { canAllocate } from \"./Neighbors\";\n\nexport function doTryAllocate(prev: PlayerSaveState, prevGameState: GameState, selfPointNodeRef: PointNodeRef): [PlayerSaveState, boolean] {\n  if (canAllocate(\n    selfPointNodeRef,\n    prevGameState.worldGen,\n    prevGameState.playerSave.allocatedPointNodeSet,\n    prevGameState.playerSave.availableSp\n  ) === 'yes') {\n    // do the change\n    const nextSet = prev.allocatedPointNodeSet.clone();\n    nextSet.put(selfPointNodeRef);\n    const nextHistory = [...prev.allocatedPointNodeHistory];\n    nextHistory.push(selfPointNodeRef);\n    let availableSp = prev.availableSp - 1;\n    return [{\n      ...prev,\n      allocatedPointNodeHistory: nextHistory,\n      allocatedPointNodeSet: nextSet,\n      availableSp\n    }, true];\n  } else {\n    return [prev, false];\n  }\n}\n\nexport function afterMaybeSpendingSp(prev: PlayerSaveState, prevGameState: GameState): PlayerSaveState {\n  let next = { ...prev };\n  if (next.spSpentThisQuest !== undefined) {\n    next.spSpentThisQuest += 1;\n  }\n\n  if (next.availableSp === 0 && next.activeQuest) {\n    // TODO: need to find out if the quest is finished...\n    next.availableSp = 1;\n    next.batchesSinceQuestStart += 1;\n  }\n  // console.log({ next });\n\n  // update quest progress history?\n  if (next.activeQuest) {\n    let resourceType = next.activeQuest.resourceType;\n    let amount = prevGameState.computed.playerResourceAmounts?.[resourceType] || 0;\n    next.questProgressHistory.push(amount);\n  }\n  return next;\n}","import * as Pixi from \"pixi.js\";\nimport { HashSet, KeyedHashMap } from \"../../lib/util/data_structures/hash\";\nimport { ChunkGen, ChunkGenConstants, ChunkRef, GameState, PointNodeRef } from \"../../data/GameState\";\nimport { PointNodeComponent } from \"./PointNodeComponent\";\nimport { UpdaterGeneratorType2 } from \"../../lib/util/updaterGenerator\";\nimport { Vector2 } from \"../../lib/util/geometry/vector2\";\nimport { PixiPointFrom } from \"../../lib/pixi/pixify\";\nimport { engageLifecycle, LifecycleHandlerBase } from \"./LifecycleHandler\";\n\nexport class RenderedChunkConstants {\n//   public static SPACING_PX: number = 24;\n//   public static CHUNK_SPACING_PX: number = (ChunkGenConstants.CHUNK_DIM + 0.5) * RenderedChunkConstants.SPACING_PX;\n//   public static NODE_SIZE_PX: number = 14;\n//   public static NODE_HITAREA_PX: number = 18;\n  public static SPACING_PX: number = 36;\n  public static CHUNK_SPACING_PX: number = (ChunkGenConstants.CHUNK_DIM + 0.0) * RenderedChunkConstants.SPACING_PX;\n  public static NODE_SIZE_PX: number = 22;\n  public static NODE_HITAREA_PX: number = RenderedChunkConstants.NODE_SIZE_PX + 4;\n  public static NODE_ROUNDED_PX: number = 4;\n}\n\ntype Props = {\n  delta: number,\n  args: {\n    pointNodeTexture: Pixi.Texture,\n    markForceUpdate: (childInstance: any) => void,\n  },\n  selfChunkRef: ChunkRef,\n  updaters: UpdaterGeneratorType2<GameState>,\n  position: Vector2,\n  chunkGen: ChunkGen,\n  selectedPointNode: PointNodeRef | undefined,\n  allocatedPointNodeSubset: HashSet<PointNodeRef>,\n}\n\ntype State = {}\n\nclass ChunkComponent2 extends LifecycleHandlerBase<Props, State> {\n  public container: Pixi.Container;\n  public state: State;\n\n  public children: KeyedHashMap<PointNodeRef, PointNodeComponent>;\n\n  constructor(props: Props) {\n    super(props);\n\n    this.state = {};\n    this.container = new Pixi.Container();\n    this.children = new KeyedHashMap();\n\n    this.resyncChildren(props);\n  }\n\n  protected renderSelf(props: Props) {\n    this.container.position = PixiPointFrom(props.position);\n  }\n\n  protected shouldUpdate(prevProps: Props, prevState: State, props: Props, state: State): boolean {\n    // return true;\n    for (let key of (Object.keys(prevProps) as (keyof Props)[])) {\n      if (key === 'delta' || key === 'args' || key === 'updaters') { continue; }\n      if (key === 'position') {\n        if (!prevProps[key].equals(props[key])) {\n          console.log(`chunk shouldUpdate differed in ${key}, returning true`);\n          return true;\n        } else {\n          continue;\n        }\n      }\n      if (key === 'selectedPointNode') {\n        if (prevProps[key]?.hash() !== props[key]?.hash()) {\n          console.log(`chunk shouldUpdate differed in ${key}, returning true`);\n          return true;\n        } else {\n          continue;\n        }\n      }\n      if (key === 'selfChunkRef') {\n        if (prevProps[key]?.hash() !== props[key]?.hash()) {\n          console.log(`chunk shouldUpdate differed in ${key}, returning true`);\n          return true;\n        } else {\n          continue;\n        }\n      }\n      if (key === 'allocatedPointNodeSubset') {\n        // subsets could be different objects but have the same contents\n        if (!prevProps[key].equals(props[key])) {\n          // console.log(`prevProps: ${JSON.stringify(prevProps[key])}`);\n          // console.log(`props: ${JSON.stringify(props[key])}`);\n          console.log(`chunk shouldUpdate differed in ${key}, returning true`);\n          return true;\n        } else {\n          continue;\n        }\n      }\n      if (prevProps[key] !== props[key]) {\n        console.log(`chunk shouldUpdate differed in ${key}, returning true`);\n        return true;\n      }\n    }\n    return false;\n  }\n\n  private resyncChildren(props: Props) {\n    let childrenToDelete = this.children.clone(); // track which children need to be destroyed according to new props\n    console.log(`chunk component upsert children got here`);\n    // console.log(`chunk component upsert children has ${this.children.size()} children`);\n\n    for (let [pointNodeCoord, pointNodeGen] of props.chunkGen.pointNodes.entries()) {\n      const pointNodeRef = new PointNodeRef({\n        z: props.selfChunkRef.z,\n        chunkCoord: props.selfChunkRef.chunkCoord,\n        pointNodeCoord: pointNodeCoord,\n        pointNodeId: pointNodeGen.id\n      })\n      let childPropsFactory = (props: Props, state: State) => {\n        return {\n          delta: props.delta,\n          args: {\n            pointNodeTexture: props.args.pointNodeTexture,\n            markForceUpdate: this.markForceUpdate,\n          },\n          selfPointNodeRef: pointNodeRef,\n          updaters: props.updaters,\n          position: pointNodeRef.pointNodeCoord.multiply(RenderedChunkConstants.SPACING_PX),\n          pointNodeGen,\n          isSelected: props.selectedPointNode?.pointNodeId === pointNodeRef.pointNodeId,\n          isAllocated: props.allocatedPointNodeSubset.contains(pointNodeRef),\n        };\n      }\n      const childKey = pointNodeRef;\n\n      let childComponent = this.children.get(childKey);\n      if (childComponent) {\n        // childComponent.update(childPropsFactory(props, this.state));\n        childrenToDelete.remove(childKey);\n      } else {\n        childComponent = new PointNodeComponent(childPropsFactory(props, this.state));\n        this.children.put(pointNodeRef, childComponent);\n        // this.container.addChild(childComponent.container);\n        this.addChild({\n          childClass: PointNodeComponent,\n          instance: childComponent,\n          propsFactory: childPropsFactory\n        });\n      }\n    }\n    console.log(`chunk component to delete has ${childrenToDelete.size()} children`);\n    for (let [childKey, childComponent] of childrenToDelete.entries()) {\n      // childComponent.willUnmount();\n      this.children.remove(childKey);\n      // this.container.removeChild(childComponent.container);\n      this.removeChild(childComponent);\n    }\n  }\n\n  protected updateChildren(props: Props) {\n    this.resyncChildren(props);\n  }\n\n  protected didForceUpdateChild(instance: LifecycleHandlerBase<any, any>) {\n    // IMPORTANT! this is intended to raise the child that asked for a force update to the top so it isn't covered\n    // by other sibling pixi containers. however this code doesnt work well during the update call, for some reason (not sure why)\n    this.container.removeChild(instance.container);\n    this.container.addChild(instance.container);\n  }\n}\n\nconst wrapped = engageLifecycle(ChunkComponent2);\n// eslint-disable-next-line\ntype wrapped = ChunkComponent2;\nexport { wrapped as ChunkComponent };\nexport type { Props as ChunkComponentProps };","import { WorldGenState, ChunkGen, PointNodeGen, ChunkGenConstants, ZLevelGen, ResourceType, ResourceModifier } from \"../data/GameState\";\nimport { HashSet, KeyedHashMap } from \"../lib/util/data_structures/hash\";\nimport { Vector2 } from \"../lib/util/geometry/vector2\";\nimport { INTMAX32, squirrel3 } from \"../lib/util/random\";\n\nexport type WorldGenStateConfig = any;\n\nexport class WorldGenStateFactory {\n  public config: WorldGenStateConfig;\n\n  constructor(config: WorldGenStateConfig) {\n    this.config = config;\n  }\n\n  public create(): WorldGenState {\n    throw Error();\n  }\n}\n\nexport type ZLevelGenConfig = any;\n\nexport class ZLevelGenFactory {\n  public config: ZLevelGenConfig;\n  public chunkGenFactory: ChunkGenFactory;\n\n  constructor(config: ZLevelGenConfig) {\n    this.config = config;\n    this.chunkGenFactory = new ChunkGenFactory({});\n  }\n\n  public create(args: { seed: number, z: number, startingChunks?: number }): ZLevelGen {\n    const id = squirrel3(args.seed + args.z);\n    const chunks: KeyedHashMap<Vector2, ChunkGen> = new KeyedHashMap();\n\n    const max = args.startingChunks || 3;\n    // TODO(bowei): generate more chunks??\n    for (let i = -max; i <= max; i++) {\n      for (let j = -max; j <= max; j++){\n        let location = new Vector2(i, j);\n        chunks.put(location, this.chunkGenFactory.create({ seed: id, location, z: args.z }));\n      }\n    }\n\n    return { id, chunks };\n  }\n}\n\nexport type ChunkGenConfig = any;\n\nexport class ChunkGenFactory {\n  public config: ChunkGenConfig;\n  public pointNodeGenFactory: PointNodeGenFactory\n\n  constructor(config: ChunkGenConfig) {\n    this.config = config;\n    this.pointNodeGenFactory = new PointNodeGenFactory({});\n  }\n\n  public create(args: { seed: number, location: Vector2, z: number }): ChunkGen {\n    const id = squirrel3(args.seed + squirrel3(args.seed + args.location.x) + args.location.y);\n    const pointNodes: KeyedHashMap<Vector2, PointNodeGen> = new KeyedHashMap();\n\n    let droppedNodes: HashSet<Vector2> = new HashSet();\n    for (let i = -ChunkGenConstants.CHUNK_HALF_DIM; i <= ChunkGenConstants.CHUNK_HALF_DIM; i++) {\n      for (let j = -ChunkGenConstants.CHUNK_HALF_DIM; j <= ChunkGenConstants.CHUNK_HALF_DIM; j++) {\n        if (i === 0 && j === 0) {\n          continue;\n        }\n        // 4 way symmetry plz\n        if (squirrel3(id + i * ChunkGenConstants.CHUNK_DIM + j) / INTMAX32 < ChunkGenConstants.DROP_NODES_CHANCE / 4) {\n          droppedNodes.put(new Vector2(i, j));\n          droppedNodes.put(new Vector2(j, -i));\n          droppedNodes.put(new Vector2(-i, -j));\n          droppedNodes.put(new Vector2(-j, i));\n        }\n      }\n    }\n\n    for (let i = -ChunkGenConstants.CHUNK_HALF_DIM; i <= ChunkGenConstants.CHUNK_HALF_DIM; i++) {\n      for (let j = -ChunkGenConstants.CHUNK_HALF_DIM; j <= ChunkGenConstants.CHUNK_HALF_DIM; j++) {\n        let loc = new Vector2(i, j);\n        if (!droppedNodes.get(loc)) {\n          pointNodes.put(loc, this.pointNodeGenFactory.create({ seed: id, location: loc, chunk: args.location, z: args.z }));\n        }\n      }\n    }\n\n    return { id, pointNodes };\n  }\n}\n\ntype PointNodeGenConfig = {};\n\nexport class PointNodeGenFactory {\n  public config: PointNodeGenConfig;\n\n  constructor(config: PointNodeGenConfig) {\n    this.config = config;\n  }\n\n  public create(args: { seed: number, location: Vector2, chunk: Vector2, z: number }): PointNodeGen {\n    const id = squirrel3(args.seed + squirrel3(args.seed + args.location.x) + args.location.y);\n\n    let randomFloat = squirrel3(id + 1) / INTMAX32;\n    let resourceType: ResourceType;\n    if (randomFloat < 0.0) {\n      resourceType = \"Nothing\";\n    } else if (randomFloat < 0.15) {\n      resourceType = ResourceType.Mana0;\n    } else if (randomFloat < -0.35) {\n      resourceType = ResourceType.Mana1;\n    } else if (randomFloat < -0.60) {\n      resourceType = ResourceType.Mana2;\n    } else {\n      resourceType = \"Nothing\";\n    }\n    // override for root node\n    if (args.location.equals(Vector2.Zero) && args.chunk.equals(Vector2.Zero) && args.z === 0) {\n      resourceType = \"Nothing\";\n    }\n\n    randomFloat = squirrel3(id + 2) / INTMAX32;\n    let resourceModifier: ResourceModifier;\n    if (randomFloat < 0.55) {\n      resourceModifier = ResourceModifier.Flat;\n    } else if (randomFloat < -0.70) {\n      resourceModifier = ResourceModifier.AfterIncreased0;\n    } else if (randomFloat < -0.70) {\n      resourceModifier = ResourceModifier.AfterIncreased1;\n    } else if (randomFloat < 1.95) {\n      resourceModifier = ResourceModifier.Increased0;\n    } else {\n      resourceModifier = ResourceModifier.Increased1;\n    }\n\n    let resourceAmount = 0;\n    if (resourceModifier === ResourceModifier.Flat ||\n      resourceModifier === ResourceModifier.AfterIncreased0 ||\n      resourceModifier === ResourceModifier.AfterIncreased1) {\n      // ([0..3] x 3) * 20 + 60 == 150 +/- 90\n      randomFloat = Math.floor(squirrel3(id + 3) / INTMAX32 * 4);\n      randomFloat += Math.floor(squirrel3(id + 4) / INTMAX32 * 4); // base is 20 ish?\n      randomFloat += Math.floor(squirrel3(id + 5) / INTMAX32 * 4); // base is 20 ish?\n      resourceAmount = randomFloat * 20 + 60;\n    } else {\n      // 3 + [0..1] x 4 == 5% +/- 2\n      randomFloat = Math.floor(squirrel3(id + 3) / INTMAX32 * 2); // base is 20 ish?\n      randomFloat += Math.floor(squirrel3(id + 4) / INTMAX32 * 2); // base is 20 ish?\n      randomFloat += Math.floor(squirrel3(id + 5) / INTMAX32 * 2); // base is 20 ish?\n      randomFloat += Math.floor(squirrel3(id + 6) / INTMAX32 * 3); // base is 20 ish?\n      resourceAmount = randomFloat + 3;\n    }\n\n    return {\n      id,\n      resourceAmount,\n      resourceModifier,\n      resourceType\n    };\n  }\n}","\nconst logRowsToKeep: number = 60; // last 1 seconds, at 60 fps\n\n/**\n * See https://www.npmjs.com/package/pixi-fps https://github.com/jkanchelov/pixi-fps\n */\nexport class FpsTracker {\n  private frameTimestampsInTicks: any[] = [];\n  private frameTimestampsInTime: any[] = [];\n\n  constructor() {\n    this.frameTimestampsInTicks.push(0);\n    // this.frameTimestampsInTime.push((new Date()).getTime());\n  }\n\n  /**\n   * @param ticksSinceLastUpdate should be the delta in ticks since the last update - will probably be a decimal close to 1\n   */\n  public tick(ticksSinceLastUpdate: number) {\n    let lastFrameTime = this.frameTimestampsInTicks[this.frameTimestampsInTicks.length - 1];\n    this.frameTimestampsInTicks.push(lastFrameTime + ticksSinceLastUpdate);\n    \n    // rotate logs\n    if (this.frameTimestampsInTicks.length > logRowsToKeep + 60) {\n      this.frameTimestampsInTicks = this.frameTimestampsInTicks.slice(60);\n    }\n\n    // do the same but track real time\n    this.frameTimestampsInTime.push((new Date()).getTime());\n    if (this.frameTimestampsInTime.length > logRowsToKeep + 60) {\n      this.frameTimestampsInTime = this.frameTimestampsInTime.slice(60);\n    }\n  }\n\n  // [0, 3, 4] -> 30 fps\n  public getUps() : number {\n    let ticksDiff = this.frameTimestampsInTicks[this.frameTimestampsInTicks.length - 1] - this.frameTimestampsInTicks[0];\n    let framesDiff = this.frameTimestampsInTicks.length - 1;\n\n    let framesPerTick = framesDiff / ticksDiff;\n    if (!framesPerTick) {\n      return 60;\n    }\n\n    return framesPerTick * 60;\n  }\n\n  public getFps(): number {\n    let timeDiff = this.frameTimestampsInTime[this.frameTimestampsInTime.length - 1] - this.frameTimestampsInTime[0];\n    let framesDiff = this.frameTimestampsInTime.length - 1;\n\n    let framesPerMilli = framesDiff / timeDiff;\n    if (!framesPerMilli) {\n      return 60;\n    }\n\n    return framesPerMilli * 1000;\n  }\n\n  public getFpsString(): string {\n    let fpsNumber = this.getFps();\n\n    return fpsNumber.toFixed(1);\n  }\n\n  public getUpsString(): string {\n    let upsNumber = this.getUps();\n\n    return upsNumber.toFixed(1);\n  }\n}","import * as Pixi from \"pixi.js\";\nimport { FpsTracker } from \"../../lib/util/fpsTracker\";\nimport { Vector2 } from \"../../lib/util/geometry/vector2\";\nimport { PixiPointFrom } from \"../../lib/pixi/pixify\";\nimport { engageLifecycle, LifecycleHandlerBase } from \"./LifecycleHandler\";\n\ntype Props = {\n  delta: number;\n  position: Vector2;\n  appSize: Vector2;\n}\n\ntype State = {\n  fpsTracker: FpsTracker\n}\n\n// export class FpsComponent {\n//   public container: Pixi.Text;\n//   staleProps: Props;\n//   state: State;\n\n//   constructor(props: Props) {\n//     this.container = new Pixi.Text('', {\n//       fontFamily: 'PixelMix',\n//       fontSize: 12,\n//       // align: 'right'\n//     });\n//     this.state = {\n//       fpsTracker: new FpsTracker()\n//     };\n//     this.staleProps = props;\n\n//     this.renderSelf(props)\n//   }\n\n//   public update(props: Props) {\n//     this.updateSelf(props);\n//     this.renderSelf(props);\n//   }\n\n//   updateSelf(props: Props) {\n//     this.state.fpsTracker.tick(props.delta);\n//   }\n//   renderSelf(props: Props) {\n//     this.container.text = this.state.fpsTracker.getFpsString() + \" FPS\\n\" +\n//       this.state.fpsTracker.getUpsString() + \" UPS\\n\" +\n//       props.appSize.x + \"x\" + props.appSize.y;\n//     this.container.position = PixiPointFrom(props.position);\n//   }\n// }\n\nclass FpsComponent extends LifecycleHandlerBase<Props, State> {\n  public container: Pixi.Text;\n  public state: State;\n\n  constructor(props: Props) {\n    super(props);\n    this.container = new Pixi.Text('', {\n      fontFamily: 'PixelMix',\n      fontSize: 12,\n      // align: 'right'\n    });\n    this.state = {\n      fpsTracker: new FpsTracker()\n    };\n  }\n\n  protected updateSelf(props: Props) {\n    this.state.fpsTracker.tick(props.delta);\n  }\n\n  protected renderSelf(props: Props) {\n    this.container.text = this.state.fpsTracker.getFpsString() + \" FPS\\n\" +\n      this.state.fpsTracker.getUpsString() + \" UPS\\n\" +\n      props.appSize.x + \"x\" + props.appSize.y;\n    this.container.position = PixiPointFrom(props.position);\n  }\n}\n\nconst wrapped = engageLifecycle(FpsComponent);\n// eslint-disable-next-line\ntype wrapped = FpsComponent;\nexport { wrapped as FpsComponent };","import * as Pixi from \"pixi.js\";\nimport { ChunkGen, ChunkRef, GameState, PointNodeRef, ZLevelGen } from \"../../data/GameState\";\nimport { ZLevelGenFactory } from \"../../game/WorldGenStateFactory\";\nimport { PixiPointFrom } from \"../../lib/pixi/pixify\";\nimport { HashSet, KeyedHashMap } from \"../../lib/util/data_structures/hash\";\nimport { Vector2 } from \"../../lib/util/geometry/vector2\";\nimport { Const } from \"../../lib/util/misc\";\nimport { UpdaterGeneratorType2 } from \"../../lib/util/updaterGenerator\";\nimport { RenderedChunkConstants, ChunkComponent, ChunkComponentProps } from \"./ChunkComponent\";\nimport { engageLifecycle, LifecycleHandlerBase } from \"./LifecycleHandler\";\n\ntype Props = {\n  delta: number,\n  args: {\n    pointNodeTexture: Pixi.Texture,\n    markForceUpdate: (childInstance: any) => void,\n  },\n  z: number,\n  updaters: UpdaterGeneratorType2<GameState>,\n  position: Vector2,\n  zLevelGen: Const<ZLevelGen> | undefined,\n  selectedPointNode: PointNodeRef | undefined,\n  allocatedPointNodeSubset: Const<HashSet<PointNodeRef>>,\n}\n\ntype State = {}\n\nclass ZLevelComponent2 extends LifecycleHandlerBase<Props, State> {\n  public container: Pixi.Container;\n  public state: State;\n\n  public children: KeyedHashMap<ChunkRef, ChunkComponent> = new KeyedHashMap();\n\n  constructor(props: Props) {\n    super(props);\n    this.state = {};\n    this.container = new Pixi.Container();\n\n    this.upsertChildren(props);\n  }\n\n  protected renderSelf(props: Props) {\n    this.container.position = PixiPointFrom(props.position);\n  }\n\n  protected didMount() {\n    const { updaters } = this._staleProps;\n    // if we mounted but our data is not generated, please generate ourselves\n    updaters.worldGen.zLevels.enqueueUpdate((prev, prevGameState) => {\n      if (!prev[this._staleProps.z]) {\n        return { [this._staleProps.z]: new ZLevelGenFactory({}).create({ seed: prevGameState.worldGen.seed, z: this._staleProps.z }) };\n      }\n      return prev;\n    })\n  }\n\n  protected didForceUpdateChild(instance: LifecycleHandlerBase<any, any>) {\n    // IMPORTANT! this is intended to raise the child that asked for a force update to the top so it isn't covered\n    // by other sibling pixi containers. however this code doesnt work well during the update call, for some reason (not sure why)\n    this.container.removeChild(instance.container);\n    this.container.addChild(instance.container);\n  }\n\n  protected shouldUpdate(prevProps: Props, prevState: State, props: Props, state: State): boolean {\n    for (let key of (Object.keys(prevProps) as (keyof Props)[])) {\n      if (key === 'delta' || key === 'args' || key === 'updaters') { continue; }\n      if (key === 'position') {\n        if (!prevProps[key].equals(props[key])) {\n          console.log(`zlevel shouldUpdate differed in ${key}, returning true`);\n          return true;\n        } else {\n          continue;\n        }\n      }\n      if (key === 'selectedPointNode') {\n        if (prevProps[key]?.hash() !== props[key]?.hash()) {\n          console.log(`zlevel shouldUpdate differed in ${key}, returning true`);\n          return true;\n        } else {\n          continue;\n        }\n      }\n      if (prevProps[key] !== props[key]) {\n        console.log(`zlevel shouldUpdate differed in ${key}, returning true`);\n        return true;\n      }\n    }\n    return false;\n  }\n\n  protected updateChildren(props: Props) {\n    this.upsertChildren(props);\n  }\n\n  private upsertChildren(props: Props) {\n    let childrenToDelete = this.children.clone(); // track which children need to be destroyed according to new props\n    console.log(`zlevel component have ${this.children.size()} children`)\n    for (let [chunkCoord, chunkGen] of props.zLevelGen?.chunks?.entries() || []) {\n      const { childKey, childPropsFactory } = this.doChild(props, chunkCoord, chunkGen);\n      let childComponent = this.children.get(childKey);\n      if (childComponent) {\n        // childComponent.update(childPropsFactory(props, this.state));\n        childrenToDelete.remove(childKey);\n      } else {\n        childComponent = new ChunkComponent(childPropsFactory(props, this.state));\n        this.children.put(childKey, childComponent);\n        // this.container.addChild(childComponent.container);\n        this.addChild({\n          childClass: ChunkComponent,\n          instance: childComponent,\n          propsFactory: childPropsFactory\n        });\n      }\n    }\n    console.log(`zlevel component have ${childrenToDelete.size()} children to delete`)\n    for (let [childKey, childComponent] of childrenToDelete.entries()) {\n      // childComponent.willUnmount();\n      this.children.remove(childKey);\n      // this.container.removeChild(childComponent.container);\n      // this._children.splice(this._children.findIndex(it => it.instance === childComponent), 1);\n      this.removeChild(childComponent);\n    }\n  }\n\n  private doChild(props: Props, chunkCoord: Vector2, chunkGen: ChunkGen): { childKey: ChunkRef, childPropsFactory: (p: Props, s: State) => ChunkComponentProps } {\n    const chunkRef = new ChunkRef({\n      z: props.z,\n      chunkCoord,\n      chunkId: chunkGen.id,\n    });\n\n    let childPropsFactory = (props: Props, state: State) => {\n      let allocatedPointNodeSubset = new HashSet(\n        props.allocatedPointNodeSubset.values().filter((pointNodeRef) => pointNodeRef.chunkCoord.equals(chunkRef.chunkCoord))\n      );\n\n      return {\n        delta: props.delta,\n        args: {\n          pointNodeTexture: props.args.pointNodeTexture,\n          markForceUpdate: this.markForceUpdate\n        },\n        selfChunkRef: chunkRef,\n        updaters: props.updaters,\n        position: chunkRef.chunkCoord.multiply(RenderedChunkConstants.CHUNK_SPACING_PX),\n        chunkGen: chunkGen,\n        // NOTE(bowei): for optimization, we dont tell other chunks about selected nodes in other chunks\n        selectedPointNode: (props.selectedPointNode?.chunkCoord.equals(chunkRef.chunkCoord) ? props.selectedPointNode : undefined),\n        allocatedPointNodeSubset,\n      };\n    }\n    return {\n      childKey: chunkRef,\n      childPropsFactory\n    };\n  }\n\n}\n\nconst wrapped = engageLifecycle(ZLevelComponent2);\n// eslint-disable-next-line\ntype wrapped = ZLevelComponent2;\nexport { wrapped as ZLevelComponent };\nexport type { Props as ZLevelComponentProps };","import * as Pixi from \"pixi.js\";\nimport { PixiPointFrom } from \"../../lib/pixi/pixify\";\nimport { Vector2 } from \"../../lib/util/geometry/vector2\";\nimport { engageLifecycle, LifecycleHandlerBase } from \"./LifecycleHandler\";\n\ntype Props = {\n  appSize: Vector2\n}\n\ntype State = {\n  position: Vector2;\n}\n\nclass ReticleComponent extends LifecycleHandlerBase<Props, State> {\n  public container: Pixi.Container;\n  public state: State;\n\n  constructor(props: Props) {\n    super(props);\n    this.container = new Pixi.Container();\n    this.state = {\n      position: props.appSize.multiply(0.5)\n    };\n\n    const outerCircle = new Pixi.Graphics();\n    outerCircle.lineStyle(2, 0x000000);\n    outerCircle.alpha = 0.5;\n    outerCircle.drawCircle(0, 0, 16);\n    outerCircle.interactive = true;\n    this.container.addChild(outerCircle)\n    outerCircle.moveTo(0, -8);\n    outerCircle.lineTo(0, 8);\n    outerCircle.moveTo(-8, 0);\n    outerCircle.lineTo(8, 0);\n  }\n\n  protected updateSelf(props: Props) {\n    this.state.position = props.appSize.multiply(0.5);\n  }\n  protected renderSelf(props: Props) {\n    this.container.position = PixiPointFrom(this.state.position);\n  }\n}\n\nconst wrapped = engageLifecycle(ReticleComponent);\n// eslint-disable-next-line\ntype wrapped = ReticleComponent;\nexport { wrapped as ReticleComponent };","import * as Pixi from \"pixi.js\";\nimport { PixiPointFrom } from \"../../lib/pixi/pixify\";\nimport { Vector2 } from \"../../lib/util/geometry/vector2\";\nimport { engageLifecycle, LifecycleHandlerBase } from \"./LifecycleHandler\";\n\ntype Props = {\n  args: {},\n  updaters: {},\n  delta: number,\n  tick: number,\n  position: Vector2,\n  efficiencyPercent: number // needs to be between 0 and 100\n}\n\ntype State = {}\n\n/**\n * Reference code for pixi gradient or blur filters:\n * https://github.com/pixijs/pixi.js/blob/dev/packages/filters/filter-blur/src/generateBlurFragSource.ts\n * https://github.com/pixijs/pixi.js/blob/dev/packages/filters/filter-blur/src/BlurFilterPass.ts\n * https://github.com/pixijs/pixi.js/tree/dev/packages/filters/filter-blur/src\n * https://pixijs.download/dev/docs/PIXI.Filter.html\n * https://github.com/pixijs/pixi-filters/blob/main/filters/radial-blur/src/RadialBlurFilter.js\n * https://github.com/pixijs/pixi-filters/blob/main/filters/radial-blur/src/radial-blur.frag\n * https://filters.pixijs.download/main/docs/index.html\n * https://www.html5gamedevs.com/topic/8424-how-to-blur-just-an-area/\n * https://www.html5gamedevs.com/topic/25539-create-gradient-filter-on-sprite/\n * https://filters.pixijs.download/main/docs/index.html\n * https://pixijs.io/examples/#/textures/gradient-resource.js\n * \n */\nclass EfficiencyBarComponent extends LifecycleHandlerBase<Props, State> {\n  public container: Pixi.Container;\n  public state: State = {}\n\n  private cornerRadius: number = 10;\n  private boundingBoxWidth: number = 100;\n  public boundingBox: Pixi.Graphics;\n\n  private innerBarWidth: number = 24;\n  private innerBarHeight: number = 200;\n  private textHeight: number = 24; // observed height of the title text, including padding at the top of the text\n  private paddingBottom: number = 12;\n  public innerBar: Pixi.Graphics;\n  public barBorder: Pixi.Graphics;\n  public filter!: Pixi.filters.BlurFilter;\n  public barFill: Pixi.Graphics;\n  public mask: Pixi.Graphics;\n    // object documentation: https://pixijs.download/dev/docs/PIXI.TextStyle.html\n\n  public titleText: Pixi.Text;\n  private textStyle: Partial<Pixi.TextStyle> = {\n    fontFamily: 'PixelMix',\n    padding: 4, // https://github.com/pixijs/pixi.js/issues/4500 -- otherwise on first load the text bounding box is calculated to be too small and the tops of the f's get cut off\n    fontSize: 26, // use 26 then scale down 50% results in sharper letters than 13\n    // align: 'center'\n  };\n\n  constructor(props: Props) {\n    super(props);\n    this.container = new Pixi.Container();\n    this.container.interactive = true;\n    this.container.sortableChildren = true;\n\n    this.titleText = new Pixi.Text('Efficiency', this.textStyle);\n    this.titleText.scale = PixiPointFrom(new Vector2(0.5, 0.5));\n    this.titleText.anchor = PixiPointFrom(new Vector2(0.5, 0.0)); // center ourselves, left-right\n    this.titleText.zIndex = 0;\n    this.titleText.x = 50; // full container width is 100, we want to be in the middle\n    this.titleText.y = 4; // bit of padding for the top\n    this.container.addChild(this.titleText);\n\n    this.boundingBox = new Pixi.Graphics();\n    this.boundingBox.beginFill(0xDDEEFF); // background color is the blue AACCEE, this is very light bluer than that\n    this.boundingBox.drawRoundedRect(\n      0, 0,\n      this.boundingBoxWidth,\n      this.textHeight + this.innerBarHeight + this.paddingBottom,\n      this.cornerRadius\n    ); // outerbar = the box containing the efficiency text + bar. 100px is just enough width for the word \"Efficiency\". 236px height was chosen arbitrarily\n    this.boundingBox.zIndex = -1;\n    this.boundingBox.alpha = .8; // let a bit of the background poke through. TODO: actually blur the background?? cant figure out how to do it\n    this.container.addChild(this.boundingBox);\n\n    this.innerBar = new Pixi.Graphics();\n    this.innerBar.beginFill(0xFFFFFF);\n    this.innerBar.drawRoundedRect(0, 0, this.innerBarWidth, this.innerBarHeight, this.cornerRadius); // we want the inner bar (containing the actual efficiency colors) to be 40 wide and 200 tall. round the corners at the same radius as the outer box.\n    // this.innerBar.x = 12;\n    this.innerBar.pivot.x = this.innerBarWidth/2; // this is our width over 2\n    this.innerBar.x = this.boundingBoxWidth/2; // this is outer bar width / 2\n    this.innerBar.y = this.textHeight; // this is just enough space below the \"Efficiency\" text to look nice\n    this.innerBar.zIndex = 3;\n    this.container.addChild(this.innerBar);\n\n    // rainbow red-green gradient for the contents of the inner bar\n    const barFillContainer = new Pixi.Container();\n    this.barFill = new Pixi.Graphics();\n    // source: https://www.schemecolor.com/red-orange-green-gradient.php\n    this.barFill.beginFill(0x69B34C);\n    this.barFill.drawRect(0, 0, this.innerBarWidth, this.innerBarHeight/5);\n    this.barFill.beginFill(0xACB334);\n    this.barFill.drawRect(0, 40, this.innerBarWidth, this.innerBarHeight/5);\n    this.barFill.beginFill(0xFAB733);\n    this.barFill.drawRect(0, 80, this.innerBarWidth, this.innerBarHeight/5);\n    this.barFill.beginFill(0xFF8E15);\n    this.barFill.drawRect(0, 120, this.innerBarWidth, this.innerBarHeight/5);\n    this.barFill.beginFill(0xFF4E11);\n    this.barFill.drawRect(0, 160, this.innerBarWidth, this.innerBarHeight/5);\n    this.barFill.pivot.x = this.innerBarWidth / 2;\n    this.barFill.x = this.boundingBoxWidth / 2;\n    this.barFill.y = this.textHeight; // same positioning as innerBar\n    this.barFill.zIndex = 4;\n    // this.container.addChild(this.barFill);\n    barFillContainer.addChild(this.barFill);\n    barFillContainer.zIndex = 4;\n    this.container.addChild(barFillContainer);\n\n    // this.barFill.filters = [this.filter];\n    // mask controls how much of the red-green gradient fillings are visible, depending on how well the player is doing\n    const maskContainer = new Pixi.Container();\n    // this mask moves up and down\n    this.mask = new Pixi.Graphics();\n    this.mask.beginFill(0x000000, 1); // color and alpha literally dont matter cuz its a mmask\n    this.mask.drawRoundedRect(0, 0, this.innerBarWidth, this.innerBarHeight, this.cornerRadius); // same dims as the inner bar. note that this doesnt take into account the line style of width 2, so it will cause the filling to leak over into the line style. to fix this barBorder is reapplied over the top to cover the leaks.\n    this.mask.zIndex = 30; // doesnt matter\n    this.mask.pivot.x = this.innerBarWidth/2; // left-right center in ourselves\n    this.mask.x = this.boundingBoxWidth/2; // center in the boundingBox\n    this.mask.y = this.textHeight; // same positioning as inner bar\n\n    // this mask does not\n    const fixedMask = new Pixi.Graphics();\n    fixedMask.beginFill(0x000000, 1); // color and alpha literally dont matter cuz its a mmask\n    fixedMask.drawRoundedRect(0, 0, this.innerBarWidth, this.innerBarHeight, this.cornerRadius); // same dims as the inner bar. note that this doesnt take into account the line style of width 2, so it will cause the filling to leak over into the line style. to fix this barBorder is reapplied over the top to cover the leaks.\n    fixedMask.zIndex = 31; // doesnt matter\n    fixedMask.pivot.x = this.innerBarWidth/2; // left-right center in ourselves\n    fixedMask.x = this.boundingBoxWidth/2; // center in the boundingBox\n    fixedMask.y = this.textHeight; // same positioning as inner bar\n\n    maskContainer.addChild(this.mask);\n    // maskContainer.addChild(fixedMask);\n    this.container.addChild(maskContainer);\n    // this.container.addChild(this.mask); // have to add child here -- not sure why\n    this.barFill.mask = maskContainer;\n\n    this.container.addChild(fixedMask);\n    barFillContainer.mask = fixedMask;\n\n    // another copy of innerbar, except this time the fill is transparent; we just need the line style to be redrawn so that \n    // the inner filling mask leakage gets hidden\n    this.barBorder = new Pixi.Graphics();\n    this.barBorder.lineStyle(2, 0x000000, 1);\n    // this.barBorder.beginFill(0x000000, 0);\n    this.barBorder.drawRoundedRect(0, 0, this.innerBarWidth, this.innerBarHeight, this.cornerRadius);\n    this.barBorder.pivot.x = this.innerBarWidth / 2;\n    this.barBorder.x = this.boundingBoxWidth / 2;\n    this.barBorder.y = this.textHeight;\n    this.barBorder.zIndex = 7;\n    this.container.addChild(this.barBorder);\n  }\n\n  public renderSelf(props: Props) {\n    this.container.position = PixiPointFrom(props.position);\n\n    if (props.tick < 60 && props.tick % 10 === 5) { // poll for document webfonts loaded; TODO, substitute for listening to actual fonts ready event\n      this.titleText.updateText(false); // false == force reload text even when text has not changed. needed to get new fonts\n    }\n\n    this.mask.y = (100 - props.efficiencyPercent) * 2 + 24;\n  }\n}\n\nconst wrapped = engageLifecycle(EfficiencyBarComponent);\n// eslint-disable-next-line\ntype wrapped = EfficiencyBarComponent;\nexport { wrapped as EfficiencyBarComponent };","import * as Pixi from \"pixi.js\";\nimport { Vector2 } from \"../../lib/util/geometry/vector2\";\nimport { ChunkGenConstants, GameState, IntentName} from \"../../data/GameState\";\nimport { generatePointNodeTexture } from \"../textures/PointNodeTexture\";\nimport { ZLevelGenFactory } from \"../../game/WorldGenStateFactory\";\nimport { Const, Lazy } from \"../../lib/util/misc\";\nimport { FpsComponent } from \"./FpsComponent\";\nimport { UpdaterGeneratorType2 } from \"../../lib/util/updaterGenerator\";\nimport { ZLevelComponent, ZLevelComponentProps } from \"./ZLevelComponent\";\nimport { ReticleComponent } from \"./ReticleComponent\";\nimport { EfficiencyBarComponent } from \"./EfficiencyBarComponent\";\nimport { engageLifecycle, LifecycleHandlerBase } from \"./LifecycleHandler\";\nimport { computeQuestEfficiencyPercent, remapQuestEfficiencyToDisplayable } from \"../../game/EfficiencyCalculator\";\n\ntype State = {\n  pointNodeTexture: Lazy<Pixi.Texture>;\n  tick: number;\n  playerCurrentZ: number;\n}\n\ntype Props = {\n  args: {\n    renderer: Pixi.Renderer,\n    markForceUpdate: (childInstance: any) => void,\n  },\n  updaters: UpdaterGeneratorType2<GameState>,\n  delta: number,\n  gameState: Const<GameState>,\n  appSize: Vector2\n}\n\nclass RootComponent2 extends LifecycleHandlerBase<Props, State> {\n  public container: Pixi.Container;\n  public state: State;\n  private stateUpdaters: UpdaterGeneratorType2<State>;\n  protected fireStateUpdaters: () => void;\n\n\n  /* children */\n  // Contains HUD, and other entities that don't move when game camera moves\n  public fixedCameraStage: Pixi.Container;\n  // Contains game entities that move when game camera pans/zooms. Highly encouraged to have further subdivions.\n  public actionStage: Pixi.Container;\n  // Contains a few entities that doesn't move when game camera moves, but located behind action stage entities, e.g. static backgrounds\n  public backdropStage: Pixi.Container;\n  // public keyboard: KeyboardState;\n  public fpsTracker: FpsComponent;\n  public zLevel: ZLevelComponent | undefined;\n  public zLevelPropsFactory: (p: Props, s: State) => ZLevelComponentProps;\n  public reticle: ReticleComponent;\n  public backdrop: Pixi.Graphics;\n  public efficiencyBar: EfficiencyBarComponent;\n\n  constructor(props: Props) {\n    super(props);\n    this.container = new Pixi.Container();\n    this.container.sortableChildren = true;\n    ({ state: this.state, stateUpdaters: this.stateUpdaters, fireStateUpdaters: this.fireStateUpdaters } =\n      this.useState<State, RootComponent2>(this, {\n      pointNodeTexture: new Lazy(() => generatePointNodeTexture(props.args.renderer)),\n      tick: 0,\n      playerCurrentZ: 0,\n      }));\n\n    this.fixedCameraStage = new Pixi.Sprite();\n    this.fixedCameraStage.zIndex = 1;\n    this.fixedCameraStage.sortableChildren = true;\n    this.container.addChild(this.fixedCameraStage);\n\n    this.actionStage = new Pixi.Sprite();\n    this.actionStage.zIndex = 0;\n    this.actionStage.sortableChildren = true;\n    this.container.addChild(this.actionStage);\n\n    this.backdropStage = new Pixi.Sprite();\n    this.backdropStage.zIndex = -1;\n    this.backdropStage.sortableChildren = true;\n    this.container.addChild(this.backdropStage);\n\n    let fpsTrackerPropsFactory = (props: Props, state: State) => {\n      return {\n        delta: props.delta,\n        position: new Vector2(0, 0),\n        appSize: props.appSize,\n      };\n    };\n    this.fpsTracker = new FpsComponent(fpsTrackerPropsFactory(props, this.state));\n    this.registerChild({\n      childClass: FpsComponent,\n      instance: this.fpsTracker,\n      propsFactory: fpsTrackerPropsFactory,\n    })\n    // this is not container.addChild, so let's manage this ourselves, outside of lifecyclehandler\n    this.fixedCameraStage.addChild(this.fpsTracker.container);\n\n    this.backdrop = new Pixi.Graphics();\n    this.backdropStage.addChild(this.backdrop);\n    this.backdrop.beginFill(0xabcdef, 1);\n    // backdrop.alpha = 0.5; // if alpha == 0, Pixi does not register this as a hittable area\n    this.backdrop.interactive = true;\n    // backdrop.interactiveChildren = true; // not sure what this does\n    this.backdrop.drawRect(0, 0, props.appSize.x, props.appSize.y);\n\n\n    const reticlePropsFactory = (props: Props, state: State) => {\n      return {\n        appSize: props.appSize,\n      };\n    };\n    this.reticle = new ReticleComponent(reticlePropsFactory(props, this.state));\n    this.registerChild({\n      childClass: ReticleComponent,\n      instance: this.reticle,\n      propsFactory: reticlePropsFactory,\n    });\n    this.fixedCameraStage.addChild(this.reticle.container);\n\n    this.zLevelPropsFactory = (props: Props, state: State): ZLevelComponentProps => {\n      return {\n        delta: props.delta,\n        args: {\n          pointNodeTexture: state.pointNodeTexture.get(),\n          markForceUpdate: this.markForceUpdate,\n        },\n        z: state.playerCurrentZ,\n        updaters: props.updaters,\n        position: props.appSize.multiply(0.5),\n        zLevelGen: props.gameState.worldGen.zLevels[state.playerCurrentZ],\n        selectedPointNode: props.gameState.playerUI.selectedPointNode,\n        allocatedPointNodeSubset: props.gameState.playerSave.allocatedPointNodeSet,\n      };\n    }\n    this.zLevel = new ZLevelComponent(this.zLevelPropsFactory(props, this.state));\n    this.actionStage.addChild(this.zLevel.container);\n    this.registerChild({\n      childClass: ZLevelComponent,\n      instance: this.zLevel,\n      propsFactory: this.zLevelPropsFactory,\n    });\n\n    let efficiencyBarPropsFactory = (props: Props, state: State) => {\n      return {\n        delta: props.delta,\n        args: {},\n        updaters: {},\n        tick: state.tick,\n        position: new Vector2(60, 60),\n        efficiencyPercent: remapQuestEfficiencyToDisplayable(computeQuestEfficiencyPercent(props.gameState.playerSave)),\n      };\n    };\n    this.efficiencyBar = new EfficiencyBarComponent(efficiencyBarPropsFactory(props, this.state));\n    this.registerChild({\n      childClass: EfficiencyBarComponent,\n      instance: this.efficiencyBar,\n      propsFactory: efficiencyBarPropsFactory,\n    });\n    this.fixedCameraStage.addChild(this.efficiencyBar.container);\n  }\n\n  protected updateSelf(props: Props) {\n    this.state.tick++;\n\n    const activeIntent = props.gameState.intent.activeIntent;\n    let deltaX = 0;\n    let deltaY = 0;\n    const unit = 5 * props.delta;\n    // if we want to pan [the hud] west (i.e. the left key was pressed), action stage needs to move east\n    if (activeIntent[IntentName.PAN_WEST]) deltaX += unit;\n    if (activeIntent[IntentName.PAN_EAST]) deltaX += -unit;\n    // if we want to pan south (i.e. the down key was pressed), action stage needs to move north to give the impression\n    // the hud is moving south. note that north is negative y direction since top left is 0,0\n    if (activeIntent[IntentName.PAN_SOUTH]) deltaY += -unit;\n    if (activeIntent[IntentName.PAN_NORTH]) deltaY += unit;\n    this.actionStage.x += deltaX;\n    this.actionStage.y += deltaY;\n\n    if (props.gameState.intent.newIntent[IntentName.TRAVEL_IN]) {\n      this.state.playerCurrentZ--;\n\n      // scale by a factor of 9\n      this.actionStage.x *= ChunkGenConstants.CHUNK_DIM;\n      this.actionStage.y *= ChunkGenConstants.CHUNK_DIM;\n\n      console.log({ currentZ: this.state.playerCurrentZ });\n    }\n    if (props.gameState.intent.newIntent[IntentName.TRAVEL_OUT]) {\n      this.state.playerCurrentZ++;\n\n      this.actionStage.x /= ChunkGenConstants.CHUNK_DIM;\n      this.actionStage.y /= ChunkGenConstants.CHUNK_DIM;\n      console.log({ currentZ: this.state.playerCurrentZ });\n    }\n  }\n\n  protected renderSelf(props: Props) {\n    this.backdrop.width = props.appSize.x;\n    this.backdrop.height = props.appSize.y;\n  }\n\n  protected didMount() {\n    const { updaters } = this._staleProps;\n    this.backdrop.addListener('pointerdown', (event) => {\n      updaters.playerUI.selectedPointNode.enqueueUpdate((prev, whole) => {\n        return undefined;\n      })\n    });\n  }\n\n  protected didUpdate() {\n    const { updaters } = this._staleProps;\n    // if we find ourselves a little idle, start pregenerating other layers\n    if (this.state.tick > 60 && !this._staleProps.gameState.worldGen.zLevels[-1]) {\n      updaters.worldGen.zLevels.enqueueUpdate((prev, prevGameState) => {\n        if (!prev[-1]) {\n          prev[-1] = new ZLevelGenFactory({}).create({ seed: prevGameState.worldGen.seed, z: -1 });\n          return {...prev};\n        } else {\n          return prev;\n        }\n      })\n    }\n    if (this.state.tick > 120 && !this._staleProps.gameState.worldGen.zLevels[1]) {\n      updaters.worldGen.zLevels.enqueueUpdate((prev, prevGameState) => {\n        if (!prev[1]) {\n          prev[1] = new ZLevelGenFactory({}).create({ seed: prevGameState.worldGen.seed, z: 1 });\n          return {...prev};\n        } else {\n          return prev;\n        }\n      })\n    }\n  }\n\n}\n\n\nconst wrapped = engageLifecycle(RootComponent2);\n// eslint-disable-next-line\ntype wrapped = RootComponent2;\nexport { wrapped as RootComponent };\nexport type { Props as ZLevelComponentProps };","import * as Pixi from \"pixi.js\";\nimport { RenderedChunkConstants } from \"../components/ChunkComponent\";\n\nexport function generatePointNodeTexture(renderer: Pixi.Renderer) {\n    let g = new Pixi.Graphics();\n    g.beginFill(0xffffff);\n    g.drawRoundedRect(\n      - RenderedChunkConstants.NODE_SIZE_PX / 2,\n      - RenderedChunkConstants.NODE_SIZE_PX / 2,\n      RenderedChunkConstants.NODE_SIZE_PX,\n      RenderedChunkConstants.NODE_SIZE_PX,\n      RenderedChunkConstants.NODE_ROUNDED_PX\n    );\n    // g.x = 200;\n    // g.y = 200;\n    // this.app.stage.addChild(g);\n    let texture = renderer.generateTexture(g, Pixi.SCALE_MODES.NEAREST, 1);\n    // const sprite = new Pixi.Sprite(texture);\n    // sprite.x = 300;\n    // sprite.y = 300;\n    // this.app.stage.addChild(sprite);\n  return texture;\n}","import * as Pixi from \"pixi.js\";\nimport { Vector2 } from \"../lib/util/geometry/vector2\";\nimport { GameState, WindowState } from \"../data/GameState\";\n// eslint-disable-next-line\nimport { assertOnlyCalledOnce, Const } from \"../lib/util/misc\";\nimport { RootComponent } from \"./components/RootComponent\";\nimport { UpdaterGeneratorType2 } from \"../lib/util/updaterGenerator\";\n\ntype Props = {\n  args: {\n    fireBatch: () => void,\n    isSecondConstructorCall: boolean\n  },\n  updaters: UpdaterGeneratorType2<GameState>, // aka updaters\n  windowState: Const<WindowState>,\n  gameState: Const<GameState>,\n}\n\ntype State = {\n  appSize: Vector2,\n  originalAppSize: Vector2,\n}\n\nfunction appSizeFromWindowSize(window?: Const<Vector2>): Vector2 {\n  return new Vector2({\n    x: Math.min(1920, (window?.x || Infinity) - 24),\n    y: Math.min(1080, (window?.y || Infinity) - 24),\n  });\n}\n\n/**\n * TODO(bowei): move the resizing out of this function and into root component,\n * and only handle react/pixi state management in this class\n */\nexport class PixiReactBridge {\n  public app!: Pixi.Application;\n\n  state!: State;\n  props!: Props;\n\n  rootComponent: RootComponent | undefined;\n  onTick!: (d: number) => void;\n\n  /**\n   * NOTE: for lifecycle convenience, we allow initializing with essentially empty props, and to finish the initialization\n   * lazily at the first rerender() call\n   */\n  constructor(props?: Props, isSecondConstructorCall: boolean = false) {\n    // verify that we are not loading this twice when we expect to load it only once -- bad for performance!!\n    if (!(props?.args?.isSecondConstructorCall || isSecondConstructorCall)) {\n      // assertOnlyCalledOnce(\"Pixi react bridge constructor\"); // annoying with react hot reload, disable for now}\n    }\n\n    let appSize = new Vector2(800, 600);\n    this.state = {\n      appSize,\n      originalAppSize: appSize\n    }\n\n    this.app = new Pixi.Application({\n      width: this.state.appSize.x,\n      height: this.state.appSize.y,\n      antialias: true, // both about the same FPS, i get around 30 fps on 1600 x 900\n      transparent: true, // true -> better fps?? https://github.com/pixijs/pixi.js/issues/5580\n      resolution: window.devicePixelRatio || 1, // lower -> more FPS but uglier\n      // resolution: 0.5,\n      // resolution: 2,\n      autoDensity: true,\n      powerPreference: \"low-power\", // the only valid one for webgl\n      backgroundColor: 0xffffff, // immaterial - we recommend setting color in backdrop graphics\n    });\n\n    // test\n    // createBunnyExample({ parent: this.app.stage, ticker: this.app.ticker, x: this.app.screen.width / 2, y: this.app.screen.height / 2 });\n  }\n\n  public pause() {\n    this.app.ticker.remove(this.onTick);\n  }\n  public destroy() {\n    this.app.destroy(true, { children: true, texture: true, baseTexture: true });\n  }\n\n  public didMount() {\n    this.onTick = (delta) => this.baseGameLoop(delta);\n    this.onTick = this.onTick.bind(this);\n    this.app.ticker.add(this.onTick);\n  }\n\n  /**\n   * Please only call once!!\n   * Usage: const container = useRef<HTMLDivElement>(null); useEffect(() => { application.register(container.current!); }, []);\n   */\n  public register(curr: HTMLDivElement) {\n    curr.appendChild(this.app.view);\n  }\n\n  updateSelf(props: Props) {\n    this.state.appSize = appSizeFromWindowSize(new Vector2(props.windowState.innerWidth, props.windowState.innerHeight));\n  }\n\n  // shim, called from react, possibly many times , possibly at any time, including during the baseGameLoop below\n  // props should be a referentially distinct object from props the last time this was called\n  rerender(props: Props) {\n    console.log(\"base app rerender called\", { playerUI: props.gameState.playerUI });\n    this.props = props;\n    if (!this.rootComponent) {\n      // finish initialization\n      this.rootComponent = new RootComponent({\n        args: {\n          renderer: this.app.renderer,\n          markForceUpdate: () => { },\n        },\n        updaters: this.props.updaters,\n        delta: 0,\n        gameState: this.props.gameState,\n        appSize: this.state.appSize,\n      })\n      this.app.stage.addChild(this.rootComponent.container);\n\n      this.renderSelf(this.props);\n\n      // test\n      // createBunnyExample({ parent: this.app.stage, ticker: this.app.ticker, x: this.app.screen.width / 2, y: this.app.screen.height / 2 });\n      this.didMount();\n    }\n  }\n\n  renderSelf(props: Props) {\n    this.app.renderer.resize(this.state.appSize.x, this.state.appSize.y);\n  }\n\n  baseGameLoop(delta: number) {\n    // assume props is up to date\n    this.updateSelf(this.props);\n    // send props downwards\n    this.rootComponent?.update({\n      args: {\n        renderer: this.app.renderer,\n        markForceUpdate: () => { },\n      },\n      updaters: this.props.updaters,\n      delta,\n      gameState: this.props.gameState,\n      appSize: this.state.appSize,\n    });\n    \n    this.renderSelf(this.props);\n    this.props.args.fireBatch(); // fire enqueued game state updates, which should come back from react in the rerender()\n  }\n}\n","import { GameState, PointNodeRef, noIntent } from \"../data/GameState\";\nimport { HashSet } from \"../lib/util/data_structures/hash\";\nimport { Vector2 } from \"../lib/util/geometry/vector2\";\nimport { assertOnlyCalledOnce } from \"../lib/util/misc\";\nimport { computePlayerResourceAmounts } from \"./ComputeState\";\nimport { ZLevelGenFactory } from \"./WorldGenStateFactory\";\n\nexport type GameStateConfig = any;\n\nexport class GameStateFactory {\n  public config: GameStateConfig;\n\n  constructor(config: GameStateConfig) {\n    this.config = config;\n  }\n\n  public create(seed: number | undefined | null = undefined): GameState {\n    if (seed === undefined) {\n      assertOnlyCalledOnce(\"GameStateFactory.create\");\n    }\n    const mySeed = seed || 0x19283;\n\n    const zLevel = new ZLevelGenFactory({}).create({\n      seed: mySeed,\n      z: 0,\n      startingChunks: 0,\n    });\n    const origin = new Vector2(0, 0);\n    const firstId = zLevel.chunks.get(origin)?.pointNodes.get(origin)?.id!;\n    const pointNodeRef: PointNodeRef = new PointNodeRef({\n      z: 0,\n      chunkCoord: origin,\n      pointNodeId: firstId,\n      pointNodeCoord: origin,\n    });\n\n    const gameState = {\n      worldGen: {\n        seed: mySeed,\n        zLevels: { 0: zLevel },\n      },\n      playerSave: {\n        availableSp: 0,\n        // justAllocated: undefined,\n        activeQuest: undefined,\n        batchesSinceQuestStart: 0,\n        spSpentThisQuest: undefined,\n        questProgressHistory: [],\n        questInitialAmount: 0,\n        questsCompleted: [],\n        allocatedPointNodeSet: new HashSet([pointNodeRef]),\n        allocatedPointNodeHistory: [pointNodeRef],\n        score: 0,\n      },\n      playerUI: {\n        selectedPointNode: undefined,\n        activeTab: 0,\n      },\n      computed: {},\n      intent: {\n        activeIntent: noIntent,\n        newIntent: noIntent,\n        endedIntent: noIntent,\n      },\n    };\n    gameState.computed = { ...computePlayerResourceAmounts(gameState) };\n    return gameState;\n  }\n}\n","import React, { useContext, useMemo, useState } from \"react\";\nimport \"./PixiComponent.css\";\nimport { GameState, WindowState } from \"../data/GameState\";\nimport { PixiWrapperComponent } from \"./PixiWrapperComponent\";\nimport { Lazy } from \"../lib/util/misc\";\nimport { PixiReactBridge } from \"../pixi/PixiReactBridge\";\nimport { UseGameStateContext } from \"../contexts\";\nimport { GameStateFactory } from \"../game/GameStateFactory\";\nimport { batchifySetState } from \"../lib/util/batchify\";\n\nconst initialApplication = new Lazy(() => new PixiReactBridge());\n\nexport function PixiComponent(props: { originalSetGameState: Function }) {\n  // eslint-disable-next-line\n  const [_, gameStateUpdaters]  = useContext(UseGameStateContext);\n  const [windowState, setWindowState] = useState<WindowState>({\n    orientation: \"original\",\n    innerHeight: window.innerHeight,\n    innerWidth: window.innerWidth,\n  });\n  let [batchedSetWindowState, fireBatchedSetWindowState] =\n    useMemo(() => batchifySetState(setWindowState), [setWindowState]);\n\n  // needed to prevent react double-render for some reason (dev mode??)\n  const [application, setApplication] = useState(initialApplication.get());\n\n  window.onresize = () => {\n    batchedSetWindowState(old => {\n      old.innerWidth = window.innerWidth;\n      old.innerHeight = window.innerHeight;\n      return { ...old };\n    })\n  };\n\n  return (\n    <>\n      <PixiWrapperComponent application={application} windowState={windowState} fireBatchedSetWindowState={fireBatchedSetWindowState}/>\n      <button onClick={() => {\n        gameStateUpdaters.enqueueUpdate((old) => {\n          let newGameState = new GameStateFactory({}).create(old.worldGen.seed);\n          old.playerSave = newGameState.playerSave;\n          old.playerUI = newGameState.playerUI;\n          old.worldGen = newGameState.worldGen;\n          return old\n        });\n      }}>Reset game state</button>\n      <button onClick={() => {\n        application.pause();\n        application.destroy();\n        setApplication(new PixiReactBridge(undefined, true));\n\n        let newGameState = new GameStateFactory({}).create(+new Date());\n        props.originalSetGameState((old: GameState) => {\n          old.playerSave = newGameState.playerSave;\n          old.playerUI = newGameState.playerUI;\n          old.worldGen = newGameState.worldGen;\n          return old\n        });\n      }}>Get a fresh seed, reset, and rerender</button>\n      <button\n        onClick={() => {\n          application.pause();\n          application.destroy();\n          setApplication(new PixiReactBridge(undefined, true));\n        }}\n      >\n        Rerender pixi application\n      </button>\n    </>\n  );\n}\n","import \"./QuestProgress.css\";\n\nimport classnames from \"classnames\";\nimport React, { useEffect, useState } from \"react\";\nimport { GameState, Quest, ResourceType } from \"../data/GameState\";\nimport { UpdaterGeneratorType2 } from \"../lib/util/updaterGenerator\";\n\ntype Props = {\n  remainingPoints: number;\n  spSpentThisQuest: number | undefined;\n  createQuestCb: () => void;\n  activeQuest: Quest | undefined;\n  numBatches: number;\n  playerResourceAmounts?: { [k in ResourceType]: number };\n  updaters: UpdaterGeneratorType2<GameState, GameState>[\"playerSave\"];\n  efficiencyGrade: string;\n  score: GameState[\"playerSave\"][\"score\"];\n  questInitialAmount: number;\n};\ntype QuestScoreDetails = {\n  total: number;\n  scoreComponents: ScoreComponent[];\n};\ntype ScoreComponent = {\n  inputAmount: number;\n  inputTitle: string;\n  outputScore: number;\n  outputDescription: string;\n};\n\nexport default React.memo(QuestProgressComponent);\n\nfunction QuestProgressComponent({\n  activeQuest,\n  spSpentThisQuest,\n  createQuestCb,\n  numBatches,\n  playerResourceAmounts,\n  updaters,\n  efficiencyGrade,\n  score,\n  questInitialAmount,\n}: Props) {\n  const [scoreDetails, setScoreDetails] = useState<QuestScoreDetails>({\n    total: 0,\n    scoreComponents: [],\n  });\n  const isQuestComplete =\n    activeQuest &&\n    (playerResourceAmounts?.[activeQuest.resourceType] || 0) >=\n      activeQuest.resourceAmount;\n  function calculateQuestScoreDetails() {\n    const questScore: { scoreComponents: ScoreComponent[] } = {\n      scoreComponents: [],\n    };\n    questScore.scoreComponents.push({\n      inputAmount: 1,\n      inputTitle: \"quest completed\",\n      outputScore: 5,\n      outputDescription: \"\",\n    });\n    questScore.scoreComponents.push({\n      inputAmount: numBatches,\n      inputTitle: \"nodes allocated\",\n      outputScore: Math.floor(10 / (numBatches + 1)),\n      outputDescription: \"efficiency\",\n    });\n    const total = questScore.scoreComponents.reduce(\n      (subtotal, prev) => subtotal + prev.outputScore,\n      0\n    );\n    console.log(total);\n    return { ...questScore, total };\n  }\n  const doClaimReward = () => {\n    const questScore = calculateQuestScoreDetails();\n    updaters.score.enqueueUpdate((lastScore) => {\n      console.log({ score, lastScore, questScore });\n      console.log(\"updating score\");\n      return lastScore + questScore.total;\n    });\n    updaters.activeQuest.enqueueUpdate(() => {\n      return undefined;\n    });\n    setScoreDetails(questScore);\n  };\n  const handleStartQuest = () => {\n    // setOldPoints()\n    createQuestCb();\n  };\n  return (\n    <>\n      {<Score score={score} scoreDetails={scoreDetails} />}\n      {activeQuest === undefined ? (\n        <>\n          <h2>No active quest\n          </h2>\n          <br></br>\n          <button className=\"button\" onClick={handleStartQuest}>\n            Start a quest\n          </button>\n          <br></br>\n          <br></br>\n          <br></br>\n        </>\n      ) : (\n        <>\n            <h2> Active quest: </h2>\n            <table className={classnames({ table: true })}>\n              <tr>\n                <td>\n                  Initial\n                </td>\n                <td>\n                  {questInitialAmount} {activeQuest.resourceType}\n                </td>\n              </tr>\n              <tr>\n                <td>\n                  Current\n                </td>\n                <td>\n                  {playerResourceAmounts?.[activeQuest.resourceType]} {activeQuest.resourceType}\n                </td>\n              </tr>\n              <tr>\n                <td>\n                  Target\n                </td>\n                <td>\n                  {activeQuest.resourceAmount} {activeQuest.resourceType}\n                </td>\n              </tr>\n              <tr>\n                <td>\n                  SP spent\n                </td>\n                <td>\n                  {spSpentThisQuest === undefined ? \"\" : spSpentThisQuest}\n                </td>\n              </tr>\n              <tr>\n                <td>\n                  Efficiency\n                </td>\n                <td>\n                  {efficiencyGrade}\n                </td>\n              </tr>\n            </table>\n\n          {isQuestComplete ? (\n            <>\n              <br></br>\n              <button\n                className=\"button\"\n                onClick={() => {\n                  doClaimReward();\n                }}\n              >\n                Claim reward\n              </button>\n            </>\n          ) : (\n            <></>\n          )}\n        </>\n      )}\n    </>\n  );\n}\n\nfunction Score({\n  scoreDetails,\n  score,\n}: {\n  score: number;\n  scoreDetails: QuestScoreDetails;\n}) {\n  const [viewed, setViewed] = useState(true);\n  useEffect(() => {\n    console.log({ scoreDetails });\n    if (scoreDetails.total === 0) return;\n    setViewed(false);\n  }, [scoreDetails]);\n  return (\n    <>\n      {!viewed && (\n        <>\n          <h3>Score: {score}</h3>\n          {!!scoreDetails.total && (\n            <h4>Your score increased by {scoreDetails.total}!</h4>\n          )}\n          {scoreDetails.scoreComponents.map((scoreComponent) => {\n            return (\n              <React.Fragment key={scoreComponent.inputTitle}>\n                <h5>\n                  {scoreComponent.outputDescription &&\n                    scoreComponent.outputDescription + \": \"}\n                  {formatDelta(scoreComponent.outputScore)} score for{\" \"}\n                  {scoreComponent.inputAmount} {scoreComponent.inputTitle}\n                </h5>\n              </React.Fragment>\n            );\n          })}\n          <button onClick={() => setViewed(true)}>OK</button>\n        </>\n      )}\n    </>\n  );\n}\n\nfunction formatDelta(d: number): string {\n  return d < 0 ? d.toString() : \"+\" + d.toString();\n}\n","import React from \"react\";\nimport \"./Sidebar.css\";\n\nexport default function Sidebar({ children }: any) {\n  return <div className=\"layout\">{children}</div>;\n}\n","import React from \"react\";\nexport default function TabContent({ showContent, children }: any) {\n  return <div hidden={!showContent}>{children}</div>;\n}\n","import React from \"react\";\nimport \"./Tabs.css\";\n\nexport default function Tabs({ value, labels, onChange } : any) {\n  return (\n    <div className={\"tab-label-container\"}>\n      {labels.map((label: any, i : any) => (\n        <Tab onClick={onChange} value={i} active={value === i} key={i}>\n          {label}\n        </Tab>\n      ))}\n    </div>\n  );\n}\n\nfunction Tab({ onClick, value, active, children } : any) {\n  const handleClick = () => {\n    onClick(value);\n  };\n  return (\n    <div className={active ? \"tab-label active\" : \"tab-label inactive\"}>\n      <div onClick={handleClick}>{children}</div>\n    </div>\n  );\n}\n","import \"./App.css\";\n\nimport classnames from \"classnames\";\nimport React, { useCallback, useMemo, useState } from \"react\";\nimport UAParser from \"ua-parser-js\";\nimport { DebugTab } from \"./components/DebugTab\";\nimport { KeyboardControlComponent } from \"./components/KeyboardControl\";\nimport { NodeDetail } from \"./components/NodeDetail\";\nimport { PixiComponent } from \"./components/PixiComponent\";\nimport QuestProgress from \"./components/QuestProgress\";\nimport Sidebar from \"./components/Sidebar\";\nimport TabContent from \"./components/TabContent\";\nimport Tabs from \"./components/Tabs\";\nimport { UseGameStateContext } from \"./contexts\";\nimport { GameState } from \"./data/GameState\";\nimport { GameStateFactory } from \"./game/GameStateFactory\";\nimport { createQuest } from \"./game/QuestFactory\";\nimport { batchifySetState } from \"./lib/util/batchify\";\nimport { Lazy } from \"./lib/util/misc\";\nimport { updaterGenerator2 } from \"./lib/util/updaterGenerator\";\nimport { computeQuestEfficiencyPercent, remapQuestEfficiencyToGrade } from \"./game/EfficiencyCalculator\";\n\n// TODO(bowei): on mobile, for either ios or android, when in portrait locked orientation, we want to serve a landscape\n// experience - similar to a native app which is landscape locked.\n// (on mobile in already landscape orientation, and in all desktop, serve ordinary orientation.)\n// also note that android webapp supports manifest.json setting orientation, but not in the browser\n// FOR NOW - ignore this\nconst browser = new UAParser().getBrowser();\nlet forceRotate = false;\nif (\n  browser.name === \"Mobile Safari\" &&\n  window.innerWidth < window.innerHeight\n) {\n  forceRotate = true;\n}\n\nconst tabLabels = [\"Quest Progress\", \"Node Details\", \"Debug\"];\n\nconst initialGameState: Lazy<GameState> = new Lazy(() =>\n  new GameStateFactory({}).create()\n);\n\nfunction App() {\n  const [gameState, setGameState] = useState<GameState>(function factory() {\n    return initialGameState.get();\n  });\n\n  let [batchedSetGameState, fireBatch] = useMemo(\n    () => batchifySetState(setGameState),\n    [setGameState]\n  );\n  let updaters = useMemo(\n    () => updaterGenerator2(initialGameState.get(), batchedSetGameState),\n    [batchedSetGameState]\n  );\n  let createQuestCb = useCallback(() => createQuest(updaters, gameState), [\n    updaters,\n    gameState,\n  ]);\n\n  let tabViews: JSX.Element[] = [];\n  tabViews = [\n    <QuestProgress\n      remainingPoints={gameState.playerSave.availableSp}\n      spSpentThisQuest={gameState.playerSave.spSpentThisQuest}\n      createQuestCb={createQuestCb}\n      activeQuest={gameState.playerSave.activeQuest}\n      numBatches={gameState.playerSave.batchesSinceQuestStart}\n      playerResourceAmounts={gameState.computed.playerResourceAmounts}\n      updaters={updaters.playerSave}\n      score={gameState.playerSave.score}\n      efficiencyGrade={remapQuestEfficiencyToGrade(computeQuestEfficiencyPercent(gameState.playerSave))}\n      questInitialAmount={gameState.playerSave.questInitialAmount}\n    />,\n    <NodeDetail\n      selectedPointNode={gameState.playerUI.selectedPointNode}\n      allocatedPointNodeSet={gameState.playerSave.allocatedPointNodeSet}\n      worldGen={gameState.worldGen}\n      availableSp={gameState.playerSave.availableSp}\n    />,\n    <DebugTab\n      selectedPointNode={gameState.playerUI.selectedPointNode}\n      allocatedPointNodeSet={gameState.playerSave.allocatedPointNodeSet}\n      worldGen={gameState.worldGen}\n      availableSp={gameState.playerSave.availableSp}\n      playerSave={gameState.playerSave}\n      computed={gameState.computed}\n    />,\n  ];\n  return (\n    <div className={classnames({ App: true, \"force-landscape\": forceRotate })}>\n      <UseGameStateContext.Provider value={[gameState, updaters, fireBatch]}>\n        <PixiComponent originalSetGameState={setGameState} />\n        <Sidebar>\n          <Tabs\n            value={gameState.playerUI.activeTab}\n            labels={tabLabels}\n            onChange={updaters.playerUI.activeTab.getUpdater()}\n          />\n          {tabViews.map((component, i) => {\n            return (\n              <TabContent\n                key={i}\n                showContent={gameState.playerUI.activeTab === i}\n              >\n                {component}\n              </TabContent>\n            );\n          })}\n        </Sidebar>\n      </UseGameStateContext.Provider>\n      <KeyboardControlComponent\n        intent={gameState.intent}\n        updaters={updaters.intent}\n      ></KeyboardControlComponent>\n    </div>\n  );\n}\n\nexport default App;\n","import {\n  GameState,\n  ResourceType,\n} from \"../data/GameState\";\nimport { INTMAX32, squirrel3 } from \"../lib/util/random\";\nimport { UpdaterGeneratorType2 } from \"../lib/util/updaterGenerator\";\n\nexport function createQuest(\n  updaters: UpdaterGeneratorType2<GameState>,\n  gameState: GameState,\n  // config: QuestFactoryConfig = {}\n) {\n  updaters.playerSave.questsCompleted.enqueueUpdate((prev, prevGameState) => {\n    let next = [...prev];\n    prevGameState.playerSave.activeQuest && next.push(prevGameState.playerSave.activeQuest);\n    return next;\n  });\n  updaters.playerSave.activeQuest.enqueueUpdate((prev, prevGameState) => {\n    const numQuestsCompleted = prevGameState.playerSave.questsCompleted.length;\n    const totalAllocatedNodes = gameState.computed.playerResourceNodesAggregated?.size() || 5;\n\n    // const r = Math.floor(Math.random() * 3) as 0 | 1 | 2;\n    // const resource = Object.values(ResourceNontrivialType)[r];\n    const resourceType = ResourceType.Mana0;\n    const currentResourceAmount = gameState.computed.playerResourceAmounts?.[resourceType] || 50;\n\n    const historicalAmountPerNode = currentResourceAmount / totalAllocatedNodes; // how much benefit, on average, each node gave\n\n    // we want # of nodes to be quadratic with the # of quests completed\n    const targetNumAllocatedNodes = totalAllocatedNodes + Math.round(Math.sqrt(totalAllocatedNodes) * 3 - 2);\n    const randomScale = (squirrel3(prevGameState.worldGen.seed + numQuestsCompleted) / INTMAX32) * 0.4 + 0.8; // 0.8 - 1.2\n\n    const resourceAmount = Math.round(targetNumAllocatedNodes * historicalAmountPerNode * randomScale);\n    return {\n      resourceType,\n      resourceAmount,\n      description: \"\"\n    };\n  });\n  updaters.playerSave.batchesSinceQuestStart.enqueueUpdate((prev) => {\n    return 1;\n  });\n  updaters.playerSave.availableSp.enqueueUpdate((prev) => {\n    return 1;\n  });\n  updaters.playerSave.spSpentThisQuest.enqueueUpdate((prev) => {\n    return 0;\n  });\n  updaters.playerSave.questProgressHistory.enqueueUpdate((prev) => {\n    return [];\n  });\n  updaters.playerSave.questInitialAmount.enqueueUpdate((prev, prevGameState) => {\n    let resourceType = prevGameState.playerSave.activeQuest?.resourceType\n    if (resourceType) {\n      let newAmount = prevGameState.computed.playerResourceAmounts?.[resourceType];\n      return newAmount || prev;\n    }\n    return prev;\n  });\n}\n\n// type QuestFactoryConfig = {};\n// export class QuestFactory {\n//   public config: QuestFactoryConfig;\n// \n//   constructor(config: QuestFactoryConfig) {\n//     this.config = config;\n//   }\n// \n//   public create(\n//     resourceType: ResourceType,\n//     resourceAmount: number,\n//     description: string = \"\"\n//   ): Quest {\n//     // console.log(resourceAmount);\n//     return {\n//       index,\n//       description,\n//       resourceType,\n//       resourceAmount,\n//     };\n//   }\n// }\n// ","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === \"localhost\" ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === \"[::1]\" ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === \"production\" && \"serviceWorker\" in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener(\"load\", () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            \"This web app is being served cache-first by a service \" +\n              \"worker. To learn more, visit https://bit.ly/CRA-PWA\"\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then((registration) => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === \"installed\") {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                \"New content is available and will be used when all \" +\n                  \"tabs for this page are closed. See https://bit.ly/CRA-PWA.\"\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log(\"Content is cached for offline use.\");\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch((error) => {\n      console.error(\"Error during service worker registration:\", error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { \"Service-Worker\": \"script\" },\n  })\n    .then((response) => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get(\"content-type\");\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf(\"javascript\") === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then((registration) => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        \"No internet connection found. App is running in offline mode.\"\n      );\n    });\n}\n\nexport function unregister() {\n  if (\"serviceWorker\" in navigator) {\n    navigator.serviceWorker.ready\n      .then((registration) => {\n        registration.unregister();\n      })\n      .catch((error) => {\n        console.error(error.message);\n      });\n  }\n}\n","import React from \"react\";\nimport ReactDOM from \"react-dom\";\nimport \"./index.css\";\nimport App from \"./App\";\nimport * as serviceWorker from \"./serviceWorker\";\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n","import crypto from \"crypto\";\n\n/**\n * NOTE(bowei): we use a hash function that is NOT md5 -\n * Either https://github.com/sublee/squirrel3-python/blob/master/squirrel3.py or https://github.com/svaarala/duktape/blob/master/misc/splitmix64.c works fine and is much faster\n * Reference: https://www.youtube.com/watch?v=e4b--cyXEsM or https://www.youtube.com/watch?v=LWFzPP8ZbdU\n * TODO(bowei): port bigint to wasm for faster 64bit operations\n */\n\n// NOTE(bowei): untested\nexport function splitmix64(seed: bigint, i: bigint) {\n    let z: bigint = seed + i * BigInt(\"0x9e3779b97f4a7c15\");\n    z = ( z ^ ( z >> BigInt(30) ) ) * BigInt(\"0xBF58476D1CE4E5B9\");\n    z = ( z ^ ( z >> BigInt(27) ) ) * BigInt(0x94D049BB133111EB);\n    return z ^ ( z >> BigInt(31) );\n}\n\nexport const INTMAX32 = 2 ** 32;\nexport function squirrel3(i: number) {\n  let n = (i + INTMAX32) % INTMAX32;\n    n = Math.imul(n, 0xb5297a4d);\n    n ^= n >>> 8;\n    n += 0x68e31da4;\n    n ^= n << 8;\n    n = Math.imul(n, 0x1b56c4e9);\n    n ^= n >>> 8;\n    return (n + INTMAX32) % INTMAX32;\n}\nexport const PRIME32 = 0x3233f2cd; // not used ; useful for hashing integers; a 32 bit prime\n\n/**\n * Md5 is 16 bytes, or max int of 256 ** 16 = 2 ** 128\n */\nexport class HashState {\n  private seed!: Buffer;\n\n  /**\n   * HashState().step(\"foo\") is equivalent to HashState(\"foo\")\n   */\n  constructor(seed?: string) {\n    const buffer = crypto\n      .createHash(\"md5\")\n      .update((seed || \"\").toString())\n      .digest();\n    this.seed = buffer;\n  }\n\n  public peekRandom(): number {\n    const buffer = crypto.createHash(\"md5\").update(this.seed).digest();\n    return Number(this.bufferToBigInt(buffer) % BigInt(2 ** 32)) % 2 ** 32;\n  }\n\n  // increment the seed linearly by 1\n  public step(numSteps: number = 1) {\n    this.seed = this.bigIntToBuffer(this.bufferToBigInt(this.seed) + BigInt(1));\n  }\n\n  public stepSeed(seed: string) {\n    const buffer = crypto.createHash(\"md5\").update(seed.toString()).digest();\n    this.seed = this.bigIntToBuffer(\n      this.bufferToBigInt(this.seed) + this.bufferToBigInt(buffer)\n    );\n  }\n\n  private bigIntToBuffer(b: bigint): Buffer {\n    let buf = Buffer.alloc(16);\n    let val = b;\n    for (let i = 0; i < 16; i++) {\n      buf[i] = Number(val % BigInt(256));\n      val = val / BigInt(256);\n    }\n    return buf;\n  }\n\n  private bufferToBigInt(b: Buffer): bigint {\n    let val = BigInt(0);\n    for (let i = 0; i < 16; i++) {\n      val = val * BigInt(256) + BigInt(b[i]);\n    }\n    return val;\n  }\n\n  public random(): number {\n    this.step();\n    return this.peekRandom();\n  }\n}\n"],"sourceRoot":""}