{"version":3,"sources":["lib/util/random.ts","lib/util/fpsTracker.ts","components/DebugOverlayComponent.tsx","lib/util/misc.ts","data/PlayerIntentState.ts","components/KeyboardListenerComponent.tsx","contexts.ts","lib/util/epsilon_math.ts","lib/util/geometry/vector2.ts","pixi/colors.ts","lib/util/data_structures/hash.ts","lib/pixi/pixify.ts","lib/util/color.ts","lib/util/batchify.ts","lib/util/updaterGenerator.ts","pixi/components/LifecycleHandler.ts","data/WorldGenState.ts","pixi/components/PointNodeComponent.ts","data/PointNodeRef.ts","pixi/components/ChunkComponent.ts","lib/util/lazy.ts","data/NodeStatus.ts","pixi/components/FixedCameraStageComponent.ts","lib/util/geometry/vector3.ts","lib/util/randomHelpers.ts","game/worldGen/LockFactory.ts","game/worldGen/nodeContents/NodeContentsFactory.ts","game/worldGen/nodeContents/NodeContentsRendering.ts","data/WindowState.ts","data/PlayerSaveState.ts","game/lib/HexGrid.ts","game/worldGen/WorldGenStateFactory.ts","components/Sidebars/Tabs/DebugTab.tsx","components/Sidebars/Tabs/StrategicTab.tsx","game/actions/DeallocateNode.ts","components/GameArea/computeVirtualNodeDataMap.tsx","components/Sidebars/Tabs/SelectedNodeTab.tsx","components/Sidebars/Tabs/StatsTab.tsx","components/Sidebars/Tabs/HelpTab.tsx","components/Sidebars/Tabs/QuestsTab.tsx","components/Sidebars/TabContentInterface.tsx","data/PlayerUIState.ts","components/PersistenceComponent.tsx","data/DebugState.ts","game/GameStateFactory.ts","game/actions/AllocateNode.ts","components/GameArea/CssVariables.tsx","components/GameArea/GameAreaCell.tsx","components/GameArea/GameAreaGrid.tsx","components/GameArea/InfiniteScrollManager.tsx","components/GameArea/locationUtils.tsx","components/GameArea/GameAreaStateManager.tsx","components/GameArea/GameAreaInterface.tsx","pixi/components/StrategicHexGridComponent.ts","pixi/textures/SimpleTextures.ts","pixi/components/RootComponent.ts","pixi/textures/PointNodeTexture.ts","pixi/PixiReactBridge.ts","components/PixiWrapperComponent.tsx","components/WindowListenerComponent.tsx","game/actions/ProgressNextEra.ts","components/HudTopComponent.tsx","components/Sidebars/Sidebar.tsx","components/Sidebars/Tabs.tsx","components/Sidebars/SidebarsInterface.tsx","App.tsx","serviceWorker.ts","index.tsx"],"names":["INTMAX32","squirrel3","i","n","Math","imul","FpsTracker","frameTimestampsInTicks","frameTimestampsInTime","this","push","ticksSinceLastUpdate","lastFrameTime","length","logRowsToKeep","slice","Date","getTime","ticksDiff","framesPerTick","timeDiff","framesPerMilli","getFps","toFixed","getUps","DebugOverlayComponent","props","pixiFpsTracker","useRef","useEffect","current","tick","className","windowState","innerWidth","innerHeight","ReactFps","getFpsString","useState","counter","setCounter","reactFpsTracker","timer","setTimeout","it","clearTimeout","fpsString","useMemo","Util","list","fn","lowestT","lowestValue","item","value","obj","highestT","highestValue","low","high","floor","random","array","key","sort","a","b","str","mapObj","re","RegExp","Object","keys","join","replace","matched","toLowerCase","func","timeoutId","waitMilliseconds","options","isImmediate","result","args","doLater","undefined","apply","shouldCallNow","d","monthName","getMonth","getDate","getHours","substr","getMinutes","getSeconds","arr","concat","string","intersperse","character","repeat","enumKeys","enm","enumAssociateBy","mapper","map","fromEntries","EnumInvalidError","Error","extractAccessPaths","deepFilter","accessPaths","proxyHandler","get","target","p","receiver","newPath","path","toString","Proxy","extractDeps","t","accessPath","ref","IntentName","DeserializationError","defaultKeyIntentConfig","MAYBE_RESET_BOOKMARKS_THIS_ERA","UNDO","REDO","g","MAYBE_PROGRESS_NEXT_ERA","CapsLock","TOGGLE_SHOW_PATHS","LeftShift","TEMP_SHOW_PATHS","w","PAN_NORTH","PAN_WEST","s","PAN_SOUTH","PAN_EAST","TOGGLE_STRATEGIC_VIEW","TOGGLE_LEFT_SIDEBAR","y","TOGGLE_RIGHT_SIDEBAR","Escape","EXIT","j","MOVE_CURSOR_WEST","l","MOVE_CURSOR_EAST","u","MOVE_CURSOR_NORTHWEST","MOVE_CURSOR_NORTHEAST","MOVE_CURSOR_SOUTHWEST","m","MOVE_CURSOR_SOUTHEAST","k","ArrowUp","ArrowLeft","ArrowDown","ArrowRight","RightShift","RightControl","INTERACT_WITH_NODE","Backspace","DEALLOCATE_NODE","r","ZOOM_RECENTER_AT_NODE","TRAVEL_UPSTAIRS","TRAVEL_DOWNSTAIRS","HARD_REFRESH_PAGE","noIntent","reduce","object","newPlayerIntentState","activeIntent","newIntent","endedIntent","KeyboardListenerComponent","handleKeydown","e","keyIntentConfig","state","location","shiftKey","altKey","ctrlKey","configuredIntent","isTextBoxFocused","console","log","preventDefault","NOOP","updaters","enqueueUpdate","handleKeyup","document","addEventListener","removeEventListener","React","Component","UseGameStateContext","createContext","EPSILON","Vector2","propsOrX","x","_x","_y","round","abs","max","dx","dy","sqrt","newX","newY","about","amount","origin","angle","PI","cos","sin","other","__type","trans","scale","error","add","tx","ty","lerp","highX","highY","lowX","lowY","RandRange","hasOwnProperty","JSON","stringify","SerializeToObject","Zero","One","COLORS","entries","backgroundBlue","nodePink","nodeLavender","nodeBlue","nodeAqua","gateTint","selectedTint","allocatedTint","nodeBorder","nullTint","tooltipBorderBlack","tooltipFillWhite","white","grayBlack","borderBlack","borderWhite","black","textWhite","v","colorToCss","c","HashSet","initialValues","_values","HashMap","put","remove","contains","values","clone","size","hash","KeyedHashMap","_kvalues","hashCode","pv","cv","keySerializer","valueSerializer","entry","keyDeserializer","valueDeserializer","Array","isArray","h","charCodeAt","PixiPointFrom","Pixi","RED_MASK","GREEN_MASK","BLUE_MASK","RED_UNIT","GREEN_UNIT","multiplyColor","color1","color2","reds","greens","blues","out","interpolateColor","arg2","arg3","_interpolateColor","_args","color","proportion","opacity","base","background","batchifySetState","batch","arg","thisBatch","prev","next","valueOrCallback","updaterGenerator2Helper","dataObject","dataUpdater","forEach","newValueOrCallback","oldData","wholeData","newKey","updaterGenerator2","setState","stateCallbackFunction","ChildrenArray","removed","splice","findIndex","instance","find","cloned","callbackfn","LifecycleHandlerBase","container","stateUpdaters","_staleProps","_children","_childrenToConstruct","_childrenToDestruct","_forceUpdates","markForceUpdate","childInstance","childInfo","child","childClass","propsFactory","addChild","renderSelf","didMount","self","initialState","batchedSetState","fireBatch","fireStateUpdaters","nextProps","_update","staleState","updateSelf","shouldUpdate","forceUpdates","didForceUpdateChild","updateChildren","_updateChildren","Promise","resolve","didUpdate","willUnmount","removeChild","engageLifecycle","derived","construct","_didConstruct","newTarget","Reflect","NodeType","ResourceNontrivialType","ResourceModifier","ChunkGenConstants","CHUNK_HALF_DIM","CHUNK_DIM","DROP_NODES_CHANCE","wrapped","sprite","halfwayCenterSprite","centerSprite","topHalfSprite","hitArea","tooltippableArea","numClicks","descriptionText","defaultTexture","pointNodeTexture","cropFraction","texture","sortableChildren","anchor","zIndex","pointNodeGen","nodeType","EfficiencyGate","mask","beginFill","drawRect","width","height","pivot","alpha","interactive","buttonMode","RenderedChunkConstants","NODE_HITAREA_PX","nodeDescription","Nothing","resourceAmount","resourceModifier","resourceType","tint","centerTint","position","isSelected","isAllocated","baseColor","topHalfColor","Mana0","Flat","Increased0","textureToFind","selfPointNodeRef","pointNodeCoord","equals","staleProps","addListener","event","localPosition","data","getLocalPosition","worldTransform","tooltipUpdaters","visible","text","PointNodeRef","z","chunkCoord","pointNodeId","SPACING_PX","CHUNK_SPACING_PX","NODE_SIZE_PX","NODE_ROUNDED_PX","children","resyncChildren","prevProps","prevState","childrenToDelete","chunkGen","pointNodes","pointNodeRef","selfChunkRef","id","childPropsFactory","delta","multiply","selectedPointNode","allocatedPointNodeSubset","childKey","childComponent","PointNodeComponent","Lazy","factory","_wasConstructed","_value","_factory","NodeAllocatedStatus","BoolEnum","LazyHashMap","newFactory","LockStatus","NodeTakenStatus","true","taken","false","NodeReachableStatus","reachable","Vector3","_z","pOrX","pairXY","newZ","randomSwitch","randInt","weights","behaviors","newRandInt","unusedWeight","weight","randomValue","randomUniform","min","increment","inclusive","numBuckets","ceil","Attribute","Modifier","LockFactory","config","seed","lockData","shortTextTarget","shortTextTimer","taxicabDistance","toVector2","subtract","WEIGHTS","ROOT","EMPTY","NO_SPEND","SPEND","STARTER_AREA_ROOT","DECISION_1","SINGLE","DOUBLE","SINGLE_COLORS","RED0","RED1","RED2","DEL0","DEL1","DEL2","SINGLE_MODIFIERS","FLAT","INCREASED","STARTER_AREA_SINGLE_MODIFIERS","NodeContentsFactory","clusterCenterData","attribute","modifier","formula","plus","numDice","parseInt","split","numPips","val","randomDice","lines","createSingle","clusterCenter","modulo3","moduloPositive","divide","createNoSpend","condition","type","AttributeSymbolMap","AttributesSorted","AttributeColorMap","AttributeDescriptionMap","AttributeDescriptionReverseMap","Red","Green","Blue","Offense","Defense","Magic","ModifierSymbolMap","ModifierDescriptionMap","ModifierDescriptionReverseMap","flat","increased","nodeContentsLineToString","line","desc","symbol","newWindowState","orientation","window","appSizeFromWindowSize","Infinity","Direction","newPlayerSaveState","allocationStatusMap","bookmarkedStatusMap","exploredStatusMap","explored","currentEra","index","deallocationPoints","provided","ERA_DEALLOCATION_POINTS","remaining","serialize","serializeToObject","deserialize","Deserialize","deserializeFromObject","parse","storageKey","load","localStorage","getItem","PlayerSaveState","loaded","setItem","getCoordNeighbors","neighbors","EAST","addX","WEST","NORTHWEST","addY","SOUTHEAST","NORTHEAST","SOUTHWEST","getWithinDistance","baseOrBases","bases","maxDistance","minDistance","disallowedSet","touched","disallowedButTouched","byDist","vec","considering","dd","WorldGenStateFactory","mySeed","lockFactory","lockDataMap","create","nodeContentsFactory","nodeContentsMap","lockMap","DebugTabContent","gameState","lastUpdated","setLastUpdated","slowRenderMsgs","setSlowRenderMsgs","appSize","hexGridPx","virtualGridDims","virtualAreaScaleMultiplier","now","msSinceLastTick","msg","toTimeString","virtualGridDimsTrigger","useCallback","debug","retriggerVirtualGridDims","toggleScrollbars","debugShowScrollbars","gameAreaGridRerender","rerenderGameAreaGrid","onDisableScrollJump","enableScrollJump","onEnableScrollJump","forceVirtualGridJump","getForceJumpOffset","addDebugOffsetX","getOffsetX","offsetX","flipCursored","isFlipCursored","toggleTextBoxFocused","playerUI","saveLocalStorage","PlayerUIState","store","loadLocalStorage","clearLocalStorage","clear","justDisabledSave","clearSave","playerSave","toggleEra","hidden","idx","virtualGridLocation","onClick","StrategicTab","memo","StrategicTabComponent","showAdvancedSearch","setShowAdvancedSearch","highlightInputValue","setHighlightInputValue","onFocus","onBlur","onFireSearch","strategicSearch","highlight1","onCancelSearch","onToggleColors","colors","enabled","isPixiHidden","HorizontalButtonRadio","labels","defaultValue","onChange","SymbolButton","updateTextInputValue","TextInputButton","icon","insertedText","onMouseDown","onPointerDown","defaultIdx","indexOf","currentIdx","setCurrentIdx","len","body","fill","_","disabled","extractDeallocateNodeCheckState","computed","reachableStatusMap","fogOfWarStatusMap","accessibleStatusMap","worldGen","depsDeallocateNodeCheckState","DeallocateNodeAction","input","nodeLocation","prevGameState","bookmarked","filter","notEquals","check","checkAction","enqueueAction","bookmarkedStatus","takenStatus","neighborNodes","start","targets","processing","shift","STARTING_NODE_DESCRIPTION","computeNodeReactData","fogOfWarStatus","reachableStatus","accessibleStatus","accessible","nodeStatus","TAKEN_OR_MARKED","AVAILABLE","UNREACHABLE","HIDDEN","lockStatus","lockStatusMap","isLocked","OPEN","nodeContents","shortText1","shortText2","tooltipHeader","toolTipText","nodeContentsToDom","shortText","fullText","status","statuses","SelectedNodeTabContent","SelectedNodeTabContentComponent","cursoredNodeLocation","allocateNodeCheckState","extractAllocateNodeCheckState","depsAllocateNodeCheckState","deallocateNodeCheckState","onAllocate","actions","allocateNode","run","newStatus","canBeAllocated","AllocateNodeAction","onDeallocate","deallocateNode","canBeDeallocated","onZoom","triggerScrollRecenterCb","xyCoords","exploredStatus","visibleStatus","description","nodeContentsDom","StatsTab","extractStatsSubState","depsStatsSubState","StatsTabHelper","StatsTabComponent","isOpen","setOpen","attributeInfos","end","enumMapValues","computeAttributeModifierStats","modifiers","total","open","nodes","HelpTab","CheckboxDiv","QuestsTab","QuestsTabHelper","TAB_NAME","QuestsTabComponent","maxAttribute","maxValue","secondMaxAttribute","secondMaxValue","attributeStats","stats","questCompleted","TabContentInterface","tabName","tabComponents","EmptyTabContent","SELECTED_NODE","STATS","QUESTS","STRATEGIC_VIEW","DEBUG","HELP","TabContentSelector","selectedTabName","tabNames","EmptyTabContentComponent","initialTabLabels","left","right","newPlayerUIState","tabs","activeIndex","isSidebarOpen","isLeftSidebarOpen","isRightSidebarOpen","new","tryLoad","PersistenceComponent","onUnload","intent","reload","onbeforeunload","loadOrCreate","DEFAULT_SEED","worldGenStateFactory","loadComputed","GameStateFactory","markLockStatus","markAccessibleNodes","flowFogOfWarFromNode","markVisibleNodes","flowReachableFromNode","markReachableNodes","TICKING","validLocks","ERA_ACCESSIBLE_RADII","isAccessible","FOG_OF_WAR_DISTANCE","prevBookmarked","ERA_SP_LIMITS","0","1","2","3","4","CssVariablesComponent","borderWidth","hexCenterRadius","documentElement","style","setProperty","GameAreaCell","GameAreaCellComponent","onUpdateStatus","nodeData","isCursored","onUpdateCursored","debugIsCursored","handleClick","stopPropagation","action","handleClickQuestionMark","Cell","onClickCenter","onClickQuestionMark","CellComponent","accessibleButHidden","completelyHidden","hovered","setHovered","onHover","onUnhover","classnames","onDoubleClick","onPointerEnter","onPointerLeave","extractGameGridSubState","depsGameGridSubState","GameAreaGrid","virtualCoordsToLocation","updateNodeStatusByLocationCb","cursoredVirtualNode","setCursoredLocation","startTime","nodeReactDataMap","Row","rowIdx","virtualCoords","elapsed","RowComponent","odd","InfiniteScrollManager","keyboardScrollDirection","jumpOffset","setJumpOffset","center","virtualCenter","centerPxY","centerPxX","getVirtualGridCenterPx","scrollTop","scrollLeft","scrollTo","handleJump","locationOffset","direction","newJumpOffset","FromVector2","handleScroll","newScrollTop","newScrollLeft","lastTime","interval","setInterval","clearInterval","onScroll","GameAreaStateManager","offsetFromVirtualCenter","relativeLocation","convertVirtualCoordsToLocation","locationToVirtualCoords","offsetFromVirtualGridLocation","relativeVirtualCoords","convertLocationToVirtualCoords","handleUpdateNodeStatusByLocation","handleUpdateNodeStatus","cursoredVirtualNodeCoords","cursorHitEdgeCallback","cursor","newLocation","MOVE_CURSOR_SOUTH","MOVE_CURSOR_NORTH","MOVE_CURSOR_NORTHNORTH","MOVE_CURSOR_SOUTHSOUTH","infiniteScrollManagerDebug","gameAreaGridDebug","subGameState","extractGameAreaSubState","depsGameAreaSubState","uiScaleFromAppSize","maxDim","GameAreaInterface","uiScale","onDebugRetrigger","extractStrategicHexGridSubState","depsStrategicHexGridSubState","strategicHexGridPxFromUiScale","pixiUiScale","strategicHexGridDims","hexGrid","phases","strategicHexGridPx","graphics","node","animation","cursorAnimation","keyString","newPhase","periodSecs","phase","PIXI_TICKS_PER_SECOND","bezierX","tintProp","basePosition","baseTint","nodeVisibleStatus","nodeTakenStatus","nodeBookmarkedStatus","nodeReachableStatus","nodeAccessibleStatus","removeAllListeners","on","textures","dot","rect","square","circle","nodeContentsLch","chroma","color0","nodeContentsToColor","lch","originalLch","num","query","terms","wrappedTerm","unmatchedTerm","term","maybeAttribute","maybeModifier","matchStrategicSearch","mode","verticalLine","staleGameState","staleDeps","deps","WHITE","fixedCameraStage","actionStage","backdropStage","strategicHexGrid","backdrop","onWheel","renderer","textureSet","drawRoundedRect","generateTexture","LINEAR","generatePointNodeTexture","simpleTexture","diameter","drawCircle","thickness","generateSimpleTextures","playerCurrentZ","tooltip","fixedCameraStagePropsFactory","FixedCameraStageComponent","strategicHexGridPropsFactory","StrategicHexGridComponent","canvasElement","DEFAULT_APP_SIZE","PixiReactBridge","app","rootComponent","onTick","isSecondConstructorCall","originalAppSize","antialias","transparent","resolution","devicePixelRatio","autoDensity","powerPreference","backgroundColor","ticker","destroy","baseTexture","baseGameLoop","bind","curr","appendChild","view","futureProps","willMount","RootComponent","stage","resize","update","initialApplication","PixiWrapperComponent","useContext","gameStateUpdaters","fireBatchedSetGameState","application","childNodes","rerender","WindowListenerComponent","handleWindowResize","newSize","extractProgressNextEraCheckState","depsProgressNextEraCheckState","ProgressNextEraAction","HudTopComponent","setLocked","progressNextEra","progressNextEraCheckState","canProgressNextEra","maxAllocationPoints","remainingAllocationPoints","eraTooltip","eraName","pointTypeName","Sidebar","placement","Tabs","label","Tab","active","TabComponent","emptyTabLabels","SidebarsInterface","setLeftSidebarHidden","setLeftSidebarUnhidden","setRightSidebarHidden","setRightSidebarUnhidden","tabsState","tabsUpdaters","leftSidebarTabs","rightSidebarTabs","leftActiveTabIndex","rightActiveTabIndex","setLeftSidebarTabs","setRightSidebarTabs","setLeftActiveTabIndex","setRightActiveTabIndex","onSendTabLeft","currentRightTab","newRightSidebarTabs","newLeftSidebarTabs","onSendTabRight","currentLeftTab","leftTabName","rightTabName","initialGameState","App","setGameState","batchedSetGameState","gameStateContextValue","TOGGLE_SIDEBAR","TURN_OFF_SIDEBAR","Provider","Boolean","hostname","match","ReactDOM","render","StrictMode","getElementById","navigator","serviceWorker","ready","then","registration","unregister","catch","message"],"mappings":"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","file":"static/js/main.2f9bd5a6.chunk.js","sourcesContent":["import crypto from 'crypto';\n\n/**\n * NOTE(bowei): we use a hash function that is NOT md5 -\n * Either https://github.com/sublee/squirrel3-python/blob/master/squirrel3.py or https://github.com/svaarala/duktape/blob/master/misc/splitmix64.c works fine and is much faster\n * Reference: https://www.youtube.com/watch?v=e4b--cyXEsM or https://www.youtube.com/watch?v=LWFzPP8ZbdU\n * TODO(bowei): port bigint to wasm for faster 64bit operations\n */\n\n// NOTE(bowei): untested\nexport function splitmix64(seed: bigint, i: bigint) {\n  let z: bigint = seed + i * BigInt('0x9e3779b97f4a7c15');\n  z = (z ^ (z >> BigInt(30))) * BigInt('0xBF58476D1CE4E5B9');\n  z = (z ^ (z >> BigInt(27))) * BigInt(0x94d049bb133111eb);\n  return z ^ (z >> BigInt(31));\n}\n\nexport const INTMAX32 = 2 ** 32;\nexport function squirrel3(i: number) {\n  let n = (i + INTMAX32) % INTMAX32;\n  n = Math.imul(n, 0xb5297a4d);\n  n ^= n >>> 8;\n  n += 0x68e31da4;\n  n ^= n << 8;\n  n = Math.imul(n, 0x1b56c4e9);\n  n ^= n >>> 8;\n  return (n + INTMAX32) % INTMAX32;\n}\nexport const PRIME32 = 0x3233f2cd; // not used ; useful for hashing integers; a 32 bit prime\n\n/**\n * Md5 is 16 bytes, or max int of 256 ** 16 = 2 ** 128\n */\nexport class HashState {\n  private seed!: Buffer;\n\n  /**\n   * HashState().step(\"foo\") is equivalent to HashState(\"foo\")\n   */\n  constructor(seed?: string) {\n    const buffer = crypto\n      .createHash('md5')\n      .update((seed || '').toString())\n      .digest();\n    this.seed = buffer;\n  }\n\n  public peekRandom(): number {\n    const buffer = crypto.createHash('md5').update(this.seed).digest();\n    return Number(this.bufferToBigInt(buffer) % BigInt(2 ** 32)) % 2 ** 32;\n  }\n\n  // increment the seed linearly by 1\n  public step(numSteps: number = 1) {\n    this.seed = this.bigIntToBuffer(this.bufferToBigInt(this.seed) + BigInt(1));\n  }\n\n  public stepSeed(seed: string) {\n    const buffer = crypto.createHash('md5').update(seed.toString()).digest();\n    this.seed = this.bigIntToBuffer(\n      this.bufferToBigInt(this.seed) + this.bufferToBigInt(buffer)\n    );\n  }\n\n  private bigIntToBuffer(b: bigint): Buffer {\n    let buf = Buffer.alloc(16);\n    let val = b;\n    for (let i = 0; i < 16; i++) {\n      buf[i] = Number(val % BigInt(256));\n      val = val / BigInt(256);\n    }\n    return buf;\n  }\n\n  private bufferToBigInt(b: Buffer): bigint {\n    let val = BigInt(0);\n    for (let i = 0; i < 16; i++) {\n      val = val * BigInt(256) + BigInt(b[i]);\n    }\n    return val;\n  }\n\n  public random(): number {\n    this.step();\n    return this.peekRandom();\n  }\n}\n","const logRowsToKeep: number = 60; // last 1 seconds, at 60 fps\n\n/**\n * See https://www.npmjs.com/package/pixi-fps https://github.com/jkanchelov/pixi-fps\n */\nexport class FpsTracker {\n  private frameTimestampsInTicks: any[] = [];\n  private frameTimestampsInTime: any[] = [];\n\n  constructor() {\n    this.frameTimestampsInTicks.push(0);\n    // this.frameTimestampsInTime.push((new Date()).getTime());\n  }\n\n  /**\n   * @param ticksSinceLastUpdate should be the delta in ticks since the last update - will probably be a decimal close to 1\n   */\n  public tick(ticksSinceLastUpdate: number) {\n    let lastFrameTime =\n      this.frameTimestampsInTicks[this.frameTimestampsInTicks.length - 1];\n    this.frameTimestampsInTicks.push(lastFrameTime + ticksSinceLastUpdate);\n\n    // rotate logs\n    if (this.frameTimestampsInTicks.length > logRowsToKeep + 60) {\n      this.frameTimestampsInTicks = this.frameTimestampsInTicks.slice(60);\n    }\n\n    // do the same but track real time\n    this.frameTimestampsInTime.push(new Date().getTime());\n    if (this.frameTimestampsInTime.length > logRowsToKeep + 60) {\n      this.frameTimestampsInTime = this.frameTimestampsInTime.slice(60);\n    }\n  }\n\n  // [0, 3, 4] -> 30 fps\n  public getUps(): number {\n    let ticksDiff =\n      this.frameTimestampsInTicks[this.frameTimestampsInTicks.length - 1] -\n      this.frameTimestampsInTicks[0];\n    let framesDiff = this.frameTimestampsInTicks.length - 1;\n\n    let framesPerTick = framesDiff / ticksDiff;\n    if (!framesPerTick) {\n      return 60;\n    }\n\n    return framesPerTick * 60;\n  }\n\n  public getFps(): number {\n    let timeDiff =\n      this.frameTimestampsInTime[this.frameTimestampsInTime.length - 1] -\n      this.frameTimestampsInTime[0];\n    let framesDiff = this.frameTimestampsInTime.length - 1;\n\n    let framesPerMilli = framesDiff / timeDiff;\n    if (!framesPerMilli) {\n      return 60;\n    }\n\n    return framesPerMilli * 1000;\n  }\n\n  public getFpsString(): string {\n    let fpsNumber = this.getFps();\n\n    return fpsNumber.toFixed(1);\n  }\n\n  public getUpsString(): string {\n    let upsNumber = this.getUps();\n\n    return upsNumber.toFixed(1);\n  }\n}\n","import './DebugOverlayComponent.css';\n\nimport React, { useEffect, useMemo, useRef, useState } from 'react';\nimport { FpsTracker } from '../lib/util/fpsTracker';\nimport { WindowState } from '../data/WindowState';\n\n/**\n * Small overlay in the top left which displays window dimensions and fps.\n */\nexport function DebugOverlayComponent(props: {\n  tick: number;\n  windowState: WindowState;\n}) {\n  const pixiFpsTracker = useRef(new FpsTracker());\n  useEffect(() => {\n    pixiFpsTracker.current.tick(0);\n  }, [props.tick]);\n\n  return (\n    <div className=\"text\">\n      <div>\n        {props.windowState.innerWidth}x{props.windowState.innerHeight}\n      </div>\n      <ReactFps />\n      <div>UPS: {pixiFpsTracker.current.getFpsString()}</div>\n    </div>\n  );\n}\n\nfunction ReactFps() {\n  const [counter, setCounter] = useState(0);\n  const reactFpsTracker = useRef(new FpsTracker());\n\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setCounter((it) => it + 1);\n      reactFpsTracker.current.tick(0);\n    }, 5); // try to refresh every 5 millis\n    return () => clearTimeout(timer);\n  }, [counter]);\n\n  const fpsString = useMemo(() => {\n    if (counter >= 0) {\n      return reactFpsTracker.current.getFpsString();\n    }\n    return '';\n  }, [counter]);\n\n  return <div>RPS: {fpsString}</div>;\n}\n","let lastUsedId = 0;\n\nexport const getUniqueID = () => {\n  return lastUsedId++;\n};\n\nexport class Util {\n  static MinBy<T>(list: T[], fn: (T: T) => number): T | null {\n    let lowestT: T | null = null;\n    let lowestValue: number | null = null;\n\n    for (const item of list) {\n      const value = fn(item);\n\n      if (lowestValue === null || value < lowestValue) {\n        lowestT = item;\n        lowestValue = value;\n      }\n    }\n\n    return lowestT;\n  }\n\n  static MinByAndValue<T>(\n    list: T[],\n    fn: (T: T) => number\n  ): { obj: T; value: number } | null {\n    let lowestT: T | null = null;\n    let lowestValue: number | null = null;\n\n    for (const item of list) {\n      const value = fn(item);\n\n      if (lowestValue === null || value < lowestValue) {\n        lowestT = item;\n        lowestValue = value;\n      }\n    }\n\n    return lowestT === null || lowestValue === null\n      ? null\n      : { obj: lowestT, value: lowestValue };\n  }\n\n  static MaxBy<T>(list: T[], fn: (T: T) => number): T | null {\n    let highestT: T | null = null;\n    let highestValue: number | null = null;\n\n    for (const item of list) {\n      const value = fn(item);\n\n      if (highestValue === null || value > highestValue) {\n        highestT = item;\n        highestValue = value;\n      }\n    }\n\n    return highestT;\n  }\n\n  static RandRange(low: number, high: number): number {\n    return Math.floor(Math.random() * (high - low) + low);\n  }\n\n  public static SortByKey<T>(array: T[], key: (x: T) => number): T[] {\n    return array.sort((a, b) => {\n      return key(a) - key(b);\n    });\n  }\n\n  public static ReplaceAll(\n    str: string,\n    mapObj: { [key: string]: string }\n  ): string {\n    const re = new RegExp(Object.keys(mapObj).join('|'), 'gi');\n\n    return str.replace(re, (matched) => {\n      return mapObj[matched.toLowerCase()];\n    });\n  }\n\n  public static Debounce<F extends (...args: any[]) => void>(\n    func: F,\n    waitMilliseconds = 50,\n    options = {\n      isImmediate: false,\n    }\n  ): F {\n    let timeoutId: any; // types are different on node vs client, so we have to use any.\n\n    const result = (...args: any[]) => {\n      const doLater = () => {\n        timeoutId = undefined;\n        if (!options.isImmediate) {\n          func.apply(this, args);\n        }\n      };\n\n      const shouldCallNow = options.isImmediate && timeoutId === undefined;\n\n      if (timeoutId !== undefined) {\n        clearTimeout(timeoutId);\n      }\n\n      timeoutId = setTimeout(doLater, waitMilliseconds);\n\n      if (shouldCallNow) {\n        func.apply(this, args);\n      }\n    };\n\n    return result as any;\n  }\n\n  public static FormatDate(d: Date): string {\n    const monthName = [\n      'Jan',\n      'Feb',\n      'Mar',\n      'Apr',\n      'May',\n      'Jun',\n      'Jul',\n      'Aug',\n      'Sep',\n      'Oct',\n      'Nov',\n      'Dec',\n    ][d.getMonth()];\n\n    return `${monthName} ${d.getDate()}, ${('00' + d.getHours()).substr(-2)}:${(\n      '00' + d.getMinutes()\n    ).substr(-2)}:${('00' + d.getSeconds()).substr(-2)}`;\n  }\n\n  public static FlattenByOne<T>(arr: T[][]): T[] {\n    let result: T[] = [];\n\n    for (const obj of arr) {\n      result = result.concat(obj);\n    }\n\n    return result;\n  }\n\n  public static PadString(\n    string: string,\n    length: number,\n    intersperse = '',\n    character = ' '\n  ) {\n    return string + intersperse + character.repeat(length - string.length);\n  }\n}\n\n/**\n * A deep readonly type - given an object type, all subobjects and their subobjects are also marked as readonly.\n * see also: https://twitter.com/mgechev/status/1240178886979223552?lang=en\n */\nexport type Const<T> = T extends Function\n  ? T\n  : {\n      readonly [P in keyof T]: T[P] extends { [k: string]: any }\n        ? Const<T[P]>\n        : T[P];\n    };\n\nconst assertOnlyCalledOnceData: { [k: string]: [string, number] } = {};\n\n/**\n * Asserts that a function is not called more than twice. Useful for debugging react lifecycle which may be creating more objects than you realize, impacting performance.\n * @param id identifier\n */\nexport function assertOnlyCalledOnce(id: string | number) {\n  let k = id.toString();\n  if (assertOnlyCalledOnceData[k] !== undefined) {\n    if (assertOnlyCalledOnceData[k][1] === 1) {\n      assertOnlyCalledOnceData[k][1] = 2;\n    } else {\n      throw new Error(\n        'Error, called more than twice with same id: ' +\n          k +\n          ' , callback the first time was : ' +\n          assertOnlyCalledOnceData[k]\n      );\n    }\n  } else {\n    const stacktrace = new Error().stack!;\n    assertOnlyCalledOnceData[k] = [stacktrace, 1];\n  }\n}\n\nexport function enumKeys<T extends string>(enm: { [key in T]: T }): T[] {\n  return Object.keys(enm) as T[];\n}\nexport function enumEntries<T extends string, U>(\n  obj: { [key in T]: U }\n): [T, U][] {\n  return Object.entries(obj) as [T, U][];\n}\n\nexport function fromEnumEntries<T extends string, U>(\n  array: [T, U][]\n): { [key in T]?: U } {\n  return Object.fromEntries(array) as { [key in T]?: U };\n}\n\nexport function enumAssociateBy<T extends string, U>(\n  enm: { [key in T]: T },\n  mapper: (t: T) => [T, U]\n): { [key in T]: U } {\n  return fromEnumEntries(enumKeys(enm).map(mapper)) as { [key in T]: U };\n}\n\nexport function enumMapValues<T extends string, U, V>(\n  obj: { [key in T]: U },\n  mapper: (_: U, key: T, obj: { [key in T]: U }) => V\n): { [key in T]: V } {\n  let start = Object.entries(obj) as [T, U][];\n  let end = start.map(([k, v]) => [k, mapper(v, k, obj)]) as [T, V][];\n  let result = Object.fromEntries(end) as { [key in T]: V };\n  return result;\n}\n\n/**\n * Error if a value is expected to be in an enum, but somehow is not -- deserialization error?\n */\nexport class EnumInvalidError extends Error {}\n\n/**\n * Error for a WIP feature that has not been implemented yet\n */\nexport class NotImplementedError extends Error {}\n\n// export function enumKeys<T extends string>(enm: { [key: string]: string }) : T[] {\n//   return Object.keys(enm) as T[];\n// }\n\n/**\n * Used on pojo filtering functions.\n * Here deepFilter: T => U is expected to be a pure function of the form object => object with a subset of the same properties (deeply).\n * for instance\n * deepFilter: { a: number, b: { c: number , d: string } } => { a: number, b: { c: number } }\n * @returns a list. each element of the list represents an access path that is in the subset of paths kept by the pure filter function.\n * in the example above, the output would be [ ['a'],  ['b', 'c'] ]\n */\nexport function extractAccessPaths<T, U>(deepFilter: (t: T) => U): string[][] {\n  let accessPaths: string[][] = [[]];\n\n  const proxyHandler: ProxyHandler<{ path: string[] }> = {\n    get: (\n      target: { path: string[] },\n      p: string | number | symbol,\n      receiver: any\n    ): any => {\n      const newPath = target.path.concat([p.toString()]);\n      // detect if we are merely adding on to an existing path and if so update it in place\n      if (accessPaths[accessPaths.length - 1] === target.path) {\n        accessPaths[accessPaths.length - 1] = newPath;\n      } else {\n        accessPaths.push(newPath);\n      }\n      const newObj = new Proxy({ path: newPath }, proxyHandler);\n      return newObj;\n    },\n  };\n\n  // run the function and record the paths\n  deepFilter(new Proxy({ path: accessPaths[0] }, proxyHandler) as any);\n\n  return accessPaths;\n}\n\n/**\n *\n * @param deepFilter pojo filtering function, as above\n * @returns a function that takes a T instance and returns the list of properties accessed by deepFilter. useful in react useMemo calls\n */\nexport function extractDeps<T, U>(\n  deepFilter: (t: T) => U\n): (t: T | Const<U>) => any[] {\n  const accessPaths = extractAccessPaths(deepFilter);\n\n  return (t: T | Const<U>) => {\n    const deps = accessPaths.map((accessPath) => {\n      let ref: any = t;\n      for (let p of accessPath) {\n        ref = ref?.[p];\n      }\n      return ref;\n    });\n    // console.log({ deps });\n    return deps;\n  };\n}\n\nexport class DeserializationError extends Error {}\n","import { enumKeys } from '../lib/util/misc';\n\n/**\n * Player intents == what they want to do when they press certain mouse/keyboard keys. This is decoupled\n * from their actual keyboard keys to make remapping easier.\n */\n\nexport type PlayerIntentState = {\n  activeIntent: Intent;\n  newIntent: Intent;\n  endedIntent: Intent;\n};\n\nexport type Intent = {\n  [name in IntentName]: boolean;\n};\n\nexport enum IntentName {\n  // Default intent - does nothing\n  NOOP = 'NOOP',\n\n  PAN_NORTH = 'PAN_NORTH',\n  PAN_SOUTH = 'PAN_SOUTH',\n  PAN_WEST = 'PAN_WEST',\n  PAN_EAST = 'PAN_EAST',\n  TRAVEL_UPSTAIRS = 'TRAVEL_UPSTAIRS',\n  TRAVEL_DOWNSTAIRS = 'TRAVEL_DOWNSTAIRS',\n\n  TOGGLE_STRATEGIC_VIEW = 'TOGGLE_STRATEGIC_VIEW',\n  TOGGLE_SIDEBAR = 'TOGGLE_SIDEBAR',\n  TOGGLE_LEFT_SIDEBAR = 'TOGGLE_LEFT_SIDEBAR',\n  TOGGLE_RIGHT_SIDEBAR = 'TOGGLE_RIGHT_SIDEBAR',\n  TURN_OFF_SIDEBAR = 'TURN_OFF_SIDEBAR',\n  EXIT = 'EXIT',\n  HARD_REFRESH_PAGE = 'HARD_REFRESH_PAGE',\n\n  MOVE_CURSOR_WEST = 'MOVE_CURSOR_WEST',\n  MOVE_CURSOR_EAST = 'MOVE_CURSOR_EAST',\n  MOVE_CURSOR_NORTH = 'MOVE_CURSOR_NORTH',\n  MOVE_CURSOR_SOUTH = 'MOVE_CURSOR_SOUTH',\n  MOVE_CURSOR_NORTHWEST = 'MOVE_CURSOR_NORTHWEST',\n  MOVE_CURSOR_NORTHEAST = 'MOVE_CURSOR_NORTHEAST',\n  MOVE_CURSOR_SOUTHWEST = 'MOVE_CURSOR_SOUTHWEST',\n  MOVE_CURSOR_SOUTHEAST = 'MOVE_CURSOR_SOUTHEAST',\n  MOVE_CURSOR_NORTHNORTH = 'MOVE_CURSOR_NORTHNORTH',\n  MOVE_CURSOR_SOUTHSOUTH = 'MOVE_CURSOR_SOUTHSOUTH',\n\n  INTERACT_WITH_NODE = 'INTERACT_WITH_NODE',\n  DEALLOCATE_NODE = 'DEALLOCATE_NODE',\n  ZOOM_RECENTER_AT_NODE = 'ZOOM_RECENTER_AT_NODE',\n\n  // TODO(bowei): implement these\n  // if in era A, removes all bookmarks. also should be undoable\n  MAYBE_RESET_BOOKMARKS_THIS_ERA = 'MAYBE_RESET_BOOKMARKS_THIS_ERA',\n  // goes to next era; must be clicked twice to work\n  MAYBE_PROGRESS_NEXT_ERA = 'MAYBE_PROGRESS_NEXT_ERA',\n  // pop the most recent action stack, perform the reverse action, and push to the most recent undo stack. Only allocate/deallocates are reversible, not cursor select changes or era progression.\n  UNDO = 'UNDO',\n  // pop the most recent undo stack, perform the original action, and push to the most recent action stack\n  REDO = 'REDO',\n  // capslock - causes cursor selection \"[\" to also show cursors on the shortest path from selection to origin (going through .taken nodes costs 0.01), on both strategic and detailed\n  TOGGLE_SHOW_PATHS = 'TOGGLE_SHOW_PATHS',\n  // temporarily causes cursor selection \"[\" to also show cursors on the shortest path from selection to origin (going through .taken nodes costs 0.01), on both strategic and detailed\n  TEMP_SHOW_PATHS = 'TEMP_SHOW_PATHS',\n}\n\nexport const defaultKeyIntentConfig = {\n  'Ctrl-Backspace': IntentName.MAYBE_RESET_BOOKMARKS_THIS_ERA,\n  'Ctrl-z': IntentName.UNDO,\n  'Ctrl-y': IntentName.REDO,\n  'Ctrl-r': IntentName.REDO,\n  g: IntentName.MAYBE_PROGRESS_NEXT_ERA,\n  CapsLock: IntentName.TOGGLE_SHOW_PATHS,\n  LeftShift: IntentName.TEMP_SHOW_PATHS,\n\n  // ArrowUp: IntentName.PAN_NORTH,\n  // ArrowLeft: IntentName.PAN_WEST,\n  // ArrowDown: IntentName.PAN_SOUTH,\n  // ArrowRight: IntentName.PAN_EAST,\n  w: IntentName.PAN_NORTH,\n  a: IntentName.PAN_WEST,\n  s: IntentName.PAN_SOUTH,\n  d: IntentName.PAN_EAST,\n\n  // k: IntentName.PAN_NORTH,\n  // h: IntentName.PAN_WEST,\n  // j: IntentName.PAN_SOUTH,\n  // l: IntentName.PAN_EAST,\n\n  // m: IntentName.TOGGLE_STRATEGIC_VIEW,\n  b: IntentName.TOGGLE_STRATEGIC_VIEW,\n\n  // i: IntentName.TOGGLE_SIDEBAR,\n  t: IntentName.TOGGLE_LEFT_SIDEBAR,\n  y: IntentName.TOGGLE_RIGHT_SIDEBAR,\n\n  Escape: IntentName.EXIT,\n\n  // w: IntentName.MOVE_CURSOR_NORTH,\n  // a: IntentName.MOVE_CURSOR_WEST,\n  // s: IntentName.MOVE_CURSOR_SOUTH,\n  // d: IntentName.MOVE_CURSOR_EAST,\n  // q: IntentName.MOVE_CURSOR_NORTHWEST,\n  // e: IntentName.MOVE_CURSOR_NORTHEAST,\n  // z: IntentName.MOVE_CURSOR_SOUTHWEST,\n  // x: IntentName.MOVE_CURSOR_SOUTHEAST,\n  // c: IntentName.MOVE_CURSOR_SOUTHEAST,\n\n  j: IntentName.MOVE_CURSOR_WEST,\n  l: IntentName.MOVE_CURSOR_EAST,\n  u: IntentName.MOVE_CURSOR_NORTHWEST,\n  i: IntentName.MOVE_CURSOR_NORTHEAST,\n  n: IntentName.MOVE_CURSOR_SOUTHWEST,\n  m: IntentName.MOVE_CURSOR_SOUTHEAST,\n  k: IntentName.MOVE_CURSOR_SOUTHWEST,\n\n  // ArrowUp: IntentName.MOVE_CURSOR_NORTHNORTH,\n  ArrowUp: IntentName.MOVE_CURSOR_NORTHEAST,\n  ArrowLeft: IntentName.MOVE_CURSOR_WEST,\n  ArrowDown: IntentName.MOVE_CURSOR_SOUTHWEST,\n  ArrowRight: IntentName.MOVE_CURSOR_EAST,\n  RightShift: IntentName.MOVE_CURSOR_NORTHWEST,\n  RightControl: IntentName.MOVE_CURSOR_SOUTHEAST,\n\n  ' ': IntentName.INTERACT_WITH_NODE,\n  Backspace: IntentName.DEALLOCATE_NODE,\n  // z: IntentName.ZOOM_RECENTER_AT_NODE,\n  r: IntentName.ZOOM_RECENTER_AT_NODE,\n  '\\\\': IntentName.ZOOM_RECENTER_AT_NODE,\n  '<': IntentName.TRAVEL_UPSTAIRS,\n  '>': IntentName.TRAVEL_DOWNSTAIRS,\n  'Ctrl-Shift-R': IntentName.HARD_REFRESH_PAGE,\n};\n\nexport const noIntent = enumKeys(IntentName).reduce((object: Intent, key) => {\n  object[key] = false;\n  return object;\n}, {} as Intent);\n\nexport const newPlayerIntentState = (): PlayerIntentState => {\n  return {\n    activeIntent: noIntent,\n    newIntent: noIntent,\n    endedIntent: noIntent,\n  };\n};\n","import React from 'react';\nimport { GameState } from '../data/GameState';\nimport {\n  defaultKeyIntentConfig,\n  IntentName,\n  PlayerIntentState,\n} from '../data/PlayerIntentState';\nimport { UpdaterGeneratorType2 } from '../lib/util/updaterGenerator';\n\ntype Props = {\n  updaters: UpdaterGeneratorType2<PlayerIntentState, GameState>;\n  isTextBoxFocused: boolean;\n};\n\ntype State = {\n  keyIntentConfig: keyToIntentMap;\n};\n\n// TODO: enumerate all the keyboard keys we care about\ntype BrowserKeys = string;\n\n/**\n * Holds the mapping of which keyboard keys (as interpreted by the browser)\n * map to which intents, e.g. \"up arrow\" means \"pan left\"\n */\ntype keyToIntentMap = {\n  [key in BrowserKeys]?: IntentName;\n};\n\n/**\n * Empty react element with listeners for keyboard actions.\n */\nexport class KeyboardListenerComponent extends React.Component<Props, State> {\n  constructor(props: Props) {\n    super(props);\n    this.state = {\n      keyIntentConfig: defaultKeyIntentConfig,\n    };\n  }\n\n  componentDidMount() {\n    // console.log('adding event listeners for keyboard component');\n    document.addEventListener('keydown', this.handleKeydown);\n    document.addEventListener('keyup', this.handleKeyup);\n  }\n\n  // NOTE(bowei): does using e.repeat here break when window loses focus??\n  handleKeydown = (e: KeyboardEvent) => {\n    const { keyIntentConfig } = this.state;\n    let key: BrowserKeys = e.key;\n    // special case to handle left/right control and alt keys\n    if (\n      // e.ctrlKey || e.altKey || e.metaKey || e.shiftKey\n      key === 'Control' ||\n      key === 'Shift' ||\n      key === 'Meta' ||\n      key === 'Alt'\n    ) {\n      if (e.location === 1) {\n        key = 'Left' + key;\n      } else if (e.location === 2) {\n        key = 'Right' + key;\n      } else if (e.location === 3) {\n        key = 'Extra' + key;\n      }\n    } else {\n      // reversed order of prefixes! 'Ctrl-Alt-Shift' is canonical order\n      if (e.shiftKey) {\n        key = 'Shift-' + key;\n      }\n      if (e.altKey) {\n        key = 'Alt-' + key;\n      }\n      if (e.ctrlKey) {\n        key = 'Ctrl-' + key;\n      }\n    }\n    const configuredIntent = keyIntentConfig[key];\n    if (configuredIntent) {\n      if (this.props.isTextBoxFocused) {\n        console.log(\n          'bypassing keyboard event processing because text box is focused'\n        );\n        return;\n      } else {\n        // console.log(\"skipping default on keyboard event because text box is not focused\");\n        e.preventDefault();\n      }\n    } else {\n      console.log('Unregistered key ', key, e);\n    }\n\n    if (\n      e.repeat === false &&\n      configuredIntent !== undefined &&\n      configuredIntent !== IntentName.NOOP\n    ) {\n      this.props.updaters.newIntent[configuredIntent].enqueueUpdate(() => {\n        this.props.updaters.newIntent[configuredIntent].enqueueUpdate(\n          () => false\n        );\n        return true;\n      });\n      this.props.updaters.activeIntent[configuredIntent].enqueueUpdate(\n        () => true\n      );\n    }\n  };\n\n  handleKeyup = (e: KeyboardEvent) => {\n    const { keyIntentConfig } = this.state;\n    const key: BrowserKeys = e.key;\n    const configuredIntent = keyIntentConfig[key];\n    if (\n      configuredIntent !== undefined &&\n      configuredIntent !== IntentName.NOOP\n    ) {\n      this.props.updaters.activeIntent[configuredIntent].enqueueUpdate(\n        () => false\n      );\n      this.props.updaters.endedIntent[configuredIntent].enqueueUpdate(() => {\n        this.props.updaters.endedIntent[configuredIntent].enqueueUpdate(\n          () => false\n        );\n        return true;\n      });\n    }\n  };\n\n  componentWillUnmount() {\n    // console.log('removing event listeners for keyboard component');\n    document.removeEventListener('keydown', this.handleKeydown);\n    document.removeEventListener('keyup', this.handleKeyup);\n  }\n\n  render() {\n    return <> </>;\n  }\n}\n","import React from 'react';\nimport { GameState } from './data/GameState';\nimport { Const } from './lib/util/misc';\nimport { UpdaterGeneratorType2 } from './lib/util/updaterGenerator';\n\n// nullable, but should be OK, just remember to populate the context\n// export const GameContext = React.createContext<GameState>(null as any);\n// export const GameUpdatersContext = React.createContext<UpdaterGeneratorType<GameState>>(null as any);\nexport const UseGameStateContext = React.createContext<\n  [Const<GameState>, UpdaterGeneratorType2<GameState>, () => void]\n>([] as any);\n","export const EPSILON = 0.0000001;\n\nexport const epsEqual = (x: number, y: number) => {\n  return Math.abs(x - y) < EPSILON;\n};\n\nexport const epsGreaterThan = (x: number, y: number) => {\n  return x + EPSILON - y > 0;\n};\n\nexport const epsLessThan = (x: number, y: number) => {\n  return x - EPSILON - y < 0;\n};\n","import { EPSILON } from '../epsilon_math';\nimport { Util } from '../misc';\n\nexport interface IVector2 {\n  x: number;\n  y: number;\n}\n\nexport class Vector2 {\n  private _x: number;\n  private _y: number;\n\n  public get x(): number {\n    return this._x;\n  }\n  public get y(): number {\n    return this._y;\n  }\n\n  constructor();\n  constructor(x: number, y: number);\n  constructor(props: { x: number; y: number });\n  constructor(\n    propsOrX: { x: number; y: number } | number = { x: 0, y: 0 },\n    y?: number\n  ) {\n    if (typeof propsOrX === 'number') {\n      this._x = propsOrX;\n      this._y = y!;\n    } else {\n      this._x = propsOrX.x;\n      this._y = propsOrX.y;\n    }\n  }\n\n  public get half(): Vector2 {\n    return new Vector2({ x: this.x / 2, y: this.y / 2 });\n  }\n\n  public static Zero: Vector2 = new Vector2(0, 0);\n  public static One: Vector2 = new Vector2(1, 1);\n\n  static IsVector2(x: any): x is Vector2 {\n    return x instanceof Vector2;\n  }\n\n  static Random(highX: number, highY: number, lowX = 0, lowY = 0) {\n    return new Vector2({\n      x: Util.RandRange(lowX, highX),\n      y: Util.RandRange(lowY, highY),\n    });\n  }\n\n  hash(): string {\n    return this.toString();\n  }\n\n  toString(): string {\n    return `[${this.x}, ${this.y}]`;\n  }\n\n  invert(): Vector2 {\n    return new Vector2({\n      x: -this.x,\n      y: -this.y,\n    });\n  }\n\n  round(): Vector2 {\n    return new Vector2({\n      x: Math.round(this.x),\n      y: Math.round(this.y),\n    });\n  }\n\n  floor(): Vector2 {\n    return new Vector2({\n      x: Math.floor(this.x),\n      y: Math.floor(this.y),\n    });\n  }\n\n  taxicabDistance(p: Vector2): number {\n    return Math.abs(p.x - this.x) + Math.abs(p.y - this.y);\n  }\n\n  diagonalDistance(p: IVector2): number {\n    return Math.max(Math.abs(p.x - this.x), Math.abs(p.y - this.y));\n  }\n\n  distance(p: IVector2): number {\n    let dx = Math.abs(p.x - this.x);\n    let dy = Math.abs(p.y - this.y);\n\n    return Math.sqrt(dx * dx + dy * dy);\n  }\n\n  translate(p: { x: number; y: number }): Vector2 {\n    return new Vector2({\n      x: this.x + p.x,\n      y: this.y + p.y,\n    });\n  }\n\n  subtract(p: { x: number; y: number }): Vector2 {\n    return new Vector2({\n      x: this.x - p.x,\n      y: this.y - p.y,\n    });\n  }\n\n  add(p: { x: number; y: number }): Vector2 {\n    return new Vector2({\n      x: this.x + p.x,\n      y: this.y + p.y,\n    });\n  }\n\n  addX(x: number): Vector2 {\n    return new Vector2({\n      x: this.x + x,\n      y: this.y,\n    });\n  }\n\n  addY(y: number): Vector2 {\n    return new Vector2({\n      x: this.x,\n      y: this.y + y,\n    });\n  }\n\n  subtractX(x: number): Vector2 {\n    return new Vector2({\n      x: this.x - x,\n      y: this.y,\n    });\n  }\n\n  subtractY(y: number): Vector2 {\n    return new Vector2({\n      x: this.x,\n      y: this.y - y,\n    });\n  }\n\n  clampX(low: number, high: number): Vector2 {\n    let newX = this.x;\n\n    if (newX < low) {\n      newX = low;\n    }\n    if (newX > high) {\n      newX = high;\n    }\n\n    return new Vector2({\n      x: newX,\n      y: this.y,\n    });\n  }\n\n  clampY(low: number, high: number): Vector2 {\n    let newY = this.y;\n\n    if (newY < low) {\n      newY = low;\n    }\n    if (newY > high) {\n      newY = high;\n    }\n\n    return new Vector2({\n      x: this.x,\n      y: newY,\n    });\n  }\n\n  scale(\n    about: { x: number; y: number },\n    amount: { x: number; y: number }\n  ): Vector2 {\n    return new Vector2({\n      x: (this.x - about.x) * amount.x + about.x,\n      y: (this.y - about.y) * amount.y + about.y,\n    });\n  }\n\n  rotate(origin: Vector2, angle: number): Vector2 {\n    angle = angle / (180 / Math.PI);\n\n    return new Vector2({\n      x:\n        Math.cos(angle) * (this.x - origin.x) -\n        Math.sin(angle) * (this.y - origin.y) +\n        origin.x,\n      y:\n        Math.sin(angle) * (this.x - origin.x) +\n        Math.cos(angle) * (this.y - origin.y) +\n        origin.y,\n    });\n  }\n\n  equals(other: Vector2 | undefined | null): boolean {\n    if (other === undefined || other === null) {\n      return false;\n    }\n\n    return (\n      Math.abs(this.x - other.x) < EPSILON &&\n      Math.abs(this.y - other.y) < EPSILON\n    );\n  }\n\n  multiply(other: Vector2 | number): Vector2 {\n    if (typeof other === 'number') {\n      return new Vector2({\n        x: this.x * other,\n        y: this.y * other,\n      });\n    } else {\n      return new Vector2({\n        x: this.x * other.x,\n        y: this.y * other.y,\n      });\n    }\n  }\n\n  divide(other: Vector2 | number): Vector2 {\n    if (typeof other === 'number') {\n      return new Vector2({\n        x: this.x / other,\n        y: this.y / other,\n      });\n    } else {\n      return new Vector2({\n        x: this.x / other.x,\n        y: this.y / other.y,\n      });\n    }\n  }\n\n  toJSON(): any {\n    return {\n      __type: 'Vector2',\n      x: this.x,\n      y: this.y,\n    };\n  }\n\n  transform(trans: Vector2, scale: number): Vector2 {\n    return new Vector2({\n      x: Math.floor((this.x - trans.x) * scale),\n      y: Math.floor((this.y - trans.y) * scale),\n    });\n  }\n\n  normalize(): Vector2 {\n    if (this.x === 0 && this.y === 0) {\n      return this;\n    }\n\n    const length = Math.sqrt(this.x * this.x + this.y * this.y);\n\n    return new Vector2({\n      x: this.x / length,\n      y: this.y / length,\n    });\n  }\n\n  withX(newX: number): Vector2 {\n    return new Vector2({\n      x: newX,\n      y: this.y,\n    });\n  }\n\n  withY(newY: number): Vector2 {\n    return new Vector2({\n      x: this.x,\n      y: newY,\n    });\n  }\n\n  invertX(): Vector2 {\n    return new Vector2({\n      x: -this.x,\n      y: this.y,\n    });\n  }\n\n  lerp(other: Vector2, t: number): Vector2 {\n    if (t > 1 || t < 0) {\n      console.error('Lerp t must be between 0 and 1.');\n    }\n    if (t === 0) return this;\n    if (t === 1) return other;\n\n    return this.scale({ x: 0, y: 0 }, { x: 1 - t, y: 1 - t }).add(\n      other.scale({ x: 0, y: 0 }, { x: t, y: t })\n    );\n  }\n\n  lerp2D(other: Vector2, tx: number, ty: number): Vector2 {\n    if (tx > 1 || tx < 0 || ty > 1 || ty < 0) {\n      console.error('Lerp t must be between 0 and 1.');\n    }\n    return this.scale({ x: 0, y: 0 }, { x: 1 - tx, y: 1 - ty }).add(\n      other.scale({ x: 0, y: 0 }, { x: tx, y: ty })\n    );\n  }\n\n  coserp(other: Vector2, t: number): Vector2 {\n    t = 0.5 * (1 + Math.cos(2 * t * Math.PI));\n\n    return this.lerp(other, t);\n  }\n\n  static Deserialize(obj: any): Vector2 | null {\n    if (!obj || !obj.hasOwnProperty('x') || !obj.hasOwnProperty('y')) {\n      console.error('Failed deserializing point');\n      return null;\n    }\n\n    return new Vector2({\n      x: obj.x,\n      y: obj.y,\n    });\n  }\n\n  static Serialize(obj: Vector2): string {\n    return JSON.stringify(this.SerializeToObject(obj));\n  }\n\n  static SerializeToObject(obj: Vector2): object {\n    return { x: obj.x, y: obj.y };\n  }\n}\n","const doInvertColors = false;\n\nexport const COLORS = Object.fromEntries(\n  Object.entries({\n    // good colors\n    backgroundBlue: 0x222222, // 444444 or 383838 also work\n    // nodePink: 0xeeaaaa,\n    // nodeLavender: 0xcc88ee,\n    // nodeBlue: 0x99bbff,\n    // nodeAqua: 0xbbccdd,\n    // nodeGrey: 0xddffdd,\n\n    // shitty colors\n    // backgroundBlue: 0xffffff,\n    // nodePink: 0x332244,\n    nodePink: 0x333333, // try this?\n    nodeLavender: 0x4b4b4b,\n    nodeBlue: 0x444444,\n\n    // used for lock nodes\n    nodeAqua: 0xffaaaa,\n    // gateTint: 0xaaaaaa,\n    gateTint: 0xffffff,\n\n    selectedTint: 0xbbbbff,\n    allocatedTint: 0x444444,\n    nodeBorder: 0x666666,\n    nullTint: 0xffffff,\n\n    // colors that dont matter too much\n    tooltipBorderBlack: 0x222222,\n    tooltipFillWhite: 0xeeeeee,\n    white: 0xffffff,\n    grayBlack: 0x1d1d1d,\n    borderBlack: 0x111111,\n    borderWhite: 0x666666,\n    black: 0x000000,\n    textWhite: 0x888888,\n  }).map(([k, v]) => [k, doInvertColors ? 0xffffff - v : v])\n);\n\n// baseColor = 0xccee88; // bright yellow green\n// baseColor = 0xcccccc; // gray almost invisible\n// baseColor = 0xccccee; // lavender almost invisible\n// baseColor = 0xaacccc; // lavender almost invisible\n// baseColor = 0xdddddd; // grayish white?\n// baseColor = 0xaaaaaa; // dark grayish brown\n// baseColor = 0x777777; // very dark brown\n\nexport default COLORS;\n\nexport function colorToCss(c: number): string {\n  return '#' + c.toString(16);\n}\n","import { DeserializationError } from '../misc';\n\n/**\n * Intended as a typescript-friendly replacement for {[k: string]: boolean} that allows us to specify what the key type should be (\n * rather than allowing any keyType.toString() to be a valid key, and without going through the trouble of declaring distinguishable\n * types for each key type we want to use). Also serves as a slightly different version of ES6 native Set(), which is hardcoded\n * to use === for object referential equality.\n *\n * NOTE: this assume hash() is a strong test for equality, i.e. 2 objects are considered equal if and only if their hashes are the same!!!\n * TODO: write StrictHashSet<K extends {hash(): string, equals(k: K): boolean}> to handle custom equality checks\n */\nexport class HashSet<K extends { hash(): string }> {\n  private _values: HashMap<K, K>;\n\n  constructor(initialValues: K[] = []) {\n    this._values = new HashMap<K, K>();\n\n    for (const value of initialValues) {\n      this.put(value);\n    }\n  }\n\n  remove(key: K): void {\n    this._values.remove(key);\n  }\n\n  put(key: K): void {\n    this._values.put(key, key);\n  }\n\n  get(key: K): boolean {\n    return this._values.get(key) !== undefined;\n  }\n\n  contains(key: K): boolean {\n    return this._values.contains(key);\n  }\n\n  values(): K[] {\n    return this._values.values();\n  }\n\n  // hash(): string {\n  //   return this._values.hashKeyset();\n  // }\n\n  clone(): HashSet<K> {\n    let n = new HashSet<K>();\n    n._values = this._values.clone();\n    return n;\n  }\n\n  size(): number {\n    return this._values.size();\n  }\n\n  equals(other: HashSet<K> | undefined | null) {\n    if (other === undefined || other === null) {\n      return false;\n    }\n\n    if (this.size() !== other.size()) {\n      return false;\n    }\n\n    for (let k of this.values()) {\n      if (!other.contains(k)) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  // *[Symbol.iterator]() {\n  //   // construct a new iterator. note that as usual\n  //   for (let key of Object.keys(this._values)) {\n  //     yield key;\n  //   }\n  // }\n}\n\n/**\n * Intended as a typescript-friendly replacement for {[k: string]: V} that allows us to specify what the key type should be (\n * rather than allowing any keyType.toString() to be a valid key, and without going through the trouble of declaring distinguishable\n * types for each key type we want to use). Also serves as a slightly different version of ES6 native Map(), which is hardcoded\n * to use === for object referential equality.\n *\n * NOTE: this assume hash() is a strong test for equality, i.e. 2 objects are considered equal if and only if their hashes are the same!!!\n * TODO: write StrictHashMap<K extends {hash(): string, equals(K): boolean}> to handle custom equality checks\n */\nexport class HashMap<K extends { hash(): string }, V> {\n  protected _values: { [key: string]: V } = {};\n\n  constructor(initialValues: [K, V][] = []) {\n    for (const [key, value] of initialValues) {\n      this.put(key, value);\n    }\n  }\n\n  put(key: K, value: V) {\n    this._values[key.hash()] = value;\n  }\n\n  remove(key: K): void {\n    delete this._values[key.hash()];\n  }\n\n  get(key: K): V | undefined {\n    return this._values[key.hash()];\n  }\n\n  contains(key: K): boolean {\n    // V may be an undefined type\n    return this.get(key) !== undefined && key.hash() in this._values;\n  }\n\n  values(): V[] {\n    return Object.values(this._values);\n    // return Object.keys(this._values).map(key => this._values[key]); // why grant???\n  }\n\n  // *[Symbol.iterator]() {\n  //   // construct a new iterator. note that as usual editing the object during iteration is not supported\n  //   for (let key of Object.keys(this._values)) {\n  //     yield key;\n  //   }\n  // }\n\n  // hashes only the keys - use HashableHashMap if you know that the value type here is also hashable\n  // hashKeyset(): string {\n  //   const hashes: number[] = Object.keys(this._values).map(s => hashCode(s));\n  //   let code: number = hashes.reduce((pv, cv) => pv + cv);\n  //   return code.toString();\n  // }\n\n  size(): number {\n    return Object.keys(this._values).length;\n  }\n\n  clone(): HashMap<K, V> {\n    let n = new HashMap<K, V>();\n    n._values = { ...this._values };\n    return n;\n  }\n}\n\nexport class HashableHashMap<\n  K extends { hash(): string },\n  V extends { hash(): string }\n> extends HashMap<K, V> {\n  hash(): string {\n    const hashes: number[] = Object.entries(this._values).map(\n      ([s, v]) => hashCode(s) + hashCode(v.hash())\n    );\n    let code: number = hashes.reduce((pv, cv) => pv + cv);\n    return code.toString();\n  }\n}\n\n/**\n * Same as HashMap, but actually stores the keys used to key the hashmap, instead of just their hashes.\n * Allows iteration over the full key-value pair set.\n */\nexport class KeyedHashMap<K extends { hash(): string }, V> {\n  private _kvalues: { [key: string]: [K, V] } = {};\n\n  constructor(initialValues: [K, V][] = []) {\n    for (const [key, value] of initialValues) {\n      this.put(key, value);\n    }\n  }\n\n  put(key: K, value: V) {\n    this._kvalues[key.hash()] = [key, value];\n  }\n\n  remove(key: K): void {\n    delete this._kvalues[key.hash()];\n  }\n\n  get(key: K): V | undefined {\n    return this._kvalues[key.hash()]?.[1];\n  }\n\n  contains(key: K): boolean {\n    // V may be an undefined type\n    return this.get(key) !== undefined && key.hash() in this._kvalues;\n  }\n\n  keys(): K[] {\n    return Object.keys(this._kvalues).map((key) => this._kvalues[key][0]);\n  }\n\n  entries(): [K, V][] {\n    return Object.keys(this._kvalues).map((key) => this._kvalues[key]);\n  }\n\n  values(): V[] {\n    return Object.keys(this._kvalues).map((key) => this._kvalues[key][1]);\n  }\n\n  hashKeyset(): string {\n    const hashes: number[] = Object.keys(this._kvalues).map((s) => hashCode(s));\n    let code: number = hashes.reduce((pv, cv) => pv + cv);\n    return code.toString();\n  }\n\n  clone(): KeyedHashMap<K, V> {\n    let n = new KeyedHashMap<K, V>();\n    n._kvalues = { ...this._kvalues };\n    return n;\n  }\n\n  size(): number {\n    return Object.keys(this._kvalues).length;\n  }\n\n  static SerializeToObject<K extends { hash(): string }, V>(\n    obj: KeyedHashMap<K, V>,\n    keySerializer?: (k: K) => object,\n    valueSerializer?: (v: V) => object\n  ): object {\n    return obj.entries().map((entry) => {\n      const [k, v] = entry;\n\n      return [\n        keySerializer ? keySerializer(k) : k,\n        valueSerializer ? valueSerializer(v) : v,\n      ];\n    });\n  }\n\n  static Deserialize<K extends { hash(): string }, V>(\n    obj: any,\n    keyDeserializer?: (o: any) => K,\n    valueDeserializer?: (o: any) => V\n  ): KeyedHashMap<K, V> | null {\n    if (!obj || !Array.isArray(obj)) {\n      console.error('Failed deserializing keyed hash map');\n      return null;\n    }\n\n    try {\n      const entries = obj.map((entry): [K, V] => {\n        if (!entry || !Array.isArray(entry) || entry.length !== 2) {\n          throw new DeserializationError(\n            `Failed deserializing entry ${JSON.stringify(entry)}`\n          );\n        }\n        const [k, v] = entry as [any, any];\n\n        const key: K = keyDeserializer ? keyDeserializer(k) : k;\n        const value: V = valueDeserializer ? valueDeserializer(v) : v;\n\n        return [key, value];\n      });\n      return new KeyedHashMap(entries);\n    } catch (e) {\n      if (e instanceof DeserializationError) {\n        console.error('Failed deserializing keyed hash map', e);\n        return null;\n      } else {\n        throw e;\n      }\n    }\n  }\n}\n\nexport class DefaultHashMap<K extends { hash(): string }, V> {\n  private _values: { [key: string]: V } = {};\n  private _makeDefault: () => V;\n\n  constructor(makeDefaultValue: () => V) {\n    this._makeDefault = makeDefaultValue;\n  }\n\n  put(key: K, value: V) {\n    this._values[key.hash()] = value;\n  }\n\n  get(key: K): V {\n    if (this._values[key.hash()] === undefined) {\n      this._values[key.hash()] = this._makeDefault();\n    }\n\n    return this._values[key.hash()];\n  }\n}\n\n// Hash a string to a number. source: https://gist.github.com/hyamamoto/fd435505d29ebfa3d9716fd2be8d42f0\nexport function hashCode(s: string): number {\n  let h = 0;\n  for (let i = 0; i < s.length; i++) {\n    h = (Math.imul(31, h) + s.charCodeAt(i)) | 0;\n  }\n  return h;\n}\n\n// declare global {\n//   interface Array<T extends { hash(): string }> {\n//     hash(): string\n//   }\n//\n//   interface Number {\n//     hash(): string\n//   }\n//\n//   interface String {\n//     hash(): String\n//   }\n// }\n//\n// Array.prototype.hash = function () {\n//   return hashArray(this);\n// }\n//\n// Number.prototype.hash = function () {\n//   return this.toString();\n// }\n//\n// String.prototype.hash = function () {\n//   return this;\n// }\n//\n// function hashArray<T extends { hash(): string }>(arr: T[]): string {\n//   return arr.map(elt => hashCode(elt.hash())).reduce((pv, cv) => 31 * pv + cv).hash();\n// }\n//\n","import * as Pixi from 'pixi.js';\nimport { IVector2 } from '../util/geometry/vector2';\n\nexport function PixiPointFrom(p: IVector2): Pixi.Point {\n  return new Pixi.Point(p.x, p.y);\n}\n","const RED_MASK = 0xff0000;\nconst GREEN_MASK = 0x00ff00;\nconst BLUE_MASK = 0x0000ff;\nconst RED_UNIT = 0x010000;\nconst GREEN_UNIT = 0x000100;\nconst BLUE_UNIT = 0x000001;\nconst COLOR_MAX = 255;\n\n/**\n * Multiplies colors (0xFFFFFF === 1). use for applying tints manually.\n * @param color1 A base color\n * @param color2 A tint\n */\nexport function multiplyColor(color1: number, color2: number): number {\n  let reds = [color1 & RED_MASK, color2 & RED_MASK];\n  let greens = [color1 & GREEN_MASK, color2 & GREEN_MASK];\n  let blues = [color1 & BLUE_MASK, color2 & BLUE_MASK];\n  let out = Math.round(((reds[0] / RED_UNIT) * reds[1]) / RED_MASK) * RED_UNIT;\n  out +=\n    Math.round(((greens[0] / GREEN_UNIT) * greens[1]) / GREEN_MASK) *\n    GREEN_UNIT;\n  out +=\n    Math.round(((blues[0] / BLUE_UNIT) * blues[1]) / BLUE_MASK) * BLUE_UNIT;\n  return out;\n}\n\nexport function addColor(color1: number, color2: number): number {\n  let reds = [color1 & RED_MASK, color2 & RED_MASK];\n  let greens = [color1 & GREEN_MASK, color2 & GREEN_MASK];\n  let blues = [color1 & BLUE_MASK, color2 & BLUE_MASK];\n  let out =\n    Math.round(Math.min(reds[0] / RED_UNIT + reds[1] / RED_UNIT, COLOR_MAX)) *\n    RED_UNIT;\n  out +=\n    Math.round(\n      Math.min(greens[0] / GREEN_UNIT + greens[1] / GREEN_UNIT, COLOR_MAX)\n    ) * GREEN_UNIT;\n  out +=\n    Math.round(\n      Math.min(blues[0] / BLUE_UNIT + blues[1] / BLUE_UNIT, COLOR_MAX)\n    ) * BLUE_UNIT;\n  return out;\n}\n/**\n *\n * @param args either { target, proportion, base } or { color, opacity, background } or target\n * @param arg2 if args was a single number, this should be opacity\n * @param arg3 if args was a single number, this should be background, or default to 0 (black) background\n */\n\nexport function interpolateColor(\n  args:\n    | { target: number; proportion: number; base?: number }\n    | { color: number; opacity: number; background?: number }\n    | number,\n  arg2?: number,\n  arg3?: number\n): number {\n  if (typeof args === 'object') {\n    if (args.hasOwnProperty('target')) {\n      let _args: any = args;\n      return _interpolateColor(_args);\n    } else if (args.hasOwnProperty('color')) {\n      let _args: any = args;\n      return _interpolateColor({\n        target: _args.color,\n        proportion: _args.opacity,\n        base: _args.background,\n      });\n    } else {\n      throw new Error(`missing parameter in interpolateColor: ${args}`);\n    }\n  } else {\n    if (arg2) {\n      return _interpolateColor({ target: args, proportion: arg2, base: arg3 });\n    } else {\n      throw new Error(\n        `missing parameter in interpolateColor: ${args} ${arg2} ${arg3}`\n      );\n    }\n  }\n}\nfunction _interpolateColor(args: {\n  target: number;\n  proportion: number;\n  base?: number;\n}): number {\n  const { target, base = 0, proportion = 1 } = args;\n  let reds = [target & RED_MASK, base & RED_MASK];\n  let greens = [target & GREEN_MASK, base & GREEN_MASK];\n  let blues = [target & BLUE_MASK, base & BLUE_MASK];\n  let out =\n    Math.round(\n      (reds[0] / RED_UNIT) * proportion +\n        (reds[1] / RED_UNIT) * (1 - proportion)\n    ) * RED_UNIT;\n  out +=\n    Math.round(\n      (greens[0] / GREEN_UNIT) * proportion +\n        (greens[1] / GREEN_UNIT) * (1 - proportion)\n    ) * GREEN_UNIT;\n  out +=\n    Math.round(\n      (blues[0] / BLUE_UNIT) * proportion +\n        (blues[1] / BLUE_UNIT) * (1 - proportion)\n    ) * BLUE_UNIT;\n\n  return out;\n}\n\n// h in degrees; s, v in [0, 1]\ntype Hsv = {\n  h: number;\n  s: number;\n  v: number;\n};\n\nconst SECTOR_DEGREES = 60; // 6 color sectors that total 360 degrees\n\n// source: https://stackoverflow.com/questions/17242144/javascript-convert-hsb-hsv-color-to-rgb-accurately/54024653#54024653\n// and https://stackoverflow.com/questions/8022885/rgb-to-hsv-color-in-javascript\n// tested using: https://stackoverflow.com/questions/52193529/is-it-possible-to-import-a-typescript-into-a-running-instance-of-ts-node-repl\nexport function hexToHsv(color: number): Hsv {\n  const [r, g, b] = [\n    (color & RED_MASK) / RED_UNIT / COLOR_MAX,\n    (color & GREEN_MASK) / GREEN_UNIT / COLOR_MAX,\n    (color & BLUE_MASK) / BLUE_UNIT / COLOR_MAX,\n  ];\n  const v = Math.max(r, g, b);\n  const cMin = Math.min(r, g, b);\n  const range = v - cMin;\n  const hueSector =\n    range &&\n    (v === r\n      ? (g - b) / range\n      : v === g\n      ? 2 + (b - r) / range\n      : 4 + (r - g) / range);\n  const h = SECTOR_DEGREES * (hueSector < 0 ? hueSector + 6 : hueSector);\n  return {\n    h,\n    s: v && range / v,\n    v,\n  };\n}\n\nexport function hsvToHex(hsv: Hsv): number {\n  const [r, g, b] = [\n    hsvToHexHelper(5, hsv),\n    hsvToHexHelper(3, hsv),\n    hsvToHexHelper(1, hsv),\n  ];\n  return r * RED_UNIT + g * GREEN_UNIT + b * BLUE_UNIT;\n}\n\nfunction hsvToHexHelper(colorDirection: number, hsv: Hsv) {\n  const { h, s, v } = hsv;\n  const k = (colorDirection + h / SECTOR_DEGREES) % 6;\n  const colorPercentUnclamped = Math.min(k, 4 - k);\n  const colorPercent = Math.max(0, Math.min(colorPercentUnclamped, 1));\n  // console.log({ h, s, v , colorDirection, k, colorPercentUnclamped, colorPercent, })\n  return Math.round(v * (1 - s * colorPercent) * COLOR_MAX);\n}\n\nexport function invertColor(c: number): number {\n  return 0xffffff - c;\n}\n","import { Const } from './misc';\nimport { UpdaterFn, UpdaterFn2, UpdaterFnParam2 } from './updaterGenerator';\n\n/**\n *\n * @param fn an arbitrary callback which performs some operation with side effects.\n * @returns a tuple: [batchedFn, fireBatch].\n * batchedFn takes the same arguments as fn, but the side effects are delayed until fireBatch is called.\n * if batchedFn is called multiple times, those invocations are stored in order, and then popped off in order when fireBatch is called.\n */\nexport function batchify<A extends any[]>(\n  fn: (...args: A) => void\n): [(...args: A) => void, () => void] {\n  let batch: A[] = [];\n\n  return [\n    (...args: A) => {\n      batch.push(args);\n      // console.log({ stack: new Error().stack, batchSize: batch.length });\n      // console.log({ batchSize: batch.length });\n    },\n    () => {\n      if (batch.length !== 0) {\n        console.log({ fired: batch.length });\n      }\n      for (let a of batch) {\n        fn(...a);\n      }\n      batch = [];\n    },\n  ];\n}\n\n/**\n * Same use case and types as [batchify], however, specifically we expect [fn] to be a setState function which takes value-or-callback\n * as its single argument, and instead of calling [fn] repeatedly for each callback in the batch, we apply the callbacks in the batch\n * sequentially to get a single state update which we then provide to [fn].\n */\nexport function batchifySetState<T>(\n  fn: UpdaterFn<T> | UpdaterFn2<T, T>\n): [UpdaterFn2<T, T>, () => void] {\n  let batch: UpdaterFnParam2<T, T>[] = [];\n\n  return [\n    (arg: UpdaterFnParam2<T, T>) => {\n      batch.push(arg);\n      // console.log({ batchSize: batch.length });\n    },\n    () => {\n      if (batch.length === 0) {\n        return;\n      }\n      // console.log({ fired: batch.length });\n      let thisBatch = [...batch];\n      batch = [];\n      (fn as any)((prev: any) => {\n        let next = prev;\n        for (let valueOrCallback of thisBatch) {\n          if (typeof valueOrCallback === 'function') {\n            next = (valueOrCallback as (t: Const<T>) => Const<T>)(next);\n          } else {\n            next = valueOrCallback;\n          }\n        }\n        return next;\n      });\n    },\n  ];\n}\n","import { Const } from './misc';\n\nexport type UpdaterFnParam2<T, W> =\n  | ((prev: Const<T>, prevWhole: W) => Const<T>)\n  | (T extends Function ? never : T); // (T | ((prev: T, prevWhole: W) => T));\n\nexport type UpdaterFn2<T, W> = (arg: UpdaterFnParam2<T, W>) => void;\n\n/**\n * Represent the type which has the same deep object struture as T but instead of values, it has\n * functions on [getUpdater], [enqueueUpdate], and [update] attached to every level of the object structure.\n */\nexport type UpdaterGeneratorType2<T, W = T> = {\n  [k in keyof T]: (T[k] extends { [kkt: string]: any }\n    ? UpdaterGeneratorType2<T[k], W>\n    : {}) & {\n    getUpdater: () => UpdaterFn2<T[k], W>;\n    enqueueUpdate: UpdaterFn2<T[k], W>;\n  };\n} & {\n  getUpdater: () => UpdaterFn2<T, W>;\n  enqueueUpdate: UpdaterFn2<T, W>;\n};\n\n// helper method for the recursion\nfunction updaterGenerator2Helper<T, W>(\n  dataObject: T,\n  dataUpdater: UpdaterFn2<T, W>\n): UpdaterGeneratorType2<T, W> {\n  const updaters: UpdaterGeneratorType2<T, W> = {} as any;\n  updaters.getUpdater = () => dataUpdater;\n  updaters.enqueueUpdate = dataUpdater;\n  if (\n    dataObject === null ||\n    dataObject === undefined ||\n    typeof dataObject !== 'object'\n  ) {\n    return updaters;\n  } else {\n    const keys: (keyof T)[] = Object.keys(dataObject) as any;\n    keys.forEach((key: keyof T) => {\n      if (key === 'enqueueUpdate' || key === 'getUpdater' || key === 'update') {\n        throw Error(\n          `Invalid key in updaterGenerator: ${key} conflicts with reserved keywords enqueueUpdate, update, getUpdater.`\n        );\n      }\n      function keyUpdater(\n        newValueOrCallback: UpdaterFnParam2<T[typeof key], W>\n      ) {\n        if (typeof newValueOrCallback === 'function') {\n          dataUpdater((oldData: Const<T>, wholeData: W) => {\n            const newKey = (\n              newValueOrCallback as (\n                prev: Const<T[typeof key]>,\n                whole: W\n              ) => T[typeof key]\n            )(\n              oldData[key] as any as Const<T[typeof key]>, // NOTE(bowei): typescript does not recognize Const<T>[typeof key] == Const<T[typeof key]>\n              wholeData\n            );\n            if (oldData[key] === newKey) {\n              return oldData; // no update detected, no need to update anything\n            } else {\n              const newData = {\n                ...oldData,\n                [key]: newKey,\n              };\n              return newData;\n            }\n          });\n        } else {\n          dataUpdater((oldData, wholeData) => ({\n            ...oldData,\n            [key]: newValueOrCallback,\n          }));\n        }\n      }\n      updaters[key] = updaterGenerator2Helper<T[typeof key], W>(\n        dataObject[key],\n        keyUpdater\n      ) as unknown as typeof updaters[typeof key];\n    });\n    return updaters;\n  }\n}\n\n/**\n * Convenience method for generating setState<FancyObject.sub.component>() from setState<FancyObject> callbacks.\n * If used in react, recommended that this be memoized.\n *\n * @generic T should be a data-only object - nested objects are allowed but arrays, sets not supported\n * @param dataObject ANY instance of T, used only for its keys. MUST have all keys present\n * @param setState an updater function, which can be called as: dataUpdater(newT) or\n *   dataUpdater((oldT) => { return newTFromOldT(oldT) }) ; e.g. react setState() function.\n * @return a deep object that has the same keys as T, except each key also has a getUpdater()/set/update member;\n *   the getUpdater() on a subobject of T acts similarly to the [setState] param but to the subobject rather than the whole object;\n *   the whole object is also available as the second argument of the callback\n * e.g. :\n *   let gameStateUpdater = updaterGenerator(skeletonObject, setGameState);\n *   let setName = gameStateUpdater.player.name.getUpdater();\n *   gameStateUpdater.player.name.set(newName);\n *   gameStateUpdater.player.name.update((oldName, wholeObject) => oldName + \" \");\n *\n */\nexport function updaterGenerator2<T>(\n  dataObject: T,\n  // setState: UpdaterFn2<T, T> | UpdaterFn<T>,\n  setState: UpdaterFn2<T, T>\n  // setState: UpdaterFn<T>,\n): UpdaterGeneratorType2<T> {\n  const dataUpdater2 = (stateCallbackFunction: UpdaterFnParam2<T, T>) => {\n    if (typeof stateCallbackFunction === 'function') {\n      setState((prev: Const<T>) => {\n        // if T is a function type already, typescript correctly notifies us that this will fail\n        const next = (\n          stateCallbackFunction as (\n            prev: Const<T>,\n            prevWhole: Const<T>\n          ) => Const<T>\n        )(\n          // const next = (stateCallbackFunction as (prev: T, prevWhole: T) => T)(\n          prev,\n          prev\n        );\n        // console.log(\" in updater generator 2\", { next });\n        return next;\n      });\n    } else {\n      setState(stateCallbackFunction);\n    }\n  };\n  return updaterGenerator2Helper<T, T>(dataObject, dataUpdater2);\n}\n\nexport type UpdaterFnParam<T> =\n  | (T extends Function ? never : T)\n  | ((prev: T) => T);\nexport type UpdaterFn<T> = (arg: UpdaterFnParam<T>) => void;\n","import * as Pixi from 'pixi.js';\nimport { batchifySetState } from '../../lib/util/batchify';\nimport { Const } from '../../lib/util/misc';\nimport {\n  UpdaterFn2,\n  updaterGenerator2,\n  UpdaterGeneratorType2,\n} from '../../lib/util/updaterGenerator';\n\ntype Props = {\n  args?: {\n    markForceUpdate?: (self: LifecycleHandlerBase<any, any>) => void;\n    [k: string]: any;\n  };\n  [k: string]: any;\n};\n\ntype State = {};\n\n/**\n * Bundle used for associating child components with this component.\n * Contains the childClass class reference,\n * the constructed instance itself (if already constructed),\n * and a pure function for computing child props from parent props & parent state.\n */\ntype ChildInstructions<\n  ChildInstanceType,\n  ChildPropsType extends Props,\n  ParentPropsType extends Props,\n  ParentStateType extends State\n> = {\n  childClass: new (props: ChildPropsType) => ChildInstanceType;\n  instance?: ChildInstanceType;\n  propsFactory: (\n    parentProps: ParentPropsType,\n    parentState: Const<ParentStateType>\n  ) => ChildPropsType;\n};\n\nclass ChildrenArray<P extends Props, S extends State> {\n  private _values: ChildInstructions<\n    LifecycleHandlerBase<any, any, any>,\n    any,\n    P,\n    S\n  >[] = [];\n\n  public add<CIT extends LifecycleHandlerBase<any, any, any>, CPT>(\n    c: ChildInstructions<CIT, CPT, P, S>\n  ) {\n    // if (\n    //   this._values.indexOf(c) === -1 ||\n    //   (c.instance && this.contains(c.instance))\n    // ) {\n    //   // do nohting - its already in here\n    // }\n    this._values.push(c);\n  }\n\n  public remove<CIT extends LifecycleHandlerBase<any, any, any>>(\n    c: CIT\n  ): ChildInstructions<CIT, any, P, S> | undefined {\n    const removed = this._values.splice(\n      this._values.findIndex((it) => it.instance === c),\n      1\n    );\n    if (removed.length === 0) {\n      return undefined;\n    } else {\n      return removed[0] as ChildInstructions<CIT, any, P, S>;\n    }\n  }\n\n  public contains<CIT extends LifecycleHandlerBase<any, any, any>>(\n    c: CIT\n  ): boolean {\n    return this._values.findIndex((it) => it.instance === c) > -1;\n  }\n\n  public get<CIT extends LifecycleHandlerBase<CPT, any>, CPT>(\n    c: CIT\n  ): ChildInstructions<CIT, CPT, P, S> | undefined {\n    return this._values.find((it) => it.instance === c) as\n      | ChildInstructions<CIT, CPT, P, S>\n      | undefined;\n  }\n\n  public clone(): ChildrenArray<P, S> {\n    let cloned = new ChildrenArray<P, S>();\n    cloned._values = [...this._values];\n    return cloned;\n  }\n\n  public forEach(\n    callbackfn: (\n      value: ChildInstructions<LifecycleHandlerBase<any, any>, any, P, S>,\n      index: number,\n      array: ChildInstructions<LifecycleHandlerBase<any, any>, any, P, S>[]\n    ) => void\n  ) {\n    this._values.forEach(callbackfn);\n  }\n}\n\n// export interface LifecycleHandlerBase<P extends Props, S extends State> {\n// // useful for interface merging?? https://stackoverflow.com/questions/44153378/typescript-abstract-optional-method\n// }\n\n/**\n * LifecycleHandlerConstructor <- this should take the usual props, and will return new proxy, new base component(props), the handler object which has the construct() property and that function in it\n */\n// export function LifecycleHandlerConstructor<T>(props:\n// class and interface merging??? https://stackoverflow.com/questions/44153378/typescript-abstract-optional-method\nexport abstract class LifecycleHandlerBase<\n  P extends Props,\n  S extends State,\n  U extends UpdaterGeneratorType2<S, S> = UpdaterGeneratorType2<S, S>\n> {\n  // public, only to interface with non lifecycleHandler classes that we have yet to refactor\n  public abstract container: Pixi.Container;\n  // public, only to allow useState function below to set this.state\n  // abstract, to remind implementers to set it in the constructor\n  // Immutable state! use updaters to update it, and then lifecycle will handle firing the batched updates.\n  public abstract state: Const<S>;\n\n  // updater functions generate from state. The only way to update state. Also useful to pass down selectively to children.\n  protected stateUpdaters?: U;\n\n  protected _staleProps: P; // NOTE(bowei): need it for args for now; maybe we can extract out args?\n  private _children: ChildrenArray<P, S> = new ChildrenArray();\n\n  /**\n   * Holds references to children which we will soon be constructing and adding to pixi hierarchy\n   */\n  private _childrenToConstruct: ChildrenArray<P, S> = new ChildrenArray();\n  /**\n   * Holds references to the children which are marked for deletion but have not been deleted and deconstructed yet\n   */\n  private _childrenToDestruct: ChildrenArray<P, S> = new ChildrenArray();\n  /**\n   * Holds children which have requested that they be forcefully updated even if props have not changed\n   */\n  private _forceUpdates: ChildrenArray<P, S> = new ChildrenArray();\n\n  constructor(props: P) {\n    this._staleProps = props;\n  }\n\n  protected addChild<CIT extends LifecycleHandlerBase<CPT, any, any>, CPT>(\n    c: ChildInstructions<CIT, CPT, P, S>\n  ) {\n    this._children.add(c); // make sure children are updated\n    this._childrenToConstruct.add(c); // if not already constructed/added to pixi hierarchy, queue it up\n  }\n\n  protected registerChild<CIT extends LifecycleHandlerBase<CPT, any, any>, CPT>(\n    c: ChildInstructions<CIT, CPT, P, S>\n  ) {\n    // only add children to updateable, not constructed\n    // Note that this also skips adding them to pixi hierarchy\n    this._children.add(c);\n  }\n\n  protected removeChild<CIT extends LifecycleHandlerBase<any, any, any>>(\n    c: CIT\n  ) {\n    let childInfo = this._children.remove(c); // make sure children are no longer updated\n    // NOTE(bowei): do we need to call willUnount on the children here??\n    childInfo && this._childrenToDestruct.add(childInfo); // queue it for destruction next update tick\n  }\n\n  /**\n   * Intended to be called as part of the constructor.\n   * So that subclasses of lifecycleHandler don't have to manually add this line to the constructor each time,\n   * we provide a handy [engageLifecycle] method on the class reference which automatically adds it using a [Proxy<>].\n   */\n  private _didConstruct(props: P) {\n    // this._self = this;\n    this._childrenToConstruct.forEach((child) => {\n      if (!child.instance) {\n        child.instance = new child.childClass(\n          child.propsFactory(props, this.state)\n        );\n      }\n      // NOTE(bowei): we are assuming the derived class did NOT manually add child to pixi hierarchy, even if\n      // they constructed the instance themselves (in order to e.g. hold a reference); we do that here\n      this.container.addChild(child.instance.container);\n    });\n    this._childrenToConstruct = new ChildrenArray(); // clear the list so that we don't re-add them in the update loop\n    this.renderSelf(props);\n    this.didMount?.();\n  }\n\n  /**\n   * callback that can be passed to child -\n   * if child is not a pure component, it might need to inform us of \"forced\" updates for otherwise we wouldnt call any child code at all\n   * (e.g. if child needs to update its own animation or hover states)\n   */\n  protected markForceUpdate = (childInstance: any) => {\n    this._staleProps.args?.markForceUpdate?.(this); // mark us for update in OUR parent\n\n    const childInfo = this._children.get(childInstance);\n    if (childInfo) {\n      this._forceUpdates.add(childInfo);\n    } else {\n      throw new Error(`Error, child ${childInstance} not found in ${this}`);\n    }\n  };\n\n  // cannot be attached to an instance due to typescript/eslint\n  // if satic, cannot be called \"useState\" or else react linter complains\n  // Sets this.fireStateUpdaters, this.stateUpdaters if not already set.\n  protected useState<S, T extends { state: Const<S> }>(\n    self: T,\n    initialState: S\n  ) {\n    const setState: UpdaterFn2<S, S> = (valueOrCallback) => {\n      if (typeof valueOrCallback === 'function') {\n        // self.state = (valueOrCallback as (s: S) => S as any as (s: Const<S>) => Const<S>)(self.state);\n        self.state = (valueOrCallback as (s: Const<S>) => Const<S>)(self.state);\n      } else {\n        self.state = valueOrCallback as S as Const<S>;\n      }\n    };\n    const [batchedSetState, fireBatch] = batchifySetState(setState);\n    const stateUpdaters = updaterGenerator2<S>(initialState, batchedSetState);\n\n    if (!this.fireStateUpdaters) {\n      this.fireStateUpdaters = fireBatch;\n    }\n    if (!this.stateUpdaters) {\n      this.stateUpdaters = stateUpdaters as any as U;\n    }\n\n    return {\n      state: initialState as Const<S>,\n      setState,\n      fireStateUpdaters: fireBatch,\n      stateUpdaters,\n    };\n  }\n\n  // shim while we migrate\n  public update(nextProps: P) {\n    this._update(nextProps);\n  }\n\n  // NOTE(bowei): this is public because the root of component hierarchy needs to be bootstrapped from pixi react bridge\n  public _update(nextProps: P) {\n    // nextProps is guaranteed to be referentially a distinct object (might be shallow copy though)\n    const staleState = { ...this.state };\n    this.fireStateUpdaters?.(); // the ONLY place in this function where this.state is changed\n    this.updateSelf?.(nextProps);\n    if (\n      this.shouldUpdate &&\n      !this.shouldUpdate(this._staleProps, staleState, nextProps, this.state)\n    ) {\n      // we think we don't need to update; however, we still need to\n      // update the chidlren that asked us to forcefully update them\n      let forceUpdates = this._forceUpdates.clone();\n      this._forceUpdates = new ChildrenArray<P, S>(); // clear the force updates of next tick\n      forceUpdates.forEach((childInfo) => {\n        let { instance, propsFactory } = childInfo;\n        instance?._update(propsFactory(nextProps, this.state)); // why are we even calling props factory here?? theres no point... we should just tell the child to use their own stale props, like this:\n        // instance._forceUpdate();\n        // note that children can add themselves into forceupdate next tick as well, if they need to ensure they're continuously in there\n\n        instance && this.didForceUpdateChild?.(instance);\n      });\n      // no need to do anything else -- stale props has not changed\n\n      // this.didForceUpdate?.();\n      return;\n    } else {\n      this.updateChildren?.(nextProps);\n      this._updateChildren(nextProps); // implementation should call children._update in here\n      this.renderSelf(nextProps);\n      this._staleProps = nextProps;\n      new Promise((resolve) => resolve(this.didUpdate?.()));\n    }\n  }\n\n  /**\n   * Not recommended to implement this.\n   * Do any work to prepare for updating children components. Guaranteed to run before children are destroyed/updated/created.\n   *\n   * Will not run if shouldUpdate() === false.\n   */\n  protected updateChildren?(nextProps: P): void;\n\n  // destroy, update, create in that order, so that there's no extra update right before destroy or after create\n  private _updateChildren(nextProps: P) {\n    this._childrenToDestruct.forEach((child) => {\n      if (child.instance) {\n        // should always be true\n        child.instance.willUnmount?.();\n        this.container.removeChild(child.instance.container);\n      }\n    });\n    this._childrenToDestruct = new ChildrenArray();\n\n    this._children.forEach(({ instance, propsFactory }) => {\n      instance?._update(propsFactory(nextProps, this.state));\n    });\n\n    this._childrenToConstruct.forEach((child) => {\n      // here we expect the child instances to be empty, but they could be already constructed, if the derived class needs to keep a reference to it\n      if (!child.instance) {\n        child.instance = new child.childClass(\n          child.propsFactory(nextProps, this.state)\n        );\n      }\n      this.container.addChild(child.instance.container);\n    });\n    this._childrenToConstruct = new ChildrenArray();\n  }\n\n  /**\n   * If this component has state managed by updaters, and the updaters object has batched enqueueUpdate calls,\n   * put the fireBatch method here so the lifecycle handler fires the state updaters at the correct time.\n   */\n  protected fireStateUpdaters?(): void;\n\n  /**\n   * Called after this class's constructor is finished calling and this component and all its children are finished rendering\n   */\n  protected didMount?(): void;\n\n  /**\n   * Called every tick, regardless of whether shouldUpdate is true or false.\n   * Called before children are updated.\n   * Called right after state updater batch is fired.\n   * TODO(bowei): consider renaming this to \"onTick\" or something, and also making sure that it gets called in children even if they are memoized\n   * @param nextProps\n   */\n  protected updateSelf?(nextProps: P): void;\n\n  /**\n   *\n   * @param staleProps\n   * @param staleState\n   * @param nextProps\n   * @param state\n   * @returns false if staleProps == nextProps and staleState == state (which will cause the component to be memoized)\n   *          true if the props or state differ significantly\n   */\n  protected shouldUpdate?(\n    staleProps: P,\n    staleState: Const<S>,\n    nextProps: P,\n    state: Const<S>\n  ): boolean;\n\n  /**\n   * Called after children are updated,\n   * Called only if shouldUpdate === true.\n   */\n  protected abstract renderSelf(nextProps: P): void;\n  protected didUpdate?(): void;\n  protected didForceUpdate?(): void;\n\n  /**\n   * Called before a component is removed\n   */\n  public willUnmount(): void {} // TODO(bowei): revert this to protected nullable; however it's needed for shim for now\n\n  protected didForceUpdateChild?(child: LifecycleHandlerBase<any, any>): void;\n\n  public toString(): string {\n    return 'lifecyclehandler object';\n  }\n}\n\nexport type LifecycleHandlerType<P, S> = LifecycleHandlerBase<P, S>;\nexport const LifecycleHandler = new Proxy(LifecycleHandlerBase, {\n  construct: (target, args, newTarget) => {\n    const instance = Reflect.construct(target, args, newTarget);\n    instance._didConstruct(...args);\n    return instance;\n  },\n});\n\n/**\n * Wrapper - this MUST be called on new lifecycle handler extensions in order to hook up the _didConstruct lifecycle automatically.\n * @param derived the class that extends LifecycleHandler\n * @returns the wrapped class which should be exported\n */\nexport function engageLifecycle<T extends object>(derived: T): T {\n  return new Proxy<T>(derived, {\n    construct: (target, args) => {\n      const instance = new (target as any)(args[0]);\n      instance._didConstruct(args[0]);\n      return instance;\n    },\n  });\n}\n\n/**\n * First render:\n * constructor\n * renderChildren?\n * renderSelf\n * didMount\n *\n * Subsequent updates:\n *\n * fireStateUpdaters\n * updateSelf\n * shouldUpdate(props,state)?\n * updateChildren\n * children._update\n * renderSelf\n * didUpdate\n * staleProps = props\n *\n */\n\ntype ReferenceProps = {\n  updaters: 'stuff';\n  args: { s: 'other stuff' };\n};\ntype ReferenceState = {\n  lalalala: 'hahahah';\n};\n\nexport class Reference extends LifecycleHandler<\n  ReferenceProps,\n  ReferenceState\n> {\n  public container: Pixi.Container;\n  public state: ReferenceState;\n  constructor(props: ReferenceProps) {\n    super(props);\n    this.container = new Pixi.Container();\n    this.state = {\n      lalalala: 'hahahah',\n    };\n  }\n\n  updateSelf(nextProps: ReferenceProps) {}\n  renderSelf(nextProps: ReferenceProps) {}\n  didMount() {}\n  didUpdate() {}\n  shouldUpdate(): boolean {\n    return true;\n  }\n  fireStateUpdaters() {}\n  willUnmount() {}\n}\n","import { NodeContents } from '../game/worldGen/nodeContents/NodeContentsFactory';\nimport { KeyedHashMap } from '../lib/util/data_structures/hash';\nimport { Vector2 } from '../lib/util/geometry/vector2';\nimport { Vector3 } from '../lib/util/geometry/vector3';\nimport { LazyHashMap } from '../lib/util/lazy';\nimport { LockData } from './PlayerSaveState';\n\nexport type WorldGenState = {\n  seed: number;\n  /**\n   * What sort of locks are generated. Does not store the live status of the locks.\n   */\n  lockMap: LazyHashMap<Vector3, LockData | undefined>;\n\n  /**\n   * Data about each node.\n   */\n  nodeContentsMap: LazyHashMap<Vector3, NodeContents>;\n};\n\nexport type ZLevelGen = {\n  id: number;\n  chunks: KeyedHashMap<Vector2, ChunkGen>;\n};\n\nexport type ChunkGen = {\n  id: number;\n  pointNodes: KeyedHashMap<Vector2, PointNodeGen>;\n};\n\nexport class ChunkGenConstants {\n  public static CHUNK_DIM = 9; // each chunk is a DIM x DIM grid of nodes, centered on a single node\n  public static CHUNK_HALF_DIM = (ChunkGenConstants.CHUNK_DIM - 1) / 2;\n  public static DROP_NODES_CHANCE = 0.0; // before generating edges, how many of the nodes to throw out\n}\n\nexport type PointNodeGen = {\n  id: number;\n} & (\n  | {\n      nodeType: NodeType.Basic;\n      // more data to be generated here - size, color, etc.\n      resourceType: ResourceNontrivialType;\n      resourceModifier: ResourceModifier;\n      resourceAmount: number;\n    }\n  | {\n      nodeType: NodeType.Nothing;\n    }\n  | {\n      nodeType: NodeType.EfficiencyGate;\n      resourceType: ResourceNontrivialType;\n      resourceModifier: ResourceModifier;\n      resourceAmount: number;\n\n      efficiencyGateInfo: {\n        thresholdResourceType: ResourceType;\n        thresholdResourceAmount: number;\n        timeUntilLocked: number;\n      };\n    }\n);\n\nexport enum NodeType {\n  Basic = 'Basic',\n  Nothing = 'Nothing',\n  EfficiencyGate = 'EfficiencyGate',\n}\n\nexport enum ResourceNontrivialType {\n  Mana0 = 'Mana0',\n  Mana1 = 'Mana1',\n  Mana2 = 'Mana2',\n}\n\nexport type ResourceType = ResourceNontrivialType;\n// // eslint-disable-next-line\n// export const ResourceType = {\n//   Nothing: \"Nothing\",\n//   EfficiencyGate: \"EfficiencyGate\",\n//   ...ResourceNontrivialType,\n// };\n\nexport enum ResourceModifier {\n  Flat = 'Flat',\n  Increased0 = '% increased',\n  AfterIncreased0 = 'added after % increased',\n  Increased1 = '% increased multiplier',\n  AfterIncreased1 = 'added after % increased multiplier',\n}\n","import * as Pixi from 'pixi.js';\nimport { RenderedChunkConstants } from './ChunkComponent';\nimport { UpdaterGeneratorType2 } from '../../lib/util/updaterGenerator';\nimport { GameState } from '../../data/GameState';\nimport { Vector2 } from '../../lib/util/geometry/vector2';\nimport { PixiPointFrom } from '../../lib/pixi/pixify';\nimport { multiplyColor } from '../../lib/util/color';\nimport { TooltippableAreaComponent } from './TooltippableAreaComponent';\nimport { engageLifecycle, LifecycleHandlerBase } from './LifecycleHandler';\nimport { RootComponentState } from './RootComponent';\nimport { PointNodeTextureSet } from '../textures/PointNodeTexture';\nimport COLORS from '../colors';\nimport {\n  NodeType,\n  PointNodeGen,\n  ResourceModifier,\n  ResourceNontrivialType,\n} from '../../data/WorldGenState';\nimport { PointNodeRef } from '../../data/PointNodeRef';\n\ntype Props = {\n  delta: number;\n  args: {\n    pointNodeTexture: PointNodeTextureSet;\n    position: Vector2;\n    markForceUpdate: (childInstance: any) => void;\n  };\n  selfPointNodeRef: PointNodeRef;\n  updaters: UpdaterGeneratorType2<GameState>;\n  tooltipUpdaters: UpdaterGeneratorType2<RootComponentState>['tooltip'];\n  pointNodeGen: PointNodeGen;\n  isSelected: boolean;\n  isAllocated: boolean;\n};\n\ntype State = {\n  numClicks: number; // debug\n  descriptionText: string;\n};\n\nclass PointNodeComponent extends LifecycleHandlerBase<Props, State> {\n  public container: Pixi.Container;\n  public state: State;\n\n  public sprite: Pixi.Sprite;\n  public halfwayCenterSprite: Pixi.Sprite;\n  public centerSprite: Pixi.Sprite;\n  public topHalfSprite: Pixi.Sprite;\n  public hitArea: Pixi.IHitArea;\n\n  public tooltippableArea?: TooltippableAreaComponent;\n\n  constructor(props: Props) {\n    super(props);\n    this.state = {\n      numClicks: 0,\n      descriptionText: '',\n    };\n    this.updateSelf(props); // initialize the description text properly\n    this.container = new Pixi.Container();\n\n    let defaultTexture = props.args.pointNodeTexture.find((it) => {\n      return it.cropFraction >= 0.99;\n    })?.texture;\n    this.container.sortableChildren = true;\n    this.sprite = new Pixi.Sprite(defaultTexture);\n    this.sprite.anchor.x = 0.5;\n    this.sprite.anchor.y = 0.5;\n    this.sprite.zIndex = -2;\n    this.container.addChild(this.sprite);\n\n    this.topHalfSprite = new Pixi.Sprite(\n      props.args.pointNodeTexture.find((it) => {\n        return it.cropFraction >= 0.499;\n      })?.texture\n    );\n    this.topHalfSprite.anchor.x = 0.5;\n    this.topHalfSprite.anchor.y = 0.5;\n    this.topHalfSprite.zIndex = -1;\n    // this.topHalfSprite.alpha = 0;\n    if (props.pointNodeGen.nodeType === NodeType.EfficiencyGate) {\n      // adding this drops FPS from 90 static/50 moving to 70 static/40 moving, even when alpha off, so we only add it for the nodes that need it\n      this.container.addChild(this.topHalfSprite);\n    }\n\n    const mask = new Pixi.Graphics();\n    mask.beginFill(COLORS.black);\n    mask.drawRect(\n      0,\n      0,\n      this.topHalfSprite.width,\n      this.topHalfSprite.height / 2\n    );\n    mask.pivot.x = this.topHalfSprite.width / 2;\n    mask.pivot.y = this.topHalfSprite.height / 2;\n    mask.zIndex = 30;\n    // this.container.addChild(mask);\n    // this.topHalfSprite.mask = mask; // DO NOT DO THIS, masking many masks is extremely slow: https://forums.rpgmakerweb.com/index.php?threads/games-optimisations-tips.92717/\n\n    this.centerSprite = new Pixi.Sprite(defaultTexture);\n    this.centerSprite.anchor.x = 0.5;\n    this.centerSprite.anchor.y = 0.5;\n    this.centerSprite.scale = PixiPointFrom(new Vector2(0.5, 0.5));\n    this.centerSprite.zIndex = 1;\n    this.centerSprite.alpha = 0; // TESTING\n    // this.container.addChild(this.centerSprite);\n\n    this.halfwayCenterSprite = new Pixi.Sprite(defaultTexture);\n    this.halfwayCenterSprite.anchor.x = 0.5;\n    this.halfwayCenterSprite.anchor.y = 0.5;\n    this.halfwayCenterSprite.scale = PixiPointFrom(new Vector2(0.75, 0.75));\n    this.halfwayCenterSprite.zIndex = 0;\n    // disable this sprite for now - causes a fairly significant fps hit, until we get around to holding less nodes on the page at once\n    this.halfwayCenterSprite.alpha = 0;\n    // this.container.addChild(this.halfwayCenterSprite);\n\n    this.container.interactive = true;\n    // NOTE(bowei): ive tested, the following 2 settings don't significantly affect FPS\n    this.container.buttonMode = true;\n    this.hitArea = new Pixi.Rectangle(\n      -RenderedChunkConstants.NODE_HITAREA_PX / 2,\n      -RenderedChunkConstants.NODE_HITAREA_PX / 2,\n      RenderedChunkConstants.NODE_HITAREA_PX,\n      RenderedChunkConstants.NODE_HITAREA_PX\n    );\n    // note: hitarea breaks child onhover: https://github.com/pixijs/pixi.js/issues/5837\n    this.container.hitArea = this.hitArea;\n\n    // const tooltippableAreaPropsFactory = (p: Props, s: State) => {\n    //   let nodeDescription: string = \"Nothing (empty node)\";\n    //   if (p.pointNodeGen.resourceType !== ResourceType.Nothing) {\n    //     nodeDescription = `${p.pointNodeGen.resourceAmount} ${p.pointNodeGen.resourceModifier} ${p.pointNodeGen.resourceType}`;\n    //   }\n    //   return {\n    //     args: {\n    //       markForceUpdate: this.markForceUpdate,\n    //     },\n    //     text: nodeDescription,\n    //     hitArea: this.hitArea, // TODO(bowei): move into state???\n    //   }\n    // }\n    // this.tooltippableArea = new TooltippableAreaComponent(tooltippableAreaPropsFactory(props, this.state));\n    // this.container.addChild(this.tooltippableArea.container);\n    // this.addChild({\n    //   childClass: TooltippableAreaComponent,\n    //   instance: this.tooltippableArea,\n    //   propsFactory: tooltippableAreaPropsFactory,\n    // });\n  }\n\n  protected updateSelf(props: Props) {\n    let nodeDescription: string = 'Nothing (empty node)';\n    if (props.pointNodeGen.nodeType === NodeType.EfficiencyGate) {\n      nodeDescription = `Unlocks at 300 Mana0 in 14 or fewer allocations`; // TODO\n    } else if (props.pointNodeGen.nodeType !== NodeType.Nothing) {\n      nodeDescription = `${props.pointNodeGen.resourceAmount} ${props.pointNodeGen.resourceModifier} ${props.pointNodeGen.resourceType}`;\n    }\n    this.state.descriptionText = nodeDescription;\n  }\n\n  protected renderSelf(props: Props) {\n    this.container.position = PixiPointFrom(props.args.position);\n    let tint: number;\n    let centerTint: number;\n    if (props.isSelected) {\n      tint = COLORS.selectedTint;\n      centerTint = COLORS.selectedTint;\n    } else {\n      tint = COLORS.nullTint;\n      centerTint = COLORS.nullTint;\n    }\n    if (props.isAllocated) {\n      tint = COLORS.allocatedTint;\n    } else {\n    }\n\n    let baseColor: number = 0;\n    let topHalfColor: number = 0;\n    if (props.pointNodeGen.nodeType === NodeType.Nothing) {\n      baseColor = COLORS.nodeBlue; // blue that mixes in with bg\n    } else if (props.pointNodeGen.nodeType === NodeType.EfficiencyGate) {\n      baseColor = COLORS.nodeAqua; // bg color = abcdef\n      topHalfColor = multiplyColor(COLORS.nodeAqua, COLORS.gateTint); // grayish white\n    } else if (\n      props.pointNodeGen.resourceType === ResourceNontrivialType.Mana0\n    ) {\n      if (props.pointNodeGen.resourceModifier === ResourceModifier.Flat) {\n        baseColor = COLORS.nodePink;\n      } else if (\n        props.pointNodeGen.resourceModifier === ResourceModifier.Increased0\n      ) {\n        baseColor = COLORS.nodeLavender;\n      }\n    }\n    // switch (props.pointNodeGen.resourceType) {\n    //   case ResourceType.Nothing:\n    //     baseColor = 0x99bbff; // blue that mixes in with bg\n    //     break;\n    //   case ResourceType.Mana0:\n    //     baseColor = 0xeeaaaa; // red\n    //     break;\n    //   case ResourceType.Mana1:\n    //     baseColor = 0xbb7733; // brown?\n    //     break;\n    //   case ResourceType.Mana2:\n    //     baseColor = 0x44aa44; // green\n    //     break;\n    // }\n\n    this.sprite.tint = multiplyColor(baseColor, tint);\n    this.centerSprite.tint = multiplyColor(baseColor, centerTint);\n    this.topHalfSprite.tint = multiplyColor(topHalfColor, tint);\n\n    // TESTING\n    let textureToFind = Math.floor(Math.random() * 9) / 8 - 0.001;\n    this.topHalfSprite.texture = props.args.pointNodeTexture.find(\n      (it) => it.cropFraction >= textureToFind\n    )?.texture!;\n\n    // NOTE(bowei): careful, we dont want to set the scale of our tooltip to be bigger\n    if (props.selfPointNodeRef.pointNodeCoord.equals(Vector2.Zero)) {\n      this.container.scale = PixiPointFrom(new Vector2(1.25, 1.25));\n    }\n  }\n\n  protected shouldUpdate(\n    staleProps: Props,\n    staleState: State,\n    props: Props,\n    state: State\n  ): boolean {\n    for (let key of Object.keys(staleProps) as (keyof Props)[]) {\n      if (key === 'delta' || key === 'args' || key === 'updaters') {\n        continue;\n      }\n      if (staleProps[key] !== props[key]) {\n        console.log(`node shouldUpdate differed in ${key}, returning true`);\n        return true;\n      }\n      if (key === 'selfPointNodeRef') {\n        if (staleProps[key]?.hash() !== props[key]?.hash()) {\n          console.log(`node shouldUpdate differed in ${key}, returning true`);\n          return true;\n        } else {\n          continue;\n        }\n      }\n    }\n    return false;\n  }\n\n  protected didMount() {\n    // const { updaters } = this._staleProps; // we assume this will never change\n\n    //     this.container.addListener('pointerover', (event: Pixi.InteractionEvent) => {\n    //       this.state.pointerover = event;\n    //     })\n    //     this.container.addListener('pointerout', () => {\n    //       this.state.pointerover = undefined;\n    //     })\n    //\n\n    this.container.addListener(\n      'pointerdown',\n      (event: Pixi.InteractionEvent) => {\n        this._staleProps.args.markForceUpdate(this);\n        this.state.numClicks++;\n        // selectOrReselectNode(updaters, this._staleProps.selfPointNodeRef);\n        // event.stopPropagation();\n      }\n    );\n\n    this.container.addListener(\n      'pointerover',\n      (event: Pixi.InteractionEvent) => {\n        // this._staleProps.args.markForceUpdate(this);\n\n        // source: https://www.iwm-tuebingen.de/iwmbrowser/lib/pixi/tooltip.js\n        const localPosition = event.data.getLocalPosition(this.container);\n        const position = new Vector2(\n          this.container.worldTransform.tx,\n          this.container.worldTransform.ty\n        );\n        // const position = new Vector2(this.container.worldTransform.tx, this.container.worldTransform.ty);\n\n        this._staleProps.tooltipUpdaters.enqueueUpdate((prev) => {\n          const next = {\n            ...prev,\n            visible: true,\n            text: this.state.descriptionText,\n            position: position.add(localPosition),\n          };\n          // console.log({ next });\n          return next;\n        });\n      }\n    );\n\n    this.container.addListener('pointerout', (event: Pixi.InteractionEvent) => {\n      // this._staleProps.args.markForceUpdate(this);\n\n      this._staleProps.tooltipUpdaters.enqueueUpdate((prev) => {\n        const next = { ...prev, visible: false, text: '' };\n        return next;\n      });\n    });\n\n    this.container.addListener(\n      'pointermove',\n      (event: Pixi.InteractionEvent) => {\n        // this._staleProps.args.markForceUpdate(this);\n\n        // source: https://www.iwm-tuebingen.de/iwmbrowser/lib/pixi/tooltip.js\n        const localPosition = event.data.getLocalPosition(this.container);\n        const position = new Vector2(\n          this.container.worldTransform.tx,\n          this.container.worldTransform.ty\n        );\n\n        this._staleProps.tooltipUpdaters.position.enqueueUpdate(\n          position.add(localPosition)\n        );\n      }\n    );\n  }\n\n  public toString(): string {\n    return 'PointNodeCompoent ' + this._staleProps.selfPointNodeRef.toString();\n  }\n}\n\nconst wrapped = engageLifecycle(PointNodeComponent);\n// eslint-disable-next-line\ntype wrapped = PointNodeComponent;\nexport { wrapped as PointNodeComponent };\nexport type { Props as PointNodeComponentProps };\n","import { Vector2 } from '../lib/util/geometry/vector2';\n\nexport class PointNodeRef {\n  public z: number;\n  public chunkCoord: Vector2;\n  public pointNodeCoord: Vector2;\n  public pointNodeId: number;\n\n  constructor(args: {\n    z: number;\n    chunkCoord: Vector2;\n    pointNodeCoord: Vector2;\n    pointNodeId: number;\n  }) {\n    this.z = args.z;\n    this.chunkCoord = args.chunkCoord;\n    this.pointNodeCoord = args.pointNodeCoord;\n    this.pointNodeId = args.pointNodeId;\n  }\n\n  public hash(): string {\n    return (\n      this.pointNodeId.toString() +\n      this.z.toString() +\n      this.chunkCoord.toString() +\n      this.pointNodeCoord.toString()\n    );\n  }\n\n  public toString(): string {\n    return (\n      this.z +\n      ',' +\n      this.chunkCoord.toString() +\n      ',' +\n      this.pointNodeCoord.toString()\n    );\n  }\n}\n\nexport class ChunkRef {\n  public z: number;\n  public chunkCoord: Vector2;\n  public chunkId: number;\n\n  constructor(args: { z: number; chunkCoord: Vector2; chunkId: number }) {\n    this.z = args.z;\n    this.chunkCoord = args.chunkCoord;\n    this.chunkId = args.chunkId;\n  }\n\n  public hash(): string {\n    return (\n      this.chunkId.toString() + this.z.toString() + this.chunkCoord.toString()\n    );\n  }\n}\n","import * as Pixi from 'pixi.js';\nimport { HashSet, KeyedHashMap } from '../../lib/util/data_structures/hash';\nimport { GameState } from '../../data/GameState';\nimport {\n  PointNodeComponent,\n  PointNodeComponentProps,\n} from './PointNodeComponent';\nimport { UpdaterGeneratorType2 } from '../../lib/util/updaterGenerator';\nimport { Vector2 } from '../../lib/util/geometry/vector2';\nimport { PixiPointFrom } from '../../lib/pixi/pixify';\nimport { engageLifecycle, LifecycleHandlerBase } from './LifecycleHandler';\nimport { RootComponentState } from './RootComponent';\nimport { PointNodeTextureSet } from '../textures/PointNodeTexture';\nimport { ChunkRef, PointNodeRef } from '../../data/PointNodeRef';\nimport { ChunkGenConstants, ChunkGen } from '../../data/WorldGenState';\n\nexport class RenderedChunkConstants {\n  //   public static SPACING_PX: number = 24;\n  //   public static CHUNK_SPACING_PX: number = (ChunkGenConstants.CHUNK_DIM + 0.5) * RenderedChunkConstants.SPACING_PX;\n  //   public static NODE_SIZE_PX: number = 14;\n  //   public static NODE_HITAREA_PX: number = 18;\n  public static SPACING_PX: number = 36;\n  public static CHUNK_SPACING_PX: number =\n    (ChunkGenConstants.CHUNK_DIM + 0.0) * RenderedChunkConstants.SPACING_PX;\n  public static NODE_SIZE_PX: number = 22;\n  public static NODE_HITAREA_PX: number =\n    RenderedChunkConstants.NODE_SIZE_PX + 4;\n  public static NODE_ROUNDED_PX: number = 4;\n}\n\ntype Props = {\n  delta: number;\n  args: {\n    pointNodeTexture: PointNodeTextureSet;\n    markForceUpdate: (childInstance: any) => void;\n  };\n  selfChunkRef: ChunkRef;\n  updaters: UpdaterGeneratorType2<GameState>;\n  tooltipUpdaters: UpdaterGeneratorType2<RootComponentState>['tooltip'];\n  position: Vector2;\n  chunkGen: ChunkGen;\n  selectedPointNode: PointNodeRef | undefined;\n  allocatedPointNodeSubset: HashSet<PointNodeRef>;\n};\n\ntype State = {};\n\nclass ChunkComponent2 extends LifecycleHandlerBase<Props, State> {\n  public container: Pixi.Container;\n  public state: State;\n\n  public children: KeyedHashMap<PointNodeRef, PointNodeComponent>;\n\n  constructor(props: Props) {\n    super(props);\n\n    this.state = {};\n    this.container = new Pixi.Container();\n    this.children = new KeyedHashMap();\n\n    this.resyncChildren(props);\n  }\n\n  protected renderSelf(props: Props) {\n    this.container.position = PixiPointFrom(props.position);\n  }\n\n  protected shouldUpdate(\n    prevProps: Props,\n    prevState: State,\n    props: Props,\n    state: State\n  ): boolean {\n    // return true;\n    for (let key of Object.keys(prevProps) as (keyof Props)[]) {\n      if (key === 'delta' || key === 'args' || key === 'updaters') {\n        continue;\n      }\n      if (key === 'position') {\n        if (!prevProps[key].equals(props[key])) {\n          console.log(`chunk shouldUpdate differed in ${key}, returning true`);\n          return true;\n        } else {\n          continue;\n        }\n      }\n      if (key === 'selectedPointNode') {\n        if (prevProps[key]?.hash() !== props[key]?.hash()) {\n          console.log(`chunk shouldUpdate differed in ${key}, returning true`);\n          return true;\n        } else {\n          continue;\n        }\n      }\n      if (key === 'selfChunkRef') {\n        if (prevProps[key]?.hash() !== props[key]?.hash()) {\n          console.log(`chunk shouldUpdate differed in ${key}, returning true`);\n          return true;\n        } else {\n          continue;\n        }\n      }\n      if (key === 'allocatedPointNodeSubset') {\n        // subsets could be different objects but have the same contents\n        if (!prevProps[key].equals(props[key])) {\n          // console.log(`prevProps: ${JSON.stringify(prevProps[key])}`);\n          // console.log(`props: ${JSON.stringify(props[key])}`);\n          console.log(`chunk shouldUpdate differed in ${key}, returning true`);\n          return true;\n        } else {\n          continue;\n        }\n      }\n      if (prevProps[key] !== props[key]) {\n        console.log(`chunk shouldUpdate differed in ${key}, returning true`);\n        return true;\n      }\n    }\n    return false;\n  }\n\n  private resyncChildren(props: Props) {\n    let childrenToDelete = this.children.clone(); // track which children need to be destroyed according to new props\n    console.log(`chunk component upsert children got here`);\n    // console.log(`chunk component upsert children has ${this.children.size()} children`);\n\n    for (let [\n      pointNodeCoord,\n      pointNodeGen,\n    ] of props.chunkGen.pointNodes.entries()) {\n      const pointNodeRef = new PointNodeRef({\n        z: props.selfChunkRef.z,\n        chunkCoord: props.selfChunkRef.chunkCoord,\n        pointNodeCoord: pointNodeCoord,\n        pointNodeId: pointNodeGen.id,\n      });\n      let childPropsFactory = (\n        props: Props,\n        state: State\n      ): PointNodeComponentProps => {\n        return {\n          delta: props.delta,\n          args: {\n            pointNodeTexture: props.args.pointNodeTexture,\n            markForceUpdate: this.markForceUpdate,\n            position: pointNodeRef.pointNodeCoord.multiply(\n              RenderedChunkConstants.SPACING_PX\n            ),\n          },\n          selfPointNodeRef: pointNodeRef,\n          updaters: props.updaters,\n          tooltipUpdaters: props.tooltipUpdaters,\n          pointNodeGen,\n          isSelected:\n            props.selectedPointNode?.pointNodeId === pointNodeRef.pointNodeId,\n          isAllocated: props.allocatedPointNodeSubset.contains(pointNodeRef),\n        };\n      };\n      const childKey = pointNodeRef;\n\n      let childComponent = this.children.get(childKey);\n      if (childComponent) {\n        // childComponent.update(childPropsFactory(props, this.state));\n        childrenToDelete.remove(childKey);\n      } else {\n        childComponent = new PointNodeComponent(\n          childPropsFactory(props, this.state)\n        );\n        this.children.put(pointNodeRef, childComponent);\n        // this.container.addChild(childComponent.container);\n        this.addChild({\n          childClass: PointNodeComponent,\n          instance: childComponent,\n          propsFactory: childPropsFactory,\n        });\n      }\n    }\n    console.log(\n      `chunk component to delete has ${childrenToDelete.size()} children`\n    );\n    for (let [childKey, childComponent] of childrenToDelete.entries()) {\n      // childComponent.willUnmount();\n      this.children.remove(childKey);\n      // this.container.removeChild(childComponent.container);\n      this.removeChild(childComponent);\n    }\n  }\n\n  protected updateChildren(props: Props) {\n    this.resyncChildren(props);\n  }\n\n  protected didForceUpdateChild(instance: LifecycleHandlerBase<any, any>) {\n    // IMPORTANT! this is intended to raise the child that asked for a force update to the top so it isn't covered\n    // by other sibling pixi containers. however this code doesnt work well during the update call, for some reason (not sure why)\n    this.container.removeChild(instance.container);\n    this.container.addChild(instance.container);\n  }\n}\n\nconst wrapped = engageLifecycle(ChunkComponent2);\n// eslint-disable-next-line\ntype wrapped = ChunkComponent2;\nexport { wrapped as ChunkComponent };\nexport type { Props as ChunkComponentProps };\n","import { KeyedHashMap } from './data_structures/hash';\nimport { Const } from './misc';\n\n/**\n * Class representing a value which is only computed when used.\n *\n * Usage: const lazy = new Lazy(() => thingThatReturnsSomething()).\n * Then thingThatReturnsSomething() will only get called on the first time lazy.get() is called.\n * On the second and subsequent times, lazy.get() will return the same object - the factory method is not called again.\n */\nexport class Lazy<T> {\n  private _wasConstructed: boolean = false;\n  private _value: T | undefined = undefined;\n  private _factory: () => T;\n\n  constructor(\n    factory: () => T\n    // structure?: T extends { [key: string]: any } ? T : void\n  ) {\n    this._factory = factory;\n  }\n  public get(): T {\n    // T might have undefined as a valid value\n    if (this._value !== undefined || this._wasConstructed === true) {\n      return this._value!;\n    } else {\n      this._value = this._factory();\n      this._wasConstructed = true;\n      return this._value;\n    }\n  }\n  public wasConstructed(): boolean {\n    return this._wasConstructed;\n  }\n  // public async getAsync(): Promise<T> {\n  //   if (this._value !== undefined || this._wasConstructed === true) {\n  //     return Promise.resolve(this._value!);\n  //   } else {\n  //     return new Promise<T>((resolve, reject) => {\n  //       this._value = this._factory();\n  //       this._wasConstructed = true;\n  //       resolve(this._value);\n  //     });\n  //   }\n  // }\n}\n\nexport function LazyProxy<\n  T extends { [key: string]: any } | { [i: number]: any }\n>(factory: () => T): Const<T> {\n  return new Proxy(new Lazy(factory), {\n    get: (target, property, receiver) => {\n      if (property === 'toJSON') {\n        return () => {\n          if (target.wasConstructed()) {\n            return target.get();\n          } else {\n            return '[Object Lazy]';\n          }\n        };\n      }\n      const targetValue = target.get();\n      return Reflect.get(targetValue, property);\n    },\n    ownKeys: (target) => {\n      const targetValue = target.get();\n      return Reflect.ownKeys(targetValue);\n    },\n    getOwnPropertyDescriptor: (target, property) => {\n      /**\n       * https://stackoverflow.com/questions/40352613/why-does-object-keys-and-object-getownpropertynames-produce-different-output\n       */\n\n      return Object.getOwnPropertyDescriptor(target.get(), property);\n    },\n    has: (target, property) => {\n      // This is called when iterating over array i.e. array.forEach()\n      return property in target.get();\n    },\n  }) as unknown as Const<T>;\n}\n\n/**\n * Similar to HashMap, except it allows setting a factory function to be used for missing keys.\n * Also memoizes the result.\n *\n * NOTE: this assume hash() is a strong test for equality, i.e. 2 objects are considered equal if and only if their hashes are the same!!!\n */\nexport class LazyHashMap<K extends { hash(): string }, V> {\n  protected _values: KeyedHashMap<K, V>;\n  protected _factory: (k: K) => V;\n\n  constructor(factory: (k: K) => V) {\n    this._values = new KeyedHashMap();\n    this._factory = factory;\n  }\n\n  setFactory(factory: (k: K) => V): LazyHashMap<K, V> {\n    this._factory = factory;\n    return this;\n  }\n\n  // overrides any factory provided values\n  put(key: K, value: V) {\n    this._values.put(key, value);\n  }\n\n  // removes the key from the list of memoized (cached) values and forces a re-call of the factory() provider.\n  // also removes the key from any manually put(ted) factory overrides.\n  remove(key: K): void {\n    this._values.remove(key);\n  }\n\n  invalidate(key: K): void {\n    this.remove(key);\n  }\n\n  clear(): void {\n    this._values = new KeyedHashMap();\n  }\n\n  // checks to see if the key is present. returns undefined if populating the key would require a factory() call.\n  peek(key: K): V | undefined {\n    return this._values.get(key);\n  }\n\n  get(key: K): V {\n    if (this._values.contains(key)) {\n      return this._values.get(key)!;\n    } else {\n      const value = this._factory(key);\n      this._values.put(key, value);\n      return value;\n    }\n  }\n\n  // same as get(), but does not return the result. useful for forcing factory() call so the value is available quickly later.\n  precompute(key: K) {\n    if (this._values.contains(key)) {\n      return;\n    } else {\n      const value = this._factory(key);\n      this._values.put(key, value);\n    }\n  }\n\n  // returns true if the key was already instantiated, false otherwise.\n  contains(key: K): boolean {\n    return this._values.contains(key);\n  }\n\n  // only contains populated (i.e. non-factory) entries.\n  values(): V[] {\n    return this._values.values();\n  }\n\n  // only contains populated (i.e. non-factory) entries.\n  keys(): K[] {\n    return this._values.keys();\n  }\n\n  // only contains populated (i.e. non-factory) entries.\n  entries(): [K, V][] {\n    return this._values.entries();\n  }\n\n  // *[Symbol.iterator]() {\n  //   // construct a new iterator. note that as usual editing the object during iteration is not supported\n  //   for (let key of Object.keys(this._values)) {\n  //     yield key;\n  //   }\n  // }\n\n  // hashes only the keys - use HashableHashMap if you know that the value type here is also hashable\n  // hashKeyset(): string {\n  //   const hashes: number[] = Object.keys(this._values).map(s => hashCode(s));\n  //   let code: number = hashes.reduce((pv, cv) => pv + cv);\n  //   return code.toString();\n  // }\n\n  // only contains populated (i.e. non-factory) entries.\n  size(): number {\n    return this._values.size();\n  }\n\n  clone(newFactory?: (k: K) => V): LazyHashMap<K, V> {\n    let n = new LazyHashMap<K, V>(newFactory || this._factory);\n    n._values = this._values.clone();\n    return n;\n  }\n}\n/*\nexport class LazyHashSet<K extends { hash(): string }> {\n  private _values: LazyHashMap<K, boolean>;\n\n  constructor(factory: (k: K) => boolean, initialValues: K[] = []) {\n    this._values = new LazyHashMap<K, boolean>(factory);\n\n    for (const value of initialValues) {\n      this.put(value);\n    }\n  }\n\n  // remove(key: K): void {\n  //   this._values.remove(key);\n  // }\n\n  put(key: K): void {\n    this._values.put(key, true);\n  }\n\n  get(key: K): boolean {\n    return this._values.get(key) !== undefined;\n  }\n\n  contains(key: K): boolean {\n    return this._values.contains(key);\n  }\n\n  values(): K[] {\n    return this._values.values();\n  }\n\n  // hash(): string {\n  //   return this._values.hashKeyset();\n  // }\n\n  clone(): HashSet<K> {\n    let n = new HashSet<K>();\n    n._values = this._values.clone();\n    return n;\n  }\n\n  size(): number {\n    return this._values.size();\n  }\n\n  equals(other: HashSet<K> | undefined | null) {\n    if (other === undefined || other === null) {\n      return false;\n    }\n\n    if (this.size() !== other.size()) {\n      return false;\n    }\n\n    for (let k of this.values()) {\n      if (!other.contains(k)) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  // *[Symbol.iterator]() {\n  //   // construct a new iterator. note that as usual\n  //   for (let key of Object.keys(this._values)) {\n  //     yield key;\n  //   }\n  // }\n}\n*/\n","export enum NodeAllocatedStatus {\n  TAKEN_OR_MARKED = 'TAKEN_OR_MARKED',\n  AVAILABLE = 'AVAILABLE',\n  UNREACHABLE = 'UNREACHABLE',\n  HIDDEN = 'HIDDEN',\n}\n/**\n * taken implies reachable. reachable implies visible.\n */\n\n// Whether or not the node is allocated. implies reachable\nexport type NodeTakenStatus = {\n  taken: boolean;\n};\n// Whether or not the node is within 1 distance from an allocated node. not used during exploration era. implies visible\nexport type NodeReachableStatus = {\n  reachable: boolean;\n};\n// whether or not the node is revealed in fog of war. implies accessible\nexport type NodeVisibleStatus = 'revealed' | 'hinted' | 'obscured';\n// whether or not the node exists in the current era of the game and can be accessed at all.\nexport type NodeAccessibleStatus = {\n  accessible: boolean;\n};\n// whether or not the node was ever touched in the exploration era. once explored cannot be unexplored.\nexport type NodeExploredStatus = {\n  explored: boolean;\n};\n// whether or not the node was allocated at the end of the exploration era. player can bookmark or unbookmark nodes during the exploration era,\n// and they will be show up as useful convenience markers in the optimization era.\nexport type NodeBookmarkedStatus = {\n  bookmarked: boolean;\n};\n\n/**\n * Immutable, readable booleans\n */\nexport enum BoolEnum {\n  true = 'true',\n  false = 'false',\n}\n// eslint-disable-next-line\nexport const NodeTakenStatus: {\n  [k in BoolEnum]: NodeTakenStatus;\n} = {\n  true: { taken: true },\n  false: { taken: false },\n};\n// eslint-disable-next-line\nexport const NodeReachableStatus: {\n  [k in BoolEnum]: NodeReachableStatus;\n} = {\n  true: { reachable: true },\n  false: { reachable: false },\n};\n\nexport enum LockStatus {\n  CLOSED = 'CLOSED',\n  TICKING = 'TICKING',\n  OPEN = 'OPEN',\n}\n","import * as Pixi from 'pixi.js';\nimport { GameState } from '../../data/GameState';\nimport { Vector2 } from '../../lib/util/geometry/vector2';\nimport { Const } from '../../lib/util/misc';\nimport { engageLifecycle, LifecycleHandlerBase } from './LifecycleHandler';\nimport { TooltipInfo } from './TooltipComponent';\n\ntype Props = {\n  args: {\n    renderer: Pixi.Renderer;\n    markForceUpdate: (childInstance: any) => void;\n  };\n  delta: number;\n  gameState: Const<GameState>;\n  appSize: Vector2;\n  tick: number;\n  tooltip: TooltipInfo;\n};\n\ntype State = {};\n\nclass FixedCameraStageComponent extends LifecycleHandlerBase<Props, State> {\n  public container: Pixi.Container;\n  public state: State;\n\n  constructor(props: Props) {\n    super(props);\n    this.container = new Pixi.Container();\n    this.container.sortableChildren = true;\n    this.state = {};\n  }\n\n  protected renderSelf(props: Props) {}\n}\n\nconst wrapped = engageLifecycle(FixedCameraStageComponent);\n// eslint-disable-next-line\ntype wrapped = FixedCameraStageComponent;\nexport { wrapped as FixedCameraStageComponent };\nexport type { Props as FixedCameraStageComponentProps };\n","import { EPSILON } from '../epsilon_math';\nimport { IVector2, Vector2 } from './vector2';\n\nexport interface IVector3 {\n  x: number;\n  y: number;\n  z: number;\n}\n\nexport class Vector3 {\n  private _x: number;\n  private _y: number;\n  private _z: number;\n\n  public get x(): number {\n    return this._x;\n  }\n  public get y(): number {\n    return this._y;\n  }\n  public get z(): number {\n    return this._z;\n  }\n\n  constructor();\n  constructor(x: number, y: number, z: number);\n  constructor(props: IVector3);\n  constructor(\n    propsOrX: IVector3 | number = { x: 0, y: 0, z: 0 },\n    y?: number,\n    z?: number\n  ) {\n    if (typeof propsOrX === 'number') {\n      this._x = propsOrX;\n      this._y = y!;\n      this._z = z!;\n    } else {\n      this._x = propsOrX.x;\n      this._y = propsOrX.y;\n      this._z = propsOrX.z;\n    }\n  }\n\n  // public get half(): Vector3 {\n  //   return new Vector3({ x: this.x / 2, y: this.y / 2 });\n  // }\n\n  public static Zero: Vector3 = new Vector3(0, 0, 0);\n  public static One: Vector3 = new Vector3(1, 1, 1);\n\n  static IsVector3(x: any): x is Vector3 {\n    return x instanceof Vector3;\n  }\n\n  static FromVector2(p: IVector2, z: number = 0) {\n    return new Vector3(p.x, p.y, z);\n  }\n\n  // static Random(highX: number, highY: number, lowX = 0, lowY = 0) {\n  //   return new Vector3({\n  //     x: Util.RandRange(lowX, highX),\n  //     y: Util.RandRange(lowY, highY),\n  //   });\n  // }\n\n  hash(): string {\n    return this.toString();\n  }\n\n  toString(): string {\n    return `[${this.x}, ${this.y}, ${this.z}]`;\n  }\n\n  // invert(): Vector3 {\n  //   return new Vector3({\n  //     x: -this.x,\n  //     y: -this.y,\n  //   });\n  // }\n\n  round(): Vector3 {\n    return new Vector3({\n      x: Math.round(this.x),\n      y: Math.round(this.y),\n      z: Math.round(this.z),\n    });\n  }\n\n  moduloPositive(b: number): Vector3 {\n    return new Vector3({\n      x: ((this.x % b) + b) % b,\n      y: ((this.y % b) + b) % b,\n      z: ((this.z % b) + b) % b,\n    });\n  }\n\n  // floor(): Vector3 {\n  //   return new Vector3({\n  //     x: Math.floor(this.x),\n  //     y: Math.floor(this.y),\n  //   });\n  // }\n\n  // taxicabDistance(p: Vector3): number {\n  //   return Math.abs(p.x - this.x) + Math.abs(p.y - this.y);\n  // }\n\n  // diagonalDistance(p: IVector3): number {\n  //   return Math.max(Math.abs(p.x - this.x), Math.abs(p.y - this.y));\n  // }\n\n  // distance(p: IVector3): number {\n  //   let dx = Math.abs(p.x - this.x);\n  //   let dy = Math.abs(p.y - this.y);\n\n  //   return Math.sqrt(dx * dx + dy * dy);\n  // }\n\n  // translate(p: { x: number; y: number }): Vector3 {\n  //   return new Vector3({\n  //     x: this.x + p.x,\n  //     y: this.y + p.y,\n  //   });\n  // }\n\n  subtract(p: IVector3): Vector3 {\n    return new Vector3({\n      x: this.x - p.x,\n      y: this.y - p.y,\n      z: this.z - p.z,\n    });\n  }\n\n  add(pOrX: IVector3 | number, y?: number, z?: number): Vector3 {\n    if (typeof pOrX === 'number') {\n      return new Vector3({\n        x: this.x + pOrX,\n        y: this.y + y!,\n        z: this.z + z!,\n      });\n    } else {\n      return new Vector3({\n        x: this.x + pOrX.x,\n        y: this.y + pOrX.y,\n        z: this.z + pOrX.z,\n      });\n    }\n  }\n\n  addX(x: number): Vector3 {\n    return new Vector3({\n      x: this.x + x,\n      y: this.y,\n      z: this.z,\n    });\n  }\n\n  addY(y: number): Vector3 {\n    return new Vector3({\n      x: this.x,\n      y: this.y + y,\n      z: this.z,\n    });\n  }\n\n  addZ(z: number): Vector3 {\n    return new Vector3({\n      x: this.x,\n      y: this.y,\n      z: this.z + z,\n    });\n  }\n\n  subtractX(x: number): Vector3 {\n    return new Vector3({\n      x: this.x - x,\n      y: this.y,\n      z: this.z,\n    });\n  }\n\n  subtractY(y: number): Vector3 {\n    return new Vector3({\n      x: this.x,\n      y: this.y - y,\n      z: this.z,\n    });\n  }\n\n  subtractZ(z: number): Vector3 {\n    return new Vector3({\n      x: this.x,\n      y: this.y,\n      z: this.z - z,\n    });\n  }\n\n  // clampY(low: number, high: number): Vector3 {\n  //   let newY = this.y;\n\n  //   if (newY < low) {\n  //     newY = low;\n  //   }\n  //   if (newY > high) {\n  //     newY = high;\n  //   }\n\n  //   return new Vector3({\n  //     x: this.x,\n  //     y: newY,\n  //   });\n  // }\n\n  scale(about: IVector3, amount: IVector3): Vector3 {\n    return new Vector3({\n      x: (this.x - about.x) * amount.x + about.x,\n      y: (this.y - about.y) * amount.y + about.y,\n      z: (this.z - about.z) * amount.z + about.z,\n    });\n  }\n\n  // rotate(origin: Vector3, angle: number): Vector3 {\n  //   angle = angle / (180 / Math.PI);\n\n  //   return new Vector3({\n  //     x:\n  //       Math.cos(angle) * (this.x - origin.x) -\n  //       Math.sin(angle) * (this.y - origin.y) +\n  //       origin.x,\n  //     y:\n  //       Math.sin(angle) * (this.x - origin.x) +\n  //       Math.cos(angle) * (this.y - origin.y) +\n  //       origin.y,\n  //   });\n  // }\n\n  equals(other: IVector3 | undefined | null): boolean {\n    if (other === undefined || other === null) {\n      return false;\n    }\n\n    return (\n      Math.abs(this.x - other.x) < EPSILON &&\n      Math.abs(this.y - other.y) < EPSILON &&\n      Math.abs(this.z - other.z) < EPSILON\n    );\n  }\n\n  notEquals(other: IVector3 | undefined | null): boolean {\n    return !this.equals(other);\n  }\n\n  multiply(other: IVector3 | number): Vector3 {\n    if (typeof other === 'number') {\n      return new Vector3({\n        x: this.x * other,\n        y: this.y * other,\n        z: this.z * other,\n      });\n    } else {\n      return new Vector3({\n        x: this.x * other.x,\n        y: this.y * other.y,\n        z: this.z * other.z,\n      });\n    }\n  }\n\n  divide(other: IVector3 | number): Vector3 {\n    if (typeof other === 'number') {\n      return new Vector3({\n        x: this.x / other,\n        y: this.y / other,\n        z: this.z / other,\n      });\n    } else {\n      return new Vector3({\n        x: this.x / other.x,\n        y: this.y / other.y,\n        z: this.z / other.z,\n      });\n    }\n  }\n\n  toJSON(): any {\n    return {\n      __type: 'Vector3',\n      x: this.x,\n      y: this.y,\n      z: this.z,\n    };\n  }\n\n  // transform(trans: Vector3, scale: number): Vector3 {\n  //   return new Vector3({\n  //     x: Math.floor((this.x - trans.x) * scale),\n  //     y: Math.floor((this.y - trans.y) * scale),\n  //   });\n  // }\n\n  // normalize(): Vector3 {\n  //   if (this.x === 0 && this.y === 0) {\n  //     return this;\n  //   }\n\n  //   const length = Math.sqrt(this.x * this.x + this.y * this.y);\n\n  //   return new Vector3({\n  //     x: this.x / length,\n  //     y: this.y / length,\n  //   });\n  // }\n\n  pairXY(): Vector2 {\n    return new Vector2({\n      x: this.x,\n      y: this.y,\n    });\n  }\n\n  toVector2(): Vector2 {\n    return this.pairXY();\n  }\n\n  withX(newX: number): Vector3 {\n    return new Vector3({\n      x: newX,\n      y: this.y,\n      z: this.z,\n    });\n  }\n\n  withY(newY: number): Vector3 {\n    return new Vector3({\n      x: this.x,\n      y: newY,\n      z: this.z,\n    });\n  }\n\n  withZ(newZ: number): Vector3 {\n    return new Vector3({\n      x: this.x,\n      y: this.y,\n      z: newZ,\n    });\n  }\n\n  // invertX(): Vector3 {\n  //   return new Vector3({\n  //     x: -this.x,\n  //     y: this.y,\n  //   });\n  // }\n\n  // lerp(other: Vector3, t: number): Vector3 {\n  //   if (t > 1 || t < 0) {\n  //     console.error('Lerp t must be between 0 and 1.');\n  //   }\n  //   if (t === 0) return this;\n  //   if (t === 1) return other;\n\n  //   return this.scale({ x: 0, y: 0 }, { x: 1 - t, y: 1 - t }).add(\n  //     other.scale({ x: 0, y: 0 }, { x: t, y: t })\n  //   );\n  // }\n\n  // lerp2D(other: Vector3, tx: number, ty: number): Vector3 {\n  //   if (tx > 1 || tx < 0 || ty > 1 || ty < 0) {\n  //     console.error('Lerp t must be between 0 and 1.');\n  //   }\n  //   return this.scale({ x: 0, y: 0 }, { x: 1 - tx, y: 1 - ty }).add(\n  //     other.scale({ x: 0, y: 0 }, { x: tx, y: ty })\n  //   );\n  // }\n\n  // coserp(other: Vector3, t: number): Vector3 {\n  //   t = 0.5 * (1 + Math.cos(2 * t * Math.PI));\n\n  //   return this.lerp(other, t);\n  // }\n\n  static Deserialize(obj: any): Vector3 | null {\n    if (\n      !obj ||\n      !obj.hasOwnProperty('x') ||\n      !obj.hasOwnProperty('y') ||\n      !obj.hasOwnProperty('z')\n    ) {\n      console.error('Failed deserializing vector3');\n      return null;\n    }\n\n    return new Vector3({\n      x: obj.x,\n      y: obj.y,\n      z: obj.z,\n    });\n  }\n\n  static Serialize(obj: IVector3): string {\n    return JSON.stringify(this.SerializeToObject(obj));\n  }\n\n  static SerializeToObject(obj: IVector3): object {\n    return { x: obj.x, y: obj.y, z: obj.z };\n  }\n}\n","import { INTMAX32, squirrel3 } from './random';\n\nexport function randomSwitch<T>(args: {\n  randInt: number;\n  weights: { [k: string]: number };\n  behaviors: { [k: string]: (randInt: number) => T };\n}): T {\n  const { randInt, weights, behaviors } = args;\n  const p = randInt / INTMAX32;\n  const newRandInt = squirrel3(randInt);\n  const weightTotal = Object.values(weights).reduce((pv, cv) => pv + cv);\n  let unusedWeight = p * weightTotal;\n  for (const [key, weight] of Object.entries(weights)) {\n    if (unusedWeight <= weight) {\n      // use key\n      return behaviors[key](newRandInt);\n    } else {\n      unusedWeight -= weight;\n    }\n  }\n  throw Error();\n}\n\nexport function randomValue<T>(args: {\n  randInt: number;\n  weights: { [k in keyof T]: number };\n}): keyof T {\n  const { randInt, weights } = args;\n  const p = randInt / INTMAX32;\n  const weightTotal = (Object.values(weights) as number[]).reduce(\n    (pv, cv) => pv + cv\n  );\n  let unusedWeight = p * weightTotal;\n  for (const [key, weight] of Object.entries(weights) as [keyof T, number][]) {\n    if (unusedWeight <= weight) {\n      // use key\n      return key;\n    } else {\n      unusedWeight -= weight;\n    }\n  }\n  throw Error();\n}\n\nexport function randomUniform(args: {\n  randInt: number;\n  min: number;\n  max: number;\n  increment?: number;\n  inclusive?: boolean;\n}): number {\n  const { randInt, min, max, increment = 1, inclusive = true } = args;\n  const p = randInt / INTMAX32;\n  let numBuckets = Math.ceil((max - min) / increment);\n  if (min + increment * numBuckets === max && inclusive === true) {\n    numBuckets += 1;\n  }\n  const g = Math.floor(p * numBuckets);\n  return min + g * increment;\n}\n\nexport function randomDice(args: {\n  randInt: number;\n  formula: string;\n  plus?: number;\n}): number {\n  const { randInt, formula, plus = 0 } = args;\n  const numDice = parseInt(formula.split('d')[0]);\n  const numPips = parseInt(formula.split('d')[1]);\n  let val = 0;\n  for (let i = 0; i < numDice; i++) {\n    val += randomUniform({\n      randInt: squirrel3(randInt + i),\n      min: 1,\n      max: numPips,\n      inclusive: true,\n    });\n  }\n  return val + plus;\n}\n","import { LockData } from '../../data/PlayerSaveState';\nimport { Vector2 } from '../../lib/util/geometry/vector2';\nimport { Vector3 } from '../../lib/util/geometry/vector3';\nimport { INTMAX32, squirrel3 } from '../../lib/util/random';\n\ntype LockFactoryConfig = {};\n\n// locks occur at this frequency\n// a good non-debug value is 0.47. 0.5 is the site percolation threshold for triangular lattice\nconst LOCK_FREQUENCY = 0.47;\nconst LOCK_FREQUENCY_STARTER_AREA = 0.2;\nexport const STARTER_AREA_RADIUS = 4;\n\nexport class LockFactory {\n  public config: LockFactoryConfig;\n\n  constructor(config: LockFactoryConfig) {\n    this.config = config;\n  }\n\n  public create(args: {\n    seed: number;\n    location: Vector3;\n  }): LockData | undefined {\n    const id = squirrel3(\n      args.seed +\n        args.location.x +\n        args.location.y +\n        squirrel3(args.seed + args.location.x + args.location.z)\n    );\n    const p = id / INTMAX32;\n\n    let lockData: LockData = {\n      shortTextTarget: '🔒',\n      shortTextTimer: '',\n    };\n    if (args.location.equals(Vector3.Zero)) {\n      return undefined;\n    }\n    // special case for starting area -- should have lower lock frequency\n    if (taxicabDistance(args.location.toVector2()) <= STARTER_AREA_RADIUS) {\n      if (p < LOCK_FREQUENCY_STARTER_AREA) {\n        return lockData;\n      } else {\n        return undefined;\n      }\n    } else {\n      if (p < LOCK_FREQUENCY) {\n        return lockData;\n      } else {\n        return undefined;\n      }\n    }\n  }\n}\n\nexport function taxicabDistance(v: Vector2, w: Vector2 = Vector2.Zero): number {\n  if (!w.equals(Vector2.Zero)) {\n    return taxicabDistance(v.subtract(w));\n  }\n  let a = v.x;\n  let b = v.y;\n  let c = 0;\n\n  // find the most negative coordinate and add it to all of them to coerce them positive\n  let min = Math.min(a, b, c);\n  a -= min;\n  b -= min;\n  c -= min;\n\n  // now they're all nonnegative and one of them is zero, so WLOG we can work in the first 120-degree trident.\n  return Math.max(a, b, c);\n}\n\n// not square rooted\nexport function l2Norm(v: Vector2, w: Vector2 = Vector2.Zero): number {\n  if (!w.equals(Vector2.Zero)) {\n    return taxicabDistance(v.subtract(w));\n  }\n\n  // computed by doing \\| a + b \\omega \\|^2 = ( a + b \\omega ) * ( a + b \\omega^2 )\n  return v.x * v.x + v.y * v.y - v.x * v.y;\n}\n","import { HashMap } from '../../../lib/util/data_structures/hash';\nimport { Vector2 } from '../../../lib/util/geometry/vector2';\nimport { Vector3 } from '../../../lib/util/geometry/vector3';\nimport { squirrel3 } from '../../../lib/util/random';\nimport {\n  randomDice,\n  randomSwitch,\n  randomUniform,\n  randomValue,\n} from '../../../lib/util/randomHelpers';\nimport { STARTER_AREA_RADIUS, taxicabDistance } from '../LockFactory';\n\ntype NodeContentsFactoryConfig = {};\n\nexport interface NodeContents {\n  lines: NodeContentsLine[];\n\n  condition?: NodeContentsCondition;\n}\n\nexport interface NodeContentsCondition {\n  type: 'SPEND';\n  attribute: Attribute;\n  amount: number;\n}\n\nexport interface NodeContentsLine {\n  amount: number;\n  attribute: Attribute;\n  modifier: Modifier;\n}\n\nexport enum Attribute {\n  RED0 = 'RED0',\n  RED1 = 'RED1',\n  RED2 = 'RED2',\n  DEL0 = 'DEL0',\n  DEL1 = 'DEL1',\n  DEL2 = 'DEL2',\n}\n\nexport enum Modifier {\n  FLAT = 'FLAT',\n  INCREASED = 'INCREASED',\n}\n\nconst WEIGHTS = {\n  // for any single node, what is in it\n  ROOT: {\n    EMPTY: 150,\n    NO_SPEND: 100,\n    SPEND: 0,\n  },\n\n  STARTER_AREA_ROOT: {\n    EMPTY: 30,\n    NO_SPEND: 100,\n    SPEND: 0,\n  },\n  // how many different attributes are in the non-spend section\n  DECISION_1: {\n    SINGLE: 500,\n    DOUBLE: 0,\n  },\n  // if we are doing a single attribute, what attribute is it going to be\n  SINGLE_COLORS: {\n    [Attribute.RED0]: 100,\n    [Attribute.RED1]: 100,\n    [Attribute.RED2]: 100,\n    [Attribute.DEL0]: 10,\n    [Attribute.DEL1]: 10,\n    [Attribute.DEL2]: 10,\n  },\n  // if we are doing a single attribute, what modifier is it going to be\n  SINGLE_MODIFIERS: {\n    [Modifier.FLAT]: 150,\n    [Modifier.INCREASED]: 100,\n  },\n  // same as above but in the starting region\n  STARTER_AREA_SINGLE_MODIFIERS: {\n    [Modifier.FLAT]: 400,\n    [Modifier.INCREASED]: 100,\n  },\n};\n\nexport class NodeContentsFactory {\n  public config: NodeContentsFactoryConfig;\n\n  private clusterCenterData: HashMap<Vector3, any>;\n\n  constructor(config: NodeContentsFactoryConfig) {\n    this.config = config;\n    this.clusterCenterData = new HashMap();\n  }\n\n  private createSingle(args: {\n    randInt: number;\n    location: Vector3;\n  }): NodeContentsLine {\n    const attribute = randomValue<typeof Attribute>({\n      randInt: args.randInt,\n      weights: WEIGHTS.SINGLE_COLORS,\n    });\n\n    const modifier = randomValue<typeof Modifier>({\n      randInt: squirrel3(args.randInt),\n      weights:\n        taxicabDistance(args.location.pairXY()) <= STARTER_AREA_RADIUS\n          ? WEIGHTS.STARTER_AREA_SINGLE_MODIFIERS\n          : WEIGHTS.SINGLE_MODIFIERS,\n    });\n\n    let amount = 0;\n    if (modifier === Modifier.FLAT) {\n      amount = randomDice({\n        randInt: squirrel3(args.randInt + 1),\n        formula: '2d6',\n        plus: 8,\n      });\n    } else {\n      amount = randomUniform({\n        randInt: squirrel3(args.randInt + 2),\n        min: 4,\n        max: 7,\n        increment: 0.5,\n        inclusive: true,\n      });\n    }\n\n    return {\n      attribute: Attribute[attribute],\n      amount,\n      modifier: Modifier[modifier],\n    };\n  }\n\n  private createNoSpend(args: {\n    randInt: number;\n    location: Vector3;\n  }): NodeContents {\n    const { location } = args;\n\n    return randomSwitch<NodeContents>({\n      randInt: args.randInt,\n      weights: WEIGHTS.DECISION_1,\n      behaviors: {\n        SINGLE: (randInt) => {\n          return {\n            lines: [this.createSingle({ randInt, location })],\n          };\n        },\n        DOUBLE: (randInt) => {\n          return {\n            lines: [\n              this.createSingle({ randInt, location }),\n              this.createSingle({ randInt: squirrel3(randInt), location }),\n            ],\n          };\n        },\n      },\n    });\n  }\n\n  /**\n   * Entry point.\n   * @param args\n   * @returns\n   */\n  public create(args: { seed: number; location: Vector3 }): NodeContents {\n    const { seed, location } = args;\n\n    // hardcode the starting point to be empty\n    if (location.equals(Vector3.Zero)) {\n      return {\n        lines: [],\n      };\n    }\n\n    // find the closest cluster center - a 3x3 hexagonal region\n    let clusterCenter: Vector3;\n    let modulo3 = location.moduloPositive(3).pairXY();\n    if (\n      modulo3.equals(new Vector2(1, 2)) ||\n      modulo3.equals(new Vector2(2, 1))\n    ) {\n      // not close to any cluster centers\n      clusterCenter = location;\n    } else {\n      clusterCenter = location.divide(3).round().multiply(3);\n    }\n\n    // don't use the cluster for the starting cluster\n    if (clusterCenter.equals(Vector3.Zero)) {\n      clusterCenter = location;\n    }\n\n    const result = randomSwitch<NodeContents>({\n      randInt: squirrel3(seed + Vector3ToSeed(clusterCenter)),\n      weights:\n        taxicabDistance(args.location.pairXY()) <= STARTER_AREA_RADIUS\n          ? WEIGHTS.STARTER_AREA_ROOT\n          : WEIGHTS.ROOT,\n      behaviors: {\n        EMPTY: (randInt: number) => {\n          return {\n            lines: [],\n          };\n        },\n        NO_SPEND: (randInt: number) => {\n          return this.createNoSpend({ randInt, location: clusterCenter });\n        },\n        SPEND: (randInt: number) => {\n          const base = this.createNoSpend({ randInt, location: clusterCenter });\n\n          const attribute = randomValue<typeof Attribute>({\n            randInt,\n            weights: {\n              [Attribute.RED0]: 100,\n              [Attribute.RED1]: 100,\n              [Attribute.RED2]: 100,\n              [Attribute.DEL0]: 0,\n              [Attribute.DEL1]: 0,\n              [Attribute.DEL2]: 0,\n            },\n          });\n\n          return {\n            ...base,\n            condition: {\n              type: 'SPEND',\n              amount: 12,\n              attribute: Attribute[attribute],\n            },\n          };\n        },\n      },\n    });\n\n    return result;\n  }\n}\n\nexport function Vector3ToSeed(v: Vector3) {\n  return v.x + v.y + squirrel3(v.x + v.z);\n}\n","import { interpolateColor } from '../../../lib/util/color';\nimport {\n  Attribute,\n  Modifier,\n  NodeContents,\n  NodeContentsCondition,\n  NodeContentsLine,\n} from './NodeContentsFactory';\n\nexport const AttributeSymbolMap = {\n  [Attribute.RED0]: '🔴',\n  [Attribute.RED1]: '🟢',\n  [Attribute.RED2]: '🔵',\n  [Attribute.DEL0]: '⚔️',\n  [Attribute.DEL1]: '🛡',\n  [Attribute.DEL2]: '✨',\n};\n\n// TODO(bowei): enforce this is the same length using typescript\nexport const AttributesSorted = [\n  Attribute.RED0,\n  Attribute.RED1,\n  Attribute.RED2,\n  Attribute.DEL0,\n  Attribute.DEL1,\n  Attribute.DEL2,\n];\n\n// Use hue and saturation from this map; HSV value is determined by node allocation state\n// Lch is actually better: see https://en.wikipedia.org/wiki/HCL_color_space\nexport const AttributeColorMap: { [k in Attribute | '']: number } = {\n  '': 0x888888,\n  [Attribute.RED0]: 0xff0000,\n  [Attribute.RED1]: 0x00ff00,\n  [Attribute.RED2]: 0x0000ff,\n  [Attribute.DEL0]: 0x5a8f88,\n  [Attribute.DEL1]: 0xffc400,\n  [Attribute.DEL2]: 0xffff43,\n};\n\nexport const AttributeDescriptionMap = {\n  [Attribute.RED0]: 'Red',\n  [Attribute.RED1]: 'Green',\n  [Attribute.RED2]: 'Blue',\n  [Attribute.DEL0]: 'Offense',\n  [Attribute.DEL1]: 'Defense',\n  [Attribute.DEL2]: 'Magic',\n};\n\nexport const AttributeDescriptionReverseMap: { [k: string]: Attribute } = {\n  Red: Attribute.RED0,\n  Green: Attribute.RED1,\n  Blue: Attribute.RED2,\n  Offense: Attribute.DEL0,\n  Defense: Attribute.DEL1,\n  Magic: Attribute.DEL2,\n};\n\nexport const ModifierSymbolMap = {\n  [Modifier.FLAT]: '+',\n  [Modifier.INCREASED]: '%',\n};\nexport const ModifierDescriptionMap = {\n  [Modifier.FLAT]: 'flat',\n  [Modifier.INCREASED]: 'increased',\n};\nexport const ModifierDescriptionReverseMap: { [k: string]: Modifier } = {\n  flat: Modifier.FLAT,\n  increased: Modifier.INCREASED,\n};\n\nexport function nodeContentsLineToString(line: NodeContentsLine): string {\n  const desc = AttributeDescriptionMap[line.attribute];\n  const symbol = AttributeSymbolMap[line.attribute];\n  if (line.modifier === Modifier.FLAT) {\n    return `+${line.amount} ${symbol} (${desc})`;\n  } else {\n    return `${line.amount}% increased ${symbol} (${desc})`;\n  }\n}\n\nexport function nodeContentsConditionToString(\n  condition: NodeContentsCondition\n): string {\n  return `SPEND: ${condition.amount} ${\n    AttributeDescriptionMap[condition.attribute]\n  }`;\n}\n\nexport function nodeContentsToColor(nodeContents: NodeContents): number {\n  if (nodeContents.lines.length === 0) {\n    return AttributeColorMap[''];\n  }\n  const color0 = AttributeColorMap[nodeContents.lines[0].attribute];\n  if (nodeContents.lines.length === 1) {\n    return color0;\n  }\n  const color1 = AttributeColorMap[nodeContents.lines[1].attribute];\n  // return 50% of the way in between the 2 colors\n  return interpolateColor({ color: color0, opacity: 0.5, background: color1 });\n}\n","import { Vector2 } from '../lib/util/geometry/vector2';\nimport { Const } from '../lib/util/misc';\n\n/**\n * current window settings -- allows for dynamic resizing and also rotation on mobile web\n */\nexport type WindowState = {\n  orientation: 'original' | 'rotated'; // rotated === we are forcing landscape-in-portrait\n  innerWidth: number;\n  innerHeight: number;\n};\n\nexport const newWindowState = (): WindowState => {\n  return {\n    orientation: 'original',\n    innerWidth: window.innerWidth,\n    innerHeight: window.innerHeight,\n  };\n};\n\n/**\n * given the dimensions of the entire html window, computes the size of the intended play area -- leaves a 24px border\n * TODO(bowei): move this somewhere more appropriate. for now it's just here because it's used in both pixi and react components\n */\nexport function appSizeFromWindowSize(window?: Const<Vector2>): Vector2 {\n  return new Vector2({\n    x: Math.min(2560, (window?.x || Infinity) - 24),\n    y: Math.min(1440, (window?.y || Infinity) - 24),\n  });\n}\n","import {\n  NodeBookmarkedStatus,\n  NodeExploredStatus,\n  NodeTakenStatus,\n} from './NodeStatus';\nimport { KeyedHashMap } from '../lib/util/data_structures/hash';\nimport { Vector3 } from '../lib/util/geometry/vector3';\nimport { DeserializationError } from '../lib/util/misc';\nimport { ERA_DEALLOCATION_POINTS } from '../game/actions/AllocateNode';\n\nexport type PlayerSaveState = {\n  /**\n   * Indicated which nodes are allocated or not. NOTE: does not contain fog of war information\n   */\n  allocationStatusMap: KeyedHashMap<Vector3, NodeTakenStatus>;\n\n  /**\n   * Similar but for era A\n   */\n  bookmarkedStatusMap: KeyedHashMap<Vector3, NodeBookmarkedStatus>;\n\n  /**\n   * Saves a map of all the nodes we bookmarked and then unbookmarked -- doing that preserves fog of war\n   */\n  exploredStatusMap: KeyedHashMap<Vector3, NodeExploredStatus>;\n\n  /**\n   * Which phase of the game we are in\n   */\n  currentEra: EraType;\n\n  /**\n   *\n   */\n  deallocationPoints: {\n    remaining: number;\n    provided: number;\n  };\n};\n\nexport type EraType = {\n  type: 'A' | 'B';\n  index: number;\n};\n\n// NOT DEPRECATED\nexport type LockData = {\n  shortTextTarget: string;\n  shortTextTimer: string;\n};\n\nexport const newPlayerSaveState = (): PlayerSaveState => {\n  return {\n    // make sure to allocate the beginning node\n    allocationStatusMap: new KeyedHashMap([\n      [Vector3.Zero, NodeTakenStatus.true],\n    ]),\n    bookmarkedStatusMap: new KeyedHashMap(),\n    exploredStatusMap: new KeyedHashMap([[Vector3.Zero, { explored: true }]]),\n    currentEra: {\n      type: 'B',\n      index: 0,\n    },\n    deallocationPoints: {\n      provided: ERA_DEALLOCATION_POINTS[0],\n      remaining: ERA_DEALLOCATION_POINTS[0],\n    },\n  };\n};\n\nconst serializeToObject = (s: PlayerSaveState): object => {\n  return {\n    ...s,\n    allocationStatusMap: KeyedHashMap.SerializeToObject<\n      Vector3,\n      NodeTakenStatus\n    >(s.allocationStatusMap, Vector3.SerializeToObject),\n    bookmarkedStatusMap: KeyedHashMap.SerializeToObject<\n      Vector3,\n      NodeBookmarkedStatus\n    >(s.bookmarkedStatusMap, Vector3.SerializeToObject),\n    exploredStatusMap: KeyedHashMap.SerializeToObject<\n      Vector3,\n      NodeExploredStatus\n    >(s.exploredStatusMap, Vector3.SerializeToObject),\n  };\n};\n\nconst serialize = (s: PlayerSaveState) => JSON.stringify(serializeToObject(s));\n\nconst deserializeFromObject = (obj: any): PlayerSaveState | null => {\n  if (\n    !obj ||\n    !obj.hasOwnProperty('allocationStatusMap') ||\n    !obj.hasOwnProperty('bookmarkedStatusMap') ||\n    !obj.hasOwnProperty('exploredStatusMap') ||\n    !obj.hasOwnProperty('deallocationPoints') ||\n    !obj.hasOwnProperty('currentEra')\n  ) {\n    console.error('Failed deserializing PlayerSaveState: ', obj);\n    return null;\n  }\n\n  const allocationStatusMap = KeyedHashMap.Deserialize<\n    Vector3,\n    NodeTakenStatus\n  >(obj.allocationStatusMap, (it) => {\n    const result = Vector3.Deserialize(it);\n    if (!result) {\n      throw new DeserializationError(\n        `Failed deserializing vector3 ${JSON.stringify(it)}`\n      );\n    }\n    return result;\n  });\n  if (!allocationStatusMap) {\n    console.error(\n      'Failed deserializing PlayerSaveState.allocationStatusMap: ',\n      obj\n    );\n    return null;\n  }\n\n  const bookmarkedStatusMap = KeyedHashMap.Deserialize<\n    Vector3,\n    NodeBookmarkedStatus\n  >(obj.bookmarkedStatusMap, (it) => {\n    const result = Vector3.Deserialize(it);\n    if (!result) {\n      throw new DeserializationError(\n        `Failed deserializing vector3 ${JSON.stringify(it)}`\n      );\n    }\n    return result;\n  });\n  if (!bookmarkedStatusMap) {\n    console.error(\n      'Failed deserializing PlayerSaveState.bookmarkedStatusMap: ',\n      obj\n    );\n    return null;\n  }\n\n  const exploredStatusMap = KeyedHashMap.Deserialize<\n    Vector3,\n    NodeExploredStatus\n  >(obj.exploredStatusMap, (it) => {\n    const result = Vector3.Deserialize(it);\n    if (!result) {\n      throw new DeserializationError(\n        `Failed deserializing vector3 ${JSON.stringify(it)}`\n      );\n    }\n    return result;\n  });\n  if (!exploredStatusMap) {\n    console.error(\n      'Failed deserializing PlayerSaveState.exploredStatusMap: ',\n      obj\n    );\n    return null;\n  }\n\n  return {\n    ...(obj as PlayerSaveState),\n    allocationStatusMap,\n    bookmarkedStatusMap,\n    exploredStatusMap,\n  };\n};\n\nconst deserialize = (obj: string) => deserializeFromObject(JSON.parse(obj));\n\nconst storageKey = 'PlayerSaveState';\n\n/**\n * Tries to load from local storage and falls back to creating a new object if unsuccessful.\n * see: https://gist.github.com/muzfr7/7e15582add46e74dee111002ec6cf594\n * http://vaughnroyko.com/idbonbeforeunload/\n * https://discourse.mozilla.org/t/saving-to-localstorage-on-window-close/35627/7\n * https://developer.mozilla.org/en-US/docs/Web/API/WindowEventHandlers/onbeforeunload\n * https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage\n */\nconst tryLoad = (): PlayerSaveState => {\n  const loaded = load();\n  if (loaded) {\n    return loaded;\n  } else {\n    console.log('Failed to load PlayerSaveState');\n    return newPlayerSaveState();\n  }\n};\n\nconst load = (): PlayerSaveState | null => {\n  const data = window.localStorage.getItem(storageKey);\n  const loaded = (data && deserialize(data)) || null;\n  return loaded;\n};\n\nconst store = (s: PlayerSaveState) => {\n  const data = serialize(s);\n  window.localStorage.setItem(storageKey, data);\n};\n\nconst clear = () => {\n  window.localStorage.setItem(storageKey, '');\n};\n\n// eslint-disable-next-line\nexport const PlayerSaveState = {\n  new: newPlayerSaveState,\n  serialize,\n  deserialize,\n  tryLoad,\n  load,\n  store,\n  clear,\n};\n","import { HashSet } from '../../lib/util/data_structures/hash';\nimport { Vector3 } from '../../lib/util/geometry/vector3';\n\nexport enum Direction {\n  NORTHWEST = 'NORTHWEST',\n  SOUTHWEST = 'SOUTHWEST',\n  NORTHEAST = 'NORTHEAST',\n  SOUTHEAST = 'SOUTHEAST',\n  EAST = 'EAST',\n  WEST = 'WEST',\n  UP = 'UP',\n  DOWN = 'DOWN',\n}\n\n/**\n * Moving 1 unit of grid on a z level corresponds to moving this many units of grid in the same direction on the z level below.\n */\n// const PER_Z_SCALE_FACTOR = 6;\n\n/**\n *   2   3\n * 4 - O - 1\n *   6   5\n * x-axis is along 0 -> 1\n * y-axis is along 0 -> 2\n * z-axis is vertical\n *\n * @param base 0\n */\nexport function getCoordNeighbors(\n  base: Vector3\n): { [d in Direction]?: Vector3 } {\n  let neighbors: { [d in Direction]?: Vector3 } = {} as any;\n\n  neighbors.EAST = base.addX(1);\n  neighbors.WEST = base.addX(-1);\n  neighbors.NORTHWEST = base.addY(1);\n  neighbors.SOUTHEAST = base.addY(-1);\n  neighbors.NORTHEAST = base.add(1, 1, 0);\n  neighbors.SOUTHWEST = base.add(-1, -1, 0);\n\n  // TODO(bowei): reenable up/down neighbors later\n  // neighbors.DOWN = base\n  //   .multiply(new Vector3(PER_Z_SCALE_FACTOR, PER_Z_SCALE_FACTOR, 1))\n  //   .addZ(-1);\n\n  // if (base.x % PER_Z_SCALE_FACTOR === 0 && base.y % PER_Z_SCALE_FACTOR === 0) {\n  //   neighbors.UP = base\n  //     .divide(new Vector3(PER_Z_SCALE_FACTOR, PER_Z_SCALE_FACTOR, 1))\n  //     .addZ(1);\n  // }\n\n  return neighbors;\n}\n\nexport type IReadonlySet<K> = {\n  contains: (k: K) => boolean;\n};\n\n/**\n * BFS.\n * @param base\n * @param maxDistance\n * @param minDistance\n * @param disallowedSet we are not allowed to BFS through these\n * @returns all vector3 coords that are <= maxDistance and >= minDistance where we cannot pass through the disallowed set, but we can arrive at them.\n */\nexport function getWithinDistance(\n  baseOrBases: Vector3 | Vector3[],\n  maxDistance: number = Infinity,\n  minDistance?: number,\n  disallowedSet?: IReadonlySet<Vector3>\n): Vector3[] {\n  let bases: Vector3[];\n  if (Array.isArray(baseOrBases)) {\n    bases = baseOrBases;\n  } else {\n    bases = [baseOrBases];\n  }\n\n  let touched: HashSet<Vector3> = new HashSet();\n  let disallowedButTouched: HashSet<Vector3> = new HashSet();\n  bases.forEach((it) => touched.put(it));\n  const byDist: Vector3[][] = [bases];\n\n  for (let d = 1; d <= maxDistance; d++) {\n    if (byDist[d - 1].length === 0) {\n      break;\n    }\n\n    byDist.push([]);\n\n    for (let vec of byDist[d - 1]) {\n      const considering = Object.values(getCoordNeighbors(vec));\n      for (const n of considering) {\n        if (!n) continue;\n        if (touched.get(n)) continue;\n        touched.put(n);\n\n        if (disallowedSet?.contains(n)) {\n          disallowedButTouched.put(n);\n        } else {\n          byDist[d].push(n);\n        }\n      }\n    }\n  }\n\n  let result: Vector3[] = [];\n  for (\n    let dd = minDistance || 0;\n    dd <= maxDistance && dd <= byDist.length;\n    dd++\n  ) {\n    if (byDist[dd] && byDist[dd].length > 0) {\n      result = result.concat(byDist[dd]);\n    }\n  }\n  result = result.concat(disallowedButTouched.values());\n  return result;\n}\n","import { LockData } from '../../data/PlayerSaveState';\nimport { WorldGenState } from '../../data/WorldGenState';\nimport { Vector3 } from '../../lib/util/geometry/vector3';\nimport { LazyHashMap } from '../../lib/util/lazy';\nimport { LockFactory } from './LockFactory';\nimport {\n  NodeContentsFactory,\n  NodeContents,\n} from './nodeContents/NodeContentsFactory';\n\nexport type WorldGenStateConfig = {};\n\nconst storageKey = 'WorldGenState';\n\nexport class WorldGenStateFactory {\n  public config: WorldGenStateConfig;\n\n  constructor(config: WorldGenStateConfig) {\n    this.config = config;\n  }\n\n  public create(args: { seed: number }): WorldGenState {\n    const mySeed = args.seed;\n\n    const lockFactory = new LockFactory({});\n    const lockDataMap = new LazyHashMap<Vector3, LockData | undefined>((k) =>\n      lockFactory.create({ seed: mySeed, location: k })\n    );\n    const nodeContentsFactory = new NodeContentsFactory({});\n    const nodeContentsMap = new LazyHashMap<Vector3, NodeContents>((k) =>\n      nodeContentsFactory.create({ seed: mySeed, location: k })\n    );\n    return {\n      seed: mySeed,\n      lockMap: lockDataMap,\n      nodeContentsMap,\n    };\n  }\n\n  public tryLoad(args: { seed: number }): WorldGenState {\n    const loaded = this.load();\n    if (loaded) {\n      return this.create(loaded);\n    } else {\n      return this.create(args);\n    }\n  }\n\n  public store(s: WorldGenState) {\n    const data = this.serialize(s);\n    window.localStorage.setItem(storageKey, data);\n  }\n\n  load(): { seed: number } | null {\n    const data = window.localStorage.getItem(storageKey);\n    const loaded = (data && this.deserialize(data)) || null;\n    return loaded;\n  }\n\n  deserialize(obj: string): { seed: number } | null {\n    return this.deserializeFromObject(JSON.parse(obj));\n  }\n\n  deserializeFromObject(obj: any): { seed: number } | null {\n    if (!obj || !obj.hasOwnProperty('seed')) {\n      return null;\n    }\n    return { ...obj };\n  }\n\n  serialize(s: WorldGenState) {\n    return JSON.stringify(this.serializeToObject(s));\n  }\n\n  serializeToObject(s: WorldGenState): object {\n    return { seed: s.seed };\n  }\n\n  public clear() {\n    window.localStorage.setItem(storageKey, '');\n  }\n}\n","import React, { useCallback, useEffect, useMemo, useState } from 'react';\nimport { GameState } from '../../../data/GameState';\nimport { UpdaterGeneratorType2 } from '../../../lib/util/updaterGenerator';\nimport { Vector2 } from '../../../lib/util/geometry/vector2';\nimport { PlayerUIState } from '../../../data/PlayerUIState';\nimport { WorldGenStateFactory } from '../../../game/worldGen/WorldGenStateFactory';\nimport { appSizeFromWindowSize } from '../../../data/WindowState';\nimport { virtualAreaScaleMultiplier } from '../../GameArea/GameAreaInterface';\nimport { PlayerSaveState } from '../../../data/PlayerSaveState';\n\nexport function DebugTabContent(props: {\n  gameState: GameState; // definitely needs gameState.tick in order that this component updates regularly\n  updaters: UpdaterGeneratorType2<GameState, GameState>;\n  hidden: boolean;\n}) {\n  const { gameState } = props;\n  const { tick } = gameState;\n\n  const [lastUpdated, setLastUpdated] = useState(+new Date());\n  const [slowRenderMsgs, setSlowRenderMsgs] = useState<string[]>([]);\n\n  const appSize = useMemo(() => {\n    return appSizeFromWindowSize(\n      new Vector2(\n        gameState.windowState.innerWidth,\n        gameState.windowState.innerHeight\n      )\n    );\n  }, [gameState.windowState.innerWidth, gameState.windowState.innerHeight]);\n\n  // TODO(bowei): re-factor this from game area interface\n  // TODO(bowei): programmatically determine UI scale based on app size\n  const hexGridPx = useMemo(() => {\n    if (appSize.x > 1920) {\n      return new Vector2(268, 232);\n    } else {\n      return new Vector2(194, 168);\n      // return new Vector2(120, 104);\n      // return new Vector2(97, 84);\n      // return new Vector2(75, 65); // TODO(bowei): change text font size to xx-small\n    }\n  }, [appSize]);\n\n  const virtualGridDims = useMemo(() => {\n    let x = Math.floor(\n      (appSize.x * virtualAreaScaleMultiplier) / hexGridPx.x - 0.5\n    );\n    let y = Math.floor((appSize.y * virtualAreaScaleMultiplier) / hexGridPx.y);\n\n    // y = (Math.floor((y - 1) / 2) * 2) + 1; // force y to be odd\n\n    // needs to be at least 3.8 x 4.8 so we have room for jumps\n    // x = Math.max(4, x);\n    // y = Math.max(5, y);\n\n    return new Vector2(x, y);\n  }, [appSize, hexGridPx]);\n\n  useEffect(() => {\n    const now = new Date();\n    const msSinceLastTick = +now - lastUpdated;\n    if (msSinceLastTick > 30) {\n      const msg = `Tick ${tick} took ${msSinceLastTick}ms at ${\n        now.toTimeString().split(' ')[0]\n      }`;\n      console.log(msg);\n      setSlowRenderMsgs((prev) => {\n        return [msg, ...prev];\n      });\n    }\n    setLastUpdated(+new Date());\n  }, [tick, lastUpdated, setLastUpdated, setSlowRenderMsgs]);\n\n  const virtualGridDimsTrigger = useCallback(() => {\n    console.log('tried triggered update from debug tab');\n    // NOTE(bowei): this apparently takes around 100ms alone. full jump takes ~200ms\n    props.updaters.debug.retriggerVirtualGridDims.enqueueUpdate((prev) => {\n      return () => {\n        console.log('force triggered update from debug tab');\n      };\n    });\n  }, [props.updaters]);\n\n  const toggleScrollbars = useCallback(() => {\n    props.updaters.debug.debugShowScrollbars?.enqueueUpdate((prev) => {\n      const next = !prev;\n      return next;\n    });\n  }, [props.updaters]);\n\n  const gameAreaGridRerender = useCallback(() => {\n    props.updaters.debug.rerenderGameAreaGrid.enqueueUpdate((prev) => {\n      return () => {\n        console.log('force triggered react rerender from debug tab');\n      };\n    });\n  }, [props.updaters]);\n\n  const onDisableScrollJump = useCallback(() => {\n    props.updaters.debug.enableScrollJump.enqueueUpdate(() => {\n      return false;\n    });\n  }, [props.updaters]);\n\n  const onEnableScrollJump = useCallback(() => {\n    props.updaters.debug.enableScrollJump.enqueueUpdate(() => {\n      return true;\n    });\n  }, [props.updaters]);\n\n  const forceVirtualGridJump = useCallback(() => {\n    props.updaters.debug.getForceJumpOffset.enqueueUpdate((prev) => {\n      return () => {\n        console.log('force triggered virtual jump only');\n        return new Vector2(1, 2);\n      };\n    });\n  }, [props.updaters]);\n\n  const addDebugOffsetX = useCallback(() => {\n    props.updaters.debug.getOffsetX.enqueueUpdate((prev) => {\n      const offsetX = prev() || 0;\n      return () => {\n        return offsetX + 1;\n      };\n    });\n  }, [props.updaters]);\n\n  const flipCursored = useCallback(() => {\n    props.updaters.debug.isFlipCursored.enqueueUpdate((prev) => {\n      const flipCursored = prev() || false;\n      return () => {\n        return !flipCursored;\n      };\n    });\n  }, [props.updaters]);\n\n  const toggleTextBoxFocused = useCallback(() => {\n    props.updaters.playerUI.isTextBoxFocused.enqueueUpdate((prev) => {\n      const isTextBoxFocused = !prev;\n      console.log({ isTextBoxFocused });\n      return isTextBoxFocused;\n    });\n  }, [props.updaters]);\n\n  const saveLocalStorage = useCallback(() => {\n    PlayerUIState.store(props.gameState.playerUI);\n  }, [props.gameState]);\n\n  const loadLocalStorage = useCallback(() => {\n    const loaded = PlayerUIState.load();\n    if (loaded) {\n      props.updaters.playerUI.enqueueUpdate(() => loaded);\n    }\n  }, [props.updaters]);\n\n  const clearLocalStorage = useCallback(() => {\n    PlayerUIState.clear();\n    new WorldGenStateFactory({}).clear();\n    PlayerSaveState.clear();\n    props.updaters.justDisabledSave.enqueueUpdate(true);\n  }, [props.updaters]);\n\n  const clearSave = useCallback(() => {\n    PlayerSaveState.clear();\n    props.updaters.playerSave.enqueueUpdate((prev) => {\n      return PlayerSaveState.new();\n    });\n    props.updaters.justDisabledSave.enqueueUpdate(true);\n  }, [props.updaters]);\n\n  const toggleEra = useCallback(() => {\n    props.updaters.playerSave.currentEra.type.enqueueUpdate((prev) => {\n      if (prev === 'A') {\n        return 'B';\n      } else {\n        return 'A';\n      }\n    });\n  }, [props.updaters]);\n\n  if (props.hidden) {\n    return <> </>;\n  }\n  return (\n    <>\n      <div> debug tab </div>\n      <div className=\"tab-content-body\">\n        <br></br>\n        <div>Recent slow renders:</div>\n        {slowRenderMsgs.slice(0, 5).map((it, idx) => {\n          return <div key={idx}>{it}</div>;\n        })}\n        <br></br>\n      </div>\n      <br></br>\n      <div> virtual grid location </div>\n      <div>\n        ( {gameState.playerUI.virtualGridLocation.x} ,{' '}\n        {gameState.playerUI.virtualGridLocation.y} )\n      </div>\n      <br></br>\n      <div> virtual grid dims </div>\n      <div>\n        ( {virtualGridDims.x} , {virtualGridDims.y} )\n      </div>\n      <br></br>\n      <div> buttons </div>\n      <div className=\"tab-content-body\">\n        <br></br>\n        <div>\n          <button onClick={toggleScrollbars}>Toggle scrollbars</button>\n        </div>\n        <div>\n          <button onClick={virtualGridDimsTrigger}>\n            Trigger virtual grid dims rerender\n          </button>\n        </div>\n        <div>\n          <button onClick={gameAreaGridRerender}>\n            Trigger only virtual game area grid react rerender\n          </button>\n        </div>\n        <div>\n          <button onClick={onDisableScrollJump}>\n            Disable scroll jump trigger\n          </button>\n        </div>\n        <div>\n          <button onClick={onEnableScrollJump}>\n            Reenable scroll jump trigger\n          </button>\n        </div>\n        <div>\n          <button onClick={forceVirtualGridJump}>\n            Force virtual grid jump only\n          </button>\n        </div>\n        <div>\n          <button onClick={addDebugOffsetX}>add weird x offset to grid</button>\n        </div>\n        <div>\n          <button onClick={flipCursored}>\n            weird flip cursored state on all nodes\n          </button>\n        </div>\n        <div>\n          <button onClick={toggleTextBoxFocused}>\n            toggle text box focused\n          </button>\n        </div>\n        <div>\n          <button onClick={saveLocalStorage}>\n            save state to local storage\n          </button>\n        </div>\n        <div>\n          <button onClick={loadLocalStorage}>\n            load state from local storage\n          </button>\n        </div>\n        <div>\n          <button onClick={clearLocalStorage}>\n            clear local storage and disable saving\n          </button>\n        </div>\n        <div>\n          <button onClick={clearSave}>clear save</button>\n        </div>\n        <div>\n          <button onClick={toggleEra}>toggle era</button>\n        </div>\n      </div>\n    </>\n  );\n}\n","import React, { useCallback, useState } from 'react';\nimport { UpdaterGeneratorType2 } from '../../../lib/util/updaterGenerator';\nimport { GameState } from '../../../data/GameState';\nimport {\n  Attribute,\n  Modifier,\n} from '../../../game/worldGen/nodeContents/NodeContentsFactory';\nimport {\n  AttributeDescriptionMap,\n  AttributeSymbolMap,\n  ModifierDescriptionMap,\n  ModifierSymbolMap,\n} from '../../../game/worldGen/nodeContents/NodeContentsRendering';\n\nexport const StrategicTab = React.memo(StrategicTabComponent);\n\n// TODO(bowei): prune down state\nfunction StrategicTabComponent(props: {\n  gameState: GameState;\n  updaters: UpdaterGeneratorType2<GameState, GameState>;\n}) {\n  const { gameState, updaters } = props;\n\n  const [showAdvancedSearch, setShowAdvancedSearch] = useState(false);\n  const [highlightInputValue, setHighlightInputValue] = useState('');\n\n  const onFocus = useCallback(() => {\n    updaters.playerUI.isTextBoxFocused.enqueueUpdate(true);\n  }, [updaters]);\n  const onBlur = useCallback(() => {\n    updaters.playerUI.isTextBoxFocused.enqueueUpdate(false);\n  }, [updaters]);\n\n  const onFireSearch = useCallback(() => {\n    updaters.playerUI.strategicSearch.highlight1.enqueueUpdate(() => {\n      return {\n        value: highlightInputValue,\n      };\n    });\n  }, [updaters, highlightInputValue]);\n\n  // const onCancelSearch = useCallback(() => {\n  //   setHighlightInputValue(gameState.playerUI.strategicSearch.highlight1.value);\n  // }, [gameState.playerUI.strategicSearch.highlight1.value]);\n  const onCancelSearch = useCallback(() => {\n    setHighlightInputValue('');\n    updaters.playerUI.strategicSearch.highlight1.enqueueUpdate(() => {\n      return {\n        value: '',\n      };\n    });\n  }, [updaters]);\n\n  const onToggleColors = useCallback(\n    (value: 'Yes' | 'Only unallocated' | 'No', e: React.MouseEvent) => {\n      updaters.playerUI.strategicSearch.colors.enabled.enqueueUpdate((prev) => {\n        return value;\n      });\n    },\n    [updaters]\n  );\n\n  if (gameState.playerUI.isPixiHidden) {\n    return (\n      <>\n        <div>Strategic view is not open!</div>\n        <br></br>\n        <div>Click (hotkey: b) to toggle strategic view.</div>\n      </>\n    );\n  }\n  return (\n    <>\n      <div>{showAdvancedSearch ? 'Custom' : 'Basic'} search</div>\n      <br></br>\n      <div className=\"tab-content-body\">\n        <div>\n          Colors enabled?\n          <HorizontalButtonRadio\n            labels={['Always', 'Only unallocated', 'No']}\n            values={['Yes', 'Only unallocated', 'No']}\n            defaultValue={gameState.playerUI.strategicSearch.colors.enabled}\n            onChange={onToggleColors}\n          />\n        </div>\n        <br></br>\n        <div>\n          Symbols: {/* TODO(bowei): need tooltip text here */}\n          <SymbolButton\n            updateTextInputValue={setHighlightInputValue}\n            attribute={Attribute.RED0}\n          />\n          <SymbolButton\n            updateTextInputValue={setHighlightInputValue}\n            attribute={Attribute.RED1}\n          />\n          <SymbolButton\n            updateTextInputValue={setHighlightInputValue}\n            attribute={Attribute.RED2}\n          />\n          <SymbolButton\n            updateTextInputValue={setHighlightInputValue}\n            attribute={Attribute.DEL0}\n          />\n          <SymbolButton\n            updateTextInputValue={setHighlightInputValue}\n            attribute={Attribute.DEL1}\n          />\n          <SymbolButton\n            updateTextInputValue={setHighlightInputValue}\n            attribute={Attribute.DEL2}\n          />\n          <TextInputButton\n            updateTextInputValue={setHighlightInputValue}\n            icon={'*'}\n            insertedText={'[*] '}\n          />\n          <br></br>\n          <TextInputButton\n            updateTextInputValue={setHighlightInputValue}\n            id={Modifier.FLAT}\n            icon={ModifierSymbolMap[Modifier.FLAT]}\n            insertedText={'[' + ModifierDescriptionMap[Modifier.FLAT] + '] '}\n          />\n          <TextInputButton\n            updateTextInputValue={setHighlightInputValue}\n            id={Modifier.INCREASED}\n            icon={ModifierSymbolMap[Modifier.INCREASED]}\n            insertedText={\n              '[' + ModifierDescriptionMap[Modifier.INCREASED] + '] '\n            }\n          />\n          <TextInputButton\n            updateTextInputValue={setHighlightInputValue}\n            id={'!taken'}\n            icon={'Unallocated'}\n            insertedText={'![taken] '}\n          />\n          <TextInputButton\n            updateTextInputValue={setHighlightInputValue}\n            id={'!locked'}\n            icon={'Unlocked'}\n            insertedText={'![locked] '}\n          />\n          <TextInputButton\n            updateTextInputValue={setHighlightInputValue}\n            id={'locked'}\n            icon={'Locked'}\n            insertedText={'[locked] '}\n          />\n        </div>\n        <br></br>\n        <div>\n          Highlight:{' '}\n          <input\n            type={'text'}\n            onFocus={onFocus}\n            onChange={(e) => {\n              // need to set value manually: https://stackoverflow.com/questions/41736213/why-cant-i-change-my-input-value-in-react-even-with-the-onchange-listener\n              setHighlightInputValue(e.target.value);\n            }}\n            onBlur={onBlur}\n            value={highlightInputValue}\n          ></input>\n          <button onClick={onFireSearch}>🔎</button>\n          <button onClick={onCancelSearch}>🚫</button>\n        </div>\n        {showAdvancedSearch ? (\n          <>\n            <div>\n              Highlight 2: <input type={'text'}></input>\n              <button>Apply</button>\n              <button>Cancel</button>\n            </div>\n            <br></br>\n            <div>Filter:</div>\n            <br></br>\n            <div>\n              Show if: <input type={'text'}></input>\n              <button>Apply</button>\n              <button>Cancel</button>\n            </div>\n            <br></br>\n            <div>Color:</div>\n            <br></br>\n            <div>\n              Grayscale by: <input type={'text'}></input>\n              <button>Apply</button>\n              <button>Cancel</button>\n            </div>\n            <div>\n              Color by: <input type={'text'}></input>\n              <button>Apply</button>\n              <button>Cancel</button>\n            </div>\n            <br></br>\n            <div>Shape:</div>\n            <br></br>\n            <div>\n              Shape = | if: <input type={'text'}></input>\n              <button>Apply</button>\n              <button>Cancel</button>\n            </div>\n            <br></br>\n            <br></br>\n            <div>\n              <input type={'text'}></input>\n              <button>Save config</button>\n            </div>\n            <div>\n              <input type={'text'}></input>\n              <button>Load config</button>\n            </div>\n            <div>\n              <button>Reset to defaults</button>\n            </div>\n            <br></br>\n            <div>\n              <button\n                onClick={() => {\n                  setShowAdvancedSearch(false);\n                }}\n              >\n                Use basic search\n              </button>\n            </div>\n          </>\n        ) : (\n          <>\n            <br></br>\n            <div>\n              <button\n                onClick={() => {\n                  setShowAdvancedSearch(true);\n                }}\n              >\n                Use custom search\n              </button>\n            </div>\n          </>\n        )}\n      </div>\n    </>\n  );\n}\n\nfunction SymbolButton(props: {\n  updateTextInputValue: (fn: (s: string) => string) => void;\n  attribute: Attribute;\n}) {\n  return (\n    <TextInputButton\n      updateTextInputValue={props.updateTextInputValue}\n      insertedText={'[' + AttributeDescriptionMap[props.attribute] + '] '}\n      icon={AttributeSymbolMap[props.attribute]}\n    />\n  );\n}\n\nfunction TextInputButton(props: {\n  updateTextInputValue: (fn: (s: string) => string) => void;\n  icon: string;\n  id?: any;\n  insertedText: string;\n}) {\n  return (\n    <button\n      onMouseDown={(e) => {\n        // needed to preserve textbox focus: https://stackoverflow.com/questions/12154954/how-to-make-element-not-lose-focus-when-button-is-pressed\n        // keydown does NOT work here!\n        e.preventDefault();\n      }}\n      onPointerDown={(e) => {\n        e.preventDefault();\n      }}\n      onClick={(e) => {\n        e.preventDefault();\n        props.updateTextInputValue((prev) => prev + props.insertedText);\n      }}\n    >\n      {props.icon}\n    </button>\n  );\n}\n\nfunction HorizontalButtonRadio<T>(props: {\n  labels: (string | React.ReactNode)[];\n  values: T[];\n  defaultValue: T | null;\n  onChange: (value: T, e: React.MouseEvent) => void;\n}) {\n  const { labels, values, defaultValue, onChange } = props;\n\n  const defaultIdx = defaultValue ? values.indexOf(defaultValue) : -1;\n  const [currentIdx, setCurrentIdx] = useState(defaultIdx);\n\n  const len = Math.min(labels.length, values.length);\n\n  const body = Array(len)\n    .fill(0)\n    .map((_, idx) => {\n      return (\n        <button\n          key={idx}\n          disabled={idx === currentIdx}\n          onClick={(e: React.MouseEvent) => {\n            setCurrentIdx(idx);\n            onChange(values[idx], e);\n          }}\n        >\n          {labels[idx]}\n        </button>\n      );\n    });\n\n  return <>{body}</>;\n}\n","import { GameState } from '../../data/GameState';\nimport { HashSet } from '../../lib/util/data_structures/hash';\nimport { Vector3 } from '../../lib/util/geometry/vector3';\nimport { EnumInvalidError, extractDeps } from '../../lib/util/misc';\nimport { UpdaterGeneratorType2 } from '../../lib/util/updaterGenerator';\nimport { getCoordNeighbors } from '../lib/HexGrid';\n\nexport interface DeallocateNodeInput {\n  nodeLocation: Vector3;\n}\n\nexport type DeallocateNodeResult = boolean;\n\nfunction _extract(gameState: GameState) {\n  return {\n    playerSave: {\n      allocationStatusMap: gameState.playerSave.allocationStatusMap,\n      bookmarkedStatusMap: gameState.playerSave.bookmarkedStatusMap,\n      currentEra: gameState.playerSave.currentEra,\n      deallocationPoints: gameState.playerSave.deallocationPoints,\n    },\n    computed: {\n      reachableStatusMap: gameState.computed.reachableStatusMap,\n      fogOfWarStatusMap: gameState.computed.fogOfWarStatusMap,\n      accessibleStatusMap: gameState.computed.accessibleStatusMap,\n    },\n    worldGen: {\n      lockMap: gameState.worldGen.lockMap,\n    },\n  };\n}\n\nexport function extractDeallocateNodeCheckState(g: DeallocateNodeCheckState) {\n  return _extract(g as GameState);\n}\n\nexport type DeallocateNodeCheckState = ReturnType<typeof _extract>;\nexport const depsDeallocateNodeCheckState = extractDeps(\n  extractDeallocateNodeCheckState\n);\n\n/**\n * Stateless action wrapper over updaters.\n * Represents the action of de-allocating a node.\n */\nexport class DeallocateNodeAction {\n  updaters: UpdaterGeneratorType2<GameState, GameState>;\n\n  constructor(updaters: UpdaterGeneratorType2<GameState, GameState>) {\n    this.updaters = updaters;\n  }\n\n  /**\n   * Unchecked\n   * Deallocates the node (updates save status).\n   * @param input\n   */\n  enqueueAction(input: DeallocateNodeInput) {\n    const { nodeLocation } = input;\n\n    this.updaters.enqueueUpdate((prev, prevGameState) => {\n      if (prevGameState.playerSave.currentEra.type === 'A') {\n        if (\n          prev.playerSave.bookmarkedStatusMap.get(nodeLocation)?.bookmarked ===\n          true\n        ) {\n          const bookmarkedStatusMap =\n            prev.playerSave.bookmarkedStatusMap.clone();\n          bookmarkedStatusMap.remove(nodeLocation);\n          const playerSave = { ...prev.playerSave, bookmarkedStatusMap };\n          return { ...prev, playerSave };\n        }\n        return prev;\n      } else if (prevGameState.playerSave.currentEra.type === 'B') {\n        let result: typeof prev | null = null;\n\n        // update allocation map to despect the node\n        if (\n          prev.playerSave.allocationStatusMap.get(nodeLocation)?.taken === true\n        ) {\n          const allocationStatusMap =\n            prev.playerSave.allocationStatusMap.clone();\n          allocationStatusMap.remove(nodeLocation);\n\n          // decrement remaining dealloc points\n          const deallocationPoints = {\n            ...prev.playerSave.deallocationPoints,\n          };\n          deallocationPoints.remaining -= 1;\n\n          const playerSave = {\n            ...prev.playerSave,\n            allocationStatusMap,\n            deallocationPoints,\n          };\n          result = result || { ...prev };\n          result = { ...result, playerSave };\n        }\n\n        // also need to un-flow reachable\n        let reachableStatusMap: typeof prev.computed.reachableStatusMap | null =\n          null;\n        // first look at all previously reachable neighbors which are not allocated\n        const reachableNeighbors = Object.values(\n          getCoordNeighbors(nodeLocation)\n        ).filter((it) => {\n          return (\n            prevGameState.computed.reachableStatusMap?.get(it)?.reachable ===\n              true &&\n            prevGameState.playerSave.allocationStatusMap?.get(it)?.taken !==\n              true\n          );\n        });\n\n        // unset reachable on nodes 2 away from the current one, if needed\n        reachableNeighbors.forEach((n) => {\n          // find out if they have any neighbors which are still allocated and are not the freshly deallocated node\n          const nsAllocatedNeighbors = Object.values(\n            getCoordNeighbors(n)\n          ).filter((it) => {\n            return (\n              prevGameState.playerSave.allocationStatusMap.get(it)?.taken ===\n                true && it.notEquals(nodeLocation)\n            );\n          });\n\n          // if no allocated neighbors, try to remove it\n          if (nsAllocatedNeighbors.length === 0) {\n            if (prev.computed.reachableStatusMap?.get(n)?.reachable === true) {\n              reachableStatusMap =\n                reachableStatusMap || prev.computed.reachableStatusMap.clone();\n              reachableStatusMap.remove(n);\n            }\n          }\n        });\n\n        if (reachableStatusMap) {\n          const computed = { ...prev.computed, reachableStatusMap };\n          result = result || { ...prev };\n          result = { ...result, computed };\n        }\n\n        return result || prev;\n      } else {\n        throw new EnumInvalidError();\n      }\n    });\n  }\n\n  /**\n   * Stateless function to provide a pre-flight check before actually performing the action.\n   *\n   * @param input\n   * @param gameState\n   * @returns true if the action can be taken based on the game state, false otherwise\n   */\n  static checkAction(\n    input: DeallocateNodeInput,\n    gameState: DeallocateNodeCheckState\n  ): DeallocateNodeResult {\n    const { nodeLocation } = input;\n    if (gameState.playerSave.currentEra.type === 'A') {\n      if (\n        gameState.playerSave.allocationStatusMap.get(input.nodeLocation)\n          ?.taken === true\n      ) {\n        console.log(\"can't do that, can't unbookmark a taken node\", input);\n        return false;\n      }\n      // we can only unmark an already marked node\n      const bookmarkedStatus =\n        gameState.playerSave.bookmarkedStatusMap.get(nodeLocation);\n      if (bookmarkedStatus?.bookmarked === true) {\n        return true;\n      } else {\n        console.log(\n          \"can't do that, can't unbookmark something if it's not bookmarked\"\n        );\n        return false;\n      }\n    } else if (gameState.playerSave.currentEra.type === 'B') {\n      // check against the # of respecs we have in inventory\n      if (gameState.playerSave.deallocationPoints.remaining <= 0) {\n        console.log(\"can't do that, out of deallocation points\");\n        return false;\n      }\n\n      // we can only deallocate if it's already allocated\n      const takenStatus =\n        gameState.playerSave.allocationStatusMap.get(nodeLocation);\n      if (takenStatus?.taken !== true) {\n        console.log(\n          \"can't do that, can't deallocate something if it's not allocated\"\n        );\n        return false;\n      }\n\n      // need to check that deallocating does not disconnect the graph allocation status graph\n      // TODO(bowei): cache this!! recomputing this all the time is hard\n      // find the taken nodes which are also adjacent to the node to be deallocated\n      const neighborNodes = Object.values(\n        getCoordNeighbors(nodeLocation)\n      ).filter((n) => {\n        return gameState.playerSave.allocationStatusMap.get(n)?.taken === true;\n      });\n      if (neighborNodes.length <= 1) {\n        // there's only 1 neighbor, so we're definitely OK\n        return true;\n      }\n\n      // start from one of them, and make sure we can BFS to the others\n      let start = neighborNodes[0];\n      let targets = new HashSet(neighborNodes.slice(1));\n\n      let touched = new HashSet<Vector3>();\n      let processing: Vector3[] = [start];\n\n      // touched.put(start);\n      while (processing.length > 0) {\n        const current = processing.shift();\n        if (!current) continue;\n        if (touched.get(current)) {\n          continue;\n        }\n        touched.put(current);\n\n        // check if we are done\n        targets.remove(current);\n        if (targets.size() === 0) {\n          // the graph is still connected, so we are done and deallocation would be successful\n          return true;\n        }\n\n        // find neighbors of current, but don't BFS through the node we're trying to deallocate\n        Object.values(getCoordNeighbors(current))\n          .filter((n) => {\n            return (\n              gameState.playerSave.allocationStatusMap.get(n)?.taken === true &&\n              n.notEquals(nodeLocation)\n            );\n          })\n          .forEach((it) => processing.push(it));\n      }\n\n      if (targets.size() > 0) {\n        console.log(\"can't do that, tree would be disconnected\");\n        return false;\n      }\n      return true;\n    } else {\n      throw new EnumInvalidError();\n    }\n  }\n\n  /**\n   * First checks to see if the action can be performed, then performs it and returns true if successful or false otherwise.\n   *\n   * @param input\n   * @param gameState\n   * @returns\n   */\n  run(\n    input: DeallocateNodeInput,\n    gameState: DeallocateNodeCheckState\n  ): DeallocateNodeResult {\n    const check = DeallocateNodeAction.checkAction(input, gameState);\n    if (check) {\n      this.enqueueAction(input);\n    }\n    return check;\n  }\n}\n","import React from 'react';\nimport {\n  LockStatus,\n  NodeAccessibleStatus,\n  NodeAllocatedStatus,\n  NodeBookmarkedStatus,\n  NodeVisibleStatus,\n} from '../../data/NodeStatus';\nimport { LockData } from '../../data/PlayerSaveState';\nimport { NodeContents } from '../../game/worldGen/nodeContents/NodeContentsFactory';\nimport {\n  AttributeSymbolMap,\n  ModifierSymbolMap,\n  nodeContentsConditionToString,\n  nodeContentsLineToString,\n} from '../../game/worldGen/nodeContents/NodeContentsRendering';\nimport { Vector3 } from '../../lib/util/geometry/vector3';\nimport { LazyHashMap } from '../../lib/util/lazy';\nimport { GameGridSubState } from './GameAreaGrid';\n\nexport type NodeReactData = {\n  // 3-4 character description that goes on the main board\n  shortText: React.ReactElement;\n  // 3-4 line description that gets displayed on hover\n  toolTipText: React.ReactElement;\n  // Extended description that shows up in sidebar\n  fullText: React.ReactElement;\n  lockData?: (LockData | undefined) & { status: LockStatus | undefined };\n  nodeContents: NodeContents;\n  status: NodeAllocatedStatus;\n  statuses: {\n    bookmarkedStatus: NodeBookmarkedStatus;\n    accessibleStatus: NodeAccessibleStatus;\n    fogOfWarStatus: NodeVisibleStatus;\n  };\n  nodeLocation: Vector3;\n  id: string;\n};\n\n// Text to display both in the tooltip and sidebar for node description.\n// Currently we only have a description for the starting node.\nexport const STARTING_NODE_DESCRIPTION = 'The starting node.';\n\n/**\n * Computes a hash map of vector2 virtual hex grid coordinates to\n * text & tooltip info about the node at those coordinates.\n */\nexport function computeNodeReactData(args: {\n  gameState: GameGridSubState;\n  location: Vector3;\n}): NodeReactData {\n  const { location } = args;\n  const {\n    fogOfWarStatusMap,\n    reachableStatusMap,\n    accessibleStatusMap,\n    // lockStatusMap,\n  } = args.gameState.computed;\n  const { allocationStatusMap, bookmarkedStatusMap, currentEra } =\n    args.gameState.playerSave;\n  const { lockMap, nodeContentsMap } = args.gameState.worldGen;\n\n  const fogOfWarStatus = fogOfWarStatusMap?.get(location) || 'obscured';\n  const reachableStatus = reachableStatusMap?.get(location);\n  const takenStatus = allocationStatusMap.get(location);\n  const bookmarkedStatus = bookmarkedStatusMap.get(location) || {\n    bookmarked: false,\n  };\n\n  const accessibleStatus = accessibleStatusMap?.get(location) || {\n    accessible: false,\n  };\n\n  const nodeStatus = takenStatus?.taken\n    ? NodeAllocatedStatus.TAKEN_OR_MARKED\n    : currentEra.type === 'A' && bookmarkedStatus?.bookmarked\n    ? NodeAllocatedStatus.TAKEN_OR_MARKED\n    : // TODO(bowei): what to show here if bookmarked in B era?\n    reachableStatus?.reachable\n    ? NodeAllocatedStatus.AVAILABLE\n    : fogOfWarStatus === 'revealed'\n    ? NodeAllocatedStatus.UNREACHABLE\n    : NodeAllocatedStatus.HIDDEN;\n  const id = location.hash();\n\n  const lockData = lockMap.get(location);\n  const lockStatus = args.gameState.computed.lockStatusMap?.get(location);\n  const isLocked = !!lockData && lockStatus !== LockStatus.OPEN;\n\n  const nodeContents = nodeContentsMap.get(location);\n  let shortText1 = '';\n  if (location.equals(Vector3.Zero)) {\n    // the origin node\n    shortText1 = '🚩';\n  } else if (nodeContents.lines[0]) {\n    shortText1 += ModifierSymbolMap[nodeContents.lines[0].modifier];\n    shortText1 += AttributeSymbolMap[nodeContents.lines[0].attribute];\n  } else {\n    // the origin node is empty\n    shortText1 = '';\n  }\n  if (\n    nodeContents.lines[1] &&\n    nodeContents.lines[0].attribute !== nodeContents.lines[1].attribute\n  ) {\n    // add another symbol if it's a mixed node\n    // TODO(bowei): make sure that node contents generation cannot mix modifiers!!\n    shortText1 += AttributeSymbolMap[nodeContents.lines[1].attribute];\n  }\n  let shortText2 = '';\n  if (nodeContents.condition) {\n    // SPENDing\n    shortText2 = '-' + AttributeSymbolMap[nodeContents.condition.attribute];\n  }\n\n  let tooltipHeader = <> {nodeStatus.toString()}</>;\n  if (isLocked) {\n    if (nodeStatus === NodeAllocatedStatus.AVAILABLE) {\n      tooltipHeader = (\n        <>\n          <div>{'LOCKED'}</div>\n          <br></br>\n          <div>{'Locks are currently WIP!'}</div>\n        </>\n      );\n    } else if (nodeStatus === NodeAllocatedStatus.UNREACHABLE) {\n      tooltipHeader = (\n        <>\n          <div>\n            {'LOCKED, '}\n            {nodeStatus.toString()}\n          </div>\n          <br></br>\n          <div>{'Locks are currently WIP!'}</div>\n        </>\n      );\n    }\n  } else if (nodeStatus === NodeAllocatedStatus.AVAILABLE) {\n    tooltipHeader = (\n      <>\n        <div>{nodeStatus.toString()}</div>\n        <br></br>\n        <div>Click to allocate.</div>\n      </>\n    );\n  } else if (location.equals(Vector3.Zero)) {\n    tooltipHeader = (\n      <>\n        <div>{nodeStatus.toString()}</div>\n        <br></br>\n        <div>{STARTING_NODE_DESCRIPTION}</div>\n      </>\n    );\n  }\n\n  let toolTipText = <div>{tooltipHeader}</div>;\n  if (nodeContents.lines.length && accessibleStatus.accessible) {\n    toolTipText = (\n      <>\n        <div>{tooltipHeader}</div>\n        <br />\n        {nodeContentsToDom(nodeContents)}\n      </>\n    );\n  }\n\n  const nodeData: NodeReactData = {\n    nodeLocation: location,\n    shortText: shortText2 ? (\n      <>\n        {shortText1}\n        <br />\n        {shortText2}\n      </>\n    ) : (\n      <>{shortText1}</>\n    ),\n    toolTipText,\n    nodeContents,\n    fullText: <> </>,\n    status: nodeStatus,\n    lockData: lockData\n      ? {\n          ...lockData,\n          status: lockStatus,\n        }\n      : undefined,\n    id,\n    statuses: {\n      bookmarkedStatus,\n      accessibleStatus,\n      fogOfWarStatus,\n    },\n  };\n  return nodeData;\n}\n\nexport function computeNodeReactDataMap(args: {\n  gameState: GameGridSubState;\n}): LazyHashMap<Vector3, NodeReactData> {\n  const map = new LazyHashMap<Vector3, NodeReactData>((location: Vector3) => {\n    return computeNodeReactData({ location, gameState: args.gameState });\n  });\n\n  return map;\n}\n\nexport function nodeContentsToDom(nodeContents: NodeContents) {\n  return (\n    <>\n      <div>\n        {nodeContents.lines[0] &&\n          nodeContentsLineToString(nodeContents.lines[0])}\n      </div>\n      <div>\n        {nodeContents.lines[1] &&\n          nodeContentsLineToString(nodeContents.lines[1])}\n      </div>\n      <div>\n        {nodeContents.condition &&\n          nodeContentsConditionToString(nodeContents.condition)}\n      </div>\n    </>\n  );\n}\n","import React, { useCallback, useMemo } from 'react';\nimport { GameState } from '../../../data/GameState';\nimport { LockStatus, NodeTakenStatus } from '../../../data/NodeStatus';\nimport {\n  AllocateNodeAction,\n  depsAllocateNodeCheckState,\n  extractAllocateNodeCheckState,\n} from '../../../game/actions/AllocateNode';\nimport {\n  DeallocateNodeAction,\n  depsDeallocateNodeCheckState,\n  extractDeallocateNodeCheckState,\n} from '../../../game/actions/DeallocateNode';\nimport { Vector2 } from '../../../lib/util/geometry/vector2';\nimport { Vector3 } from '../../../lib/util/geometry/vector3';\nimport { UpdaterGeneratorType2 } from '../../../lib/util/updaterGenerator';\nimport {\n  nodeContentsToDom,\n  STARTING_NODE_DESCRIPTION,\n} from '../../GameArea/computeVirtualNodeDataMap';\n\nexport const SelectedNodeTabContent = React.memo(\n  SelectedNodeTabContentComponent\n);\n\n// TODO(bowei): trim down the game state here\nfunction SelectedNodeTabContentComponent(props: {\n  gameState: GameState;\n  updaters: UpdaterGeneratorType2<GameState, GameState>;\n  actions: {\n    allocateNode: AllocateNodeAction;\n    deallocateNode: DeallocateNodeAction;\n  };\n}) {\n  const { gameState } = props;\n  const location = gameState.playerUI.cursoredNodeLocation;\n\n  // TODO(bowei): use custom hooks for onAllocate/canAllocate paradigm\n\n  const allocateNodeCheckState = useMemo(() => {\n    return extractAllocateNodeCheckState(gameState);\n    // TODO(bowei): use custom hook here so react doesnt complain so much\n    // eslint-disable-next-line\n  }, depsAllocateNodeCheckState(gameState));\n\n  const deallocateNodeCheckState = useMemo(() => {\n    return extractDeallocateNodeCheckState(gameState);\n    // TODO(bowei): use custom hook here so react doesnt complain so much\n    // eslint-disable-next-line\n  }, depsDeallocateNodeCheckState(gameState));\n\n  const onAllocate = useCallback(\n    (e: React.MouseEvent) => {\n      e.preventDefault();\n      if (location) {\n        props.actions.allocateNode.run(\n          {\n            nodeLocation: location,\n            newStatus: NodeTakenStatus.true,\n          },\n          allocateNodeCheckState\n        );\n      }\n    },\n    [props.actions.allocateNode, location, allocateNodeCheckState]\n  );\n\n  const canBeAllocated = useMemo(() => {\n    if (location) {\n      return AllocateNodeAction.checkAction(\n        { nodeLocation: location, newStatus: { taken: true } },\n        allocateNodeCheckState\n      );\n    }\n  }, [location, allocateNodeCheckState]);\n\n  const onDeallocate = useCallback(\n    (e: React.MouseEvent) => {\n      e.preventDefault();\n      if (location) {\n        props.actions.deallocateNode.run(\n          { nodeLocation: location },\n          deallocateNodeCheckState\n        );\n      }\n    },\n    [props.actions.deallocateNode, location, deallocateNodeCheckState]\n  );\n\n  const canBeDeallocated = useMemo(() => {\n    if (location) {\n      return DeallocateNodeAction.checkAction(\n        { nodeLocation: location },\n        deallocateNodeCheckState\n      );\n    }\n  }, [location, deallocateNodeCheckState]);\n\n  const onZoom = useCallback(\n    (e: React.MouseEvent) => {\n      e.preventDefault();\n      if (location) {\n        // set virtual grid location\n        props.updaters.playerUI.virtualGridLocation.enqueueUpdate((prev) => {\n          return location;\n        });\n\n        props.updaters.playerUI.triggerScrollRecenterCb.enqueueUpdate(() => {\n          return () => {\n            // this is not guaranteed to ever be called\n            console.log('zoomed to location: ', { location });\n          };\n        });\n      }\n    },\n    [props.updaters, location]\n  );\n\n  if (location === null) {\n    return (\n      <>\n        <div>Nothing selected!</div>\n        <div>\n          <br></br>\n        </div>\n        <div>Hover and click the</div>\n        <div> question mark tooltip to</div>\n        <div>select a node.</div>\n      </>\n    );\n  }\n  let xyCoords = new Vector2(\n    location.x - location.y / 2,\n    (location.y * Math.sqrt(3)) / 2\n  );\n  xyCoords = new Vector2(\n    Math.round(xyCoords.x * 100) / 100,\n    Math.round(xyCoords.y * 100) / 100\n  );\n\n  const takenStatus =\n    gameState.playerSave.allocationStatusMap?.get(location)?.taken || false;\n  const bookmarkedStatus =\n    gameState.playerSave.bookmarkedStatusMap?.get(location)?.bookmarked ||\n    false;\n  const exploredStatus =\n    gameState.playerSave.exploredStatusMap?.get(location)?.explored || false;\n  const reachableStatus =\n    gameState.computed.reachableStatusMap?.get(location)?.reachable || false;\n  const visibleStatus =\n    gameState.computed.fogOfWarStatusMap?.get(location) || 'obscured';\n  const accessibleStatus =\n    gameState.computed.accessibleStatusMap?.get(location)?.accessible || false;\n  const lockData = visibleStatus\n    ? gameState.worldGen.lockMap?.get(location) || null\n    : null;\n  const lockStatus = gameState.computed.lockStatusMap?.get(location) || null;\n  const isLocked = !!lockData && lockStatus !== LockStatus.OPEN;\n\n  let description = '';\n  if (location.equals(Vector3.Zero)) {\n    description = STARTING_NODE_DESCRIPTION;\n  } else if (!visibleStatus) {\n    description = 'Unknown.';\n  } else if (isLocked) {\n    description = 'A locked node.';\n  } else {\n    description = 'An allocatable node.';\n  }\n\n  const nodeContents =\n    visibleStatus === 'revealed'\n      ? gameState.worldGen.nodeContentsMap.get(location) || null\n      : null;\n  const nodeContentsDom = nodeContents?.lines[0]\n    ? nodeContentsToDom(nodeContents)\n    : 'empty';\n\n  return (\n    <>\n      <div className=\"tab-content-body\">\n        <div>\n          Location: ( {xyCoords.x} , {xyCoords.y} ) , z-layer = {location.z}\n        </div>\n        <br></br>\n        <div>\n          <button onClick={onZoom}>Recenter on here (hotkey: r, {'\\\\'})</button>\n        </div>\n        <br></br>\n        <div>Description: {description}</div>\n        <br></br>\n        <div>Taken?: {takenStatus.toString()}</div>\n        <div>Reachable?: {reachableStatus.toString()}</div>\n        <div>Visible?: {visibleStatus.toString()}</div>\n        <div>Bookmarked?: {bookmarkedStatus.toString()}</div>\n        <div>Explored?: {exploredStatus.toString()}</div>\n        <div>Accessible?: {accessibleStatus.toString()}</div>\n        {visibleStatus ? (\n          <>\n            <div>Locked?: {isLocked.toString()}</div>\n            <div>Can be allocated?: {(!!canBeAllocated).toString()}</div>\n            <br></br>\n            <div>Contents: {nodeContentsDom}</div>\n            <br></br>\n            <button disabled={!canBeAllocated} onClick={onAllocate}>\n              Allocate (hotkey: spacebar)\n            </button>\n            <button disabled={!canBeDeallocated} onClick={onDeallocate}>\n              Deallocate (hotkey: backspace)\n            </button>\n          </>\n        ) : (\n          <> </>\n        )}\n      </div>\n    </>\n  );\n}\n","import React, { useMemo, useState } from 'react';\nimport { GameState } from '../../../data/GameState';\nimport {\n  Attribute,\n  Modifier,\n} from '../../../game/worldGen/nodeContents/NodeContentsFactory';\nimport {\n  AttributeDescriptionMap,\n  AttributeSymbolMap,\n} from '../../../game/worldGen/nodeContents/NodeContentsRendering';\nimport {\n  enumAssociateBy,\n  enumMapValues,\n  extractDeps,\n} from '../../../lib/util/misc';\nimport { UpdaterGeneratorType2 } from '../../../lib/util/updaterGenerator';\n\nexport function StatsTab(props: {\n  gameState: GameState;\n  updaters: UpdaterGeneratorType2<GameState, GameState>;\n}) {\n  const gameState = useMemo(() => {\n    return extractStatsSubState(props.gameState);\n    // TODO(bowei): use custom hook here so react doesnt complain so much\n    // eslint-disable-next-line\n  }, depsStatsSubState(props.gameState));\n\n  return <StatsTabHelper gameState={gameState} updaters={props.updaters} />;\n}\n\n/**\n * The subset of the game state that is relevant to game area components.\n */\nexport function extractStatsSubState(g: StatsSubState) {\n  return _extract(g as GameState);\n}\n\nexport function _extract(gameState: GameState) {\n  return {\n    playerSave: {\n      allocationStatusMap: gameState.playerSave.allocationStatusMap,\n      bookmarkedStatusMap: gameState.playerSave.bookmarkedStatusMap,\n      currentEra: gameState.playerSave.currentEra,\n    },\n    worldGen: {\n      nodeContentsMap: gameState.worldGen.nodeContentsMap,\n    },\n  };\n}\nexport type StatsSubState = ReturnType<typeof _extract>;\nexport const depsStatsSubState = extractDeps(extractStatsSubState);\n\nconst StatsTabHelper = React.memo(StatsTabComponent);\n// TODO(bowei): trim down the game state here\nfunction StatsTabComponent(props: {\n  gameState: StatsSubState;\n  updaters: UpdaterGeneratorType2<GameState, GameState>;\n}) {\n  const { gameState } = props;\n\n  const [isOpen, setOpen] = useState(false);\n\n  const attributeInfos = enumMapValues(\n    computeAttributeModifierStats({ gameState }),\n    ({ modifiers, total }, attribute) => {\n      const desc = AttributeDescriptionMap[attribute];\n      const symbol = AttributeSymbolMap[attribute];\n      return (\n        <>\n          <details className=\"details\" open={isOpen}>\n            <summary>\n              {' '}\n              {symbol} ({desc}):\n            </summary>\n            <div className=\"details-body\">\n              <div>+: {modifiers[Modifier.FLAT]}</div>\n              <div>%: {modifiers[Modifier.INCREASED]}</div>\n              <div className=\"final-total\">Total: {total}</div>\n            </div>\n          </details>\n        </>\n      );\n    }\n  );\n\n  return (\n    <>\n      <div>Current stats</div>\n      <br></br>\n      <div>\n        <button\n          onClick={() => {\n            setOpen(true);\n          }}\n        >\n          Open all\n        </button>{' '}\n        <button\n          onClick={() => {\n            setOpen(false);\n          }}\n        >\n          Close all\n        </button>\n      </div>\n      <br></br>\n      <div className=\"tab-content-body\">\n        {attributeInfos[Attribute.RED0]}\n        {attributeInfos[Attribute.RED1]}\n        {attributeInfos[Attribute.RED2]}\n        {attributeInfos[Attribute.DEL0]}\n        {attributeInfos[Attribute.DEL1]}\n        {attributeInfos[Attribute.DEL2]}\n      </div>\n    </>\n  );\n}\n\nexport function computeAttributeModifierStats(args: {\n  gameState: StatsSubState;\n}) {\n  const { gameState } = args;\n\n  const attributeInfos = enumAssociateBy(Attribute, (attribute) => {\n    // const modifiers: {[k in keyof typeof Modifier]: number} = fromEnumEntries(\n    const modifiers = enumAssociateBy(Modifier, (modifier) => {\n      // find all allocated && bookmarked nodes\n      let nodes = gameState.playerSave.allocationStatusMap\n        .entries()\n        .filter(([location, status]) => {\n          return status.taken === true;\n        })\n        .map((it) => it[0]);\n\n      if (gameState.playerSave.currentEra.type === 'A') {\n        nodes = nodes.concat(\n          gameState.playerSave.bookmarkedStatusMap\n            .entries()\n            .filter(([location, status]) => {\n              return status.bookmarked === true;\n            })\n            .map((it) => it[0])\n        );\n      }\n\n      const amount = nodes\n        .map((location) => {\n          // look for nodes with attribute\n          const nodeContents = gameState.worldGen.nodeContentsMap.get(location);\n          if (\n            nodeContents.lines[0]?.attribute === attribute &&\n            nodeContents.lines[0]?.modifier === modifier\n          ) {\n            return nodeContents.lines[0].amount;\n          } else if (\n            nodeContents.lines[1]?.attribute === attribute &&\n            nodeContents.lines[1]?.modifier === modifier\n          ) {\n            return nodeContents.lines[1].amount;\n          } else {\n            return 0;\n          }\n        })\n        .reduce((pv, cv) => pv + cv);\n\n      return [modifier, amount];\n    });\n\n    const total = Math.round(\n      modifiers[Modifier.FLAT] * (1 + 0.01 * modifiers[Modifier.INCREASED])\n    );\n    return [attribute, { modifiers, total }];\n  });\n\n  return attributeInfos;\n}\n","import React from 'react';\n\nexport function HelpTab() {\n  return (\n    <>\n      <div>How to play the game</div>\n      <br></br>\n      <div className=\"tab-content-body\">\n        <div>CONTROLS</div>\n        <br></br>\n        <CheckboxDiv>Use hotkey: t, y to open and close the tabs.</CheckboxDiv>\n        <CheckboxDiv>Use hotkey: b to toggle strategic view.</CheckboxDiv>\n        <CheckboxDiv>\n          Move the tabs around using \"send left/right\" buttons.\n        </CheckboxDiv>\n        <CheckboxDiv>Open the Stats tab.</CheckboxDiv>\n        <CheckboxDiv>Open the Quests tab.</CheckboxDiv>\n        <br></br>\n        <div>GAME</div>\n        <br></br>\n        <CheckboxDiv>Hover over some nodes.</CheckboxDiv>\n        <CheckboxDiv>\n          Left click on an available node to allocate it.\n        </CheckboxDiv>\n        <CheckboxDiv>\n          Left click on any other node to view detailed info.\n        </CheckboxDiv>\n        <CheckboxDiv>\n          Scroll around to see what other nodes are visible.\n        </CheckboxDiv>\n        <CheckboxDiv>\n          Use keyboard controls (hotkeys: ijklmun) to move around the map, and\n          (hotkeys: wasd) to pan around.\n        </CheckboxDiv>\n        <CheckboxDiv>\n          Click (hotkey: r, \\) to recenter the view on your selected node.\n        </CheckboxDiv>\n        <CheckboxDiv>Close the selected node tab.</CheckboxDiv>\n        <br></br>\n        <div>STRATEGIC VIEW</div>\n        <br></br>\n        <CheckboxDiv>\n          Open the strategic view tab while strategic view is open.\n        </CheckboxDiv>\n        <CheckboxDiv>Toggle colors.</CheckboxDiv>\n        <CheckboxDiv>\n          Try adding an attribute to the search bar by clicking a symbol.\n        </CheckboxDiv>\n        <CheckboxDiv>Click search to highlight those attributes.</CheckboxDiv>\n        <CheckboxDiv>Click cancel to reset the search.</CheckboxDiv>\n      </div>\n    </>\n  );\n}\n\nfunction CheckboxDiv(props: { children: any }) {\n  return (\n    <div>\n      <input type=\"checkbox\" /> {props.children}\n    </div>\n  );\n}\n","import React, { useMemo } from 'react';\nimport { GameState } from '../../../data/GameState';\nimport { Attribute } from '../../../game/worldGen/nodeContents/NodeContentsFactory';\nimport {\n  AttributesSorted,\n  AttributeSymbolMap,\n} from '../../../game/worldGen/nodeContents/NodeContentsRendering';\nimport {\n  computeAttributeModifierStats,\n  depsStatsSubState,\n  extractStatsSubState,\n  StatsSubState,\n} from './StatsTab';\n\nexport function QuestsTab(props: { gameState: GameState }) {\n  const gameState = useMemo(() => {\n    return extractStatsSubState(props.gameState);\n    // TODO(bowei): use custom hook here so react doesnt complain so much\n    // eslint-disable-next-line\n  }, depsStatsSubState(props.gameState));\n\n  return <QuestsTabHelper gameState={gameState} />;\n}\n\nconst QuestsTabHelper = React.memo(QuestsTabComponent);\n\nfunction QuestsTabComponent(props: { gameState: StatsSubState }) {\n  const attributeStats = computeAttributeModifierStats({\n    gameState: props.gameState,\n  });\n\n  // find max attribute and its value\n  let maxAttribute!: Attribute;\n  let maxValue!: number;\n  AttributesSorted.map((attribute) => {\n    return { attribute, stats: attributeStats[attribute] };\n  }).forEach(({ attribute, stats }) => {\n    const { total } = stats;\n    if (maxValue === undefined || total > maxValue) {\n      maxAttribute = attribute;\n      maxValue = total;\n    }\n  });\n\n  // find second largest\n  let secondMaxAttribute!: Attribute;\n  let secondMaxValue!: number;\n  AttributesSorted.map((attribute) => {\n    return { attribute, stats: attributeStats[attribute] };\n  }).forEach(({ attribute, stats }) => {\n    const { total } = stats;\n    if (attribute === maxAttribute) return;\n    if (secondMaxValue === undefined || total > secondMaxValue) {\n      secondMaxAttribute = attribute;\n      secondMaxValue = total;\n    }\n  });\n\n  const questCompleted = maxValue >= 1000 && secondMaxValue >= 400;\n\n  return (\n    <>\n      <div>Quests info</div>\n      <br></br>\n      <div className=\"tab-content-body\">\n        <div>Ultimate goal:</div>\n        <ol>\n          <li>\n            <div>1000 of any attribute:</div>\n            <br></br>\n            <div>\n              Progress: <meter value={maxValue} min={0} max={1000}></meter>{' '}\n              {maxValue + ' ' + AttributeSymbolMap[maxAttribute] + ' / 1000'}\n            </div>\n            <br></br>\n          </li>\n          <li>\n            <div>400 of any other attribute:</div>\n            <br></br>\n            <div>\n              Progress: <meter value={secondMaxValue} min={0} max={400}></meter>{' '}\n              {secondMaxValue +\n                ' ' +\n                AttributeSymbolMap[secondMaxAttribute] +\n                ' / 400'}\n            </div>\n            <br></br>\n            {questCompleted ? <div>YOU WIN!!!</div> : false}\n          </li>\n        </ol>\n        <div>Other goals: WIP</div>\n      </div>\n    </>\n  );\n}\n","import React from 'react';\nimport './TabContent.css';\nimport { GameState } from '../../data/GameState';\nimport { UpdaterGeneratorType2 } from '../../lib/util/updaterGenerator';\nimport { DebugTabContent } from './Tabs/DebugTab';\nimport { StrategicTab } from './Tabs/StrategicTab';\nimport { SelectedNodeTabContent } from './Tabs/SelectedNodeTab';\nimport { AllocateNodeAction } from '../../game/actions/AllocateNode';\nimport { StatsTab } from './Tabs/StatsTab';\nimport { HelpTab } from './Tabs/HelpTab';\nimport { QuestsTab } from './Tabs/QuestsTab';\nimport { DeallocateNodeAction } from '../../game/actions/DeallocateNode';\n\nexport enum TAB_NAME {\n  EMPTY = 'EMPTY',\n  SELECTED_NODE = 'SELECTED_NODE',\n  STATS = 'STATS',\n  QUESTS = 'QUESTS',\n  DEBUG = 'DEBUG',\n  HELP = 'HELP',\n  STRATEGIC_VIEW = 'STRATEGIC_VIEW',\n}\n\n// in charge of constructing content. no css\nexport function TabContentInterface(props: {\n  tabName: TAB_NAME;\n  gameState: GameState;\n  updaters: UpdaterGeneratorType2<GameState, GameState>;\n  actions: {\n    allocateNode: AllocateNodeAction;\n    deallocateNode: DeallocateNodeAction;\n  };\n}) {\n  const { tabName } = props;\n\n  const tabComponents = {\n    [TAB_NAME.EMPTY]: <EmptyTabContent />,\n    [TAB_NAME.SELECTED_NODE]: (\n      <SelectedNodeTabContent\n        gameState={props.gameState}\n        updaters={props.updaters}\n        actions={props.actions}\n      />\n    ),\n    [TAB_NAME.STATS]: (\n      <StatsTab gameState={props.gameState} updaters={props.updaters} />\n    ),\n    [TAB_NAME.QUESTS]: <QuestsTab gameState={props.gameState} />,\n    [TAB_NAME.STRATEGIC_VIEW]: (\n      <StrategicTab gameState={props.gameState} updaters={props.updaters} />\n    ),\n    [TAB_NAME.DEBUG]: (\n      <DebugTabContent\n        gameState={props.gameState}\n        updaters={props.updaters}\n        hidden={tabName !== TAB_NAME.DEBUG}\n      />\n    ),\n    [TAB_NAME.HELP]: <HelpTab />,\n  };\n\n  return <TabContentSelector tabComponents={tabComponents} tabName={tabName} />;\n}\n\n// layout & switch statement. pure. no knowledge of game state\nfunction TabContentSelector(props: {\n  tabComponents: { [k in TAB_NAME]: React.ReactNode };\n  tabName: TAB_NAME;\n}) {\n  const selectedTabName = props.tabName;\n  const tabNames = Object.keys(TAB_NAME) as TAB_NAME[];\n\n  return (\n    <>\n      {tabNames.map((tabName) => {\n        return (\n          <div key={tabName} hidden={tabName !== selectedTabName}>\n            {props.tabComponents[tabName]!}\n          </div>\n        );\n      })}\n    </>\n  );\n}\n\n/**\n * Tabs\n */\nexport const EmptyTabContent = React.memo(EmptyTabContentComponent);\nfunction EmptyTabContentComponent(props: {}) {\n  console.log('got here empty tab content');\n  return <div>Nothing here!</div>;\n}\n","import { TAB_NAME } from '../components/Sidebars/TabContentInterface';\nimport { Vector2 } from '../lib/util/geometry/vector2';\nimport { Vector3 } from '../lib/util/geometry/vector3';\n\nexport const initialTabLabels: { [k in 'left' | 'right']: TAB_NAME[] } = {\n  left: [TAB_NAME.HELP],\n  right: [\n    TAB_NAME.SELECTED_NODE,\n    TAB_NAME.STATS,\n    TAB_NAME.QUESTS,\n    TAB_NAME.DEBUG,\n    TAB_NAME.STRATEGIC_VIEW,\n  ],\n};\n\nexport type PlayerUIState = {\n  /**\n   * Determines if pixi (i.e. strategic view) is hidden or not.\n   */\n  isPixiHidden: boolean;\n  /**\n   * Determines where in the universe the user has scrolled to.\n   */\n  virtualGridLocation: Vector3;\n  /**\n   * Which, if any, node is highlighted with a selection cursor\n   */\n  cursoredNodeLocation: Vector3 | null;\n  /**\n   * state of the sidebar component\n   */\n  isSidebarOpen: boolean;\n  isLeftSidebarOpen: boolean;\n  isRightSidebarOpen: boolean;\n  /**\n   * whether or not the cursor is captured by a text entry element. if so, we need to allow default behavior on keyboard events\n   */\n  isTextBoxFocused: boolean;\n  /**\n   * change this state in order to trigger a useeffect which causes scroll to recenter. this function is not guaranteed to be ever be called\n   */\n  triggerScrollRecenterCb: () => void;\n\n  /**\n   * Tab controls.\n   */\n  tabs: {\n    left: {\n      tabs: TAB_NAME[];\n      activeIndex: number;\n    };\n    right: {\n      tabs: TAB_NAME[];\n      activeIndex: number;\n    };\n  };\n\n  strategicSearch: StrategicSearchState;\n\n  // WIP?\n  virtualApproximateScroll?: Vector2;\n  strategicGridLocation?: Vector3;\n};\n\nexport type StrategicSearchState = {\n  colors: {\n    enabled: 'Yes' | 'Only unallocated' | 'No';\n  };\n  highlight1: {\n    value: string;\n  };\n};\n\nexport const newPlayerUIState = (): PlayerUIState => {\n  return {\n    triggerScrollRecenterCb: () => {},\n    tabs: {\n      left: {\n        tabs: initialTabLabels['left'],\n        activeIndex: 0,\n      },\n      right: {\n        tabs: initialTabLabels['right'],\n        activeIndex: 0,\n      },\n    },\n    strategicSearch: {\n      colors: {\n        enabled: 'Only unallocated',\n      },\n      highlight1: {\n        value: '',\n      },\n    },\n    isPixiHidden: true,\n    virtualGridLocation: Vector3.Zero,\n    cursoredNodeLocation: null,\n    isSidebarOpen: false,\n    isLeftSidebarOpen: true,\n    isRightSidebarOpen: false,\n    isTextBoxFocused: false,\n  };\n};\n\nconst serializeToObject = (s: PlayerUIState): object => {\n  return {\n    ...s,\n    triggerScrollRecenterCb: undefined,\n    virtualGridLocation: Vector3.SerializeToObject(s.virtualGridLocation),\n  };\n};\n\nconst serialize = (s: PlayerUIState) => JSON.stringify(serializeToObject(s));\n\nconst deserializeFromObject = (obj: any): PlayerUIState | null => {\n  if (\n    !obj ||\n    !obj.hasOwnProperty('isPixiHidden') ||\n    !obj.hasOwnProperty('virtualGridLocation') ||\n    !obj.hasOwnProperty('cursoredNodeLocation') ||\n    !obj.hasOwnProperty('isSidebarOpen') ||\n    !obj.hasOwnProperty('isLeftSidebarOpen') ||\n    !obj.hasOwnProperty('isRightSidebarOpen') ||\n    !obj.hasOwnProperty('isTextBoxFocused') ||\n    !obj.hasOwnProperty('tabs') ||\n    !obj.hasOwnProperty('strategicSearch')\n  ) {\n    console.error('Failed deserializing PlayerUIState: ', obj);\n    return null;\n  }\n  const { strategicSearch } = obj;\n  if (\n    !strategicSearch ||\n    !strategicSearch.hasOwnProperty('colors') ||\n    !strategicSearch.hasOwnProperty('highlight1')\n  ) {\n    console.error('Failed deserializing PlayerUIState: ', obj);\n    return null;\n  }\n\n  const virtualGridLocation = Vector3.Deserialize(obj.virtualGridLocation);\n  if (!virtualGridLocation) {\n    console.error('Failed deserializing PlayerUIState: ', obj);\n    return null;\n  }\n  const cursoredNodeLocation = Vector3.Deserialize(obj.cursoredNodeLocation);\n\n  return {\n    ...(obj as PlayerUIState),\n    virtualGridLocation,\n    cursoredNodeLocation,\n    triggerScrollRecenterCb: () => {},\n  };\n};\n\nconst deserialize = (obj: string) => deserializeFromObject(JSON.parse(obj));\n\nconst storageKey = 'PlayerUIState';\n\n/**\n * Tries to load from local storage and falls back to creating a new object if unsuccessful.\n * see: https://gist.github.com/muzfr7/7e15582add46e74dee111002ec6cf594\n * http://vaughnroyko.com/idbonbeforeunload/\n * https://discourse.mozilla.org/t/saving-to-localstorage-on-window-close/35627/7\n * https://developer.mozilla.org/en-US/docs/Web/API/WindowEventHandlers/onbeforeunload\n * https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage\n */\nconst tryLoad = (): PlayerUIState => {\n  const loaded = load();\n  if (loaded) {\n    return loaded;\n  } else {\n    console.log('Failed to load PlayerUIState');\n    return newPlayerUIState();\n  }\n};\n\nconst load = (): PlayerUIState | null => {\n  const data = window.localStorage.getItem(storageKey);\n  const loaded = (data && deserialize(data)) || null;\n  return loaded;\n};\n\nconst store = (s: PlayerUIState) => {\n  const data = serialize(s);\n  window.localStorage.setItem(storageKey, data);\n};\n\nconst clear = () => {\n  window.localStorage.setItem(storageKey, '');\n};\n\n// eslint-disable-next-line\nexport const PlayerUIState = {\n  new: newPlayerUIState,\n  serialize,\n  deserialize,\n  tryLoad,\n  load,\n  store,\n  clear,\n};\n","import React, { useCallback, useEffect } from 'react';\nimport { GameState } from '../data/GameState';\nimport { PlayerUIState } from '../data/PlayerUIState';\nimport { WorldGenStateFactory } from '../game/worldGen/WorldGenStateFactory';\nimport { newPlayerIntentState } from '../data/PlayerIntentState';\nimport { newDebugState } from '../data/DebugState';\nimport { newWindowState } from '../data/WindowState';\nimport { PlayerSaveState } from '../data/PlayerSaveState';\nimport { loadComputed, DEFAULT_SEED } from '../game/GameStateFactory';\n\nexport function PersistenceComponent(props: { gameState: GameState }) {\n  const { gameState } = props;\n\n  // save the game\n  const onUnload = useCallback(() => {\n    if (gameState.justDisabledSave) {\n      console.log('skipping save because it was just disabled!');\n    } else {\n      PlayerUIState.store(gameState.playerUI);\n      PlayerSaveState.store(gameState.playerSave);\n      new WorldGenStateFactory({}).store(gameState.worldGen);\n    }\n    // return 'onunload'; // adds a console prompt\n  }, [\n    gameState.playerUI,\n    gameState.justDisabledSave,\n    gameState.worldGen,\n    gameState.playerSave,\n  ]);\n\n  useEffect(() => {\n    if (gameState.intent.newIntent.HARD_REFRESH_PAGE) {\n      PlayerUIState.clear();\n      new WorldGenStateFactory({}).clear();\n      PlayerSaveState.clear();\n\n      // TODO(bowei): actually force hard reload here???\n      window.location.reload();\n    }\n  }, [gameState.intent.newIntent.HARD_REFRESH_PAGE]);\n\n  // NOTE(bowei): window.addEventListener does not work here i think: https://stackoverflow.com/questions/24081699/why-onbeforeunload-event-is-not-firing\n  // https://gist.github.com/muzfr7/7e15582add46e74dee111002ec6cf594\n  useEffect(() => {\n    window.onbeforeunload = onUnload;\n    return () => {\n      window.onbeforeunload = null;\n    };\n  });\n\n  return <> </>;\n}\n\n/**\n * Tries to read out game state info from localstorage. if not present, creates a new state\n */\nexport function loadOrCreate(\n  seed: number | undefined | null = undefined\n): GameState {\n  const mySeed = seed || DEFAULT_SEED;\n\n  const worldGenStateFactory = new WorldGenStateFactory({});\n  const gameState: GameState = {\n    tick: 0,\n    worldGen: worldGenStateFactory.tryLoad({ seed: mySeed }),\n    playerSave: PlayerSaveState.tryLoad(),\n    playerUI: PlayerUIState.tryLoad(),\n    computed: {\n      lockStatusMap: null,\n      fogOfWarStatusMap: null,\n      reachableStatusMap: null,\n      accessibleStatusMap: null,\n    },\n    intent: newPlayerIntentState(),\n    windowState: newWindowState(),\n    debug: newDebugState(),\n    justDisabledSave: false,\n  };\n\n  loadComputed(gameState);\n\n  return gameState;\n}\n","import { Vector2 } from '../lib/util/geometry/vector2';\n\nexport type DebugState = {\n  retriggerVirtualGridDims: () => void;\n  debugShowScrollbars: boolean; // default false\n  rerenderGameAreaGrid: () => void;\n  enableScrollJump: boolean; // default true\n  getForceJumpOffset: () => Vector2 | void;\n  getOffsetX: () => number | void;\n  isFlipCursored: () => boolean | void;\n};\n\nexport const newDebugState = (): DebugState => {\n  return {\n    retriggerVirtualGridDims: () => {},\n    debugShowScrollbars: false,\n    rerenderGameAreaGrid: () => {},\n    enableScrollJump: true,\n    getForceJumpOffset: () => {},\n    getOffsetX: () => {},\n    isFlipCursored: () => {},\n  };\n};\n","import { GameState } from '../data/GameState';\nimport {\n  LockStatus,\n  NodeAccessibleStatus,\n  NodeReachableStatus,\n  NodeVisibleStatus,\n} from '../data/NodeStatus';\nimport { newPlayerIntentState } from '../data/PlayerIntentState';\nimport { newWindowState } from '../data/WindowState';\nimport { newPlayerSaveState } from '../data/PlayerSaveState';\nimport { HashMap } from '../lib/util/data_structures/hash';\nimport { Vector3 } from '../lib/util/geometry/vector3';\nimport { getWithinDistance, IReadonlySet } from './lib/HexGrid';\nimport { WorldGenStateFactory } from './worldGen/WorldGenStateFactory';\nimport {\n  ERA_ACCESSIBLE_RADII,\n  FOG_OF_WAR_DISTANCE,\n} from './actions/AllocateNode';\nimport { newDebugState } from '../data/DebugState';\nimport { PlayerUIState } from '../data/PlayerUIState';\nimport { loadOrCreate } from '../components/PersistenceComponent';\nimport { Const } from '../lib/util/misc';\n\nexport type GameStateConfig = any;\n\nexport const DEFAULT_SEED = 0x19283;\n\nexport class GameStateFactory {\n  public config: GameStateConfig;\n\n  constructor(config: GameStateConfig) {\n    this.config = config;\n  }\n\n  /**\n   * Tries to read out game state info from localstorage. if not present, creates a new state\n   */\n  public loadOrCreate(seed: number | undefined | null = undefined): GameState {\n    return loadOrCreate(seed);\n  }\n\n  public create(seed: number | undefined | null = undefined): GameState {\n    if (seed === undefined) {\n      // assertOnlyCalledOnce(\"GameStateFactory.create\");\n    }\n    const mySeed = seed || DEFAULT_SEED;\n\n    const worldGenStateFactory = new WorldGenStateFactory({});\n    const gameState: GameState = {\n      tick: 0,\n      worldGen: worldGenStateFactory.create({ seed: mySeed }),\n      playerSave: newPlayerSaveState(),\n      playerUI: PlayerUIState.new(),\n      computed: {\n        lockStatusMap: null,\n        fogOfWarStatusMap: null,\n        reachableStatusMap: null,\n        accessibleStatusMap: null,\n      },\n      intent: newPlayerIntentState(),\n      windowState: newWindowState(),\n      debug: newDebugState(),\n      justDisabledSave: false,\n    };\n\n    loadComputed(gameState);\n\n    return gameState;\n  }\n}\n\n/**\n * computes the computed portion of game state from a freshly created or loaded game state and inserts it into the provided obj\n * @param gameState\n */\nexport function loadComputed(gameState: GameState): GameState {\n  gameState.computed.lockStatusMap = new HashMap();\n  gameState.computed.fogOfWarStatusMap = new HashMap();\n  gameState.computed.reachableStatusMap = new HashMap();\n  gameState.computed.accessibleStatusMap = new HashMap();\n\n  /**\n   * Initialize fog of war and visible locks\n   */\n\n  // optionally, first precompute the nearby lock worldgen parameters\n  // getWithinDistance(Vector3.Zero, FOG_OF_WAR_DISTANCE).forEach((n) => {\n  //   gameState.worldGen.lockMap.precompute(n);\n  // });\n\n  // fill in lock statuses with computed statuses\n  gameState.computed.lockStatusMap = markLockStatus(\n    gameState.computed.lockStatusMap,\n    gameState\n  );\n\n  // accessible and visible computation makes use of lock information\n  gameState.computed.accessibleStatusMap = markAccessibleNodes({\n    result: gameState.computed.accessibleStatusMap,\n    prev: gameState.computed.accessibleStatusMap,\n    prevGameState: gameState,\n  });\n\n  gameState.computed.fogOfWarStatusMap = markVisibleNodes(\n    gameState.computed.fogOfWarStatusMap,\n    gameState\n  );\n\n  // reachable depends on visible\n  gameState.computed.reachableStatusMap = markReachableNodes(\n    gameState.computed.reachableStatusMap,\n    gameState\n  );\n\n  return gameState;\n}\n\nexport function markLockStatus(\n  prev: Const<HashMap<Vector3, LockStatus | undefined>> | null,\n  prevGameState: Const<GameState>\n): HashMap<Vector3, LockStatus | undefined> | null {\n  if (!prev) {\n    return prev;\n  }\n\n  let result: HashMap<Vector3, LockStatus | undefined> | null = null;\n\n  for (let [location, lockData] of prevGameState.worldGen.lockMap.entries()) {\n    if (lockData) {\n      // TODO(bowei): compute lock status\n      const newStatus = LockStatus.TICKING;\n\n      if (prev.get(location) !== newStatus) {\n        result = result || prev.clone();\n        result.put(location, newStatus);\n      }\n    }\n  }\n\n  return result || (prev as unknown as typeof result);\n}\n\n/**\n * Updates accessible computed map based on distance from the starting node.\n * @param result mutable temporary storage. null if the state is intended to be the same as prev\n * @param prev the initial state. immutable\n * @param prevGameState immutable\n * @returns the same object reference as result;\n * will be null iff null was passed in as [result], AND no further changes were necessary for the update\n * (i.e. we want to return prev)\n * if null was passed in as [result], but we DID want to make changes, this function returns a clone of [prev] with changes added on top.\n */\nexport function markAccessibleNodes(args: {\n  result: HashMap<Vector3, NodeAccessibleStatus> | null;\n  prev: Const<HashMap<Vector3, NodeAccessibleStatus>>;\n  prevGameState: Const<GameState>;\n}): HashMap<Vector3, NodeAccessibleStatus> | null {\n  const { prev, prevGameState } = args;\n  let { result } = args;\n  // if (!prev) {\n  //   return prev;\n  // }\n\n  // let result: typeof prev | null = null;\n\n  // make sure we make use of lock state\n  const validLocks: IReadonlySet<Vector3> = {\n    // TODO(bowei): optimize this?\n    contains: (v: Vector3) => {\n      const lockData = prevGameState.worldGen.lockMap.get(v);\n      const lockStatus = prevGameState.computed.lockStatusMap?.get(v);\n      const isLocked = !!lockData && lockStatus !== LockStatus.OPEN;\n      if (isLocked) {\n        return true;\n      }\n      return false;\n    },\n  };\n\n  getWithinDistance(\n    Vector3.Zero,\n    ERA_ACCESSIBLE_RADII[prevGameState.playerSave.currentEra.index],\n    0,\n    validLocks\n  ).forEach((n) => {\n    if (prev.get(n)?.accessible !== true) {\n      result = result || prev.clone();\n      result.put(n, { accessible: true });\n    }\n  });\n\n  return result;\n}\n\nexport function markReachableNodes(\n  prev: HashMap<Vector3, NodeReachableStatus> | null,\n  prevGameState: Const<GameState>\n): HashMap<Vector3, NodeReachableStatus> | null {\n  if (!prev) {\n    return prev;\n  }\n\n  let result: typeof prev | null = null;\n\n  prevGameState.playerSave.allocationStatusMap\n    .entries()\n    .filter(([location, status]) => {\n      return status.taken === true;\n    })\n    .map((it) => it[0])\n    .forEach((nodeLocation) => {\n      result = flowReachableFromNode({\n        result,\n        prev,\n        prevGameState,\n        nodeLocation,\n      });\n    });\n\n  return result || prev;\n}\n\n/**\n *\n * @param result mutable temporary storage. null if the state is intended to be the same as prev\n * @param prev the initial state of reachable status map at the beginning of the update process. immutable\n * @param prevGameState\n * @param nodeLocation which node to flow reachability from\n * @returns the same object reference as result;\n * will be null iff null was passed in as [result], AND no further changes were necessary for the update\n * (i.e. we want to return prev)\n * if null was passed in as [result], but we DID want to make changes, this function returns a clone of [prev] with changes added on top.\n */\nexport function flowReachableFromNode(args: {\n  result: HashMap<Vector3, NodeReachableStatus> | null;\n  prev: Const<HashMap<Vector3, NodeReachableStatus>>;\n  prevGameState: Const<GameState>;\n  nodeLocation: Vector3;\n}): HashMap<Vector3, NodeReachableStatus> | null {\n  const { prev, prevGameState, nodeLocation } = args;\n  let { result } = args;\n\n  getWithinDistance(nodeLocation, 1).forEach((n) => {\n    if (\n      // prevGameState.computed.accessibleStatusMap?.get(n)?.accessible !== true\n      prevGameState.computed.fogOfWarStatusMap?.get(n) !== 'revealed'\n    ) {\n      return;\n    }\n    if (prev.get(n)?.reachable !== true) {\n      result = result || prev.clone();\n      result.put(n, NodeReachableStatus.true);\n    }\n  });\n\n  return result;\n}\n\nexport function markVisibleNodes(\n  prev: HashMap<Vector3, NodeVisibleStatus> | null,\n  prevGameState: Const<GameState>\n): HashMap<Vector3, NodeVisibleStatus> | null {\n  if (!prev) {\n    return prev;\n  }\n\n  let result: typeof prev | null = null;\n\n  let nodes: Vector3[] = [];\n\n  if (prevGameState.playerSave.currentEra.type === 'A') {\n    nodes = nodes.concat(\n      prevGameState.playerSave.allocationStatusMap\n        .entries()\n        .filter(([location, status]) => {\n          return status.taken === true;\n        })\n        .map((it) => it[0])\n    );\n  }\n\n  nodes = nodes.concat(\n    prevGameState.playerSave.exploredStatusMap\n      .entries()\n      .filter(([location, status]) => {\n        return status.explored === true;\n      })\n      .map((it) => it[0])\n  );\n\n  nodes.forEach((nodeLocation) => {\n    result = flowFogOfWarFromNode({\n      result,\n      prev: result || prev,\n      prevGameState,\n      nodeLocation,\n    });\n  });\n\n  return result || prev;\n}\n\n/**\n *\n * @param result mutable temporary storage. null if the state is intended to be the same as prev\n * @param prev the initial state of fog of war status map at the beginning of the update process. immutable\n * @param prevGameState\n * @param nodeLocation which node to flow fog of war from\n * @returns the same object reference as result;\n * will be null iff null was passed in as [result], AND no further changes were necessary for the update\n * (i.e. we want to return prev)\n * if null was passed in as [result], but we DID want to make changes, this function returns a clone of [prev] with changes added on top.\n */\nexport function flowFogOfWarFromNode(args: {\n  result: HashMap<Vector3, NodeVisibleStatus> | null;\n  prev: Const<HashMap<Vector3, NodeVisibleStatus>>;\n  prevGameState: Const<GameState>;\n  nodeLocation: Vector3;\n}): HashMap<Vector3, NodeVisibleStatus> | null {\n  const { prev, prevGameState, nodeLocation } = args;\n  let { result } = args;\n\n  if ((result || prev).get(nodeLocation) !== 'revealed') {\n    result = result || prev.clone(); // clone if we haven't already\n    result.put(nodeLocation, 'revealed');\n  }\n\n  // make sure locks within distance 1 are set to visible\n  getWithinDistance(nodeLocation, 1).forEach((n) => {\n    if (\n      prevGameState.computed.accessibleStatusMap?.get(n)?.accessible !== true\n    ) {\n      return;\n    }\n    if ((result || prev).get(n) !== 'revealed') {\n      result = result || prev.clone();\n      result.put(n, 'revealed');\n    }\n  });\n\n  // make sure we make use of lock state\n  const validLocks: IReadonlySet<Vector3> = {\n    // TODO(bowei): optimize this?\n    contains: (v: Vector3) => {\n      const lockData = prevGameState.worldGen.lockMap.get(v);\n      const lockStatus = prevGameState.computed.lockStatusMap?.get(v);\n      const isLocked = !!lockData && lockStatus !== LockStatus.OPEN;\n      const isAccessible =\n        !!prevGameState.computed.accessibleStatusMap?.get(v)?.accessible;\n      if (isLocked || !isAccessible) {\n        return true;\n      }\n      return false;\n    },\n  };\n\n  // flow fog of war, keeping in mind validLocks and accessibility restrictions\n  getWithinDistance(nodeLocation, FOG_OF_WAR_DISTANCE, 0, validLocks).forEach(\n    (n) => {\n      if (\n        prevGameState.computed.accessibleStatusMap?.get(n)?.accessible !== true\n      ) {\n        return;\n      }\n\n      if (((result || prev).get(n) || 'obscured') !== 'revealed') {\n        result = result || prev.clone();\n        result.put(n, 'revealed');\n      }\n    }\n  );\n\n  // convert obscured nodes just outside fog of war to hinted, but only if they are accessible\n  // if they are locked, instead convert them to revealed -- feels bad if hinted things get revealed to be locks\n  getWithinDistance(\n    nodeLocation,\n    FOG_OF_WAR_DISTANCE + 1,\n    FOG_OF_WAR_DISTANCE + 1,\n    validLocks\n  ).forEach((n) => {\n    if (\n      prevGameState.computed.accessibleStatusMap?.get(n)?.accessible !== true\n    ) {\n      return;\n    }\n\n    if (validLocks.contains(n)) {\n      if (((result || prev).get(n) || 'obscured') !== 'revealed') {\n        result = result || prev.clone();\n        result.put(n, 'revealed');\n      }\n      return;\n    }\n\n    if (((result || prev).get(n) || 'obscured') === 'obscured') {\n      result = result || prev.clone();\n      result.put(n, 'hinted');\n    }\n  });\n\n  return result;\n}\n","import { GameState } from '../../data/GameState';\nimport { NodeTakenStatus } from '../../data/NodeStatus';\nimport { Vector3 } from '../../lib/util/geometry/vector3';\nimport { extractDeps } from '../../lib/util/misc';\nimport { UpdaterGeneratorType2 } from '../../lib/util/updaterGenerator';\nimport {\n  flowFogOfWarFromNode,\n  flowReachableFromNode,\n  markLockStatus,\n} from '../GameStateFactory';\n\nexport interface AllocateNodeInput {\n  nodeLocation: Vector3;\n  newStatus: NodeTakenStatus;\n}\n\nfunction _extract(gameState: GameState) {\n  return {\n    playerSave: {\n      allocationStatusMap: gameState.playerSave.allocationStatusMap,\n      bookmarkedStatusMap: gameState.playerSave.bookmarkedStatusMap,\n      currentEra: gameState.playerSave.currentEra,\n    },\n    computed: {\n      reachableStatusMap: gameState.computed.reachableStatusMap,\n      fogOfWarStatusMap: gameState.computed.fogOfWarStatusMap,\n      accessibleStatusMap: gameState.computed.accessibleStatusMap,\n    },\n    worldGen: {\n      lockMap: gameState.worldGen.lockMap,\n    },\n  };\n}\n\nexport function extractAllocateNodeCheckState(g: AllocateNodeCheckState) {\n  return _extract(g as GameState);\n}\n\nexport type AllocateNodeCheckState = ReturnType<typeof _extract>;\nexport const depsAllocateNodeCheckState = extractDeps(\n  extractAllocateNodeCheckState\n);\n\nexport type AllocateNodeResult = boolean;\n\n// TODO(bowei): unhardcode\n// The sight radius\nexport const FOG_OF_WAR_DISTANCE = Infinity;\n\n/**\n * Stateless action wrapper over updaters.\n * Represents the action of allocating a node.\n */\nexport class AllocateNodeAction {\n  updaters: UpdaterGeneratorType2<GameState, GameState>;\n\n  constructor(updaters: UpdaterGeneratorType2<GameState, GameState>) {\n    this.updaters = updaters;\n  }\n\n  /**\n   * Unchecked\n   * Allocates the node (updates save status) and recomputes related fog of war statuses.\n   * @param input\n   */\n  enqueueAction(input: AllocateNodeInput) {\n    const { nodeLocation } = input;\n\n    // TODO(bowei): dont forget to update statsTab to compute off of saved as well as taken\n    this.updaters.playerSave.allocationStatusMap.enqueueUpdate(\n      (prev, prevGameState) => {\n        if (prevGameState.playerSave.currentEra.type === 'B') {\n          if (prev.get(nodeLocation)?.taken !== true) {\n            const result = prev.clone();\n            result.put(nodeLocation, { taken: true });\n            return result;\n          }\n          return prev;\n        } else {\n          return prev;\n        }\n      }\n    );\n\n    // before updating Fog of war, first unlock any lock whose statuses have changed\n    this.updaters.computed.lockStatusMap?.enqueueUpdate(\n      (prev, prevGameState) => {\n        if (prevGameState.playerSave.currentEra.type === 'B') {\n          return markLockStatus(prev, prevGameState);\n        } else {\n          return prev;\n        }\n      }\n    );\n\n    // only bother to flow reachable status if we are in era B\n    this.updaters.computed.reachableStatusMap?.enqueueUpdate(\n      (prev, prevGameState) => {\n        if (prevGameState.playerSave.currentEra.type === 'B') {\n          if (!prev) {\n            return prev;\n          }\n\n          return (\n            flowReachableFromNode({\n              result: null,\n              prev,\n              prevGameState,\n              nodeLocation,\n            }) || prev\n          );\n        } else {\n          return prev;\n        }\n      }\n    );\n\n    // TODO(bowei): dont forget to update statsTab to compute off of saved as well as taken\n    this.updaters.playerSave.bookmarkedStatusMap.enqueueUpdate(\n      (prev, prevGameState) => {\n        if (prevGameState.playerSave.currentEra.type === 'A') {\n          const prevBookmarked = !!prev.get(nodeLocation)?.bookmarked;\n          const result = prev.clone();\n          if (prevBookmarked) {\n            result.remove(nodeLocation);\n            return result;\n          } else {\n            result.put(nodeLocation, { bookmarked: true });\n            return result;\n          }\n        } else {\n          return prev;\n        }\n      }\n    );\n\n    this.updaters.playerSave.exploredStatusMap.enqueueUpdate(\n      (prev, prevGameState) => {\n        if (prevGameState.playerSave.currentEra.type === 'A') {\n          if (prev.get(nodeLocation)?.explored !== true) {\n            const result = prev.clone();\n            result.put(nodeLocation, { explored: true });\n            return result;\n          }\n          return prev;\n        } else {\n          return prev;\n        }\n      }\n    );\n\n    this.updaters.computed.fogOfWarStatusMap?.enqueueUpdate(\n      (prev, prevGameState) => {\n        if (prevGameState.playerSave.currentEra.type === 'A') {\n          if (!prev) {\n            return prev;\n          }\n\n          // optimization: don't clone [prev] immediately, only clone if any changes need to be made\n          return (\n            flowFogOfWarFromNode({\n              result: null,\n              prev,\n              prevGameState,\n              nodeLocation,\n            }) || prev\n          );\n        } else {\n          return prev;\n        }\n      }\n    );\n  }\n\n  /**\n   * Stateless function to provide a pre-flight check before actually performing the action.\n   *\n   * @param input\n   * @param gameState\n   * @returns true if the action can be taken based on the game state, false otherwise\n   */\n  static checkAction(\n    input: AllocateNodeInput,\n    gameState: AllocateNodeCheckState\n  ): AllocateNodeResult {\n    if (gameState.playerSave.currentEra.type === 'B') {\n      if (!input.newStatus.taken) {\n        console.log('unsupported action: ', input);\n        return false;\n      }\n    } else if (gameState.playerSave.currentEra.type === 'A') {\n      // TODO(bowei): saved & explored?\n      if (!input.newStatus.taken) {\n        console.log('unsupported action: ', input);\n        return false;\n      }\n    }\n\n    if (\n      gameState.playerSave.currentEra.type === 'B' &&\n      gameState.playerSave.allocationStatusMap.get(input.nodeLocation)\n        ?.taken === true\n    ) {\n      console.log(\"can't do that, already taken\", input);\n      return false;\n    }\n\n    if (\n      gameState.playerSave.currentEra.type === 'A' &&\n      gameState.playerSave.allocationStatusMap.get(input.nodeLocation)\n        ?.taken === true\n    ) {\n      console.log(\n        \"can't do that, can't bookmark or unbookmark a taken node\",\n        input\n      );\n      return false;\n    }\n\n    if (!!gameState.worldGen.lockMap.get(input.nodeLocation)) {\n      console.log(\"can't do that, is locked\", input);\n      return false;\n    }\n\n    if (\n      gameState.computed.fogOfWarStatusMap?.get(input.nodeLocation) !==\n      'revealed'\n    ) {\n      console.log(\"can't do that, is not visible\", input);\n      return false;\n    }\n\n    if (\n      gameState.computed.accessibleStatusMap?.get(input.nodeLocation)\n        ?.accessible !== true\n    ) {\n      console.log(\"can't do that, is not accessible\", input);\n      return false;\n    }\n\n    // only check for reachability in era *B\n    if (gameState.playerSave.currentEra.type === 'B') {\n      if (\n        gameState.computed.reachableStatusMap?.get(input.nodeLocation)\n          ?.reachable !== true\n      ) {\n        console.log(\"can't do that, is not reachable\", input);\n        return false;\n      }\n    }\n\n    if (\n      (gameState.playerSave.currentEra.type === 'B' &&\n        gameState.playerSave.allocationStatusMap.size() >=\n          ERA_SP_LIMITS[gameState.playerSave.currentEra.index]) ||\n      (gameState.playerSave.currentEra.type === 'A' &&\n        gameState.playerSave.bookmarkedStatusMap.size() >=\n          ERA_SP_LIMITS[gameState.playerSave.currentEra.index] &&\n        gameState.playerSave.bookmarkedStatusMap.get(input.nodeLocation)\n          ?.bookmarked !== true)\n    ) {\n      console.log(\"can't do that, no available SP right now\");\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * First checks to see if the action can be performed, then performs it and returns true if successful or false otherwise.\n   *\n   * @param input\n   * @param gameState\n   * @returns\n   */\n  run(\n    input: AllocateNodeInput,\n    gameState: AllocateNodeCheckState\n  ): AllocateNodeResult {\n    const check = AllocateNodeAction.checkAction(input, gameState);\n    if (check) {\n      this.enqueueAction(input);\n    }\n    return check;\n  }\n}\n\n// sp limits for each additional era; cumulative and includes the first initial node\nexport const ERA_SP_LIMITS: { [x: number]: number } = {\n  [-1]: 1,\n  0: 11,\n  1: 31,\n  2: 61,\n  3: 91,\n  4: 121,\n};\n\n// era radius at each era; not cumulative\nexport const ERA_ACCESSIBLE_RADII: { [x: number]: number } = {\n  0: 4,\n  1: 15,\n  2: 35,\n  3: 55,\n  4: 75,\n};\n\n// how many deallocation actions. cumulative\nexport const ERA_DEALLOCATION_POINTS: { [x: number]: number } = {\n  0: 10,\n  1: 12,\n  2: 18,\n  3: 28,\n  4: 38,\n};\n","import { Vector2 } from '../../lib/util/geometry/vector2';\nimport React, { useEffect } from 'react';\nimport { colorToCss } from '../../pixi/colors';\n\nexport const CssVariablesComponent = React.memo(Component);\n\n/**\n * Handles loading display settings from props into css variables.\n * component is empty in the DOM - can be embedded anywhere in react hierarchy\n */\nfunction Component(props: {\n  appSize: Vector2;\n  hexGridPx: Vector2;\n  borderWidth: number;\n  hexCenterRadius: number;\n  COLORS: any;\n  children?: any;\n}) {\n  const { hexGridPx, borderWidth, hexCenterRadius, appSize, COLORS } = props;\n  useEffect(() => {\n    document.documentElement.style.setProperty(\n      '--grid-width',\n      ` ${hexGridPx.x}px`\n    );\n    document.documentElement.style.setProperty(\n      '--grid-height',\n      ` ${hexGridPx.y}px`\n    );\n    document.documentElement.style.setProperty(\n      '--hex-center-radius',\n      ` ${hexCenterRadius}px`\n    );\n    document.documentElement.style.setProperty(\n      '--border-width',\n      ` ${borderWidth}px`\n    );\n  }, [hexGridPx, hexCenterRadius, borderWidth]);\n  useEffect(() => {\n    document.documentElement.style.setProperty(\n      '--background-black',\n      colorToCss(COLORS.backgroundBlue)\n    );\n    document.documentElement.style.setProperty(\n      '--deemphasized-black',\n      colorToCss(COLORS.grayBlack)\n    );\n    document.documentElement.style.setProperty(\n      '--active-purple',\n      colorToCss(COLORS.nodePink)\n    );\n    document.documentElement.style.setProperty(\n      '--border-unimportant-black',\n      colorToCss(COLORS.borderBlack)\n    );\n    document.documentElement.style.setProperty(\n      '--border-important-white',\n      colorToCss(COLORS.borderWhite)\n    );\n    document.documentElement.style.setProperty(\n      '--text-readable-white',\n      colorToCss(COLORS.textWhite)\n    );\n  }, [COLORS]);\n  useEffect(() => {\n    document.documentElement.style.setProperty(\n      '--app-size-width',\n      ` ${appSize.x}px`\n    );\n    document.documentElement.style.setProperty(\n      '--app-size-height',\n      ` ${appSize.y}px`\n    );\n  }, [appSize]);\n\n  return <>{props.children}</>;\n}\n","import './GameAreaCell.css';\nimport './GameArea.css';\n\nimport classnames from 'classnames';\nimport React, { useCallback, useState } from 'react';\nimport { NodeReactData } from './computeVirtualNodeDataMap';\nimport { NodeAllocatedStatus, NodeTakenStatus } from '../../data/NodeStatus';\nimport { Vector3 } from '../../lib/util/geometry/vector3';\nimport { AllocateNodeResult } from '../../game/actions/AllocateNode';\nimport { EraType } from '../../data/PlayerSaveState';\n\n/**\n * Smart wrapper for the Cell (rectangular component of a hex grid).\n *\n * Handles sending the click event upstream to cause a status update.\n * @param idx x-coord of this cell in its row of hex cells\n * @param rowIdx y-coord of this row of hex cells\n * @param onUpdateStatus callback for updating the status of this cell\n * @param nodeData react fragments to help render this cell\n * @param isCursored whether or not to display a flashing cursor for this cell\n * @param onUpdateCursored callback, should be called with the cell virtual position to select that cell, or undefined to unselect the currently selected cell\n */\nexport const GameAreaCell = React.memo(GameAreaCellComponent);\nfunction GameAreaCellComponent({\n  id,\n  currentEra,\n  onUpdateStatus,\n  nodeData,\n  isCursored,\n  onUpdateCursored,\n  debugIsCursored,\n}: {\n  id: string;\n  currentEra: EraType;\n  onUpdateStatus: (args: {\n    nodeLocation: Vector3;\n    newStatus: NodeTakenStatus;\n    action: 'allocate' | 'deallocate';\n  }) => AllocateNodeResult;\n  nodeData: NodeReactData;\n  isCursored: boolean;\n  onUpdateCursored: (v: Vector3 | null) => void;\n  debugIsCursored: boolean;\n}) {\n  // const startTime = +new Date();\n  // console.log(`GameAreaCell key ${id} rerendered at ${startTime}`);\n  const { nodeLocation } = nodeData;\n\n  const handleClick = useCallback(\n    (e: React.MouseEvent) => {\n      // TODO(bowei): debounce this so double-clicks dont double trigger this\n\n      e.stopPropagation();\n      e.preventDefault();\n      // console.log(`clicked`);\n      // console.log({ idx, rowIdx, status: nodeData.status });\n      const updateStatusResult = onUpdateStatus({\n        nodeLocation,\n        newStatus: { taken: true },\n        action: 'allocate',\n      });\n      if (!updateStatusResult) {\n        onUpdateCursored(isCursored ? null : nodeLocation);\n      }\n    },\n    [onUpdateStatus, nodeLocation, isCursored, onUpdateCursored]\n  );\n\n  const handleClickQuestionMark = useCallback(\n    (e: React.MouseEvent) => {\n      e.stopPropagation();\n      e.preventDefault();\n      // TODO(bowei): use nodeData.id here instead of (idx, rowIdx), so that onUpdateStatus callback doesn't ever have to be recreated in the parent statemanager\n      onUpdateCursored(isCursored ? null : nodeLocation);\n    },\n    [isCursored, onUpdateCursored, nodeLocation]\n  );\n\n  return (\n    <Cell\n      key={id}\n      currentEra={currentEra}\n      id={id}\n      onClickCenter={handleClick}\n      nodeData={nodeData}\n      onClickQuestionMark={handleClickQuestionMark}\n      isCursored={isCursored}\n      // debugIsCursored={debugIsCursored}\n    ></Cell>\n  );\n}\n\n/**\n * Renderes a single rectangular component of a hex grid.\n * Contains a central node, hover-over tooltips attached to the node, and optionally 2 rectangular text boxes\n * that represent the locked state.\n *\n * @param onClickCenter callback to fire when the node itself (as opposed to the region around it) is clicked.\n * @param onClickQuestionMark callback to fire when the question mark tooltip icon is clicked.\n */\nconst Cell = React.memo(CellComponent);\nfunction CellComponent({\n  id,\n  currentEra,\n  onClickCenter,\n  onClickQuestionMark,\n  nodeData,\n  isCursored,\n  debugIsCursored,\n}: {\n  id: string;\n  currentEra: EraType;\n  onClickCenter: React.MouseEventHandler;\n  onClickQuestionMark: React.MouseEventHandler;\n  nodeData: NodeReactData;\n  isCursored: boolean;\n  debugIsCursored?: boolean;\n}) {\n  // const startTime = +new Date();\n  // console.log(`GameAreaCellComponent key: ${id} rerendered at ${startTime}`);\n\n  const status = nodeData.status;\n  const isLocked = !!nodeData.lockData;\n  const accessibleButHidden =\n    currentEra.type === 'A' &&\n    nodeData.statuses.accessibleStatus.accessible &&\n    nodeData.statuses.fogOfWarStatus === 'hinted';\n  const completelyHidden =\n    status === NodeAllocatedStatus.HIDDEN && !accessibleButHidden;\n\n  const [hovered, setHovered] = useState(false);\n\n  const onHover = (e: React.PointerEvent) => {\n    console.log(`got pointer enter on ${id}`);\n    setHovered(true);\n  };\n  const onUnhover = (e: React.PointerEvent) => {\n    console.log(`got pointer leave on ${id}`);\n    setHovered(false);\n  };\n\n  return (\n    <div className=\"hex-block hex-full-block\" key={id} id={id}>\n      <div\n        className={classnames(\n          'hex-center',\n          status === NodeAllocatedStatus.TAKEN_OR_MARKED\n            ? 'node-allocated'\n            : 'node-unallocated',\n          status === NodeAllocatedStatus.AVAILABLE && currentEra.type === 'B'\n            ? 'border-important'\n            : 'border-unimportant',\n          status === NodeAllocatedStatus.AVAILABLE && currentEra.type === 'B'\n            ? 'node-available'\n            : '',\n          nodeData.statuses.bookmarkedStatus.bookmarked ? 'marked-square' : '',\n          accessibleButHidden\n            ? 'hex-center-size-small'\n            : 'hex-center-size-medium'\n        )}\n        onClick={onClickCenter}\n        onDoubleClick={() => {\n          console.log('double clicked');\n        }}\n        onPointerEnter={onHover}\n        onPointerLeave={onUnhover}\n        hidden={completelyHidden}\n      >\n        <div\n          className={classnames(\n            'hex-center-text-wrapper',\n            accessibleButHidden\n              ? 'hex-center-size-small'\n              : 'hex-center-size-medium'\n          )}\n        >\n          <div className=\"tiny-text\" hidden={accessibleButHidden}>\n            {nodeData.shortText}\n          </div>\n        </div>\n      </div>\n      {isLocked ? (\n        <div\n          className=\"hex-center-lock\"\n          hidden={status === NodeAllocatedStatus.HIDDEN}\n          onClick={onClickCenter}\n          onDoubleClick={() => {\n            console.log('double clicked');\n          }}\n          onPointerEnter={onHover}\n          onPointerLeave={onUnhover}\n        >\n          <div className=\"hex-center-lock-left\">\n            <div className=\"tiny-text\">\n              {nodeData.lockData?.shortTextTarget}\n            </div>\n          </div>\n          <div className=\"hex-center-lock-right\">\n            <div className=\"tiny-text\">{nodeData.lockData?.shortTextTimer}</div>\n          </div>\n        </div>\n      ) : null}\n      <div className=\"empty-positioned node-tooltip-wrapper\">\n        <div\n          // className=\"hover-only absolute-positioned node-tooltip\" // temp disabling this, the css is causing perf issues\n          className=\"absolute-positioned node-tooltip\"\n          hidden={!hovered}\n        >\n          {nodeData.toolTipText}\n        </div>\n      </div>\n      <div className=\"empty-positioned\">\n        <div className=\"hover-only-2 absolute-positioned\">\n          <div\n            className=\"question\"\n            hidden={completelyHidden}\n            onClick={onClickQuestionMark}\n          >\n            ?\n          </div>\n        </div>\n      </div>\n      <div className=\"empty-positioned selection-cursor-wrapper\">\n        <div\n          className=\"absolute-positioned selection-cursor\"\n          // hidden={!debugIsCursored}\n          hidden={!isCursored}\n        ></div>\n      </div>\n    </div>\n  );\n}\n","import './GameAreaGrid.css';\nimport './GameArea.css';\n\nimport React, { useMemo } from 'react';\nimport { Vector2 } from '../../lib/util/geometry/vector2';\nimport { Vector3 } from '../../lib/util/geometry/vector3';\nimport {\n  computeNodeReactData,\n  NodeReactData,\n} from './computeVirtualNodeDataMap';\nimport { GameAreaCell } from './GameAreaCell';\nimport { NodeTakenStatus } from '../../data/NodeStatus';\nimport { LazyHashMap } from '../../lib/util/lazy';\nimport { extractDeps } from '../../lib/util/misc';\nimport { AllocateNodeResult } from '../../game/actions/AllocateNode';\nimport { GameState } from '../../data/GameState';\n\n/**\n * The subset of the game state that is relevant to game area components.\n */\nexport function extractGameGridSubState(g: GameGridSubState) {\n  return _extract(g as GameState);\n}\n\nfunction _extract(gameState: GameState) {\n  return {\n    playerUI: {\n      cursoredNodeLocation: gameState.playerUI.cursoredNodeLocation,\n    },\n    playerSave: {\n      allocationStatusMap: gameState.playerSave.allocationStatusMap,\n      bookmarkedStatusMap: gameState.playerSave.bookmarkedStatusMap,\n      currentEra: gameState.playerSave.currentEra,\n    },\n    worldGen: {\n      nodeContentsMap: gameState.worldGen.nodeContentsMap,\n      lockMap: gameState.worldGen.lockMap,\n    },\n    computed: {\n      fogOfWarStatusMap: gameState.computed.fogOfWarStatusMap,\n      reachableStatusMap: gameState.computed.reachableStatusMap,\n      lockStatusMap: gameState.computed.lockStatusMap,\n      accessibleStatusMap: gameState.computed.accessibleStatusMap,\n    },\n  };\n}\nexport type GameGridSubState = ReturnType<typeof _extract>;\nexport const depsGameGridSubState = extractDeps(extractGameGridSubState);\n\nexport const GameAreaGrid = React.memo(Component);\n/**\n * Dumb-ish component that manages the game board where the skill tree is located\n * , as well as the \"virtual\"\n * game space which is larger than the currently visible scrollable area the player can see.\n *\n * @param virtualGridDims the integer dimensions of the virtual scrollable space, measured in grid units. integer vector.\n * @param virtualCoordsToLocation utility stateless function to convert from ui virtual grid coords (ints) to 3d node location in game state (ints)\n * @param virtualNodeDataMap table of ui grid corods to object containing react fragments for contents of that node\n * @param updateNodeStatusCb callback for when a node is allocated and the node status needs to change. need to provide the virtual grid coords of the node to be allocated, and the new status.\n * @param cursoredVirtualNode 2d virtual dims of the node which is currently cursored (flashing and may show up in sidebar), or undefined if there is none\n * @param setCursoredVirtualNode callback which takes virtual 2d coords and causes that node to now be cursored, or undefined to clear cursor\n */\nfunction Component(props: {\n  gameState: GameGridSubState;\n  virtualGridDims: Vector2;\n  virtualCoordsToLocation: (v: Vector2) => Vector3;\n  updateNodeStatusByLocationCb: (args: {\n    nodeLocation: Vector3;\n    newStatus: NodeTakenStatus;\n    action: 'allocate' | 'deallocate';\n  }) => AllocateNodeResult;\n  cursoredVirtualNode: Vector2 | null;\n  setCursoredLocation: (v: Vector3 | null) => void;\n  debug?: any;\n}) {\n  const {\n    gameState,\n    virtualGridDims,\n    virtualCoordsToLocation,\n    updateNodeStatusByLocationCb,\n    cursoredVirtualNode,\n    setCursoredLocation,\n    debug,\n  } = props;\n  const startTime = +new Date();\n\n  debug?.rerenderGameAreaGrid();\n  // const debugOffsetX = (debug?.getOffsetX?.() || 0) % 8;\n  const flipCursored = debug?.isFlipCursored?.() || false;\n  // console.log('Game area grid rerender');\n\n  const nodeReactDataMap = useMemo(\n    () =>\n      new LazyHashMap<Vector3, NodeReactData>((location: Vector3) =>\n        computeNodeReactData({ location, gameState })\n      ),\n    [gameState]\n  );\n\n  /**\n   * See pointer/mouse, over/enter/out/leave, event propagation documentation\n   * https://www.w3schools.com/jquery/tryit.asp?filename=tryjquery_event_mouseenter_mouseover#:~:text=mouseenter%20and%20mouseover.-,The%20mouseover%20event%20triggers%20when%20the%20mouse%20pointer%20enters%20the,moved%20over%20the%20div%20element.\n   * https://stackoverflow.com/questions/4697758/prevent-onmouseout-when-hovering-child-element-of-the-parent-absolute-div-withou\n   * https://developer.mozilla.org/en-US/docs/Web/API/Pointer_events\n   * https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model/Examples#example_5_event_propagation\n   * https://developer.mozilla.org/en-US/docs/Web/API/Event/stopPropagation\n   * https://developer.mozilla.org/en-US/docs/Web/API/Event/target\n   * https://developer.mozilla.org/en-US/docs/Web/API/Event/currentTarget\n   * https://stackoverflow.com/questions/55546973/react-onmouseenter-event-triggering-on-child-element\n   * https://developer.mozilla.org/en-US/docs/Web/API/Touch_events\n   */\n  const result = (\n    <>\n      {Array(virtualGridDims.y)\n        .fill(0)\n        .map((_, y) => (\n          <Row\n            key={virtualCoordsToLocation(new Vector2(0, y)).y.toString()} // important to force react to hang on to the old row\n            // key={y} // stupid, for debug\n            rowIdx={y}\n          >\n            {\n              Array(virtualGridDims.x)\n                .fill(0)\n                .map((_, x) => {\n                  const virtualCoords = new Vector2(x, y);\n                  const location = virtualCoordsToLocation(virtualCoords);\n                  const nodeData = nodeReactDataMap.get(location);\n                  let isCursored =\n                    !!cursoredVirtualNode &&\n                    cursoredVirtualNode.equals(virtualCoords);\n                  // if (flipCursored) {\n                  //   isCursored = !isCursored;\n                  // }\n                  const key = nodeData.id || `loading${x}`;\n                  // console.log(`key should be ${key} from ${nodeData.toString()}`);\n                  return (\n                    <GameAreaCell\n                      // key={nodeData.id}\n                      key={key}\n                      id={key}\n                      currentEra={gameState.playerSave.currentEra}\n                      // key={x.toString() + \",\" + y.toString()} // stupid debug??\n                      // key={x} // debug??\n                      nodeData={nodeData}\n                      onUpdateStatus={updateNodeStatusByLocationCb}\n                      isCursored={isCursored}\n                      debugIsCursored={flipCursored ? !isCursored : isCursored}\n                      onUpdateCursored={setCursoredLocation}\n                    />\n                  );\n                })\n              // .slice(debugOffsetX, virtualGridDims.x - 8 + debugOffsetX)\n            }\n          </Row>\n        ))}\n    </>\n  );\n  const now = +new Date();\n  const elapsed = now - startTime;\n  console.log(`Game area grid elapsed ${elapsed}ms at ${now}`);\n  return result;\n}\n\nconst Row = React.memo(RowComponent);\nfunction RowComponent({\n  rowIdx,\n  children,\n}: {\n  rowIdx: number;\n  children?: React.ReactNode;\n}) {\n  const odd = !!(rowIdx % 2);\n\n  // If the row number is odd, prepend a half-block to the row contents of hex blocks\n  // Else, if the row number is even, append a half-block\n  return (\n    <div className=\"hex-block-row\">\n      {odd && <div className=\"hex-block hex-half-block\" />}\n      {children}\n      {!odd && <div className=\"hex-block hex-half-block\" />}\n    </div>\n  );\n}\n","import './GameAreaGrid.css';\nimport './GameArea.css';\n\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\nimport classnames from 'classnames';\nimport { Vector2 } from '../../lib/util/geometry/vector2';\nimport { Vector3 } from '../../lib/util/geometry/vector3';\nimport { UpdaterGeneratorType2 } from '../../lib/util/updaterGenerator';\nimport { GameState } from '../../data/GameState';\nimport { getVirtualGridCenterPx } from './locationUtils';\n\nconst SCROLL_INTERVAL_MS = 8; // polling interval - how often to check keyboard scroll state. recommended 60 FPS == 16ms or faster.\nconst SCROLL_VELOCITY = 0.75; // pixels per ms. independent of interval_ms tick rate\n\ntype Props = {\n  hidden: boolean;\n  appSize: Vector2;\n  hexGridPx: Vector2; // the size of a single grid unit, in px\n  virtualGridDims: Vector2; // in grid units. width x height, guaranteed to be integers\n  children?: any;\n  debug?: any;\n  triggerScrollRecenterCb: () => void;\n  updaters: UpdaterGeneratorType2<GameState, GameState>; // TODO(bowei): remove this\n  keyboardScrollDirection: Vector2;\n};\n\nexport const InfiniteScrollManager = React.memo(Component);\n/**\n * Manages the scroll state.\n * @param hidden true to disappear this entire component and all its children.\n * @param appSize size of the scrollable viewport\n * @param hexGridPx size of a single grid unit, in px. needs to be a good ratio if we want an actual hex grid\n * @param virtualGridDims integer vector for # of grid cells in each dimension\n * @param children any react subcomponents. Note that updating children causes this component to update as well - react memo is sensitive to it\n * @param debug TODO(bowei): contains triggers (extracted out of gameState.playerUI) for debugging the scroll jump and the virtual position rerender, SEPARATELY\n * @param keyboardScrollDirection unit-ish vector indicating player using keyboard controls to scroll (we disabled native browser keyboard scrolling)\n */\nfunction Component(props: Props) {\n  const {\n    hexGridPx,\n    virtualGridDims,\n    appSize,\n    updaters,\n    triggerScrollRecenterCb,\n    keyboardScrollDirection,\n    debug,\n  } = props;\n  // console.log('infinite scroll manager rerender');\n\n  const container = useRef<HTMLDivElement>(null);\n\n  const [jumpOffset, setJumpOffset] = useState(new Vector2(0, 0));\n\n  // Set initial position in the center, exactly once!\n  // useEffect(() => {\n  //   if (\n  //     container.current != null &&\n  //     container.current !== previousContainer.current\n  //   ) {\n  //     // TODO(bowei): figure out where the actual center is, so we can center the screen on the starting node perfectly\n  //     const center = getVirtualGridCenterPx({ virtualGridDims, hexGridPx });\n  //     container.current.scrollTop = center.y - appSize.y / 2;\n  //     container.current.scrollLeft = center.x - appSize.x / 2;\n  //   }\n  //   previousContainer.current = container.current;\n  // }, [appSize, virtualGridDims, hexGridPx]);\n  useEffect(() => {\n    if (container.current) {\n      triggerScrollRecenterCb();\n      const center = getVirtualGridCenterPx({ virtualGridDims, hexGridPx });\n      container.current.scrollTop = center.y - appSize.y / 2;\n      container.current.scrollLeft = center.x - appSize.x / 2;\n    }\n  }, [appSize, virtualGridDims, hexGridPx, triggerScrollRecenterCb]);\n\n  // Uses offset to jump to a new scroll position, exactly once\n  useEffect(() => {\n    if (!jumpOffset) return;\n    const ref = container.current;\n    if (!ref) return;\n    ref.scrollTo(\n      ref.scrollLeft - jumpOffset.x * hexGridPx.x,\n      ref.scrollTop - jumpOffset.y * hexGridPx.y\n    );\n  }, [jumpOffset, hexGridPx]);\n\n  // when we trigger a scroll jump, compute where we jump to, and don't forget to update the virtual grid location\n  const handleJump = useCallback(\n    (args: { direction: Vector2 }) => {\n      // // direction: if we hit bottom right of screen, direction == (1,1)\n      // // console.log({ direction: args.direction });\n      // // let jumpAmounts = virtualGridDims.multiply(0.35).floor();\n      // let jumpAmounts = virtualGridDims.multiply(0.05).floor();\n      // // jumpAmounts = jumpAmounts.withY(Math.floor(jumpAmounts.y / 2) * 2);\n      // jumpAmounts = jumpAmounts\n      //   .clampX(1, virtualGridDims.x - 1)\n      //   .clampY(1, virtualGridDims.y - 1);\n      // // .clampY(2, Math.floor((virtualGridDims.y - 1) / 2) * 2);\n\n      // let newJumpOffset = jumpAmounts.multiply(args.direction); // multiply the magnitudes by unit-ish direction vector\n      let locationOffset = new Vector2(args.direction.x, -1 * args.direction.y); // biased\n      if (args.direction.x === args.direction.y) {\n        locationOffset = new Vector2(0, -1 * args.direction.y);\n      }\n\n      const newJumpOffset = new Vector2(locationOffset.x, 0).add(\n        new Vector2(-0.5, -1).multiply(locationOffset.y)\n      );\n\n      // console.log({ newJumpOffset });\n\n      updaters.playerUI.virtualGridLocation.enqueueUpdate((it) => {\n        return it.add(Vector3.FromVector2(locationOffset, 0));\n      });\n      // force a rerender\n      setJumpOffset(newJumpOffset);\n    },\n    [updaters]\n  );\n\n  const getForceJumpOffset = debug.getForceJumpOffset;\n  useEffect(() => {\n    const newJumpOffset = getForceJumpOffset?.();\n    if (newJumpOffset) {\n      updaters.playerUI.virtualGridLocation.enqueueUpdate((it) => {\n        return it\n          .addX(newJumpOffset.x)\n          .add(new Vector3(-1, -2, 0).multiply(newJumpOffset.y / 2));\n      });\n    }\n  }, [updaters, getForceJumpOffset]);\n\n  // Detect if the user has scrolled to the edge of the screen, and if so trigger a scroll jump\n  const enableScrollJump = debug.enableScrollJump;\n  const handleScroll = useCallback(\n    (e: React.UIEvent<HTMLDivElement, UIEvent>) => {\n      // console.log(\"NOW IN handlescroll\");\n\n      // fast exit if debug\n      if (!enableScrollJump) {\n        // console.log(\"skipped scroll trigger due to debug\", { debug });\n        return;\n      }\n\n      // handle scroll\n      let direction = { x: 0, y: 0 };\n      const target = e.target! as Element;\n      let newScrollTop = target.scrollTop; // only used as boolean to see if it changed\n      let newScrollLeft = target.scrollLeft;\n      if (target.scrollTop < hexGridPx.y * 0.9) {\n        // between 0.1 and 0.4 of leeway is recommended. increasing it more helps with lag but also incurs more virtual area cost.\n        newScrollTop += hexGridPx.y * 2;\n        direction.y -= 1;\n      }\n      if (\n        target.scrollTop >\n        (virtualGridDims.y - 0.9) * hexGridPx.y - appSize.y\n      ) {\n        newScrollTop -= hexGridPx.y * 2;\n        direction.y += 1;\n      }\n      if (target.scrollLeft < hexGridPx.x * 0.9) {\n        // between 0.6 and 0.9 of leeway is recommended. increasing it more helps with lag but also incurs more virtual area cost.\n        newScrollLeft += hexGridPx.x * 2;\n        direction.x -= 1;\n      }\n      if (\n        target.scrollLeft >\n        (virtualGridDims.x - 0.9) * hexGridPx.x - appSize.x\n      ) {\n        newScrollLeft -= hexGridPx.x * 2;\n        direction.x += 1;\n      }\n      // console.log(target);\n      // console.log(target.scrollTop);\n      // console.log(target.scrollLeft);\n\n      if (\n        target.scrollTop !== newScrollTop ||\n        target.scrollLeft !== newScrollLeft\n      ) {\n        // console.log('jump!', +new Date());\n        // target.scrollTo(newScrollLeft, newScrollTop);\n        handleJump({ direction: new Vector2(direction.x, direction.y) });\n      }\n    },\n    [appSize, handleJump, hexGridPx, virtualGridDims, enableScrollJump]\n  );\n\n  // control scroll with keyboard\n  useEffect(() => {\n    if (!keyboardScrollDirection.equals(Vector2.Zero)) {\n      // console.log('nonzero keyboard scroll direction update received');\n\n      let lastTime: number | null = null;\n      const action = () => {\n        const ref = container.current;\n        if (!ref) return;\n        let direction = Vector2.Zero;\n        if (lastTime === null) {\n          direction = keyboardScrollDirection.multiply(SCROLL_INTERVAL_MS); // assume 1 tick\n          lastTime = +new Date();\n        } else {\n          const elapsed = +new Date() - lastTime;\n          if (elapsed > 40) {\n            console.log('WAS SLOW - ' + elapsed.toString());\n          }\n          direction = keyboardScrollDirection.multiply(elapsed);\n          lastTime = +new Date();\n        }\n        direction = direction.multiply(SCROLL_VELOCITY);\n        ref.scrollTo(\n          ref.scrollLeft + direction.x,\n          ref.scrollTop - direction.y // scroll is measured from the top left\n        );\n      };\n      const interval = setInterval(action, SCROLL_INTERVAL_MS);\n      action();\n      return () => clearInterval(interval);\n    }\n  }, [keyboardScrollDirection]);\n\n  return (\n    <div\n      ref={container}\n      className={classnames({\n        'game-area': true,\n        'hidden-scrollbars': !(debug?.debugShowScrollbars || false),\n      })}\n      hidden={props.hidden}\n      onScroll={handleScroll}\n    >\n      <div className=\"virtual-game-area\">{props.children}</div>\n    </div>\n  );\n}\n","import { Vector2 } from '../../lib/util/geometry/vector2';\nimport { Vector3 } from '../../lib/util/geometry/vector3';\n\nexport function convertVirtualCoordsToLocation(args: {\n  virtualCoords: Vector2;\n  virtualGridLocation: Vector3;\n  virtualGridDims: Vector2;\n}): Vector3 {\n  const { virtualCoords, virtualGridLocation, virtualGridDims } = args;\n  const virtualCenter = virtualGridDims.divide(2).floor();\n  const offsetFromVirtualCenter = virtualCoords.subtract(virtualCenter);\n  let relativeLocation = Vector2.Zero;\n\n  if (offsetFromVirtualCenter.y % 2 === 0) {\n    // calculate the effect of y\n    relativeLocation = new Vector2(-1, -2).multiply(\n      offsetFromVirtualCenter.y / 2\n    );\n  } else if (virtualCenter.y % 2 === 0) {\n    // half block is not in the center row\n    /**\n     * 0: O - O - O\n     * 1:   O - O - O\n     * 2: O - O - O <- virtualCenter.y\n     * 3:   O - O - O <- offsetFromVirtualCenter.y == 1\n     */\n    relativeLocation = new Vector2(0, -1).add(\n      new Vector2(-1, -2).multiply((offsetFromVirtualCenter.y - 1) / 2)\n    );\n  } else {\n    // half block is in the center row\n    /**\n     * 0: O - O - O\n     * 1:   O - O - O <- virtualCenter.y\n     * 2: O - O - O <- offsetFromVirtualCenter.y == 1\n     * 3:   O - O - O\n     */\n    relativeLocation = new Vector2(-1, -1).add(\n      new Vector2(-1, -2).multiply((offsetFromVirtualCenter.y - 1) / 2)\n    );\n  }\n  // now add in the x offset\n  relativeLocation = relativeLocation.addX(offsetFromVirtualCenter.x);\n\n  return virtualGridLocation.add(Vector3.FromVector2(relativeLocation, 0));\n}\n\nexport function convertLocationToVirtualCoords(args: {\n  location: Vector3;\n  virtualGridLocation: Vector3;\n  virtualGridDims: Vector2;\n}): Vector2 | null {\n  const { location, virtualGridLocation, virtualGridDims } = args;\n  const virtualCenter = virtualGridDims.divide(2).floor();\n  const offsetFromVirtualGridLocation = location.subtract(virtualGridLocation);\n  let relativeVirtualCoords = Vector2.Zero;\n\n  if (offsetFromVirtualGridLocation.z !== 0) {\n    return null;\n  }\n\n  if (offsetFromVirtualGridLocation.y % 2 === 0) {\n    relativeVirtualCoords = new Vector2(-1, -2).multiply(\n      offsetFromVirtualGridLocation.y / 2\n    );\n  } else if (virtualCenter.y % 2 === 0) {\n    // half block is not in the center row\n    /**\n     * 0: O - O - O\n     * 1:   O - O - O <- offsetFromVirtualGridLocation.y == 1\n     * 2: O - O - O <- virtualCenter.y\n     * 3:   O - O - O\n     */\n    relativeVirtualCoords = new Vector2(-1, -1).add(\n      new Vector2(-1, -2).multiply((offsetFromVirtualGridLocation.y - 1) / 2)\n    );\n  } else {\n    // half block is in the center row\n    /**\n     * 0: O - O - O <- offsetFromVirtualGridLocation.y == 1\n     * 1:   O - O - O <- virtualCenter.y\n     * 2: O - O - O\n     * 3:   O - O - O\n     */\n    relativeVirtualCoords = new Vector2(0, -1).add(\n      new Vector2(-1, -2).multiply((offsetFromVirtualGridLocation.y - 1) / 2)\n    );\n  }\n  relativeVirtualCoords = relativeVirtualCoords.addX(\n    offsetFromVirtualGridLocation.x\n  );\n\n  return virtualCenter.add(relativeVirtualCoords);\n}\n\n/**\n *\n * @param args\n * @return the number of pixels, measured from the top left of the virtual area, to the center of the \"virtualCenter\" node\n */\nexport function getVirtualGridCenterPx(args: {\n  virtualGridDims: Vector2;\n  hexGridPx: Vector2;\n}) {\n  const { virtualGridDims, hexGridPx } = args;\n\n  const virtualCenter = virtualGridDims.divide(2).floor();\n  let centerPxY = (virtualCenter.y + 0.5) * hexGridPx.y;\n\n  // even rows are left-aligned, odd rows are right-aligned\n  let centerPxX = (virtualCenter.x + 0.5) * hexGridPx.x;\n  if (virtualCenter.y % 2 === 1) {\n    centerPxX += 0.5 * hexGridPx.x;\n  }\n\n  return new Vector2(centerPxX, centerPxY);\n}\n","import React, { useCallback, useEffect, useMemo } from 'react';\nimport { GameState } from '../../data/GameState';\nimport { NodeTakenStatus } from '../../data/NodeStatus';\nimport {\n  AllocateNodeAction,\n  depsAllocateNodeCheckState,\n} from '../../game/actions/AllocateNode';\nimport { DeallocateNodeAction } from '../../game/actions/DeallocateNode';\nimport { Vector2 } from '../../lib/util/geometry/vector2';\nimport { Vector3 } from '../../lib/util/geometry/vector3';\nimport { UpdaterGeneratorType2 } from '../../lib/util/updaterGenerator';\nimport {\n  GameAreaGrid,\n  extractGameGridSubState,\n  depsGameGridSubState,\n} from './GameAreaGrid';\nimport { GameAreaSubState } from './GameAreaInterface';\nimport { InfiniteScrollManager } from './InfiniteScrollManager';\nimport {\n  convertLocationToVirtualCoords,\n  convertVirtualCoordsToLocation,\n} from './locationUtils';\n\n/**\n * Wrapper for GameAreaGrid that manages game state location <> virtual coord conversions, as well as populating the onClick/onSelect callbacks when interacting with nodes.\n * @param virtualGridDims integer vector for # of grid cells in each dimension\n * @param appSize the playable area\n */\nexport const GameAreaStateManager = React.memo(Component);\nfunction Component(props: {\n  gameState: GameAreaSubState;\n  virtualGridDims: Vector2;\n  hexGridPx: Vector2;\n  appSize: Vector2;\n  updaters: UpdaterGeneratorType2<GameState, GameState>;\n  actions: {\n    allocateNode: AllocateNodeAction;\n    deallocateNode: DeallocateNodeAction;\n  };\n}) {\n  const { gameState, hexGridPx, appSize, virtualGridDims } = props;\n  // console.log('GameArea state manager rerender');\n\n  // Compute some helpful coordinate to location conversions. These MUST be recomputed every time virtualGridLocation changes\n  const virtualCoordsToLocation = useCallback(\n    (virtualCoords: Vector2): Vector3 => {\n      return convertVirtualCoordsToLocation({\n        virtualCoords,\n        virtualGridDims,\n        virtualGridLocation: gameState.playerUI.virtualGridLocation,\n      });\n    },\n    [gameState.playerUI.virtualGridLocation, virtualGridDims]\n  );\n  const locationToVirtualCoords = useCallback(\n    (location: Vector3): Vector2 | null => {\n      return convertLocationToVirtualCoords({\n        location,\n        virtualGridDims,\n        virtualGridLocation: gameState.playerUI.virtualGridLocation,\n      });\n    },\n    [gameState.playerUI.virtualGridLocation, virtualGridDims]\n  );\n\n  // If a node is attempted to be clicked, take its virtual dims and see if that's a valid allocation action\n  const handleUpdateNodeStatusByLocation = useCallback(\n    (args: {\n      nodeLocation: Vector3;\n      newStatus: NodeTakenStatus;\n      action: 'allocate' | 'deallocate';\n    }) => {\n      if (args.action === 'allocate') {\n        return props.actions.allocateNode.run(args, gameState);\n      } else {\n        return props.actions.deallocateNode.run(args, gameState);\n      }\n    },\n    // TODO(bowei): use custom hook here so react doesnt complain so much\n    // eslint-disable-next-line\n    [\n      props.actions,\n      // TODO(bowei): use custom hook here so react doesnt complain so much\n      // eslint-disable-next-line\n      ...depsAllocateNodeCheckState(gameState),\n    ]\n  );\n\n  const handleUpdateNodeStatus = useCallback(\n    (args: {\n      virtualCoords: Vector2;\n      newStatus: NodeTakenStatus;\n      action: 'allocate' | 'deallocate';\n    }) => {\n      const { virtualCoords } = args;\n\n      // console.log({ got: 'here handleUpdateNodeStatus', virtualCoords, newStatus });\n      const nodeLocation: Vector3 = virtualCoordsToLocation(virtualCoords);\n      handleUpdateNodeStatusByLocation({ nodeLocation, ...args });\n    },\n    [virtualCoordsToLocation, handleUpdateNodeStatusByLocation]\n  );\n\n  // Manage cursor \"node selected\" state\n  const setCursoredLocation = useCallback(\n    (v: Vector3 | null) => {\n      props.updaters.playerUI.cursoredNodeLocation.enqueueUpdate((prev) => {\n        return v;\n      });\n      if (!!v) {\n        // also open the sidebar\n        props.updaters.playerUI.isSidebarOpen.enqueueUpdate(() => true);\n        props.updaters.playerUI.isLeftSidebarOpen.enqueueUpdate(() => true);\n        props.updaters.playerUI.isRightSidebarOpen.enqueueUpdate(() => true);\n      }\n    },\n    [props.updaters]\n  );\n\n  const cursoredVirtualNodeCoords: Vector2 | null = useMemo(() => {\n    if (gameState.playerUI.cursoredNodeLocation) {\n      // console.log({\n      //   3: gameState.playerUI.cursoredNodeLocation,\n      //   2: locationToVirtualCoords(gameState.playerUI.cursoredNodeLocation),\n      // });\n      return locationToVirtualCoords(gameState.playerUI.cursoredNodeLocation);\n    } else {\n      return null;\n    }\n  }, [gameState.playerUI.cursoredNodeLocation, locationToVirtualCoords]);\n\n  // reset cursor to center at different breakpoints depending on detailed or strategic view\n  const cursorHitEdgeCallback = useCallback(() => {\n    props.updaters.playerUI.virtualGridLocation.enqueueUpdate(\n      (prev, prevGameState) => {\n        const cursor = prevGameState.playerUI.cursoredNodeLocation;\n        const virtualCenter = prev;\n        // strategic view\n        if (!prevGameState.playerUI.isPixiHidden) {\n          // TODO(bowei): un-hardcode 16 & 32\n          if (\n            cursor &&\n            (Math.abs(cursor.y - virtualCenter.y) >= 16 ||\n              Math.abs(\n                cursor.x -\n                  cursor.y / 2 -\n                  (virtualCenter.x - virtualCenter.y / 2)\n              ) >= 32)\n          ) {\n            return cursor;\n          }\n          return prev;\n        } else {\n          // detailed view\n          // TODO(bowei): un-hardcode 2 & 4\n          if (\n            cursor &&\n            (Math.abs(cursor.y - virtualCenter.y) >= 2 ||\n              Math.abs(\n                cursor.x -\n                  cursor.y / 2 -\n                  (virtualCenter.x - virtualCenter.y / 2)\n              ) >= 4)\n          ) {\n            return cursor;\n          }\n          return prev;\n        }\n      }\n    );\n  }, [props.updaters]);\n\n  // manage keyboard wasdezx cusored node navigation\n  useEffect(() => {\n    // const newIntent = props.gameState.intent.newIntent;\n    const newLocation = virtualCoordsToLocation(\n      virtualGridDims.divide(2).floor()\n    );\n    if (props.gameState.intent.newIntent.MOVE_CURSOR_EAST) {\n      props.updaters.playerUI.cursoredNodeLocation.enqueueUpdate(\n        (prev) => prev?.addX(1) || newLocation\n      );\n      cursorHitEdgeCallback();\n    }\n    if (props.gameState.intent.newIntent.MOVE_CURSOR_WEST) {\n      props.updaters.playerUI.cursoredNodeLocation.enqueueUpdate(\n        (prev) => prev?.addX(-1) || newLocation\n      );\n      cursorHitEdgeCallback();\n    }\n    if (props.gameState.intent.newIntent.MOVE_CURSOR_NORTHEAST) {\n      props.updaters.playerUI.cursoredNodeLocation.enqueueUpdate(\n        (prev) => prev?.add({ x: 1, y: 1, z: 0 }) || newLocation\n      );\n      cursorHitEdgeCallback();\n    }\n    if (props.gameState.intent.newIntent.MOVE_CURSOR_NORTHWEST) {\n      props.updaters.playerUI.cursoredNodeLocation.enqueueUpdate(\n        (prev) => prev?.addY(1) || newLocation\n      );\n      cursorHitEdgeCallback();\n    }\n    if (props.gameState.intent.newIntent.MOVE_CURSOR_SOUTHEAST) {\n      props.updaters.playerUI.cursoredNodeLocation.enqueueUpdate(\n        (prev) => prev?.addY(-1) || newLocation\n      );\n      cursorHitEdgeCallback();\n    }\n    if (props.gameState.intent.newIntent.MOVE_CURSOR_SOUTHWEST) {\n      props.updaters.playerUI.cursoredNodeLocation.enqueueUpdate(\n        (prev) => prev?.add({ x: -1, y: -1, z: 0 }) || newLocation\n      );\n      cursorHitEdgeCallback();\n    }\n    if (props.gameState.intent.newIntent.MOVE_CURSOR_SOUTH) {\n      props.updaters.playerUI.cursoredNodeLocation.enqueueUpdate((prev) => {\n        if (prev && prev.y % 2 === 0) {\n          return prev?.add({ x: 0, y: -1, z: 0 });\n        } else if (prev && prev.y % 2 !== 0) {\n          return prev?.add({ x: -1, y: -1, z: 0 });\n        } else {\n          return newLocation;\n        }\n      });\n      cursorHitEdgeCallback();\n    }\n    if (props.gameState.intent.newIntent.MOVE_CURSOR_NORTH) {\n      props.updaters.playerUI.cursoredNodeLocation.enqueueUpdate((prev) => {\n        if (prev && prev.y % 2 === 0) {\n          return prev?.add({ x: 1, y: 1, z: 0 });\n        } else if (prev && prev.y % 2 !== 0) {\n          return prev?.add({ x: 0, y: 1, z: 0 });\n        } else {\n          return newLocation;\n        }\n      });\n      cursorHitEdgeCallback();\n    }\n    if (props.gameState.intent.newIntent.MOVE_CURSOR_NORTHNORTH) {\n      props.updaters.playerUI.cursoredNodeLocation.enqueueUpdate(\n        (prev) => prev?.add({ x: 1, y: 2, z: 0 }) || newLocation\n      );\n      cursorHitEdgeCallback();\n    }\n    if (props.gameState.intent.newIntent.MOVE_CURSOR_SOUTHSOUTH) {\n      props.updaters.playerUI.cursoredNodeLocation.enqueueUpdate(\n        (prev) => prev?.add({ x: -1, y: -2, z: 0 }) || newLocation\n      );\n      cursorHitEdgeCallback();\n    }\n    if (props.gameState.intent.newIntent.INTERACT_WITH_NODE) {\n      if (cursoredVirtualNodeCoords) {\n        handleUpdateNodeStatus({\n          virtualCoords: cursoredVirtualNodeCoords,\n          newStatus: { taken: true },\n          action: 'allocate',\n        });\n      }\n    }\n    if (props.gameState.intent.newIntent.DEALLOCATE_NODE) {\n      if (cursoredVirtualNodeCoords) {\n        handleUpdateNodeStatus({\n          virtualCoords: cursoredVirtualNodeCoords,\n          newStatus: { taken: true },\n          action: 'deallocate',\n        });\n      }\n    }\n  }, [\n    props.gameState.intent.newIntent.INTERACT_WITH_NODE,\n    props.gameState.intent.newIntent.MOVE_CURSOR_EAST,\n    props.gameState.intent.newIntent.MOVE_CURSOR_NORTH,\n    props.gameState.intent.newIntent.MOVE_CURSOR_NORTHNORTH,\n    props.gameState.intent.newIntent.MOVE_CURSOR_NORTHEAST,\n    props.gameState.intent.newIntent.MOVE_CURSOR_NORTHWEST,\n    props.gameState.intent.newIntent.MOVE_CURSOR_SOUTH,\n    props.gameState.intent.newIntent.MOVE_CURSOR_SOUTHSOUTH,\n    props.gameState.intent.newIntent.MOVE_CURSOR_SOUTHEAST,\n    props.gameState.intent.newIntent.MOVE_CURSOR_SOUTHWEST,\n    props.gameState.intent.newIntent.MOVE_CURSOR_WEST,\n    props.gameState.intent.newIntent.DEALLOCATE_NODE,\n    props.updaters,\n    virtualCoordsToLocation,\n    virtualGridDims,\n    cursoredVirtualNodeCoords,\n    handleUpdateNodeStatus,\n    cursorHitEdgeCallback,\n  ]);\n\n  useEffect(() => {\n    if (props.gameState.intent.newIntent.ZOOM_RECENTER_AT_NODE) {\n      const location = gameState.playerUI.cursoredNodeLocation;\n      if (location) {\n        // set virtual grid location\n        props.updaters.playerUI.virtualGridLocation.enqueueUpdate((prev) => {\n          return location;\n        });\n\n        props.updaters.playerUI.triggerScrollRecenterCb.enqueueUpdate(() => {\n          return () => {\n            // this is not guaranteed to ever be called\n            console.log('zoomed to location: ', { location });\n          };\n        });\n      }\n    }\n  }, [\n    props.gameState.intent.newIntent.ZOOM_RECENTER_AT_NODE,\n    gameState.playerUI.cursoredNodeLocation,\n    props.updaters,\n  ]);\n\n  // Manage keyboard scrolling here\n  // TODO(bowei): move this into infinite scroll manager. the only reason this is here is because we have access to intent object conveniently here\n  const keyboardScrollDirection: Vector2 = useMemo(() => {\n    let direction = Vector2.Zero;\n    if (props.gameState.intent.activeIntent.PAN_EAST) {\n      direction = direction.addX(1);\n    }\n    if (props.gameState.intent.activeIntent.PAN_WEST) {\n      direction = direction.addX(-1);\n    }\n    if (props.gameState.intent.activeIntent.PAN_NORTH) {\n      direction = direction.addY(1);\n    }\n    if (props.gameState.intent.activeIntent.PAN_SOUTH) {\n      direction = direction.addY(-1);\n    }\n    return direction;\n  }, [\n    props.gameState.intent.activeIntent.PAN_EAST,\n    props.gameState.intent.activeIntent.PAN_WEST,\n    props.gameState.intent.activeIntent.PAN_NORTH,\n    props.gameState.intent.activeIntent.PAN_SOUTH,\n  ]);\n\n  const infiniteScrollManagerDebug = useMemo(() => {\n    return {\n      debugShowScrollbars: gameState.debug.debugShowScrollbars,\n      enableScrollJump: gameState.debug.enableScrollJump,\n      getForceJumpOffset: gameState.debug.getForceJumpOffset,\n    };\n  }, [\n    gameState.debug.debugShowScrollbars,\n    gameState.debug.enableScrollJump,\n    gameState.debug.getForceJumpOffset,\n  ]);\n\n  const gameAreaGridDebug = useMemo(() => {\n    return {\n      rerenderGameAreaGrid: gameState.debug.rerenderGameAreaGrid,\n      getOffsetX: gameState.debug.getOffsetX,\n      isFlipCursored: gameState.debug.isFlipCursored,\n    };\n  }, [\n    gameState.debug.rerenderGameAreaGrid,\n    gameState.debug.getOffsetX,\n    gameState.debug.isFlipCursored,\n  ]);\n\n  const subGameState = useMemo(() => {\n    return extractGameGridSubState(gameState);\n    // TODO(bowei): use custom hook here so react doesnt complain so much\n    // eslint-disable-next-line\n  }, depsGameGridSubState(gameState));\n\n  return (\n    <>\n      <InfiniteScrollManager\n        hidden={!gameState.playerUI.isPixiHidden}\n        appSize={appSize}\n        triggerScrollRecenterCb={gameState.playerUI.triggerScrollRecenterCb}\n        updaters={props.updaters}\n        hexGridPx={hexGridPx}\n        virtualGridDims={virtualGridDims}\n        keyboardScrollDirection={keyboardScrollDirection}\n        debug={infiniteScrollManagerDebug}\n      >\n        <GameAreaGrid\n          gameState={subGameState}\n          virtualGridDims={virtualGridDims}\n          virtualCoordsToLocation={virtualCoordsToLocation}\n          updateNodeStatusByLocationCb={handleUpdateNodeStatusByLocation}\n          cursoredVirtualNode={cursoredVirtualNodeCoords}\n          setCursoredLocation={setCursoredLocation}\n          debug={gameAreaGridDebug}\n        />\n      </InfiniteScrollManager>\n    </>\n  );\n}\n","import React, { useMemo } from 'react';\nimport { GameState } from '../../data/GameState';\nimport { appSizeFromWindowSize } from '../../data/WindowState';\nimport { AllocateNodeAction } from '../../game/actions/AllocateNode';\nimport { DeallocateNodeAction } from '../../game/actions/DeallocateNode';\nimport { Vector2 } from '../../lib/util/geometry/vector2';\nimport { EnumInvalidError, extractDeps } from '../../lib/util/misc';\nimport { UpdaterGeneratorType2 } from '../../lib/util/updaterGenerator';\nimport COLORS from '../../pixi/colors';\nimport { UiScale } from '../../pixi/textures/SimpleTextures';\nimport { CssVariablesComponent } from './CssVariables';\nimport { GameAreaStateManager } from './GameAreaStateManager';\n\n/**\n * How much bigger the \"virtual\" (i.e. scrollable) game area is than the visible window.\n * Bigger == more elements rendered which are outside the viewport == worse performance,\n * but need to 'jump' the scroll viewport less often.\n * Recommended default is 3.0\n */\nexport const virtualAreaScaleMultiplier = 2.0;\n\n/**\n * The subset of the game state that is relevant to game area components.\n */\nexport function extractGameAreaSubState(g: GameAreaSubState) {\n  return _extract(g as GameState);\n}\n\nfunction _extract(gameState: GameState) {\n  return {\n    playerUI: {\n      virtualGridLocation: gameState.playerUI.virtualGridLocation,\n      cursoredNodeLocation: gameState.playerUI.cursoredNodeLocation,\n      isPixiHidden: gameState.playerUI.isPixiHidden,\n      triggerScrollRecenterCb: gameState.playerUI.triggerScrollRecenterCb,\n    },\n    playerSave: {\n      allocationStatusMap: gameState.playerSave.allocationStatusMap,\n      bookmarkedStatusMap: gameState.playerSave.bookmarkedStatusMap,\n      currentEra: gameState.playerSave.currentEra,\n      deallocationPoints: gameState.playerSave.deallocationPoints,\n    },\n    worldGen: {\n      nodeContentsMap: gameState.worldGen.nodeContentsMap,\n      lockMap: gameState.worldGen.lockMap,\n    },\n    computed: {\n      fogOfWarStatusMap: gameState.computed.fogOfWarStatusMap,\n      reachableStatusMap: gameState.computed.reachableStatusMap,\n      lockStatusMap: gameState.computed.lockStatusMap,\n      accessibleStatusMap: gameState.computed.accessibleStatusMap,\n    },\n    intent: gameState.intent,\n    debug: {\n      debugShowScrollbars: gameState.debug.debugShowScrollbars,\n      rerenderGameAreaGrid: gameState.debug.rerenderGameAreaGrid,\n      enableScrollJump: gameState.debug.enableScrollJump,\n      getForceJumpOffset: gameState.debug.getForceJumpOffset,\n      getOffsetX: gameState.debug.getOffsetX,\n      isFlipCursored: gameState.debug.isFlipCursored,\n    },\n  };\n}\n\nexport type GameAreaSubState = ReturnType<typeof _extract>;\nexport const depsGameAreaSubState = extractDeps(extractGameAreaSubState);\n\nexport function uiScaleFromAppSize(appSize: Vector2): UiScale {\n  let maxDim = Math.max(appSize.x, appSize.y);\n  let uiScale: UiScale;\n  if (maxDim > 2160) {\n    uiScale = 'x-large';\n  } else if (maxDim > 1536) {\n    uiScale = 'large';\n  } else if (maxDim > 1080) {\n    uiScale = 'medium';\n  } else if (maxDim > 800) {\n    uiScale = 'small';\n  } else {\n    uiScale = 'x-small';\n  }\n  // console.log('computed ui scale from app size ', { appSize, uiScale });\n  return uiScale;\n}\n\n/**\n * Handles managing constants (settings) as well as pruning down game state and updaters to what is actually relevant.\n * Helps with memoization as well.\n */\nexport function GameAreaInterface(props: {\n  gameState: GameState;\n  updaters: UpdaterGeneratorType2<GameState, GameState>;\n}) {\n  const { gameState } = props;\n\n  const appSize = useMemo(() => {\n    return appSizeFromWindowSize(\n      new Vector2(\n        gameState.windowState.innerWidth,\n        gameState.windowState.innerHeight\n      )\n    );\n  }, [gameState.windowState.innerWidth, gameState.windowState.innerHeight]);\n\n  // TODO(bowei): programmatically determine UI scale based on app size\n  let uiScale: UiScale = useMemo(() => {\n    return uiScaleFromAppSize(appSize);\n  }, [appSize]);\n\n  /**\n   * Approximations for sqrt(3)/2 == ratio of an equilateral triangle's height to its width:\n   * 6/7, 13/15 (*), 26/30, 45/52, 58/67, 84/97 (*), 97/112, 181/209 (*)\n   * for divisibility -- recommend 19/22, 26/30, 52/60, 78/90, 104/120, 168/194, 180/208, 232/268, 336/388\n   */\n  const hexGridPx = useMemo(() => {\n    if (uiScale === 'x-large') {\n      return new Vector2(268, 232);\n    } else if (uiScale === 'large') {\n      return new Vector2(194, 168);\n    } else if (uiScale === 'medium') {\n      return new Vector2(120, 104);\n    } else if (uiScale === 'small') {\n      return new Vector2(97, 84);\n    } else if (uiScale === 'x-small') {\n      return new Vector2(75, 65); // TODO(bowei): change text font size to xx-small\n    } else {\n      throw new EnumInvalidError();\n    }\n  }, [uiScale]);\n\n  // Radius of the circles representing allocatable nodes, in px\n  const hexCenterRadius = useMemo(() => {\n    if (uiScale === 'x-large') {\n      return 64;\n    } else if (uiScale === 'large') {\n      return 48;\n    } else if (uiScale === 'medium') {\n      return 32;\n    } else if (uiScale === 'small') {\n      return 26;\n    } else if (uiScale === 'x-small') {\n      return 20;\n    } else {\n      throw new EnumInvalidError();\n    }\n  }, [uiScale]);\n\n  // border of circles, etc. in px\n  const borderWidth = useMemo(() => {\n    if (uiScale === 'x-large') {\n      return 2;\n    } else if (uiScale === 'large') {\n      return 2;\n    } else if (uiScale === 'medium') {\n      return 2;\n    } else if (uiScale === 'small') {\n      return 1;\n    } else if (uiScale === 'x-small') {\n      return 1;\n    } else {\n      throw new EnumInvalidError();\n    }\n  }, [uiScale]);\n\n  const onDebugRetrigger = gameState.debug.retriggerVirtualGridDims; // triggered from debug tab to check performance\n  const virtualGridDims = useMemo(() => {\n    onDebugRetrigger();\n\n    let x = Math.floor(\n      (appSize.x * virtualAreaScaleMultiplier) / hexGridPx.x - 0.5\n    );\n    let y = Math.floor((appSize.y * virtualAreaScaleMultiplier) / hexGridPx.y);\n\n    // y = (Math.floor((y - 1) / 2) * 2) + 1; // force y to be odd\n\n    // needs to be at least 3.8 x 4.8 so we have room for jumps\n    // x = Math.max(4, x);\n    // y = Math.max(5, y);\n\n    return new Vector2(x, y);\n  }, [appSize, onDebugRetrigger, hexGridPx]);\n\n  const subGameState: GameAreaSubState = useMemo(() => {\n    return extractGameAreaSubState(gameState);\n    // TODO(bowei): use custom hook here so react doesnt complain so much\n    // eslint-disable-next-line\n  }, depsGameAreaSubState(gameState));\n\n  // TODO(bowei): improve this abstraction??\n  const actions = useMemo(() => {\n    return {\n      allocateNode: new AllocateNodeAction(props.updaters),\n      deallocateNode: new DeallocateNodeAction(props.updaters),\n    };\n  }, [props.updaters]);\n\n  return (\n    <>\n      <CssVariablesComponent\n        appSize={appSize}\n        hexCenterRadius={hexCenterRadius}\n        hexGridPx={hexGridPx}\n        borderWidth={borderWidth}\n        COLORS={COLORS}\n      />\n      <GameAreaStateManager\n        appSize={appSize}\n        virtualGridDims={virtualGridDims}\n        hexGridPx={hexGridPx}\n        gameState={subGameState}\n        updaters={props.updaters}\n        actions={actions}\n      />\n    </>\n  );\n}\n","import * as Pixi from 'pixi.js';\nimport chroma from 'chroma-js';\nimport { GameState } from '../../data/GameState';\nimport {\n  LockStatus,\n  NodeReachableStatus,\n  NodeTakenStatus,\n} from '../../data/NodeStatus';\nimport { StrategicSearchState } from '../../data/PlayerUIState';\nimport { NodeContents } from '../../game/worldGen/nodeContents/NodeContentsFactory';\nimport {\n  AttributeDescriptionReverseMap,\n  ModifierDescriptionReverseMap,\n  nodeContentsToColor,\n} from '../../game/worldGen/nodeContents/NodeContentsRendering';\nimport { PixiPointFrom } from '../../lib/pixi/pixify';\nimport { KeyedHashMap } from '../../lib/util/data_structures/hash';\nimport { Vector2 } from '../../lib/util/geometry/vector2';\nimport { Vector3 } from '../../lib/util/geometry/vector3';\nimport { Const, extractDeps, extractAccessPaths } from '../../lib/util/misc';\nimport { interpolateColor } from '../../lib/util/color';\nimport { UpdaterGeneratorType2 } from '../../lib/util/updaterGenerator';\nimport COLORS from '../colors';\nimport { SimpleTextureSet, UiScale } from '../textures/SimpleTextures';\nimport { engageLifecycle, LifecycleHandlerBase } from './LifecycleHandler';\nimport { PIXI_TICKS_PER_SECOND } from '../PixiReactBridge';\nimport { uiScaleFromAppSize } from '../../components/GameArea/GameAreaInterface';\nimport { Lazy } from '../../lib/util/lazy';\n\ntype Props = {\n  delta: number;\n  args: {\n    position: Vector2;\n    textures: Const<Lazy<SimpleTextureSet>>;\n  };\n  updaters: UpdaterGeneratorType2<GameState, GameState>;\n  appSize: Vector2;\n  gameState: StrategicHexGridSubState;\n};\n\n/**\n * The subset of the game state that is relevant to game area components.\n */\nexport function extractStrategicHexGridSubState(g: StrategicHexGridSubState) {\n  return _extract(g as GameState);\n}\n\nfunction _extract(gameState: Const<GameState>) {\n  return {\n    playerUI: {\n      virtualGridLocation: gameState.playerUI.virtualGridLocation,\n      cursoredNodeLocation: gameState.playerUI.cursoredNodeLocation,\n      strategicSearch: gameState.playerUI.strategicSearch,\n      isPixiHidden: gameState.playerUI.isPixiHidden,\n    },\n    playerSave: {\n      allocationStatusMap: gameState.playerSave.allocationStatusMap,\n      bookmarkedStatusMap: gameState.playerSave.bookmarkedStatusMap,\n      currentEra: gameState.playerSave.currentEra,\n    },\n    intent: {\n      newIntent: {\n        PAN_EAST: gameState.intent.newIntent.PAN_EAST,\n        PAN_NORTH: gameState.intent.newIntent.PAN_NORTH,\n        PAN_SOUTH: gameState.intent.newIntent.PAN_SOUTH,\n        PAN_WEST: gameState.intent.newIntent.PAN_WEST,\n      },\n    },\n    computed: {\n      fogOfWarStatusMap: gameState.computed.fogOfWarStatusMap,\n      reachableStatusMap: gameState.computed.reachableStatusMap,\n      accessibleStatusMap: gameState.computed.accessibleStatusMap,\n      lockStatusMap: gameState.computed.lockStatusMap,\n    },\n    worldGen: {\n      nodeContentsMap: gameState.worldGen.nodeContentsMap,\n      lockMap: gameState.worldGen.lockMap,\n    },\n  };\n}\nexport type StrategicHexGridSubState = ReturnType<typeof _extract>;\nexport const depsStrategicHexGridSubState = extractDeps(\n  extractStrategicHexGridSubState\n);\n\ntype State = {\n  phases: { [x: number]: number };\n};\n\ntype HexGridAnimation = {\n  max: number;\n  min: number;\n  periodSecs: number;\n  mode: 'start-max ease-in-out' | 'start-max ease-in';\n  phase: number;\n};\n\ntype HexGridData = {\n  animation: HexGridAnimation | null;\n  cursorAnimation: HexGridAnimation | null;\n  node: Pixi.Sprite;\n  cursor: Pixi.Sprite | null;\n};\n\n// sqrt(3)/2 approximation - see hexGridPx\nfunction strategicHexGridPxFromUiScale(pixiUiScale: UiScale) {\n  return pixiUiScale === 'x-small'\n    ? new Vector2(15, 13)\n    : pixiUiScale === 'small'\n    ? new Vector2(22, 19)\n    : pixiUiScale === 'medium' || pixiUiScale === 'large'\n    ? new Vector2(30, 26)\n    : new Vector2(45, 39);\n}\n\n// TODO(bowei): compute this to be big enough\n// const strategicHexGridDims = new Vector2(35, 20);\n// const strategicHexGridDims = new Vector2(6, 12);\nconst strategicHexGridDims = new Vector2(48, 24);\n\nclass StrategicHexGridComponent extends LifecycleHandlerBase<Props, State> {\n  public container: Pixi.Container;\n  public state: Const<State>;\n  // private graphics: Pixi.Sprite;\n  private hexGrid: KeyedHashMap<Vector2, HexGridData> = new KeyedHashMap();\n\n  constructor(props: Props) {\n    super(props);\n    this.state = this.useState(this, {\n      phases: {},\n    }).state;\n    this.updateSelf(props);\n    this.container = new Pixi.Container();\n\n    // test graphics\n    // this.graphics = new Pixi.Sprite();\n    // this.graphics.texture = props.args.textures.circle;\n    // this.graphics.tint = COLORS.borderBlack;\n    // this.graphics.visible = false;\n    // this.container.addChild(this.graphics);\n\n    // sqrt(3)/2 approximation - see hexGridPx\n    const strategicHexGridPx = strategicHexGridPxFromUiScale(\n      uiScaleFromAppSize(props.appSize)\n    );\n\n    // populate a grid\n    // TODO(bowei): unhardcode\n    for (let j = -strategicHexGridDims.y; j <= strategicHexGridDims.y; j++) {\n      for (\n        let i = -strategicHexGridDims.x + Math.floor(j / 2);\n        i <= strategicHexGridDims.x + Math.floor(j / 2);\n        i++\n      ) {\n        const graphics = new Pixi.Sprite();\n        // graphics.texture = props.args.textures.get().circle;\n        graphics.tint = COLORS.nodePink;\n        // graphics.visible = false;\n        // if ((i == 0 && j == 0) || (i == 5 && j == 5)) {\n        //   // graphics.visible = true;\n        //   graphics.tint = COLORS.borderBlack;\n        // }\n        graphics.position = PixiPointFrom(\n          props.appSize\n            .divide(2)\n            .add(\n              new Vector2(\n                strategicHexGridPx.x * i - (strategicHexGridPx.x / 2) * j,\n                -strategicHexGridPx.y * j\n              )\n            )\n        );\n        this.container.addChild(graphics);\n        this.hexGrid.put(new Vector2(i, j), {\n          node: graphics,\n          animation: null,\n          cursor: null,\n          cursorAnimation: null,\n        });\n      }\n    }\n  }\n\n  /**\n   * Progress animation state (which needs to happen even if non-delta props do not change)\n   * @param props\n   */\n  protected updateSelf(props: Props) {\n    // const { delta } = props;\n    const delta = 1; // ignore lags and freezes because color is not required to be continuous\n\n    if (\n      props.gameState.playerUI.strategicSearch !==\n      this._staleProps.gameState.playerUI.strategicSearch\n    ) {\n      // reset phases\n      this.stateUpdaters!.phases.enqueueUpdate((prev) => {\n        const result = { ...prev };\n        for (let keyString of Object.keys(result)) {\n          let keyNumber = parseInt(keyString);\n          result[keyNumber] = 0;\n        }\n        return result;\n      });\n    }\n\n    for (let data of this.hexGrid.values()) {\n      const { node: graphics, animation } = data;\n      if (animation) {\n        // the last frame was rendered at this phase in the animation\n        let phase =\n          this.state.phases[animation.periodSecs] || animation.phase || 0;\n\n        // increment it. phase of 1 == a full period == animation.period secs\n        let newPhase =\n          (phase +\n            (delta * (1 / PIXI_TICKS_PER_SECOND) * 1) / animation.periodSecs) %\n          1;\n\n        // animation starts with bezierX == 0, goes up to 1, then back down\n        let bezierX = 1 - Math.abs(newPhase * 2 - 1);\n        /* NOTE(bowei): specifically ease-in-out. we want to draw attention both to the lit-up state and to the base state. */\n        // ease-in\n        // let bezierY = ( bezierX * bezierX); // we use the shitty approximation cubicBezier(0.42,0,1,1) == x ** 2.\n        // let bezierY = (bezierX * bezierX) * (1.5 - 0.5 * bezierX); // adjustment to decrease the slope at x=1 from 2 to 1.5\n        // ease-in-out\n        let bezierY =\n          bezierX < 0.5\n            ? 2 * (bezierX * bezierX)\n            : 1 - 2 * (1 - bezierX) * (1 - bezierX);\n\n        // calculate the proper tint now\n        let tintProp = 1 - bezierY; // animation should start with tint == 1, go back down to 0, go back up\n\n        // set the tint\n        // tintProp = tintProp * .75 + 0.25; // minimum opacity = 0.25\n        graphics.tint = interpolateColor({\n          target: animation.max,\n          base: animation.min,\n          proportion: tintProp,\n        });\n        // console.log({ delta, phase, newPhase, bezierX, tintProp, tint: graphics.tint });\n\n        // update phase on animation object\n        animation.phase = newPhase;\n\n        // update it in state\n        this.stateUpdaters!.phases.enqueueUpdate((prev) => {\n          const result = { ...prev };\n          result[animation.periodSecs] = newPhase;\n          return result;\n        });\n      }\n\n      if (data.cursor && data.cursorAnimation) {\n        let animation = data.cursorAnimation;\n\n        // the last frame was rendered at this phase in the animation\n        let phase = animation.phase || 0;\n\n        // increment it. phase of 1 == a full period == animation.period secs\n        let newPhase =\n          (phase +\n            (delta * (1 / PIXI_TICKS_PER_SECOND) * 1) / animation.periodSecs) %\n          1;\n\n        // animation starts with bezierX == 0, goes up to 1, then back down\n        let bezierX = 1 - Math.abs(newPhase * 2 - 1);\n        /* NOTE(bowei): specifically ease-in-out. we want to draw attention both to the lit-up state and to the base state. */\n        // ease-in\n        // let bezierY = ( bezierX * bezierX); // we use the shitty approximation cubicBezier(0.42,0,1,1) == x ** 2.\n        // let bezierY = (bezierX * bezierX) * (1.5 - 0.5 * bezierX); // adjustment to decrease the slope at x=1 from 2 to 1.5\n        // ease-in-out\n        let bezierY = bezierX * bezierX;\n\n        // calculate the proper tint now\n        let tintProp = 1 - bezierY; // animation should start with tint == 1, go back down to 0, go back up\n\n        // set the tint\n        data.cursor.tint = interpolateColor({\n          target: animation.max,\n          base: animation.min,\n          proportion: tintProp,\n        });\n\n        // update phase on animation object\n        animation.phase = newPhase;\n      }\n    }\n\n    if (props.gameState.intent !== this._staleProps.gameState.intent) {\n      if (!props.gameState.playerUI.isPixiHidden) {\n        if (props.gameState.intent.newIntent.PAN_EAST) {\n          props.updaters.playerUI.virtualGridLocation.enqueueUpdate((prev) => {\n            return prev.addX(4);\n          });\n        }\n        if (props.gameState.intent.newIntent.PAN_WEST) {\n          props.updaters.playerUI.virtualGridLocation.enqueueUpdate((prev) => {\n            return prev.addX(-4);\n          });\n        }\n        if (props.gameState.intent.newIntent.PAN_NORTH) {\n          props.updaters.playerUI.virtualGridLocation.enqueueUpdate((prev) => {\n            return prev.addX(2).addY(4);\n          });\n        }\n        if (props.gameState.intent.newIntent.PAN_SOUTH) {\n          props.updaters.playerUI.virtualGridLocation.enqueueUpdate((prev) => {\n            return prev.addX(-2).addY(-4);\n          });\n        }\n      }\n    }\n  }\n\n  protected renderSelf(props: Props) {\n    const { gameState } = props;\n    const {\n      playerSave: { currentEra },\n    } = gameState;\n\n    this.container.position = PixiPointFrom(props.args.position);\n    // this.graphics.position = PixiPointFrom(props.appSize.divide(2));\n\n    // sqrt(3)/2 approximation - see hexGridPx\n    const strategicHexGridPx = strategicHexGridPxFromUiScale(\n      uiScaleFromAppSize(props.appSize)\n    );\n\n    for (let [v, data] of this.hexGrid.entries()) {\n      const { node: graphics } = data;\n\n      const basePosition = props.appSize\n        .divide(2)\n        .add(\n          new Vector2(\n            strategicHexGridPx.x * v.x - (strategicHexGridPx.x / 2) * v.y,\n            -strategicHexGridPx.y * v.y\n          )\n        );\n      // graphics.position = PixiPointFrom(basePosition);\n      let baseTint: number;\n\n      const nodeLocation = gameState.playerUI.virtualGridLocation.add(\n        Vector3.FromVector2(v)\n      );\n      const nodeVisibleStatus =\n        gameState.computed.fogOfWarStatusMap?.get(nodeLocation) || 'obscured';\n      const nodeTakenStatus =\n        gameState.playerSave.allocationStatusMap.get(nodeLocation) ||\n        NodeTakenStatus.false;\n      const nodeBookmarkedStatus = gameState.playerSave.bookmarkedStatusMap.get(\n        nodeLocation\n      ) || { bookmarked: false };\n      const nodeReachableStatus =\n        gameState.computed.reachableStatusMap?.get(nodeLocation) ||\n        NodeReachableStatus.false;\n      const nodeAccessibleStatus = gameState.computed.accessibleStatusMap?.get(\n        nodeLocation\n      ) || { accessible: false };\n      const lockData = gameState.worldGen.lockMap.get(nodeLocation);\n      const lockStatus = gameState.computed.lockStatusMap?.get(nodeLocation);\n      const isLocked = !!lockData && lockStatus !== LockStatus.OPEN;\n\n      let visible: boolean = true;\n      if (nodeTakenStatus.taken) {\n        graphics.visible = true;\n        baseTint = COLORS.borderBlack;\n        // graphics.tint = COLORS.borderBlack;\n      } else if (currentEra.type === 'A' && nodeBookmarkedStatus.bookmarked) {\n        graphics.visible = true;\n        baseTint = COLORS.borderBlack;\n        // graphics.tint = COLORS.borderBlack;\n        // } else if (currentEra.type === 'B' && nodeBookmarkedStatus.bookmarked) {\n        //   // TODO(bowei): what to show here if bookmarked in B era?\n        //   graphics.visible = true;\n        //   baseTint = COLORS.nodePink;\n        //   // graphics.tint = COLORS.borderBlack;\n      } else if (\n        nodeReachableStatus.reachable &&\n        !isLocked &&\n        currentEra.type === 'B'\n      ) {\n        // only recolor if it is not locked and era is in allocation era\n        graphics.visible = true;\n        baseTint = COLORS.nodeLavender;\n        // graphics.tint = COLORS.nodeLavender;\n      } else if (nodeVisibleStatus === 'revealed') {\n        // default - visible but nothing else special\n        graphics.visible = true;\n        visible = true;\n        baseTint = COLORS.nodePink;\n        // graphics.tint = COLORS.nodePink;\n      } else if (\n        currentEra.type === 'A' &&\n        nodeVisibleStatus === 'hinted' &&\n        nodeAccessibleStatus.accessible\n      ) {\n        // hinted - smaller circle and empty contents\n        graphics.visible = true;\n        visible = false;\n        baseTint = COLORS.nodePink;\n        // graphics.tint = COLORS.nodePink;\n      } else {\n        // hidden\n        graphics.visible = false;\n        visible = false;\n        baseTint = COLORS.nodePink;\n      }\n\n      // add onclick so that clicking on the node causes selected node tab to update\n      if (graphics.visible) {\n        graphics.interactive = true;\n        graphics.buttonMode = true;\n        graphics.removeAllListeners(); // NOTE(bowei): there's a double render which would otherwise attach 2 event handlers.\n        graphics.on('pointerdown', () => {\n          console.log('pointerdown in strategic hex grid pixi', {\n            nodeLocation,\n          });\n          props.updaters.playerUI.cursoredNodeLocation.enqueueUpdate((prev) => {\n            console.log('enqueue update in pointerdown in strategic hex grid', {\n              prev,\n              nodeLocation,\n            });\n            if (prev && prev.equals(nodeLocation)) {\n              return null;\n            }\n            return nodeLocation;\n          });\n        });\n      } else {\n        graphics.interactive = false;\n        graphics.buttonMode = false;\n      }\n\n      // graphics.anchor = PixiPointFrom(Vector2.Zero);\n      // graphics.pivot = PixiPointFrom(Vector2.Zero);\n      const textures = props.args.textures.get();\n      if (\n        currentEra.type === 'A' &&\n        nodeVisibleStatus === 'hinted' &&\n        nodeAccessibleStatus.accessible\n      ) {\n        graphics.texture = textures.dot;\n        graphics.position = PixiPointFrom(basePosition);\n        graphics.position.x -= textures.dot.width / 2;\n        graphics.position.y -= textures.dot.height / 2;\n      } else if (isLocked) {\n        graphics.texture = textures.rect;\n        graphics.position = PixiPointFrom(basePosition);\n        graphics.position.x -= textures.rect.width / 2;\n        graphics.position.y -= textures.rect.height / 2;\n        // graphics.tint = COLORS.borderBlack;\n      } else if (nodeBookmarkedStatus.bookmarked) {\n        graphics.texture = textures.square;\n        graphics.position = PixiPointFrom(basePosition);\n        graphics.position.x -= textures.square.width / 2;\n        graphics.position.y -= textures.square.height / 2;\n      } else {\n        graphics.texture = textures.circle;\n        graphics.position = PixiPointFrom(basePosition);\n        graphics.position.x -= textures.circle.width / 2;\n        graphics.position.y -= textures.circle.height / 2;\n      }\n\n      const nodeContents = gameState.worldGen.nodeContentsMap.get(nodeLocation);\n\n      // give color (hue, saturation) to the node according to its contents, but keep the value (grayness) from tint\n      if (visible) {\n        if (\n          gameState.playerUI.strategicSearch.colors.enabled === 'Yes' ||\n          (gameState.playerUI.strategicSearch.colors.enabled ===\n            'Only unallocated' &&\n            !nodeTakenStatus.taken)\n        ) {\n          const nodeContentsLch = chroma(\n            nodeContentsToColor(nodeContents)\n          ).lch();\n          const originalLch = chroma(baseTint).lch();\n          baseTint = chroma\n            .lch(\n              originalLch[0],\n              // nodeContentsLch[1],\n              0.5 * (originalLch[1] + nodeContentsLch[1]),\n              nodeContentsLch[2]\n            )\n            .num();\n        }\n      }\n\n      const matched = matchStrategicSearch({\n        nodeContents,\n        nodeTakenStatus,\n        isLocked,\n        query: gameState.playerUI.strategicSearch,\n      });\n\n      // If was selected by the highlight search, make it shiny\n      if (matched && visible) {\n        const animation: HexGridAnimation = {\n          // max: addColor(COLORS.nodeBlue, graphics.tint),\n          max: interpolateColor({\n            color: baseTint,\n            opacity: 0.75,\n            background: COLORS.white,\n          }),\n          // max: graphics.tint === COLORS.borderBlack ? COLORS.nodeLavender : COLORS.nodeBlue,\n          // max: COLORS.nodeBlue,\n          // max: graphics.tint,\n          min: baseTint,\n          periodSecs: 2,\n          mode: 'start-max ease-in-out',\n          phase: data.animation ? data.animation.phase : 0,\n        };\n        // TODO(bowei): properly encapsulate this in like a useEffect/useMemo to detect changes and only trigger in that case\n        // if (gameState.playerUI.strategicSearch === this._staleProps.gameState.playerUI.strategicSearch) {\n        //   animation.phase = 0;\n        // }\n        data.animation = animation;\n      } else {\n        graphics.tint = baseTint;\n        data.animation = null;\n      }\n\n      // put a cursor near the node if it has been selected\n      if (props.gameState.playerUI.cursoredNodeLocation?.equals(nodeLocation)) {\n        if (!data.cursor) {\n          const cursor = new Pixi.Sprite();\n          cursor.texture = textures.verticalLine;\n          // cursor.tint = graphics.tint;\n          // cursor.tint = addColor(COLORS.nodeBlue, graphics.tint);\n          cursor.tint = COLORS.borderWhite;\n          this.container.addChild(cursor);\n          data.cursor = cursor;\n\n          data.cursorAnimation = {\n            max: COLORS.borderWhite,\n            min: interpolateColor({\n              color: COLORS.borderWhite,\n              opacity: 0.25,\n              background: COLORS.backgroundBlue,\n            }),\n            periodSecs: 1,\n            mode: 'start-max ease-in',\n            phase: 0,\n          };\n        }\n      } else {\n        if (data.cursor) {\n          this.container.removeChild(data.cursor);\n        }\n        data.cursor = null;\n      }\n      if (data.cursor) {\n        data.cursor.position = PixiPointFrom(basePosition);\n        // data.cursor.position.x -= props.args.textures.verticalLine.width / 2;\n        data.cursor.position.x -= strategicHexGridPx.x / 2; // - props.args.textures.verticalLine.width / 3;\n        data.cursor.position.x += textures.verticalLine.width / 3;\n        // data.cursor.position.x += props.args.textures.verticalLine.width / 2;\n        // data.cursor.position.x += props.args.textures.circle.width / 2;\n        data.cursor.position.y -= textures.verticalLine.height / 2;\n      }\n    }\n  }\n\n  /**\n   * @param staleProps\n   * @param staleState\n   * @param props\n   * @param state\n   * @returns false if staleProps == nextProps and staleState == state (which will cause the component to be memoized)\n   *          true if the props or state differ anywhere\n   */\n  protected shouldUpdate(\n    staleProps: Props,\n    staleState: Const<State>,\n    props: Props,\n    state: Const<State>\n  ): boolean {\n    for (let key of Object.keys(staleProps) as (keyof Props)[]) {\n      if (key === 'delta' || key === 'args' || key === 'updaters') {\n        // if (key === 'args' || key === 'delta') {\n        continue;\n      }\n      if (key === 'gameState') {\n        const staleGameState = staleProps[key];\n        const gameState = props[key];\n        const staleDeps = depsStrategicHexGridSubState(staleGameState);\n        const deps = depsStrategicHexGridSubState(gameState);\n        for (let i = 0; i < staleDeps.length; i++) {\n          if (deps[i] !== staleDeps[i]) {\n            console.log(\n              `hexgrid substate differed in ${i} : ${extractAccessPaths(\n                extractStrategicHexGridSubState\n              )[i].join('.')}, returning true for shouldupdate`\n            );\n            return true;\n          }\n        }\n        continue;\n      }\n      if (staleProps[key] !== props[key]) {\n        console.log(`hexgrid shouldUpdate differed in ${key}, returning true`);\n        return true;\n      }\n    }\n    // for (let key of Object.keys(staleState) as (keyof State)[]) {\n    //   // check if state changed...?\n    // }\n    return false;\n  }\n}\n\nconst wrapped = engageLifecycle(StrategicHexGridComponent);\n// eslint-disable-next-line\ntype wrapped = StrategicHexGridComponent;\nexport { wrapped as StrategicHexGridComponent };\nexport type { Props as StrategicHexGridComponentProps };\n\nexport function matchStrategicSearch(args: {\n  nodeContents: NodeContents;\n  nodeTakenStatus: NodeTakenStatus;\n  isLocked: boolean;\n  query: StrategicSearchState;\n}): boolean {\n  const { nodeContents, nodeTakenStatus, isLocked, query } = args;\n\n  // missing query! return no matches\n  if (!query) {\n    return false;\n  }\n\n  // first separate out the terms\n  const highlight1 = query.highlight1.value;\n  const terms = highlight1\n    .split(' ')\n    .filter((it) => !!it)\n    .map((wrappedTerm) => {\n      // transform \"[SOME_STRING]\" to \"SOME_STRING\"\n      if (\n        wrappedTerm[0] === '[' &&\n        wrappedTerm[wrappedTerm.length - 1] === ']'\n      ) {\n        return wrappedTerm.slice(1, wrappedTerm.length - 1);\n      } else {\n        return wrappedTerm;\n      }\n    });\n\n  // missing query! return no matches\n  if (terms.length === 0) {\n    return false;\n  }\n\n  // for ALL of the terms, make sure node contents matches\n  let unmatchedTerm: string | null = null;\n  // console.log({ terms });\n  for (let term of terms) {\n    // is the term a attribute or modifier?\n    const maybeAttribute = AttributeDescriptionReverseMap[term];\n    const maybeModifier = ModifierDescriptionReverseMap[term];\n    if (!!maybeAttribute) {\n      if (\n        nodeContents.lines?.[0]?.attribute === maybeAttribute ||\n        nodeContents.lines?.[1]?.attribute === maybeAttribute\n      ) {\n        // console.log(\"matched by attribute\" , maybeAttribute);\n      } else {\n        unmatchedTerm = maybeAttribute;\n        break;\n      }\n    } else if (!!maybeModifier) {\n      if (\n        nodeContents.lines?.[0]?.modifier === maybeModifier ||\n        nodeContents.lines?.[1]?.modifier === maybeModifier\n      ) {\n        // console.log(\"matched by modifier\" , maybeModifier);\n      } else {\n        unmatchedTerm = maybeModifier;\n        break;\n      }\n    } else if (term === '*') {\n      if (\n        nodeContents.lines?.[0]?.attribute ||\n        nodeContents.lines?.[1]?.attribute\n      ) {\n        // console.log(\"matched by wild card attribute\");\n      } else {\n        unmatchedTerm = term;\n        break;\n      }\n    } else if (term === '![taken]') {\n      // TODO(bowei): actually process booleans. just special case this for now\n      if (!nodeTakenStatus.taken) {\n        // console.log(\"matched by !taken\");\n      } else {\n        unmatchedTerm = term;\n        break;\n      }\n    } else if (term === '[taken]' || term === 'taken') {\n      // TODO(bowei): actually process booleans. just special case this for now\n      if (nodeTakenStatus.taken) {\n        // console.log(\"matched by taken\");\n      } else {\n        unmatchedTerm = term;\n        break;\n      }\n    } else if (term === '![locked]') {\n      // TODO(bowei): actually process booleans. just special case this for now\n      if (!isLocked) {\n        // console.log(\"matched by !isLocked\");\n      } else {\n        unmatchedTerm = term;\n        break;\n      }\n    } else if (term === '[locked]' || term === 'locked') {\n      // TODO(bowei): actually process booleans. just special case this for now\n      if (isLocked) {\n        // console.log(\"matched by isLocked\");\n      } else {\n        unmatchedTerm = term;\n        break;\n      }\n    } else {\n      console.error('unparsed term: ', term);\n      return false;\n    }\n  }\n  if (unmatchedTerm) {\n    return false; // match failed\n  }\n  return true;\n}\n","import * as Pixi from 'pixi.js';\n\nexport interface SimpleTextureSet {\n  circle: Pixi.Texture;\n  dot: Pixi.Texture;\n  rect: Pixi.Texture;\n  square: Pixi.Texture;\n  verticalLine: Pixi.Texture;\n}\n\nconst WHITE = 0xffffff;\n\nexport type UiScale = 'x-small' | 'small' | 'medium' | 'large' | 'x-large';\n\n// export const pixiUiScale: UiScale = 'large';\n\nexport function generateSimpleTextures(\n  renderer: Pixi.Renderer,\n  uiScale: UiScale\n): SimpleTextureSet {\n  console.log('generating textures...', { uiScale });\n\n  let circle = new Pixi.Graphics();\n  let diameter =\n    uiScale === 'x-small'\n      ? 8\n      : uiScale === 'small'\n      ? 12\n      : uiScale === 'medium' || uiScale === 'large'\n      ? 16\n      : 24;\n  circle.beginFill(WHITE);\n  circle.drawCircle(0, 0, diameter / 2);\n  // circle.drawCircle(0, 0, 6);\n  // circle.pivot = PixiPointFrom(Vector2.Zero);\n\n  let rect = new Pixi.Graphics();\n  let height =\n    uiScale === 'x-small'\n      ? 10\n      : uiScale === 'small'\n      ? 14\n      : uiScale === 'medium' || uiScale === 'large'\n      ? 18\n      : 30;\n\n  {\n    let width =\n      uiScale === 'x-small'\n        ? 3\n        : uiScale === 'small'\n        ? 4\n        : uiScale === 'medium' || uiScale === 'large'\n        ? 5\n        : 8;\n    rect.beginFill(WHITE);\n    // rect.drawRect(-6, -10, 12, 20);\n    rect.drawRect(0, 0, width, height);\n    // rect.pivot = PixiPointFrom(Vector2.Zero);\n  }\n\n  // the cursor icon\n  let verticalLine = new Pixi.Graphics();\n  {\n    let thickness =\n      uiScale === 'x-small'\n        ? 1\n        : uiScale === 'small'\n        ? 2\n        : uiScale === 'medium' || uiScale === 'large'\n        ? 3\n        : 4;\n\n    let width =\n      uiScale === 'x-small'\n        ? 3\n        : uiScale === 'small' || uiScale === 'medium' || uiScale === 'large'\n        ? 6\n        : 8;\n\n    verticalLine.beginFill(WHITE);\n    verticalLine.drawRect(0, 0, thickness, height);\n    verticalLine.drawRect(0, 0, width, thickness);\n    verticalLine.drawRect(0, height - thickness, width, thickness);\n  }\n\n  let square = new Pixi.Graphics();\n  square.beginFill(WHITE);\n  square.drawRect(0, 0, diameter, diameter);\n  // square.pivot = PixiPointFrom(Vector2.Zero);\n\n  let dot = new Pixi.Graphics();\n  dot.beginFill(WHITE);\n  dot.drawCircle(0, 0, diameter / 4);\n\n  return {\n    circle: renderer.generateTexture(circle, Pixi.SCALE_MODES.LINEAR, 1),\n    rect: renderer.generateTexture(rect, Pixi.SCALE_MODES.LINEAR, 1),\n    square: renderer.generateTexture(square, Pixi.SCALE_MODES.LINEAR, 1),\n    verticalLine: renderer.generateTexture(\n      verticalLine,\n      Pixi.SCALE_MODES.LINEAR,\n      1\n    ),\n    dot: renderer.generateTexture(dot, Pixi.SCALE_MODES.LINEAR, 1),\n  };\n}\n","import * as Pixi from 'pixi.js';\nimport { Vector2 } from '../../lib/util/geometry/vector2';\nimport { GameState } from '../../data/GameState';\nimport {\n  generatePointNodeTexture,\n  PointNodeTextureSet,\n} from '../textures/PointNodeTexture';\nimport { Const } from '../../lib/util/misc';\nimport { Lazy } from '../../lib/util/lazy';\nimport { UpdaterGeneratorType2 } from '../../lib/util/updaterGenerator';\nimport { engageLifecycle, LifecycleHandlerBase } from './LifecycleHandler';\nimport { FixedCameraStageComponent } from './FixedCameraStageComponent';\nimport { TooltipInfo } from './TooltipComponent';\nimport COLORS from '../colors';\nimport {\n  extractStrategicHexGridSubState,\n  StrategicHexGridComponent,\n  StrategicHexGridComponentProps,\n} from './StrategicHexGridComponent';\nimport {\n  generateSimpleTextures,\n  SimpleTextureSet,\n} from '../textures/SimpleTextures';\nimport { uiScaleFromAppSize } from '../../components/GameArea/GameAreaInterface';\n\ntype State = {\n  pointNodeTexture: Lazy<PointNodeTextureSet>;\n  simpleTexture: Lazy<SimpleTextureSet>;\n  tick: number;\n  playerCurrentZ: number;\n  tooltip: TooltipInfo;\n};\n\ntype Props = {\n  args: {\n    renderer: Pixi.Renderer;\n    canvasElement: HTMLCanvasElement;\n    markForceUpdate: (childInstance: any) => void;\n  };\n  updaters: UpdaterGeneratorType2<GameState>;\n  delta: number;\n  gameState: Const<GameState>;\n  appSize: Vector2;\n};\n\nclass RootComponent2 extends LifecycleHandlerBase<Props, State> {\n  public container: Pixi.Container;\n  public state: Const<State>;\n  protected stateUpdaters!: UpdaterGeneratorType2<State, State>;\n  protected fireStateUpdaters!: () => void;\n\n  /* children */\n  // Contains HUD, and other entities that don't move when game camera moves\n  private fixedCameraStage: FixedCameraStageComponent;\n  // Contains game entities that move when game camera pans/zooms. Highly encouraged to have further subdivions.\n  private actionStage: Pixi.Container;\n  // Contains a few entities that doesn't move when game camera moves, but located behind action stage entities, e.g. static backgrounds\n  private backdropStage: Pixi.Container;\n  // public keyboard: KeyboardState;\n  private strategicHexGrid: StrategicHexGridComponent;\n\n  private backdrop: Pixi.Graphics;\n\n  constructor(props: Props) {\n    super(props);\n    this.container = new Pixi.Container();\n    this.container.sortableChildren = true;\n\n    // Initialize state, and also set up state updaters & batched fire callback\n    this.state = this.useState<State, RootComponent2>(this, {\n      pointNodeTexture: new Lazy(() =>\n        generatePointNodeTexture(props.args.renderer)\n      ),\n      simpleTexture: new Lazy(\n        () =>\n          generateSimpleTextures(\n            props.args.renderer,\n            uiScaleFromAppSize(this._staleProps.appSize)\n          ) // TODO(bowei): update uiScale when app size changes !!!\n      ),\n      tick: 0,\n      playerCurrentZ: 0,\n      tooltip: {\n        visible: false,\n        position: undefined,\n        text: '',\n      },\n    }).state;\n\n    const fixedCameraStagePropsFactory = (\n      props: Props,\n      state: Const<State>\n    ) => {\n      return {\n        args: {\n          renderer: props.args.renderer,\n          markForceUpdate: this.markForceUpdate,\n        },\n        delta: props.delta,\n        gameState: props.gameState,\n        appSize: props.appSize,\n        tick: state.tick,\n        tooltip: { ...state.tooltip },\n      };\n    };\n    this.fixedCameraStage = new FixedCameraStageComponent(\n      fixedCameraStagePropsFactory(props, this.state)\n    );\n    this.addChild({\n      childClass: FixedCameraStageComponent,\n      instance: this.fixedCameraStage,\n      propsFactory: fixedCameraStagePropsFactory,\n    });\n\n    this.actionStage = new Pixi.Sprite();\n    this.actionStage.zIndex = 0;\n    this.actionStage.sortableChildren = true;\n    this.container.addChild(this.actionStage);\n\n    const strategicHexGridPropsFactory = (\n      props: Props,\n      state: Const<State>\n    ): StrategicHexGridComponentProps => {\n      const { gameState } = props;\n      return {\n        delta: props.delta,\n        args: {\n          position: Vector2.Zero,\n          textures: state.simpleTexture,\n        },\n        updaters: props.updaters,\n        appSize: props.appSize,\n        gameState: extractStrategicHexGridSubState(gameState),\n      };\n    };\n    this.strategicHexGrid = new StrategicHexGridComponent(\n      strategicHexGridPropsFactory(props, this.state)\n    );\n    this.addChild({\n      childClass: StrategicHexGridComponent,\n      instance: this.strategicHexGrid,\n      propsFactory: strategicHexGridPropsFactory,\n    });\n\n    this.backdropStage = new Pixi.Sprite();\n    this.backdropStage.zIndex = -1;\n    this.backdropStage.sortableChildren = true;\n    this.container.addChild(this.backdropStage);\n\n    this.backdrop = new Pixi.Graphics();\n    this.backdropStage.addChild(this.backdrop);\n    this.backdrop.beginFill(COLORS.backgroundBlue, 1);\n    // backdrop.alpha = 0.5; // if alpha == 0, Pixi does not register this as a hittable area\n    this.backdrop.interactive = true;\n    // backdrop.interactiveChildren = true; // not sure what this does\n    this.backdrop.drawRect(0, 0, props.appSize.x, props.appSize.y);\n  }\n\n  protected updateSelf(props: Props) {\n    this.stateUpdaters.tick.enqueueUpdate((prev) => prev + 1);\n  }\n\n  protected renderSelf(props: Props) {\n    this.backdrop.width = props.appSize.x;\n    this.backdrop.height = props.appSize.y;\n  }\n\n  private onWheel = (e: WheelEvent) => {\n    // console.log('wheel on pixi', e);\n  };\n  private onScroll = (e: Event) => {\n    // doesnt work\n    // console.log('scroll on pixi', e);\n  };\n\n  protected didMount() {\n    const {\n      args: { canvasElement },\n    } = this._staleProps;\n    canvasElement.addEventListener('wheel', this.onWheel);\n    canvasElement.addEventListener('scroll', this.onScroll);\n  }\n\n  protected didUpdate() {\n    // const { updaters } = this._staleProps;\n  }\n\n  public willUnmount() {\n    const {\n      args: { canvasElement },\n    } = this._staleProps;\n    canvasElement.removeEventListener('wheel', this.onWheel);\n    canvasElement.removeEventListener('scroll', this.onScroll);\n  }\n}\n\nconst wrapped = engageLifecycle(RootComponent2);\n// eslint-disable-next-line\ntype wrapped = RootComponent2;\nexport { wrapped as RootComponent };\nexport type { Props as RootComponentProps, State as RootComponentState };\n","import * as Pixi from 'pixi.js';\nimport COLORS from '../colors';\nimport { RenderedChunkConstants } from '../components/ChunkComponent';\n\nexport type PointNodeTextureSet = {\n  cropFraction: number;\n  texture: Pixi.Texture;\n}[];\n\nexport function generatePointNodeTexture(\n  renderer: Pixi.Renderer\n): PointNodeTextureSet {\n  // generate sprite textures for 0 to 100% vertical cropped in increments of 1/8\n  let textureSet: PointNodeTextureSet = [];\n  for (let i = 0; i <= 8; i++) {\n    const cropFraction = i / 8;\n    let g = new Pixi.Graphics();\n    g.beginFill(COLORS.white);\n    g.drawRoundedRect(\n      -RenderedChunkConstants.NODE_SIZE_PX / 2,\n      -RenderedChunkConstants.NODE_SIZE_PX / 2,\n      RenderedChunkConstants.NODE_SIZE_PX,\n      RenderedChunkConstants.NODE_SIZE_PX,\n      RenderedChunkConstants.NODE_ROUNDED_PX\n    );\n    let mask = new Pixi.Graphics();\n    mask.beginFill(COLORS.black);\n    mask.drawRect(\n      -RenderedChunkConstants.NODE_SIZE_PX / 2,\n      -RenderedChunkConstants.NODE_SIZE_PX / 2,\n      RenderedChunkConstants.NODE_SIZE_PX,\n      RenderedChunkConstants.NODE_SIZE_PX * cropFraction\n    );\n    g.mask = mask;\n    // g.x = 200;\n    // g.y = 200;\n    // this.app.stage.addChild(g);\n    // let texture = renderer.generateTexture(g, Pixi.SCALE_MODES.NEAREST, 1);\n    let texture = renderer.generateTexture(g, Pixi.SCALE_MODES.LINEAR, 1);\n    // const sprite = new Pixi.Sprite(texture);\n    // sprite.x = 300;\n    // sprite.y = 300;\n    // this.app.stage.addChild(sprite);\n    textureSet.push({\n      cropFraction,\n      texture,\n    });\n  }\n  return textureSet;\n}\n","import * as Pixi from 'pixi.js';\nimport { Vector2 } from '../lib/util/geometry/vector2';\nimport { GameState } from '../data/GameState';\n// eslint-disable-next-line\nimport { assertOnlyCalledOnce, Const } from '../lib/util/misc';\nimport { RootComponent } from './components/RootComponent';\nimport { UpdaterGeneratorType2 } from '../lib/util/updaterGenerator';\nimport COLORS from './colors';\n// eslint-disable-next-line\nimport createBunnyExample from './BunnyExample';\nimport { appSizeFromWindowSize } from '../data/WindowState';\n\ntype Props = {\n  args: {\n    fireBatch: () => void;\n    isSecondConstructorCall: boolean;\n  };\n  updaters: UpdaterGeneratorType2<GameState>; // aka updaters\n  gameState: Const<GameState>;\n};\n\ntype State = {\n  appSize: Vector2;\n  originalAppSize: Vector2;\n};\n\nconst DEFAULT_APP_SIZE = new Vector2(800, 600);\n\nexport const PIXI_TICKS_PER_SECOND = 60; // pixi's onTick [delta] parameter is measured in ticks -- use this to convert to seconds\n\n// pixi code will not run while it is backgrounded, to save compute, but will run every [BACKGROUND_UPDATE_INTERVAL_TICKS] to keep roughly up-to-date\nconst BACKGROUND_UPDATE_INTERVAL_TICKS = 60;\n\n/**\n * Pixi side of a pixi-react bridge. This class owns a pixi application and receives props updates from react by way of rerender().\n * Those props updates do not apply immediately but are queued up and apply all at once on the next tick in the baseGameLoop().\n * Kicks off the pixi component lifecycle handling by updating props on Pixi RootComponent.\n */\nexport class PixiReactBridge {\n  public app!: Pixi.Application;\n\n  state!: State;\n  props!: Props;\n  private staleProps?: Props;\n\n  rootComponent: RootComponent | null = null;\n  onTick!: (d: number) => void;\n\n  /**\n   * NOTE: for lifecycle convenience, we allow initializing with essentially empty props, and to finish the initialization\n   * lazily at the first rerender() call\n   * NOTE: this causes an annoying flash since we don't know the initial window size\n   */\n  constructor(props?: Props, isSecondConstructorCall: boolean = false) {\n    // verify that we are not loading this twice when we expect to load it only once -- bad for performance!!\n    if (!(props?.args?.isSecondConstructorCall || isSecondConstructorCall)) {\n      // assertOnlyCalledOnce(\"Pixi react bridge constructor\"); // annoying with react hot reload, disable for now}\n    }\n\n    let appSize = DEFAULT_APP_SIZE;\n    this.state = {\n      appSize,\n      originalAppSize: appSize,\n    };\n\n    this.app = new Pixi.Application({\n      width: this.state.appSize.x,\n      height: this.state.appSize.y,\n      antialias: true, // both about the same FPS, i get around 30 fps on 1600 x 900\n      transparent: true, // true -> better fps?? https://github.com/pixijs/pixi.js/issues/5580\n      resolution: window.devicePixelRatio || 1, // lower -> more FPS but uglier\n      // resolution: 0.5, // DO NOT use this, this is fuzzy as heck\n      // resolution: 2,\n      autoDensity: true,\n      powerPreference: 'low-power', // the only valid one for webgl\n      backgroundColor: COLORS.white, // immaterial - we recommend setting color in backdrop graphics\n    });\n\n    // test\n    // createBunnyExample({ parent: this.app.stage, ticker: this.app.ticker, x: this.app.screen.width / 2, y: this.app.screen.height / 2 });\n  }\n\n  public pause() {\n    this.app.ticker.remove(this.onTick);\n  }\n  public destroy() {\n    this.app.destroy(true, {\n      children: true,\n      texture: true,\n      baseTexture: true,\n    });\n  }\n\n  public willMount() {\n    // we forgot to set app size properly when pixi first loaded, so do it now\n    this.state.appSize = appSizeFromWindowSize(\n      new Vector2(\n        this.props.gameState.windowState.innerWidth,\n        this.props.gameState.windowState.innerHeight\n      )\n    );\n  }\n\n  public didMount() {\n    this.onTick = (delta) => this.baseGameLoop(delta);\n    this.onTick = this.onTick.bind(this);\n    this.app.ticker.add(this.onTick);\n\n    // we forgot to set app size properly when pixi first loaded, so do it now (????? TODO bowei remove)\n    this.state.appSize = appSizeFromWindowSize(\n      new Vector2(\n        this.props.gameState.windowState.innerWidth,\n        this.props.gameState.windowState.innerHeight\n      )\n    );\n  }\n\n  /**\n   * Please only call once!!\n   * Usage: const container = useRef<HTMLDivElement>(null); useEffect(() => { application.register(container.current!); }, []);\n   */\n  public register(curr: HTMLDivElement) {\n    curr.appendChild(this.app.view);\n  }\n\n  updateSelf(props: Props, staleProps?: Props) {\n    if (props === staleProps) {\n      props.updaters.tick.enqueueUpdate((it) => it + 1); // TODO(bowei): reneable this\n      return;\n    }\n\n    // memoize: compute app state from window state dimensions only if they changed from last tick\n    if (\n      !(\n        props.gameState.windowState.innerWidth ===\n          staleProps?.gameState.windowState.innerWidth &&\n        props.gameState.windowState.innerHeight ===\n          staleProps?.gameState.windowState.innerHeight\n      )\n    ) {\n      // console.log(\n      //   'update self inner',\n      //   props.gameState.windowState,\n      //   staleProps?.gameState.windowState\n      // );\n      this.state.appSize = appSizeFromWindowSize(\n        new Vector2(\n          props.gameState.windowState.innerWidth,\n          props.gameState.windowState.innerHeight\n        )\n      );\n    }\n\n    props.updaters.tick.enqueueUpdate((it) => it + 1); // TODO(bowei): reneable this\n  }\n\n  // shim, called from react, possibly many times , possibly at any time, including during the baseGameLoop below\n  // props should be a referentially distinct object from props the last time this was called\n  rerender(futureProps: Props) {\n    if (this.rootComponent && this.props === futureProps) {\n      // skip updating props if we're already initialized and there's no new props object\n      return;\n    }\n\n    // console.log('base app rerender called');\n\n    // take the props handed down from react (probably due to our own props.updaters.fireBatch() call, see game loop) and\n    // record them for future use. note that the future props do not take effect down the child hierarchy unless they are\n    // manually told to do so.\n    this.props = futureProps;\n\n    // If we're not done initializing yet (note that constructor does not set props!), finish it now\n    if (!this.rootComponent) {\n      // finish initialization\n      this.willMount();\n      this.rootComponent = new RootComponent({\n        args: {\n          renderer: this.app.renderer,\n          markForceUpdate: () => {},\n          canvasElement: this.app.view,\n        },\n        updaters: this.props.updaters,\n        delta: 0,\n        gameState: this.props.gameState,\n        appSize: this.state.appSize,\n      });\n      this.app.stage.addChild(this.rootComponent.container);\n\n      this.renderSelf(this.props);\n\n      // test\n      // createBunnyExample({ parent: this.app.stage, ticker: this.app.ticker, x: this.app.screen.width / 2, y: this.app.screen.height / 2 });\n      this.didMount();\n    }\n  }\n\n  renderSelf(props: Props) {\n    this.app.renderer.resize(this.state.appSize.x, this.state.appSize.y);\n  }\n\n  /**\n   *\n   * @param delta passed from pixi - indicates the amount of time elapsed since this function was last called, measured in ticks.\n   * fairly sure tick is exactly 1/60 sec, but might depend on pixi default FPS (120 on some systems???)\n   */\n  baseGameLoop(delta: number): void {\n    if (this.props.gameState.playerUI.isPixiHidden) {\n      if (this.props.gameState.tick % BACKGROUND_UPDATE_INTERVAL_TICKS === 0) {\n        // console.log('computing pixi update even though pixi is not visible');\n      } else {\n        // console.log('skipping update since pixi is not visible');\n        // have to manually update the tick number since updateSelf is not being called, because staleProps is not being updated\n        this.props.updaters.tick.enqueueUpdate((it) => it + 1); // TODO(bowei): reneable this\n        this.props.args.fireBatch(); // fire enqueued game state updates, which should come back from react in the rerender()\n        return; // skip update loop if pixi is hidden\n      }\n    }\n    // assume props is up to date\n    this.updateSelf(this.props, this.staleProps);\n\n    // send props downwards\n    this.rootComponent?.update({\n      args: {\n        renderer: this.app.renderer,\n        markForceUpdate: () => {},\n        canvasElement: this.app.view,\n      },\n      updaters: this.props.updaters,\n      delta,\n      gameState: this.props.gameState,\n      appSize: this.state.appSize,\n    });\n\n    this.renderSelf(this.props);\n    this.staleProps = this.props;\n    this.props.args.fireBatch(); // fire enqueued game state updates, which should come back from react in the rerender()\n  }\n}\n","import React, { useContext, useEffect, useRef, useState } from 'react';\nimport { UseGameStateContext } from '../contexts';\nimport { PixiReactBridge } from '../pixi/PixiReactBridge';\nimport { Lazy } from '../lib/util/lazy';\n\nconst initialApplication = new Lazy(() => new PixiReactBridge());\n\n/**\n * React side of a pixi-react bridge. This react component owns the div which own the canvas element,\n * and send rerender props updates to pixi application when react causes state to be updated.\n */\nexport function PixiWrapperComponent(props: { hidden: boolean }) {\n  const [gameState, gameStateUpdaters, fireBatchedSetGameState] =\n    useContext(UseGameStateContext);\n  const [application] = useState(initialApplication.get());\n  const container = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    // remove old application if it exists\n    for (let i = container.current!.childNodes.length - 1; i >= 0; i--) {\n      container.current!.removeChild(container.current!.childNodes[i]);\n    }\n    // add the application\n    container.current!.appendChild(application.app.view);\n  }, [application]);\n\n  // Trigger component render on first load and also when game state is updated\n  // wrap in useeffect to avoid triggering every react render (130+ UPS) and only check every pixi render (60fps)\n  useEffect(() => {\n    application.rerender({\n      args: {\n        fireBatch: fireBatchedSetGameState,\n        isSecondConstructorCall: false,\n      },\n      updaters: gameStateUpdaters,\n      gameState,\n    });\n  }, [application, fireBatchedSetGameState, gameStateUpdaters, gameState]);\n\n  return (\n    <>\n      <div ref={container} hidden={props.hidden} style={{}} />\n    </>\n  );\n}\n","import React from 'react';\n// import UAParser from 'ua-parser-js';\nimport { GameState } from '../data/GameState';\nimport { WindowState } from '../data/WindowState';\nimport { UpdaterGeneratorType2 } from '../lib/util/updaterGenerator';\n\ntype Props = {\n  updaters: UpdaterGeneratorType2<WindowState, GameState>;\n};\n\ntype State = {};\n\n// TODO(bowei): on mobile, for either ios or android, when in portrait locked orientation, we want to serve a landscape\n// experience - similar to a native app which is landscape locked.\n// (on mobile in already landscape orientation, and in all desktop, serve ordinary orientation.)\n// also note that android webapp supports manifest.json setting orientation, but not in the browser\n// FOR NOW - ignore this\n// https://developer.mozilla.org/en-US/docs/Web/API/CSS_Object_Model/Managing_screen_orientation\n// https://stackoverflow.com/questions/14360581/force-landscape-orientation-mode\n\n// const browser = new UAParser().getBrowser();\n// let forceRotate = false;\n// if (\n//   browser.name === 'Mobile Safari' &&\n//   window.innerWidth < window.innerHeight\n// ) {\n//   forceRotate = true;\n// }\n//     <div className={classnames({ App: true, \"force-landscape\": forceRotate })}>\n/*\n.force-landscape {\n  transform: rotate(90deg);\n}\n*/\n\n/**\n * Empty react element with listeners for window changes.\n */\nexport class WindowListenerComponent extends React.Component<Props, State> {\n  constructor(props: Props) {\n    super(props);\n    this.state = {};\n  }\n\n  componentDidMount() {\n    window.addEventListener('resize', this.handleWindowResize);\n    window.addEventListener('orientationchange', this.handleWindowResize);\n  }\n\n  // NOTE(bowei): does using e.repeat here break when window loses focus??\n  private handleWindowResize = (e: UIEvent | Event) => {\n    const newSize = {\n      innerWidth: window.innerWidth,\n      innerHeight: window.innerHeight,\n    };\n    this.props.updaters.enqueueUpdate((prev) => {\n      // console.log(\"executing window state update in window onresize in app\");\n      // const result = { ...prev };\n      // result.innerWidth = window.innerWidth;\n      // result.innerHeight = window.innerHeight;\n      // return result;\n      return {\n        ...prev,\n        ...newSize,\n      };\n    });\n  };\n\n  componentWillUnmount() {\n    window.removeEventListener('resize', this.handleWindowResize);\n    window.removeEventListener('orientationchange', this.handleWindowResize);\n  }\n  render() {\n    return <> </>;\n  }\n}\n","import { GameState } from '../../data/GameState';\nimport { NodeReachableStatus, NodeVisibleStatus } from '../../data/NodeStatus';\nimport { HashMap, KeyedHashMap } from '../../lib/util/data_structures/hash';\nimport { Vector3 } from '../../lib/util/geometry/vector3';\nimport { Const, extractDeps } from '../../lib/util/misc';\nimport { UpdaterGeneratorType2 } from '../../lib/util/updaterGenerator';\nimport {\n  flowFogOfWarFromNode,\n  flowReachableFromNode,\n  markAccessibleNodes,\n} from '../GameStateFactory';\nimport { ERA_ACCESSIBLE_RADII } from './AllocateNode';\n\nfunction _extract(gameState: Const<GameState>) {\n  return {\n    playerSave: {\n      currentEra: gameState.playerSave.currentEra,\n    },\n  };\n}\nexport function extractProgressNextEraCheckState(g: ProgressNextEraCheckState) {\n  return _extract(g as GameState);\n}\n\nexport type ProgressNextEraCheckState = ReturnType<typeof _extract>;\nexport const depsProgressNextEraCheckState = extractDeps(\n  extractProgressNextEraCheckState\n);\n\ntype ProgressNextEraInput = {};\ntype ProgressNextEraResult = boolean;\n\n/**\n * Stateless action wrapper over updaters.\n * Represents the action of de-allocating a node.\n */\nexport class ProgressNextEraAction {\n  updaters: UpdaterGeneratorType2<GameState, GameState>;\n\n  constructor(updaters: UpdaterGeneratorType2<GameState, GameState>) {\n    this.updaters = updaters;\n  }\n\n  /**\n   * Unchecked.\n   *\n   * Progress the era.\n   * @param input\n   */\n  enqueueAction(input: ProgressNextEraInput) {\n    // increment index & type\n    this.updaters.playerSave.currentEra.enqueueUpdate((prev) => {\n      // if (prev.type === 'A') {\n      //   return { ...prev, type: 'B' };\n      // } else {\n      //   return {\n      //     ...prev,\n      //     type: 'A',\n      //     index: prev.index + 1,\n      //   };\n      // }\n      return {\n        ...prev,\n        type: 'B',\n        index: prev.index + 1,\n      };\n    });\n\n    // flow accessible\n    this.updaters.computed.accessibleStatusMap.enqueueUpdate(\n      (prev, prevGameState) => {\n        if (!prev) return prev;\n        // if (prevGameState.playerSave.currentEra.type === 'A') {\n        let result: typeof prev | null = null;\n        result = markAccessibleNodes({ result, prev, prevGameState });\n        return result || prev;\n        // }\n        // return prev;\n      }\n    );\n\n    // if we just transitioned from B to A, clear all bookmarks\n    this.updaters.playerSave.bookmarkedStatusMap.enqueueUpdate(\n      (prev, prevGameState) => {\n        if (prevGameState.playerSave.currentEra.type === 'A') {\n          return new KeyedHashMap();\n        } else {\n          return prev;\n        }\n      }\n    );\n\n    // flow fog of war from ossified taken nodes, and also make sure to distinguish obscured/hinted/revealed\n    this.updaters.computed.fogOfWarStatusMap.enqueueUpdate(\n      (prev, prevGameState) => {\n        if (!prev) return prev;\n\n        let result: HashMap<Vector3, NodeVisibleStatus> | null = null;\n        let nodes = prevGameState.playerSave.allocationStatusMap\n          .entries()\n          .filter(([n, status]) => {\n            return status.taken === true;\n          })\n          .map((it) => it[0]);\n\n        nodes = nodes.concat(\n          prevGameState.playerSave.exploredStatusMap\n            .entries()\n            .filter(([n, status]) => {\n              return status.explored === true;\n            })\n            .map((it) => it[0])\n        );\n\n        nodes.forEach((nodeLocation) => {\n          result = flowFogOfWarFromNode({\n            result,\n            prev,\n            prevGameState,\n            nodeLocation,\n          });\n        });\n\n        return result || prev;\n      }\n    );\n\n    // also flow reachable (shows adjacent locks)\n    this.updaters.computed.reachableStatusMap.enqueueUpdate(\n      (prev, prevGameState) => {\n        if (!prev) return prev;\n\n        let result: HashMap<Vector3, NodeReachableStatus> | null = null;\n        prevGameState.playerSave.allocationStatusMap\n          .entries()\n          .filter(([n, status]) => {\n            return status.taken === true;\n          })\n          .map((it) => it[0])\n          .forEach((nodeLocation) => {\n            result = flowReachableFromNode({\n              result,\n              prev,\n              prevGameState,\n              nodeLocation,\n            });\n          });\n\n        return result || prev;\n      }\n    );\n  }\n\n  /**\n   * Stateless function to provide a pre-flight check before actually performing the action.\n   *\n   * @param input\n   * @param gameState\n   * @returns true if the action can be taken based on the game state, false otherwise\n   */\n  static checkAction(\n    input: ProgressNextEraInput,\n    gameState: ProgressNextEraCheckState\n  ): ProgressNextEraResult {\n    if (gameState.playerSave.currentEra.type === 'B') {\n      const index = gameState.playerSave.currentEra.index;\n      if (!ERA_ACCESSIBLE_RADII[index + 1]) {\n        // no data for the next era\n        return false;\n      }\n    }\n    return true;\n  }\n\n  /**\n   * First checks to see if the action can be performed, then performs it and returns true if successful or false otherwise.\n   *\n   * @param input\n   * @param gameState\n   * @returns\n   */\n  run(\n    input: ProgressNextEraInput,\n    gameState: ProgressNextEraCheckState\n  ): ProgressNextEraResult {\n    const check = ProgressNextEraAction.checkAction(input, gameState);\n    if (check) {\n      this.enqueueAction(input);\n    }\n    return check;\n  }\n}\n","import React, { useCallback, useEffect, useMemo, useState } from 'react';\nimport { GameState } from '../data/GameState';\nimport { ERA_SP_LIMITS } from '../game/actions/AllocateNode';\nimport {\n  depsProgressNextEraCheckState,\n  extractProgressNextEraCheckState,\n  ProgressNextEraAction,\n} from '../game/actions/ProgressNextEra';\nimport { Const, extractDeps } from '../lib/util/misc';\nimport { UpdaterGeneratorType2 } from '../lib/util/updaterGenerator';\nimport './HudTopComponent.css';\n\nexport function extractHudTopSubState(g: HudTopSubState) {\n  return _extract(g as GameState);\n}\n\nfunction _extract(gameState: Const<GameState>) {\n  return {\n    playerSave: {\n      allocationStatusMap: gameState.playerSave.allocationStatusMap,\n      bookmarkedStatusMap: gameState.playerSave.bookmarkedStatusMap,\n      currentEra: gameState.playerSave.currentEra,\n    },\n    intent: {\n      newIntent: {\n        MAYBE_PROGRESS_NEXT_ERA:\n          gameState.intent.newIntent.MAYBE_PROGRESS_NEXT_ERA,\n      },\n    },\n  };\n}\nexport type HudTopSubState = ReturnType<typeof _extract>;\nexport const depsGameGridSubState = extractDeps(extractHudTopSubState);\n\nexport function HudTopComponent(props: {\n  gameState: GameState;\n  updaters: UpdaterGeneratorType2<GameState, GameState>;\n}) {\n  const { gameState, updaters } = props;\n  const [isLocked, setLocked] = useState(true);\n\n  // delay 10 secs after unlocking, then it should relock itself\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      setLocked(true);\n    }, 3000);\n\n    return () => clearTimeout(timer);\n  }, [isLocked]);\n\n  const actions = useMemo(() => {\n    return {\n      progressNextEra: new ProgressNextEraAction(updaters),\n    };\n  }, [updaters]);\n\n  const progressNextEraCheckState = useMemo(() => {\n    return extractProgressNextEraCheckState(gameState);\n    // TODO(bowei): use custom hook here so react doesnt complain so much\n    // eslint-disable-next-line\n  }, depsProgressNextEraCheckState(gameState));\n\n  const canProgressNextEra = useMemo(() => {\n    return ProgressNextEraAction.checkAction({}, progressNextEraCheckState);\n  }, [progressNextEraCheckState]);\n\n  const progressNextEra = useCallback(\n    (e?: React.MouseEvent) => {\n      setLocked(true);\n\n      actions.progressNextEra.run({}, progressNextEraCheckState);\n    },\n    [actions, progressNextEraCheckState]\n  );\n\n  useEffect(() => {\n    if (gameState.intent.newIntent.MAYBE_PROGRESS_NEXT_ERA) {\n      setLocked((isLocked) => {\n        if (isLocked) return false;\n        else progressNextEra();\n        return true;\n      });\n      // if (isLocked) {\n      //   setLocked(false);\n      // } else {\n      //   progressNextEra();\n      // }\n    }\n  }, [gameState.intent.newIntent.MAYBE_PROGRESS_NEXT_ERA, progressNextEra]);\n\n  const maxAllocationPoints =\n    ERA_SP_LIMITS[gameState.playerSave.currentEra.index] -\n    ERA_SP_LIMITS[gameState.playerSave.currentEra.index - 1];\n\n  const remainingAllocationPoints =\n    maxAllocationPoints -\n    (gameState.playerSave.currentEra.type === 'A'\n      ? gameState.playerSave.bookmarkedStatusMap.size()\n      : gameState.playerSave.allocationStatusMap.size() -\n        ERA_SP_LIMITS[gameState.playerSave.currentEra.index - 1]);\n\n  const eraTooltip =\n    gameState.playerSave.currentEra.type === 'A' ? (\n      <>\n        <div>Explore the grid</div>\n        <div>and plan out</div>\n        <div>the next phase.</div>\n      </>\n    ) : gameState.playerSave.currentEra.type === 'B' ? (\n      <>\n        <div>Exploit the</div>\n        <div>resources and</div>\n        <div>complete quests.</div>\n      </>\n    ) : (\n      <>\n        <div>Choose how to</div>\n        <div>expand the hidden</div>\n        <div>area to explore.</div>\n      </>\n    );\n\n  const eraName =\n    gameState.playerSave.currentEra.type === 'A'\n      ? 'Explore'\n      : gameState.playerSave.currentEra.type === 'B'\n      ? 'Exploit'\n      : 'Expand';\n\n  const pointTypeName =\n    gameState.playerSave.currentEra.type === 'A' ? 'Exploration' : 'Allocation';\n\n  return (\n    <div className=\"hud-top-zone\">\n      <div className=\"hud-text-box\">\n        {pointTypeName[0]}P: {remainingAllocationPoints}/{maxAllocationPoints}\n        <div className=\"hover-only empty-positioned\">\n          <div className=\"absolute-positioned hud-text-box-tooltip\">\n            <div>{pointTypeName} points</div>\n            <div>(remaining/total).</div>\n          </div>\n        </div>\n      </div>\n      <div className=\"hud-text-box\">\n        DP:{' '}\n        {gameState.playerSave.currentEra.type === 'B'\n          ? gameState.playerSave.deallocationPoints.remaining +\n            '/' +\n            gameState.playerSave.deallocationPoints.provided\n          : '--'}\n        <div className=\"hover-only empty-positioned\">\n          <div className=\"absolute-positioned hud-text-box-tooltip\">\n            <div>Deallocation points</div>\n            <div>(remaining/total).</div>\n          </div>\n        </div>\n      </div>\n      <div className=\"hud-text-box\">\n        Era: {gameState.playerSave.currentEra.index}-{eraName}\n        <div className=\"hover-only empty-positioned\">\n          <div className=\"absolute-positioned hud-text-box-tooltip\">\n            <div>Era (number-type).</div>\n            <br />\n            {eraTooltip}\n          </div>\n        </div>\n      </div>\n      <button\n        className=\"hud-top-button button-1\"\n        disabled={isLocked || !canProgressNextEra}\n        onClick={progressNextEra}\n      >\n        Next era (hotkey: g)\n      </button>\n      <button\n        className=\"hud-top-button button-2\"\n        onClick={() => {\n          setLocked((it) => !it);\n        }}\n      >\n        {isLocked ? '🔓' : '🔒'}\n      </button>\n    </div>\n  );\n}\n","import React from 'react';\n\nimport './Sidebar.css';\n\nexport default function Sidebar(props: {\n  children: React.ReactNode;\n  hidden: boolean;\n  placement: 'left' | 'right';\n}) {\n  const { children, hidden, placement } = props;\n\n  return (\n    <div\n      className={\n        placement === 'left' ? 'layout left-sidebar' : 'layout right-sidebar'\n      }\n      hidden={hidden}\n    >\n      <>{children}</>\n    </div>\n  );\n}\n","import React, { useCallback } from 'react';\nimport './Tabs.css';\n\nexport const Tabs = React.memo(Component);\n\nfunction Component(props: {\n  value: number;\n  labels: React.ReactNode[];\n  onChange: (t: number) => void;\n}) {\n  const { value, labels, onChange } = props;\n  return (\n    <div className={'tab-label-container'}>\n      {labels.map((label: React.ReactNode, i: number) => (\n        <Tab onClick={onChange} value={i} active={value === i} key={i}>\n          {label}\n        </Tab>\n      ))}\n    </div>\n  );\n}\n\nconst Tab = React.memo(TabComponent);\n\nfunction TabComponent(props: {\n  onClick: (t: number) => void;\n  value: number;\n  active: boolean;\n  children: React.ReactNode;\n}) {\n  const { onClick, value, active, children } = props;\n  const handleClick = useCallback(() => {\n    onClick(value);\n  }, [onClick, value]);\n  return (\n    <div className={active ? 'tab-label active' : 'tab-label inactive'}>\n      <div onClick={handleClick}>{children}</div>\n    </div>\n  );\n}\n","import './SidebarsInterface.css';\nimport React, { useCallback, useMemo } from 'react';\nimport { GameState } from '../../data/GameState';\nimport { UpdaterGeneratorType2 } from '../../lib/util/updaterGenerator';\nimport Sidebar from './Sidebar';\nimport { Tabs } from './Tabs';\nimport { TabContentInterface, TAB_NAME } from './TabContentInterface';\nimport { AllocateNodeAction } from '../../game/actions/AllocateNode';\nimport { DeallocateNodeAction } from '../../game/actions/DeallocateNode';\n\nexport const emptyTabLabels: TAB_NAME[] = [TAB_NAME.EMPTY];\nexport const initialTabLabels: TAB_NAME[] = [\n  TAB_NAME.SELECTED_NODE,\n  TAB_NAME.STATS,\n  TAB_NAME.QUESTS,\n  TAB_NAME.DEBUG,\n  TAB_NAME.HELP,\n  TAB_NAME.STRATEGIC_VIEW,\n];\n\n/**\n * Manages both sidebars (left & right) as well as anything directly adjacent to them.\n */\nexport function SidebarsInterface(props: {\n  gameState: GameState;\n  updaters: UpdaterGeneratorType2<GameState, GameState>;\n}) {\n  // NOTE(bowei): commenting out this entire component subtree increases react rerenders per sec from 80-ish to 100-ish while doing nothing other than scrolling (jumps disabled)\n  const { gameState, updaters } = props;\n\n  const setLeftSidebarHidden = useCallback(() => {\n    updaters.playerUI.isSidebarOpen.enqueueUpdate(() => false);\n    updaters.playerUI.isLeftSidebarOpen.enqueueUpdate(() => false);\n  }, [updaters]);\n  const setLeftSidebarUnhidden = useCallback(() => {\n    updaters.playerUI.isSidebarOpen.enqueueUpdate(() => true);\n    updaters.playerUI.isLeftSidebarOpen.enqueueUpdate(() => true);\n  }, [updaters]);\n  const setRightSidebarHidden = useCallback(() => {\n    updaters.playerUI.isSidebarOpen.enqueueUpdate(() => false);\n    updaters.playerUI.isRightSidebarOpen.enqueueUpdate(() => false);\n  }, [updaters]);\n  const setRightSidebarUnhidden = useCallback(() => {\n    updaters.playerUI.isSidebarOpen.enqueueUpdate(() => true);\n    updaters.playerUI.isRightSidebarOpen.enqueueUpdate(() => true);\n  }, [updaters]);\n\n  const tabsState = gameState.playerUI.tabs;\n  const tabsUpdaters = updaters.playerUI.tabs;\n\n  const leftSidebarTabs = tabsState.left.tabs;\n  const rightSidebarTabs = tabsState.right.tabs;\n  const leftActiveTabIndex = tabsState.left.activeIndex;\n  const rightActiveTabIndex = tabsState.right.activeIndex;\n  const setLeftSidebarTabs = tabsUpdaters.left.tabs.enqueueUpdate;\n  const setRightSidebarTabs = tabsUpdaters.right.tabs.enqueueUpdate;\n  const setLeftActiveTabIndex = tabsUpdaters.left.activeIndex.enqueueUpdate;\n  const setRightActiveTabIndex = tabsUpdaters.right.activeIndex.enqueueUpdate;\n\n  // const [leftSidebarTabs, setLeftSidebarTabs] = useState<TAB_NAME[]>([]);\n  // const [rightSidebarTabs, setRightSidebarTabs] = useState<TAB_NAME[]>(initialTabLabels);\n  // const [leftActiveTabIndex, setLeftActiveTabIndex] = useState(0);\n  // const [rightActiveTabIndex, setRightActiveTabIndex] = useState(0);\n\n  const onSendTabLeft = useCallback(() => {\n    if (rightSidebarTabs.length === 0) {\n      return;\n    }\n    const currentRightTab = rightSidebarTabs[rightActiveTabIndex];\n    if (currentRightTab === undefined) {\n      return;\n    }\n    const newRightSidebarTabs = rightSidebarTabs\n      .slice(0, rightActiveTabIndex)\n      .concat(rightSidebarTabs.slice(rightActiveTabIndex + 1));\n    setRightSidebarTabs(newRightSidebarTabs);\n    setRightActiveTabIndex(\n      Math.max(0, Math.min(rightActiveTabIndex, newRightSidebarTabs.length - 1))\n    );\n    const newLeftSidebarTabs = [...leftSidebarTabs, currentRightTab];\n    setLeftSidebarTabs(newLeftSidebarTabs);\n    setLeftActiveTabIndex(newLeftSidebarTabs.length - 1);\n    setLeftSidebarUnhidden();\n  }, [\n    leftSidebarTabs,\n    setLeftSidebarTabs,\n    rightSidebarTabs,\n    setRightSidebarTabs,\n    setLeftActiveTabIndex,\n    rightActiveTabIndex,\n    setRightActiveTabIndex,\n    setLeftSidebarUnhidden,\n  ]);\n\n  const onSendTabRight = useCallback(() => {\n    if (leftSidebarTabs.length === 0) {\n      return;\n    }\n    const currentLeftTab = leftSidebarTabs[leftActiveTabIndex];\n    if (currentLeftTab === undefined) {\n      return;\n    }\n    const newLeftSidebarTabs = leftSidebarTabs\n      .slice(0, leftActiveTabIndex)\n      .concat(leftSidebarTabs.slice(leftActiveTabIndex + 1));\n    setLeftSidebarTabs(newLeftSidebarTabs);\n    setLeftActiveTabIndex(\n      Math.max(Math.min(leftActiveTabIndex, newLeftSidebarTabs.length - 1), 0)\n    );\n    const newRightSidebarTabs = [...rightSidebarTabs, currentLeftTab];\n    setRightSidebarTabs(newRightSidebarTabs);\n    setRightActiveTabIndex(newRightSidebarTabs.length - 1);\n    setRightSidebarUnhidden();\n  }, [\n    leftSidebarTabs,\n    setLeftSidebarTabs,\n    rightSidebarTabs,\n    setRightSidebarTabs,\n    leftActiveTabIndex,\n    setLeftActiveTabIndex,\n    setRightActiveTabIndex,\n    setRightSidebarUnhidden,\n  ]);\n\n  // Find out which tab is active on either side\n  const leftTabName: TAB_NAME = useMemo(() => {\n    if (leftSidebarTabs.length === 0) {\n      return TAB_NAME.EMPTY;\n    } else {\n      return leftSidebarTabs[leftActiveTabIndex] as TAB_NAME;\n    }\n  }, [leftSidebarTabs, leftActiveTabIndex]);\n\n  const rightTabName: TAB_NAME = useMemo(() => {\n    if (rightSidebarTabs.length === 0) {\n      return TAB_NAME.EMPTY;\n    } else {\n      return rightSidebarTabs[rightActiveTabIndex] as TAB_NAME;\n    }\n  }, [rightSidebarTabs, rightActiveTabIndex]);\n\n  // TODO(bowei): improve this abstraction??\n  const actions = useMemo(() => {\n    return {\n      allocateNode: new AllocateNodeAction(props.updaters),\n      deallocateNode: new DeallocateNodeAction(props.updaters),\n    };\n  }, [props.updaters]);\n\n  return (\n    <>\n      <Sidebar\n        hidden={!gameState.playerUI.isLeftSidebarOpen}\n        // hidden={true}\n        placement={'left'}\n      >\n        <div className=\"sidebar-header\">\n          <div className=\"sidebar-header-button\" onClick={onSendTabRight}>\n            ➡️️ Send right\n          </div>\n          <div className=\"sidebar-header-gap\"></div>\n          <div\n            className=\"sidebar-header-button\"\n            onClick={() => {\n              setLeftSidebarHidden();\n            }}\n          >\n            ❎ Close\n          </div>\n        </div>\n        <Tabs\n          value={leftActiveTabIndex || 0}\n          labels={leftSidebarTabs.length ? leftSidebarTabs : emptyTabLabels}\n          onChange={setLeftActiveTabIndex}\n        />\n        <TabContentInterface\n          gameState={gameState}\n          updaters={updaters}\n          tabName={leftTabName}\n          actions={actions}\n        />\n      </Sidebar>\n      <Sidebar\n        hidden={!gameState.playerUI.isRightSidebarOpen}\n        placement={'right'}\n      >\n        <div className=\"sidebar-header\">\n          <div className=\"sidebar-header-button\" onClick={onSendTabLeft}>\n            ⬅️ Send left\n          </div>\n          <div className=\"sidebar-header-gap\"></div>\n          <div\n            className=\"sidebar-header-button\"\n            onClick={() => {\n              setRightSidebarHidden();\n            }}\n          >\n            ❎ Close\n          </div>\n        </div>\n        <Tabs\n          value={rightActiveTabIndex || 0}\n          labels={rightSidebarTabs.length ? rightSidebarTabs : emptyTabLabels}\n          onChange={setRightActiveTabIndex}\n        />\n        <TabContentInterface\n          gameState={gameState}\n          updaters={updaters}\n          tabName={rightTabName}\n          actions={actions}\n        />\n      </Sidebar>\n    </>\n  );\n}\n","import './App.css';\n\nimport classnames from 'classnames';\nimport React, { useEffect, useMemo, useState } from 'react';\nimport { DebugOverlayComponent } from './components/DebugOverlayComponent';\nimport { KeyboardListenerComponent } from './components/KeyboardListenerComponent';\nimport { PixiWrapperComponent } from './components/PixiWrapperComponent';\nimport { WindowListenerComponent } from './components/WindowListenerComponent';\nimport { HudTopComponent } from './components/HudTopComponent';\nimport { UseGameStateContext } from './contexts';\nimport { GameState } from './data/GameState';\nimport { GameStateFactory } from './game/GameStateFactory';\nimport { batchifySetState } from './lib/util/batchify';\nimport { Lazy } from './lib/util/lazy';\nimport {\n  UpdaterGeneratorType2,\n  updaterGenerator2,\n} from './lib/util/updaterGenerator';\nimport { GameAreaInterface } from './components/GameArea/GameAreaInterface';\nimport { SidebarsInterface } from './components/Sidebars/SidebarsInterface';\nimport { PersistenceComponent } from './components/PersistenceComponent';\n\nconst initialGameState: Lazy<GameState> = new Lazy(() =>\n  new GameStateFactory({}).loadOrCreate(+new Date())\n);\n\n/**\n * Root react component.\n * In charge of creating game state, and hooking up the game display, pixi, keyboard control, and window event listeners.\n */\nfunction App() {\n  const [gameState, setGameState] = useState<GameState>(function factory() {\n    return initialGameState.get();\n  });\n\n  let [batchedSetGameState, fireBatch] = useMemo(\n    () => batchifySetState(setGameState),\n    [setGameState]\n  );\n  let updaters = useMemo(\n    () => updaterGenerator2(initialGameState.get(), batchedSetGameState),\n    [batchedSetGameState]\n  );\n\n  const gameStateContextValue = useMemo(() => {\n    return [gameState, updaters, fireBatch] as [\n      GameState,\n      UpdaterGeneratorType2<GameState, GameState>,\n      () => void\n    ];\n  }, [gameState, updaters, fireBatch]);\n\n  useEffect(() => {\n    console.log('maybe toggling strategic view');\n    if (gameState.intent.newIntent.TOGGLE_STRATEGIC_VIEW) {\n      updaters.playerUI.isPixiHidden.enqueueUpdate((it) => !it);\n    }\n  }, [gameState.intent.newIntent.TOGGLE_STRATEGIC_VIEW, updaters]);\n\n  // DEPRECATED\n  useEffect(() => {\n    if (gameState.intent.newIntent.TOGGLE_SIDEBAR) {\n      updaters.playerUI.isSidebarOpen.enqueueUpdate((it) => !it);\n      //updaters.playerUI.isLeftSidebarOpen.enqueueUpdate((it) => !it);\n      //updaters.playerUI.isRightSidebarOpen.enqueueUpdate((it) => !it);\n    }\n  }, [gameState.intent.newIntent.TOGGLE_SIDEBAR, updaters]);\n\n  useEffect(() => {\n    if (gameState.intent.newIntent.TOGGLE_LEFT_SIDEBAR) {\n      updaters.playerUI.isLeftSidebarOpen.enqueueUpdate((it) => !it);\n    }\n  }, [gameState.intent.newIntent.TOGGLE_LEFT_SIDEBAR, updaters]);\n\n  useEffect(() => {\n    if (gameState.intent.newIntent.TOGGLE_RIGHT_SIDEBAR) {\n      updaters.playerUI.isRightSidebarOpen.enqueueUpdate((it) => !it);\n    }\n  }, [gameState.intent.newIntent.TOGGLE_RIGHT_SIDEBAR, updaters]);\n\n  useEffect(() => {\n    if (gameState.intent.newIntent.TURN_OFF_SIDEBAR) {\n      updaters.playerUI.isLeftSidebarOpen.enqueueUpdate((it) => false);\n      updaters.playerUI.isRightSidebarOpen.enqueueUpdate((it) => false);\n    }\n  }, [gameState.intent.newIntent.TURN_OFF_SIDEBAR, updaters]);\n\n  useEffect(() => {\n    if (gameState.intent.newIntent.EXIT) {\n      updaters.playerUI.isLeftSidebarOpen.enqueueUpdate((it) => false);\n      updaters.playerUI.isRightSidebarOpen.enqueueUpdate((it) => false);\n      updaters.playerUI.cursoredNodeLocation.enqueueUpdate((prev) => {\n        return null;\n      });\n    }\n  }, [gameState.intent.newIntent.EXIT, updaters]);\n\n  return (\n    <div className={classnames({ App: true })}>\n      <div className=\"entire-area\">\n        <UseGameStateContext.Provider\n          // NOTE(bowei): this context provider is absolutely unnecessary, but keeping it here for now in case i forget how to use context managers\n          value={gameStateContextValue}\n        >\n          <PixiWrapperComponent hidden={gameState.playerUI.isPixiHidden} />\n        </UseGameStateContext.Provider>\n        <GameAreaInterface\n          gameState={gameState}\n          updaters={updaters}\n        ></GameAreaInterface>\n      </div>\n\n      <div className=\"debug-overlay\">\n        <DebugOverlayComponent\n          tick={gameState.tick}\n          windowState={gameState.windowState}\n        />\n      </div>\n      <HudTopComponent gameState={gameState} updaters={updaters} />\n      <div className=\"button-zone\">\n        <button\n          className=\"button-pixi-toggle\"\n          style={{}}\n          onClick={() => {\n            updaters.playerUI.isPixiHidden.enqueueUpdate((it) => !it);\n          }}\n        >\n          Toggle detailed view (hotkey: b)\n        </button>\n        <span> </span>\n        <button\n          onClick={() => {\n            updaters.playerUI.isSidebarOpen.enqueueUpdate((it) => !it);\n            updaters.playerUI.isLeftSidebarOpen.enqueueUpdate((it) => !it);\n            updaters.playerUI.isRightSidebarOpen.enqueueUpdate((it) => !it);\n          }}\n        >\n          Toggle sidebars (hotkeys: t, y)\n        </button>\n      </div>\n\n      <SidebarsInterface gameState={gameState} updaters={updaters} />\n      <KeyboardListenerComponent\n        isTextBoxFocused={gameState.playerUI.isTextBoxFocused}\n        updaters={updaters.intent}\n      />\n      <WindowListenerComponent updaters={updaters.windowState} />\n      <PersistenceComponent gameState={gameState} />\n    </div>\n  );\n}\n\nexport default App;\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then((registration) => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch((error) => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { 'Service-Worker': 'script' },\n  })\n    .then((response) => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then((registration) => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then((registration) => {\n        registration.unregister();\n      })\n      .catch((error) => {\n        console.error(error.message);\n      });\n  }\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n"],"sourceRoot":""}